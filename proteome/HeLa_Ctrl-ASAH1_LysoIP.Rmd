---
title: "HeLaLysoIpASAH1"
output: html_document
date: "2024-12-03"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## laod packages
```{r}
# --- Core tidyverse packages
library(plyr)
library(stringr)
library(tidyverse)
library(dplyr)
library(tibble)
library(purrr)
library(rlang)
library(readr)


# --- Grammar of graphics & plotting extensions
library(ggrepel)
library(scales)
library(NatParksPalettes)
library(viridis)
library(RColorBrewer)
library(ggVennDiagram)
library(pheatmap)
library(gplots)
library(png)
library(plotly)
library(patchwork)
library(cowplot)
library(gridExtra)
library(grid)

# --- Data handling
library(data.table)

# --- Specialized / utility packages
library(UpSetR)
library(tidyplots)
library(gptstudio)
library(rlang)
library(devtools)

# Optional install commands
# devtools::install_github("jbengler/tidyplots")
# install.packages("magick")
```

# output dirs overview:
```{r}
out_dir_lysoip_dataframes <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/dataframes"
dir.create(out_dir_lysoip_dataframes, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_heatmap  <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/heatmaps"
dir.create(out_dir_lysoip_heatmap, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_corrplots <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/Organelle_CrossCorr"
dir.create(out_dir_lysoip_corrplots, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_organelle_dist <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/Organelle_Distribution"
dir.create(out_dir_lysoip_organelle_dist, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_venn <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/venn"
dir.create(out_dir_lysoip_venn, recursive = TRUE, showWarnings = FALSE)


out_dir_lysoip_autophagy <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/autophagy"
dir.create(out_dir_lysoip_autophagy, recursive = TRUE, showWarnings = FALSE)
```

# I. Background HeLa LysoIP experiments
Dataset contains data from isolated lysosomes from HeLa cell lines
Genotypes: HeLa untagged, HeLa TMEM192-3xHA Ctrl, HeLa TMEM192-3xHA ASAH1-/- #6
Samples (all in triplicates): untagged, Ctrl and ASAH1 
9plex_TMTpro & run on Thermo Orbitrap Ascent w/FAIMS-Pro, hrMS2
data was created with MSstats, has p/q.values and log2FC for samples 
k-means clustering was performed on data, is in column "cluster"



# II. Data import, add annotations
```{r}
# read in df
helalysoip_df <- read.csv(
  "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/20241130_HeLaLysoIP_ASAH1_All_results_stats_localizationAdded.csv",
  header = TRUE
)

# Transform p/q-values to -log10, and filter non-finite log2FCs
log2fc_cols_hela <- c(
"log2FC_CtrlLysoIP.untagged",
"log2FC_ASAH1LysoIP.untagged",
"log2FC_ASAH1LysoIP.CtrlLysoIP"
)

helalysoip_df <- helalysoip_df %>%
  mutate(across(contains("p.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}"),
         across(contains("q.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}")) %>%
  filter(if_all(all_of(log2fc_cols_hela), ~ is.finite(.)))


# 1. Define lysohydrolase list
lysohydrolases <- c(
  "ASAH1", "GBA", "ARSA", "ARSB", "GALNS", "IDUA", "GLA", "NEU1", "MAN2B1",
  "GLB1", "HEXA", "GNS", "HEXB", "CTSA", "CTSZ", "TPP1", "NAGLU", "CTSL",
  "CTSB", "NAGA", "LGMN"
)

# 2. Process subcellular annotation
cols_to_read <- c(1,2,3,4,5,6,7,9,10,12,15,16,17,18,19,20,21,22,23,25,26,27,28,29,30,31,32)
subcell_df <- read_csv("/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/neuroLSDgit/proteome/SubCellAnnotation.csv", show_col_types = FALSE)[, cols_to_read]
subcell_df[] <- lapply(subcell_df, as.character)

long_subcell_df <- subcell_df %>%
  pivot_longer(cols = everything(), names_to = "Localization", values_to = "Genes") %>%
  filter(!is.na(Genes) & Genes != "") %>%
  mutate(Genes = trimws(Genes)) %>%
  distinct()

binary_matrix_helalysoip <- long_subcell_df %>%
  mutate(value = TRUE) %>%
  pivot_wider(names_from = Localization, values_from = value, values_fill = list(value = FALSE))

# 3. Annotate helalysoip_df directly
helalysoip_annotated_df <- helalysoip_df %>%
  mutate(LysoHydrolase = Gene.Symbol %in% lysohydrolases) %>%
  left_join(binary_matrix_helalysoip, by = c("Gene.Symbol" = "Genes")) %>%
  mutate(across(where(is.logical) | where(is.numeric), ~ replace_na(., FALSE)))

write.csv(
  helalysoip_annotated_df,
  file = file.path(out_dir_lysoip_dataframes, "helalysoip_annotated.csv"),
  row.names = FALSE
)
```

# III. Heatmaps of dataframe w/ clusters of interst 
```{r}
# z-score heatmap (rows = gene, columns = sample)

# --- 1. Expression and clustering setup
expr_cols_lysoip <- c(
  "untagged_1", "untagged_2", "untagged_3",
  "CtrlLysoIP_1", "CtrlLysoIP_2", "CtrlLysoIP_3",
  "ASAH1LysoIP_1", "ASAH1LysoIP_2", "ASAH1LysoIP_3"
)

mat_helalysoip <- helalysoip_annotated_df %>%
  filter(!is.na(Gene.Symbol)) %>%
  mutate(Gene.Symbol = make.unique(as.character(Gene.Symbol))) %>%
  select(Gene.Symbol, cluster, all_of(expr_cols_lysoip))

row_cluster <- mat_helalysoip$cluster
rownames(mat_helalysoip) <- mat_helalysoip$Gene.Symbol
mat_helalysoip <- mat_helalysoip[, expr_cols_lysoip]
mat_helalysoip <- mat_helalysoip[order(row_cluster), , drop = FALSE]

# --- 2. Row (cluster) annotation
cluster_levels_helalysoip <- sort(unique(na.omit(as.integer(row_cluster))))
row_annotation_helalysoip <- data.frame(
  cluster = factor(row_cluster[order(row_cluster)], levels = cluster_levels_helalysoip)
)
rownames(row_annotation_helalysoip) <- rownames(mat_helalysoip)

cluster_palette_helalysoip <- setNames(
  RColorBrewer::brewer.pal(length(cluster_levels_helalysoip), "Set2")[1:length(cluster_levels_helalysoip)],
  as.character(cluster_levels_helalysoip)
)

ann_colors_helalysoip <- list(
  Genotype = c(Ctrl = "grey40", ASAH1 = "dodgerblue3"),
  cluster = cluster_palette_helalysoip
)

# --- 3. Column (sample) annotation
annotation_col_helalysoip <- tibble(Sample = expr_cols_lysoip) %>%
  mutate(
    Genotype = if_else(str_detect(Sample, "^Ctrl"), "Ctrl", "ASAH1"),
    Fraction = "LysoIP"
  ) %>%
  column_to_rownames("Sample")

ann_colors_helalysoip$Fraction <- c(
  `Whole-cell` = "#bdbdbd",
  LysoIP = "#9ecae1"  # or another distinct color
)

# --- 4. Save heatmap and matrix
pdf_file_helalysoip <- file.path(out_dir_lysoip_heatmap, "helalysoip_heatmap.pdf")

cairo_pdf(pdf_file_helalysoip, width = 3, height = 5)
pheatmap(
  mat_helalysoip,
  scale              = "row",
  color              = colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(100),
  annotation_col     = annotation_col_helalysoip,
  annotation_row     = row_annotation_helalysoip,
  annotation_colors  = ann_colors_helalysoip,
  breaks             = seq(-4, 4, length.out = 101),
  cluster_rows       = FALSE,
  cluster_cols       = TRUE,
  show_rownames      = FALSE,
  show_colnames      = TRUE,
  angle_col          = 90,
  main               = "HeLa LysoIP: Ctrl vs ASAH1",
  fontsize           = 6,
  border_color       = NA
)
dev.off()

# Save matrix with clusters
mat_helalysoip_out <- cbind(cluster = row_annotation_helalysoip$cluster, mat_helalysoip)
write.csv(mat_helalysoip_out,
          file = file.path(out_dir_lysoip_heatmap, "helalysoip_heatmap_data.csv"),
          row.names = TRUE)


```


# IV. Violins of clusters of interst 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Violin Plot of Cluster Abundance
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Define sample columns
sample_cols_lysoip <- c(
"log2FC_CtrlLysoIP.untagged",
"log2FC_ASAH1LysoIP.untagged",
"log2FC_ASAH1LysoIP.CtrlLysoIP" 
)

# --- 2. Reshape and clean
violin_df_lysoip <- helalysoip_df %>%
  filter(!is.na(cluster) & cluster != 0) %>%
  pivot_longer(cols = all_of(sample_cols_lysoip), names_to = "Sample", values_to = "log2FC") %>%
  filter(!is.na(log2FC)) %>%
  mutate(cluster = factor(cluster),
         Sample = factor(Sample, levels = sample_cols_lysoip))  # enforce consistent order


# --- 3. Define plot
lysoip_clusterPlot <- ggplot(violin_df_lysoip, aes(x = Sample, y = log2FC, fill = Sample)) +
  geom_jitter(aes(color = "red"), size = 0.5, alpha = 0.2, width = 0.2, height = 0) +
  geom_violin(scale = "width", trim = FALSE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  facet_wrap(~ cluster, scales = "free_y") +
  scale_fill_manual(values = c(
    "log2FC_CtrlLysoIP.untagged"     = "#bdc9e1",
    "log2FC_ASAH1LysoIP.untagged"    = "#74a9cf",
    "log2FC_ASAH1LysoIP.CtrlLysoIP"  = "dodgerblue3"
  )) +
  theme_bw(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "none") +
  labs(title = "LysoIP: log2FC by Sample per Cluster", x = NULL, y = "log2FC")

# --- 4. Save to PDF
ggsave(file.path(out_dir_lysoip_heatmap, "LysoIP_clusterViolinPlot_log2FC.pdf"),
       lysoip_clusterPlot, width = 6, height = 6, device = cairo_pdf)




# ─────────────────────────────────────────────────────────────────────────────
# Violin Plot of select annotations in ctrl vs ASAH1-/-
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Define setup
organelles <- c("Lysosome", "Endo_iN_curated_Hundley", "Golgi", "ER", "Mito")

org_mapping <- tibble(
  Organelle = factor(organelles, levels = organelles),
  Org_Label = c("Lyso", "Endo", "Golgi", "ER", "Mito"),
  Org_Number = 1:5
)

org_labels <- org_mapping$Org_Label
org_order  <- org_mapping$Org_Number

# --- 2. Create data subset for both comparisons
df_ctrl <- helalysoip_annotated_df %>%
  filter(if_any(all_of(organelles), ~ .x)) %>%
  select(Gene.Symbol, all_of(organelles), log2FC_CtrlLysoIP.untagged) %>%
  pivot_longer(cols = all_of(organelles), names_to = "Organelle", values_to = "flag") %>%
  filter(flag) %>%
  mutate(Sample = "Ctrl vs Untagged", log2FC = log2FC_CtrlLysoIP.untagged)

df_asah1 <- helalysoip_annotated_df %>%
  filter(if_any(all_of(organelles), ~ .x)) %>%
  select(Gene.Symbol, all_of(organelles), log2FC_ASAH1LysoIP.untagged) %>%
  pivot_longer(cols = all_of(organelles), names_to = "Organelle", values_to = "flag") %>%
  filter(flag) %>%
  mutate(Sample = "ASAH1 vs Untagged", log2FC = log2FC_ASAH1LysoIP.untagged)

# --- 3. Combine dataframes and annotate
violin_df <- bind_rows(df_ctrl, df_asah1) %>%
  mutate(
    Sample = factor(Sample, levels = c("Ctrl vs Untagged", "ASAH1 vs Untagged")),
    Organelle = factor(Organelle, levels = organelles)
  ) %>%
  left_join(org_mapping, by = "Organelle")

# --- 4. Mean value labels
# label_df <- violin_df %>%
#   group_by(Organelle, Sample) %>%
#   summarize(mean_val = round(mean(log2FC, na.rm = TRUE), 2), .groups = "drop") %>%
#   mutate(
#     xpos = interaction(Organelle, Sample),
#     ypos = max(violin_df$log2FC, na.rm = TRUE) + 0.3
#   )

# --- 5. Plot
ggplot(violin_df, aes(x = interaction(Organelle, Sample), y = log2FC, fill = Sample)) +
  geom_violin(scale = "width", trim = FALSE, width = 0.9) +
  geom_jitter(width = 0.15, height = 0, size = 0.3, alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  scale_fill_manual(values = c("Ctrl vs Untagged" = "grey70", "ASAH1 vs Untagged" = "dodgerblue3")) +
  scale_x_discrete(labels = setNames(
    rep(org_labels, times = 2),
    interaction(rep(org_mapping$Organelle, times = 2),
                rep(c("Ctrl vs Untagged", "ASAH1 vs Untagged"), each = length(organelles)))
  )) +
  theme_bw(base_size = 10) +
  theme(
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 0),
    legend.position = "none"
  ) +
  labs(y = expression(log[2]*"FC"), title = "Organelle Enrichment HeLa Ctrl vs ASAH1-/-") +
  annotate("text", x = 1:10, y = -4.5, label = rep(org_order, times = 2),
           color = rep(c("darkorange", "firebrick"), each = length(organelles)), size = 3) +
  annotate("text", x = 3, y = -5.2, label = "Ctrl vs Untagged", size = 3.2) +
  annotate("text", x = 8, y = -5.2, label = "ASAH1 vs Untagged", size = 3.2)

# --- 5. Save
ggsave(file.path(out_dir_lysoip_organelle_dist, "LysoIP_OrganelleEnrichment_ViolinCombo.pdf"), width = 5, height = 5, device = cairo_pdf)






# ─────────────────────────────────────────────────────────────────────────────
# Violin Plot of detailed endo annotations in ctrl vs ASAH1-/-
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Define organelle labels and order for detailed Endo investigation
organelle_detailed <- c(
  "Lysosome", 
  "Endo_iN_curated_Hundley", 
  "EarlyEndosome", 
  "RecyclingEndosome", 
  "Golgi", 
  "ER", 
  "Mito"
)

org_endodetailed_mapping <- tibble(
  Organelle = factor(organelle_detailed, levels = organelle_detailed),
  Org_Label = c("Lyso", "Endo", "EarlyEndo", "RecyclingEndo", "Golgi", "ER", "Mito"),
  Org_Number = 1:7
)

# --- 2. Subset data for Ctrl and ASAH1 comparisons
df_det_ctrl <- helalysoip_annotated_df %>%
  filter(if_any(all_of(organelle_detailed), ~ .x)) %>%
  select(Gene.Symbol, all_of(organelle_detailed), log2FC_CtrlLysoIP.untagged) %>%
  pivot_longer(cols = all_of(organelle_detailed), names_to = "Organelle", values_to = "flag") %>%
  filter(flag) %>%
  mutate(Sample = "Ctrl vs Untagged", log2FC = log2FC_CtrlLysoIP.untagged)

df_det_asah1 <- helalysoip_annotated_df %>%
  filter(if_any(all_of(organelle_detailed), ~ .x)) %>%
  select(Gene.Symbol, all_of(organelle_detailed), log2FC_ASAH1LysoIP.untagged) %>%
  pivot_longer(cols = all_of(organelle_detailed), names_to = "Organelle", values_to = "flag") %>%
  filter(flag) %>%
  mutate(Sample = "ASAH1 vs Untagged", log2FC = log2FC_ASAH1LysoIP.untagged)

# --- 3. Combine and annotate
violin_det_df <- bind_rows(df_det_ctrl, df_det_asah1) %>%
  mutate(Sample = factor(Sample, levels = c("Ctrl vs Untagged", "ASAH1 vs Untagged")),
         Organelle = factor(Organelle, levels = organelle_detailed)) %>%
  left_join(org_endodetailed_mapping, by = "Organelle")

# # --- 4. Compute mean labels
# label_det_df <- violin_det_df %>%
#   group_by(Organelle, Sample) %>%
#   summarize(mean_val = round(mean(log2FC, na.rm = TRUE), 2), .groups = "drop") %>%
#   mutate(
#     ypos = max(violin_det_df$log2FC, na.rm = TRUE) + 0.3
#   )

# --- 5. Plot
ggplot(violin_det_df, aes(x = interaction(Organelle, Sample), y = log2FC, fill = Sample)) +
  geom_violin(scale = "width", trim = FALSE, width = 0.9) +
  geom_jitter(width = 0.15, height = 0, size = 0.3, alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  scale_fill_manual(values = c("Ctrl vs Untagged" = "grey70", "ASAH1 vs Untagged" = "dodgerblue3")) +
  # scale_x_discrete(
  #   labels = setNames(
  #     rep(org_endodetailed_mapping$Org_Label, times = 2),
  #     interaction(rep(org_endodetailed_mapping$Organelle, times = 2),
  #                 rep(c("Ctrl vs Untagged", "ASAH1 vs Untagged"), each = nrow(org_endodetailed_mapping)))
  #   )
  # ) +
  theme_bw(base_size = 10) +
  theme(
    panel.grid = element_blank(),
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle = 90),
    legend.position = "none"
  ) +
  labs(y = expression(log[2]*"FC"), title = "Organelle Enrichment HeLa Ctrl vs ASAH1-/-")

# --- 6. Save
ggsave(file.path(out_dir_lysoip_organelle_dist, "LysoIP_OrganelleEnrichment_detailedEndo_ViolinCombo.pdf"), width = 5, height = 5, device = cairo_pdf)



```


# IV. Abundnance of lysosomal hydrolases
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Hydrolase abundance in lysosome Ctrl vs ASAH1-/-
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1: Prepare data for slope plot
hydro_df <- helalysoip_annotated_df %>%
  filter(LysoHydrolase == TRUE) %>%
  select(Gene.Symbol,
         Ctrl = log2FC_CtrlLysoIP.untagged,
         ASAH1 = log2FC_ASAH1LysoIP.untagged) %>%
  pivot_longer(cols = c("Ctrl", "ASAH1"), names_to = "Sample", values_to = "log2FC") %>%
  mutate(Gene.Symbol = factor(Gene.Symbol, levels = unique(Gene.Symbol)))  # maintain order

# Ensure factor levels enforce desired order
hydro_df <- hydro_df %>%
  mutate(Sample = factor(Sample, levels = c("Ctrl", "ASAH1")))

# --- Step 2: Plot slope plot
p_slope <- ggplot(hydro_df, aes(x = Sample, y = log2FC, group = Gene.Symbol)) +
  geom_line(color = "grey90", alpha = 0.8) +
  geom_point(size = 3, aes(fill = Sample), shape = 21, color = "black") +
  scale_fill_manual(values = c("Ctrl" = "grey70", "ASAH1" = "dodgerblue3")) +
  theme_bw(base_size = 6) +
  labs(x = NULL, y = expression(log[2]*"FC"),
       title = "Lysohydrolase Abundance in Ctrl vs ASAH1-/-") +
  theme(
    panel.grid = element_blank(),
    aspect.ratio = 1.75,
    legend.position = "none"
  )

# --- Step 3: Save as square PDF
ggsave(filename = file.path(out_dir_lysoip_organelle_dist,
                            "lysohydrolase_slopeplot.pdf"),
       plot = p_slope, width = 2, height = 4, device = cairo_pdf)
```


# V. Venn Diagramm of lyso, endo and iN-endo list to see overlap
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Venn for all proteins detected
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1: read in .csv file containing the genes which are sig down in proteomics
lysoIPvenn <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/EndoLysoIP_venn.csv', 
                   header=T, sep = ",", , stringsAsFactors = FALSE)


# --- Step 2: Venn of all three datasets #####
ggVennDiagram(
  lysoIPvenn,
  category.names = c("Lyso-enriched", "Endo-enriched", "iNendo-enriched"),
  show_intersect = FALSE,
  set_color = "black",
  set_size = NA,
  label = c("both"),
  label_alpha = 0,
  label_geom = c("label"),
  label_color = "black",
  label_size = NA,
  label_percent_digit = 0,
  label_txtWidth = 40,
  edge_lty = "solid",
  edge_size = 0,
) +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF")


# --- Step 3: Save Venn diagram as .pdf for further processing in illustrator for figures 
ggsave(file.path(out_dir_lysoip_venn,'EndoLysoVennDiagramm.pdf'), width =20, height = 20, units = "cm", dpi=600)



# ─────────────────────────────────────────────────────────────────────────────
# Venn of Lyso and iN endo list
# ─────────────────────────────────────────────────────────────────────────────
# --- Step 4: make subset of IP data to only contain lyso and Endocurated list 
lysoIPvenn_subest <- lysoIPvenn[,c("Lyso", "EndoCurated")]

ggVennDiagram(
  lysoIPvenn_subest,
  category.names = c("Lyso-enriched", "iNendo-enriched"),
  show_intersect = FALSE,
  set_color = "black",
  set_size = NA,
  label = c("both"),
  label_alpha = 0,
  label_geom = c("label"),
  label_color = "black",
  label_size = NA,
  label_percent_digit = 0,
  label_txtWidth = 40,
  edge_lty = "solid",
  edge_size = 0,
) +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  coord_flip() ## flip plot on side 


# --- Step 5: save Venn diagram as .pdf for further processing in illustrator for figures 
ggsave(file.path(out_dir_lysoip_venn, 'EndoCuratedLysoVennDiagramm.pdf'), width =27, height = 20, units = "cm", dpi=600)


# --- Step 6: Extract overlapping protein names #### 
## parse and save overlapping protein names that between the lists 
# Convert columns to sets (remove NA values)
lyso_set <- na.omit(lysoIPvenn$Lyso)
endosome_set <- na.omit(lysoIPvenn$Endosome)
endocurated_set <- na.omit(lysoIPvenn$EndoCurated)


# --- Step 7: Compute pairwise intersections
overlap_lyso_endosome <- intersect(lyso_set, endosome_set)
overlap_lyso_endocurated <- intersect(lyso_set, endocurated_set)
overlap_endosome_endocurated <- intersect(endosome_set, endocurated_set)

# --- Step 8: Save the results to CSV files
write.csv(data.frame(Overlap_Lyso_Endosome = overlap_lyso_endosome),
          '/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/Overlap_Lyso_Endosome.csv', row.names = FALSE)
write.csv(data.frame(Overlap_Lyso_EndoCurated = overlap_lyso_endocurated),
          '/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/Overlap_Lyso_EndoCurated.csv', row.names = FALSE)
write.csv(data.frame(Overlap_Endosome_EndoCurated = overlap_endosome_endocurated),
          '/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/Overlap_Endosome_EndoCurated.csv', row.names = FALSE)




# ─────────────────────────────────────────────────────────────────────────────
# Analysis for enriched protein (log2FC >0.5) in Ctrl over untagged
# ─────────────────────────────────────────────────────────────────────────────
# --- Step 9: Read in .csv file containing the genes which are sig down in proteomics
lysoIPvennCtrl <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/EndoLysoIP_vennCtrl.csv', 
                   header=T, sep = ",", , stringsAsFactors = FALSE)


# --- Step 10: Make subset of IP data to only contain lyso and Endocurated list & plot
lysoIPvennCtrl_subest <- lysoIPvennCtrl[,c("Lyso", "EndoCurated")]

ggVennDiagram(
  lysoIPvennCtrl_subest,
  category.names = c("Lyso-enriched", "iNendo-enriched"),
  show_intersect = FALSE,
  set_color = "black",
  set_size = NA,
  label = c("both"),
  label_alpha = 0,
  label_geom = c("label"),
  label_color = "black",
  label_size = NA,
  label_percent_digit = 0,
  label_txtWidth = 40,
  edge_lty = "solid",
  edge_size = 0,
) +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  coord_flip() ## flip plot on side 


# --- Step 11: Save Venn diagram as .pdf for further processing in illustrator for figures 
ggsave(file.path(out_dir_lysoip_venn,'EndoCuratedLysoVennDiagrammCtrl.pdf'), width =27, height = 20, units = "cm", dpi=600)


# --- Step 12: Ctrl over untagged: Extract overlapping protein names 
## parse and save overlapping protein names that between the lists 

# Convert columns to sets (remove NA values)
lyso_Ctrl_set <- na.omit(lysoIPvennCtrl$Lyso)
endosome_Ctrl_set <- na.omit(lysoIPvennCtrl$Endosome)
endocurated_Ctrl_set <- na.omit(lysoIPvennCtrl$EndoCurated)

# Compute pairwise intersections
overlap_Ctrl_lyso_endosome <- intersect(lyso_Ctrl_set, endosome_Ctrl_set)
overlap_Ctrl_lyso_endocurated <- intersect(lyso_Ctrl_set, endocurated_Ctrl_set)
overlap_Ctrl_endosome_endocurated <- intersect(endosome_Ctrl_set, endocurated_Ctrl_set)

# Save the results to CSV files
write.csv(data.frame(Overlap_Ctrl_Lyso_Endosome = overlap_Ctrl_lyso_endosome),file=file.path(out_dir_lysoip_venn,
          'Overlap_Ctrl_Lyso_Endosome.csv'), row.names = FALSE)
write.csv(data.frame(Overlap_Ctrl_Lyso_EndoCurated = overlap_Ctrl_lyso_endocurated),file=file.path(out_dir_lysoip_venn,
          'Overlap_Ctrl_Lyso_EndoCurated.csv'), row.names = FALSE)
write.csv(data.frame(Overlap_Ctrl_Endosome_EndoCurated = overlap_Ctrl_endosome_endocurated),file=file.path(out_dir_lysoip_venn,
          'Overlap_Ctrl_Endosome_EndoCurated.csv'), row.names = FALSE)





# ─────────────────────────────────────────────────────────────────────────────
# Analysis for enriched protein (log2FC >0.5) in ASAH1 over untagged 
# ─────────────────────────────────────────────────────────────────────────────
# --- Step 13: Read in .csv file containing the genes which are sig down in proteomics
lysoIPvennASAH1 <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/EndoLysoIP_vennASAH1.csv', 
                   header=T, sep = ",", , stringsAsFactors = FALSE)


# --- Step 14: Make subset of IP data to only contain lyso and Endocurated list & plot
lysoIPvennASAH1_subest <- lysoIPvennASAH1[,c("Lyso", "EndoCurated")]

ggVennDiagram(
  lysoIPvennASAH1_subest,
  category.names = c("Lyso-enriched", "iNendo-enriched"),
  show_intersect = FALSE,
  set_color = "black",
  set_size = NA,
  label = c("both"),
  label_alpha = 0,
  label_geom = c("label"),
  label_color = "black",
  label_size = NA,
  label_percent_digit = 0,
  label_txtWidth = 40,
  edge_lty = "solid",
  edge_size = 0,
) +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  coord_flip() ## flip plot on side 


# --- Step 15: Save Venn diagram as .pdf for further processing in illustrator for figures 
ggsave(file.path(out_dir_lysoip_venn,'EndoCuratedLysoVennDiagrammASAH1.pdf'), width =27, height = 20, units = "cm", dpi=600)


# --- Step 16: Ctrl over untagged: Extract overlapping protein names 
## parse and save overlapping protein names that between the lists 
# Convert columns to sets (remove NA values)
lyso_ASAH1_set <- na.omit(lysoIPvennASAH1$Lyso)
endosome_ASAH1_set <- na.omit(lysoIPvennASAH1$Endosome)
endocurated_ASAH1_set <- na.omit(lysoIPvennASAH1$EndoCurated)

# Compute pairwise intersections
overlap_ASAH1_lyso_endosome <- intersect(lyso_ASAH1_set, endosome_ASAH1_set)
overlap_ASAH1_lyso_endocurated <- intersect(lyso_ASAH1_set, endocurated_ASAH1_set)
overlap_ASAH1_endosome_endocurated <- intersect(endosome_ASAH1_set, endocurated_ASAH1_set)

# Save the results to CSV files
write.csv(data.frame(Overlap_ASAH1_Lyso_Endosome = overlap_ASAH1_lyso_endosome),file=file.path(out_dir_lysoip_venn,
          'Overlap_ASAH1_Lyso_Endosome.csv'), row.names = FALSE)
write.csv(data.frame(Overlap_ASAH1_Lyso_EndoCurated = overlap_ASAH1_lyso_endocurated),file=file.path(out_dir_lysoip_venn,
          '/Overlap_ASAH1_Lyso_EndoCurated.csv'), row.names = FALSE)
write.csv(data.frame(Overlap_ASAH1_Endosome_EndoCurated = overlap_ASAH1_endosome_endocurated),file=file.path(out_dir_lysoip_venn,
          'Overlap_ASAH1_Endosome_EndoCurated.csv'), row.names = FALSE)



```


## VI. Autophagy investigation in more detail
```{r}
# --- 0.  define annotation lists:
autophagy_receptors <- c(
  "AMBRA1", "BCL2L13", "BECN1", "BNIP3L", "CALCOCO2", "CCPG1", "CDK5RAP3", "FUNDC1", 
  "LGALS3", "LGALS8", "NBR1", "NCOA4", "NLRX1", "OPTN", "RETREG1", "SQSTM1", 
  "STBD1", "TAX1BP1", "TEX264", "TOLLIP", "TRIM5"
)
autophagy_core <- c(
  "ATG12", "ATG13", "ATG14", "ATG16L1", "ATG3", "ATG4A", "ATG4B", "ATG4C", "ATG5", 
  "ATG7", "ATG9A", "GABARAP", "GABARAPL2", "MAP1LC3A", "MAP1LC3B", "MTOR", "PIK3C3", 
  "PIK3R4", "PLEKHM1", "RAB5A", "RAB7A", "RB1CC1", "RUBCN", "STX17", "ULK1", 
  "ULK2", "UVRAG", "WDR45", "WDR45B", "WIPI1", "WIPI2", "ZFYVE1"
)
golgi_trans <- c(
  "PACS1", "VPS45", "VPS41", "GGA3", "ARFIP2", "GGA1", "GOLPH3L", "GOPC", 
  "AP4M1", "GGA2", "OSBPL11", "GOLGA1", "FAM91A1", "C17orf75", "OSBPL9", "GOLGA4", 
  "VPS51", "TBC1D23", "VPS52", "CCDC91", "ARFIP1", "AP4B1", "AP4E1", "IMPAD1"
)
golgi_trans <- c(
  "PACS1", "VPS45", "VPS41", "GGA3", "ARFIP2", "GGA1", "GOLPH3L", "GOPC", 
  "AP4M1", "GGA2", "OSBPL11", "GOLGA1", "FAM91A1", "C17orf75", "OSBPL9", "GOLGA4", 
  "VPS51", "TBC1D23", "VPS52", "CCDC91", "ARFIP1", "AP4B1", "AP4E1", "IMPAD1"
)

golgi_cis <- c(
  "TMED10", "TRAPPC3", "TMED1", "TRAPPC10", "COPG2", "TRAPPC5", "COPB1", "COPB2", 
  "GOLM1", "COPG1", "B3GAT3", "TRAPPC11", "TRAPPC6B", "TMED2", "GOSR2", "TRAPPC8", 
  "TRAPPC4", "GBF1", "TMED5", "TMED9", "GOLGA5", "SEB22B", "NUCB1", "GOLGA2"
)
ergic <- c(
  "TMED10", "TMED1", "ATP6AP1", "RAB1B", "RAB2A", "TAOK2", "NXF1", "TMEM181", 
  "STX16", "RAB2B", "RAB6B", "USP46", "SURF4", "GLE1", "GORASP1", "LMAN2L", 
  "ECPAS", "TMED2", "UGGT1", "TRAPPC12", "DNM2", "SEH1L", "MARCKS", "GBF1", "RDX", 
  "BCAP31", "DST", "ERGIC3", "TMED9", "LMAN1", "SEB22B", "LMAN2", "STX5"
)

annotation_lists <- list(
  autophagy_receptors = autophagy_receptors,
  autophagy_core = autophagy_core,
  golgi_trans = golgi_trans,
  golgi_cis = golgi_cis,
  ergic = ergic,
  ER = helalysoip_annotated_df %>% filter(ER) %>% pull(Gene.Symbol)  # if ER is already a logical column
)


# --- 1. Annotate dataframe
annot_df <- helalysoip_annotated_df %>%
  select(Gene.Symbol, sig_ASAH1LysoIP.CtrlLysoIP) %>%
  mutate(across(Gene.Symbol, as.character)) %>%
  mutate(across(Gene.Symbol, make.unique))  # in case of duplicate gene names

for (ann in names(annotation_lists)) {
  annot_df[[ann]] <- annot_df$Gene.Symbol %in% annotation_lists[[ann]]
}

# --- 2. Reshape to long format and filter sig hits
sig_hits_df <- annot_df %>%
  pivot_longer(cols = names(annotation_lists), names_to = "Annotation", values_to = "flag") %>%
  filter(flag) %>%
  rename(SigStatus = sig_ASAH1LysoIP.CtrlLysoIP) %>%
  filter(SigStatus %in% c("up", "down"))

# --- 3. Count hits
sig_summary_autophagy <- sig_hits_df %>%
  dplyr::count(.data$Annotation, .data$SigStatus) %>%
  mutate(Comparison = "ASAH1LysoIP vs CtrlLysoIP")

# --- 4. Get gene lists per annotation and direction
sig_genes_autophagy <- sig_hits_df %>%
  filter(SigStatus %in% c("up", "down")) %>%
  group_by(Annotation, SigStatus) %>%
  summarize(Genes = paste(Gene.Symbol, collapse = "; "), .groups = "drop")

# --- 5. Plot
sig_plot_autophagy <- ggplot(sig_summary_autophagy,
                             aes(x = reorder(Annotation, n), y = n, fill = SigStatus)) +
  geom_col(position = "stack") +
  coord_flip() +
  facet_wrap(~ Comparison, ncol = 1) +
  scale_fill_manual(values = c(up = "grey70", down = "dodgerblue3")) +
  labs(x = NULL, y = "# Significant Hits", title = "Significant Hits – ASAH1LysoIP vs CtrlLysoIP") +
  theme_bw(base_size = 8) +
  theme(panel.grid = element_blank())


# --- 6. Save plot and table
ggsave(file.path(out_dir_lysoip_autophagy, "sig_hits_ASAH1LysoIP_barplot.pdf"),
       sig_plot_autophagy, width = 5, height = 4, device = cairo_pdf)

# --- 7. Save gene-level summary for ASAH1LysoIP vs CtrlLysoIP
sig_gene_summary_autophagy <- sig_hits_df %>%
  mutate(
    Type = "SigHits",  # Optional, for consistency
    Comparison = "ASAH1LysoIP vs CtrlLysoIP"
  ) %>%
  group_by(Type, Comparison, Annotation, SigStatus) %>%
  summarise(
    n = n(),
    GeneList = paste(unique(Gene.Symbol), collapse = ";"),
    .groups = "drop"
  )

write.csv(sig_gene_summary_autophagy,file = file.path(out_dir_lysoip_autophagy, "sig_hits_annotation_geneList.csv"),row.names = FALSE)
write_csv(sig_summary_autophagy, file.path(out_dir_lysoip_autophagy, "sig_hits_autophagy_summary.csv"))


```



