---
title: "HeLaLysoIpASAH1"
output: html_document
date: "2024-12-03"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## load packages
```{r}
# --- Core tidyverse packages
library(plyr)
library(stringr)
library(tidyverse)
library(dplyr)
library(tibble)
library(purrr)
library(rlang)
library(readr)


# --- Grammar of graphics & plotting extensions
library(ggrepel)
library(scales)
library(NatParksPalettes)
library(viridis)
library(RColorBrewer)
library(ggVennDiagram)
library(pheatmap)
library(gplots)
library(png)
library(plotly)
library(patchwork)
library(cowplot)
library(gridExtra)
library(grid)

# --- Data handling
library(data.table)

# --- Specialized / utility packages
library(UpSetR)
library(tidyplots)
library(gptstudio)
library(rlang)
library(devtools)
library(Cairo)


# --- GO Term analysis ---
#BiocManager::install("topGO")
library(topGO)
#BiocManager::install("org.Hs.eg.db")
library(org.Hs.eg.db)
#BiocManager::install("clusterProfiler")
library(clusterProfiler)


library(ggplot2)
library(ggdist)
library(gghalves)
library(ggrepel)
library(dplyr)
library(tibble)


# Optional install commands
# devtools::install_github("jbengler/tidyplots")
# install.packages("magick")
```

# output dirs overview:
```{r}
out_dir_lysoip_dataframes <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/dataframes"
dir.create(out_dir_lysoip_dataframes, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_heatmap  <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/heatmaps"
dir.create(out_dir_lysoip_heatmap, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_corrplots <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/Organelle_CrossCorr"
dir.create(out_dir_lysoip_corrplots, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_organelle_dist <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/Organelle_Distribution"
dir.create(out_dir_lysoip_organelle_dist, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_organelle_rainfall <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/Rainfall"
dir.create(out_dir_lysoip_organelle_rainfall, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_venn <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/venn"
dir.create(out_dir_lysoip_venn, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_venn_coenrichment  <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/venn/coenrichment"
dir.create(out_dir_lysoip_venn_coenrichment, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_autophagy <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/autophagy"
dir.create(out_dir_lysoip_autophagy, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_GO <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/GO"
dir.create(out_dir_lysoip_GO, recursive = TRUE, showWarnings = FALSE)

out_dir_lysoip_GOcoenrichment <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/GO/coenrichment"
dir.create(out_dir_lysoip_GOcoenrichment, recursive = TRUE, showWarnings = FALSE)



```

# I. Background HeLa LysoIP experiments
Dataset contains data from isolated lysosomes from HeLa cell lines
Genotypes: HeLa untagged, HeLa TMEM192-3xHA Ctrl, HeLa TMEM192-3xHA ASAH1-/- #6
Samples (all in triplicates): untagged, Ctrl and ASAH1 
9plex_TMTpro & run on Thermo Orbitrap Ascent w/FAIMS-Pro, hrMS2
data was created with MSstats, has p/q.values and log2FC for samples 
k-means clustering was performed on data, is in column "cluster"



# II. Data import, add annotations
```{r}
# read in df
helalysoip_df <- read.csv(
  "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/Eval/datasets/20241130_HeLaLysoIP_ASAH1_All_results_stats_localizationAdded.csv",
  header = TRUE
)

# Transform p/q-values to -log10, and filter non-finite log2FCs
log2fc_cols_hela <- c(
"log2FC_CtrlLysoIP.untagged",
"log2FC_ASAH1LysoIP.untagged",
"log2FC_ASAH1LysoIP.CtrlLysoIP"
)

helalysoip_df <- helalysoip_df %>%
  mutate(across(contains("p.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}"),
         across(contains("q.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}")) %>%
  filter(if_all(all_of(log2fc_cols_hela), ~ is.finite(.)))


# 1. Define lysohydrolase list
lysohydrolases <- c(
  "ASAH1", "GBA", "ARSA", "ARSB", "GALNS", "IDUA", "GLA", "NEU1", "MAN2B1",
  "GLB1", "HEXA", "GNS", "HEXB", "CTSA", "CTSZ", "TPP1", "NAGLU", "CTSL",
  "CTSB", "NAGA", "LGMN"
)

# 2. Process subcellular annotation
cols_to_read <- c(1,2,3,4,5,6,7,9,10,12,15,16,17,18,19,20,21,22,23,25,26,27,28,29,30,31,32,33)
subcell_df <- read.csv("/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/neuroLSDgit/proteome/SubCellAnnotation.csv", stringsAsFactors = FALSE)[, cols_to_read]
subcell_df[] <- lapply(subcell_df, as.character)

long_subcell_df <- subcell_df %>%
  pivot_longer(cols = everything(), names_to = "Localization", values_to = "Genes") %>%
  filter(!is.na(Genes) & Genes != "") %>%
  mutate(Genes = trimws(Genes)) %>%
  distinct()

binary_matrix_helalysoip <- long_subcell_df %>%
  mutate(value = TRUE) %>%
  pivot_wider(names_from = Localization, values_from = value, values_fill = list(value = FALSE))

# 3. Annotate helalysoip_df directly
helalysoip_annotated_df <- helalysoip_df %>%
  mutate(LysoHydrolase = Gene.Symbol %in% lysohydrolases) %>%
  left_join(binary_matrix_helalysoip, by = c("Gene.Symbol" = "Genes")) %>%
  mutate(across(where(is.logical) | where(is.numeric), ~ replace_na(., FALSE)))

write.csv(
  helalysoip_annotated_df,
  file = file.path(out_dir_lysoip_dataframes, "helalysoip_annotated.csv"),
  row.names = FALSE
)
```

# III. Heatmaps of dataframe w/ clusters of interst 
```{r}
# z-score heatmap (rows = gene, columns = sample)

# --- 1. Expression and clustering setup
expr_cols_lysoip <- c(
  "untagged_1", "untagged_2", "untagged_3",
  "CtrlLysoIP_1", "CtrlLysoIP_2", "CtrlLysoIP_3",
  "ASAH1LysoIP_1", "ASAH1LysoIP_2", "ASAH1LysoIP_3"
)

mat_helalysoip <- helalysoip_annotated_df %>%
  filter(!is.na(Gene.Symbol)) %>%
  mutate(Gene.Symbol = make.unique(as.character(Gene.Symbol))) %>%
  select(Gene.Symbol, cluster, all_of(expr_cols_lysoip))

row_cluster <- mat_helalysoip$cluster
rownames(mat_helalysoip) <- mat_helalysoip$Gene.Symbol
mat_helalysoip <- mat_helalysoip[, expr_cols_lysoip]
mat_helalysoip <- mat_helalysoip[order(row_cluster), , drop = FALSE]

# --- 2. Row (cluster) annotation
cluster_levels_helalysoip <- sort(unique(na.omit(as.integer(row_cluster))))
row_annotation_helalysoip <- data.frame(
  cluster = factor(row_cluster[order(row_cluster)], levels = cluster_levels_helalysoip)
)
rownames(row_annotation_helalysoip) <- rownames(mat_helalysoip)

cluster_palette_helalysoip <- setNames(
  RColorBrewer::brewer.pal(length(cluster_levels_helalysoip), "Set2")[1:length(cluster_levels_helalysoip)],
  as.character(cluster_levels_helalysoip)
)

ann_colors_helalysoip <- list(
  Genotype = c(Ctrl = "grey40", ASAH1 = "dodgerblue3"),
  cluster = cluster_palette_helalysoip
)

# --- 3. Column (sample) annotation
annotation_col_helalysoip <- tibble(Sample = expr_cols_lysoip) %>%
  mutate(
    Genotype = if_else(str_detect(Sample, "^Ctrl"), "Ctrl", "ASAH1"),
    Fraction = "LysoIP"
  ) %>%
  column_to_rownames("Sample")

ann_colors_helalysoip$Fraction <- c(
  `Whole-cell` = "#bdbdbd",
  LysoIP = "#9ecae1"  # or another distinct color
)

# --- 4. Save heatmap and matrix
pdf_file_helalysoip <- file.path(out_dir_lysoip_heatmap, "helalysoip_heatmap.pdf")

cairo_pdf(pdf_file_helalysoip, width = 3, height = 5)
pheatmap(
  mat_helalysoip,
  scale              = "row",
  color              = colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(100),
  annotation_col     = annotation_col_helalysoip,
  annotation_row     = row_annotation_helalysoip,
  annotation_colors  = ann_colors_helalysoip,
  breaks             = seq(-4, 4, length.out = 101),
  cluster_rows       = FALSE,
  cluster_cols       = TRUE,
  show_rownames      = FALSE,
  show_colnames      = TRUE,
  main               = "HeLa LysoIP: Ctrl vs ASAH1",
  fontsize           = 6,
  border_color       = NA
)
dev.off()

# Save matrix with clusters
mat_helalysoip_out <- cbind(cluster = row_annotation_helalysoip$cluster, mat_helalysoip)
write.csv(mat_helalysoip_out,
          file = file.path(out_dir_lysoip_heatmap, "helalysoip_heatmap_data.csv"),
          row.names = TRUE)


```



### IIIa. Scaled intensity Violinplot based on heatmap clusters 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Violin Plot of scaled intensities of mat_helalysoip_out: Group Means by Cluster
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1.  Step: Row-wise Scaling (Z-score)
# Scale intensities row-wise (z-score across all replicates)
mat_scaled <- mat_helalysoip_out %>%
  select(untagged_1:ASAH1LysoIP_3) %>%
  as.matrix() %>%
  t() %>%
  scale(center = TRUE, scale = TRUE) %>%
  t() %>%
  as.data.frame()

# --- Add cluster info back ---
mat_scaled$cluster <- mat_helalysoip_out$cluster



# --- Step 2. Rebuild long-format dataframe for plotting
# Compute group-wise scaled means
violin_df_lysoip_mean_scaled <- mat_scaled %>%
  mutate(
    untagged     = rowMeans(select(., c("untagged_1", "untagged_2", "untagged_3")), na.rm = TRUE),
    CtrlLysoIP   = rowMeans(select(., c("CtrlLysoIP_1", "CtrlLysoIP_2", "CtrlLysoIP_3")), na.rm = TRUE),
    ASAH1LysoIP  = rowMeans(select(., c("ASAH1LysoIP_1", "ASAH1LysoIP_2", "ASAH1LysoIP_3")), na.rm = TRUE)
  ) %>%
  select(cluster, untagged, CtrlLysoIP, ASAH1LysoIP) %>%
  pivot_longer(cols = c("untagged", "CtrlLysoIP", "ASAH1LysoIP"),
               names_to = "Sample", values_to = "scaled_intensity") %>%
  filter(!is.na(cluster) & cluster != 0 & is.finite(scaled_intensity)) %>%
  mutate(cluster = factor(cluster),
         Sample = factor(Sample, levels = c("untagged", "CtrlLysoIP", "ASAH1LysoIP")))


# --- Step 3. Plot scaled violin plot
# Scaled violin plot
violin_scaled_plot <- ggplot(violin_df_lysoip_mean_scaled, aes(x = Sample, y = scaled_intensity, fill = Sample)) +
  geom_jitter(color = "red", size = 0.5, alpha = 0.2, width = 0.2) +
  geom_violin(scale = "width", trim = FALSE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  facet_wrap(~ cluster, scales = "free_y") +
  scale_fill_manual(values = c(
    "untagged"    = "#bdc9e1",
    "CtrlLysoIP"  = "#74a9cf",
    "ASAH1LysoIP" = "dodgerblue3"
  )) +
  theme_bw(base_size = 10) +
  theme(
    panel.grid = element_blank(),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "none") +
  labs(title = "LysoIP: Scaled Intensities by Sample per Cluster", x = NULL, y = "Scaled Intensity")



# --- Step 4. Save to PDF
ggsave(file.path(out_dir_lysoip_heatmap, "LysoIP_clusterViolinPlot_scaled.pdf"),
       violin_scaled_plot, width = 6, height = 6, device = cairo_pdf)



```


# IV. Violins of clusters of interest 
### IVa. Violin Plot of Cluster Abundance
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Violin Plot of Cluster Abundance
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Define sample columns
sample_cols_lysoip <- c(
"log2FC_CtrlLysoIP.untagged",
"log2FC_ASAH1LysoIP.untagged",
"log2FC_ASAH1LysoIP.CtrlLysoIP" 
)

# --- 2. Reshape and clean
violin_df_lysoip <- helalysoip_df %>%
  filter(!is.na(cluster) & cluster != 0) %>%
  pivot_longer(cols = all_of(sample_cols_lysoip), names_to = "Sample", values_to = "log2FC") %>%
  filter(!is.na(log2FC)) %>%
  mutate(cluster = factor(cluster),
         Sample = factor(Sample, levels = sample_cols_lysoip))  # enforce consistent order


# --- 3. Define plot
lysoip_clusterPlot <- ggplot(violin_df_lysoip, aes(x = Sample, y = log2FC, fill = Sample)) +
  geom_jitter(aes(color = "red"), size = 0.5, alpha = 0.2, width = 0.2, height = 0) +
  geom_violin(scale = "width", trim = FALSE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  facet_wrap(~ cluster, scales = "free_y") +
  scale_fill_manual(values = c(
    "log2FC_CtrlLysoIP.untagged"     = "#bdc9e1",
    "log2FC_ASAH1LysoIP.untagged"    = "#74a9cf",
    "log2FC_ASAH1LysoIP.CtrlLysoIP"  = "dodgerblue3"
  )) +
  theme_bw(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "none") +
  labs(title = "LysoIP: log2FC by Sample per Cluster", x = NULL, y = "log2FC")

# --- 4. Save to PDF
ggsave(file.path(out_dir_lysoip_heatmap, "LysoIP_clusterViolinPlot_log2FC.pdf"),
       lysoip_clusterPlot, width = 6, height = 6, device = cairo_pdf)

```


### IVb. Violin Plot of Ctrl vs ASAH1-/-
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Violin Plot of detailed endo annotations in ctrl vs ASAH1-/-
# ─────────────────────────────────────────────────────────────────────────────

## --- 1. Define organelle labels and order
organelles <- c("Lysosome","Endo_iN_curated_Hundley","Golgi","ER","Mito")
org_mapping <- tibble(
  Organelle = factor(organelles, levels = organelles),
  Org_Label = c("Lyso","Endo","Golgi","ER","Mito"),
  Org_Number = 1:5
)

# --- 2. Subset data for Ctrl and ASAH1 comparisons
df_det_ctrl <- helalysoip_annotated_df %>%
  filter(if_any(all_of(organelles), ~ .x)) %>%
  select(Gene.Symbol, all_of(organelles), log2FC_CtrlLysoIP.untagged) %>%
  pivot_longer(cols = all_of(organelles), names_to = "Organelle", values_to = "flag") %>%
  filter(flag) %>%
  mutate(Sample = "Ctrl vs Untagged", log2FC = log2FC_CtrlLysoIP.untagged)

df_det_asah1 <- helalysoip_annotated_df %>%
  filter(if_any(all_of(organelles), ~ .x)) %>%
  select(Gene.Symbol, all_of(organelles), log2FC_ASAH1LysoIP.untagged) %>%
  pivot_longer(cols = all_of(organelles), names_to = "Organelle", values_to = "flag") %>%
  filter(flag) %>%
  mutate(Sample = "ASAH1 vs Untagged", log2FC = log2FC_ASAH1LysoIP.untagged)

# --- 3. Combine and annotate
violin_det_df <- bind_rows(df_det_ctrl, df_det_asah1) %>%
  mutate(Sample = factor(Sample, levels = c("Ctrl vs Untagged","ASAH1 vs Untagged")),
         Organelle = factor(Organelle, levels = organelles)) %>%
  left_join(org_mapping, by = "Organelle")

# --- 4. Compute mean log2FC per annotation and sample, save CSV
mean_log2fc_det_df <- violin_det_df %>%
  group_by(Organelle, Org_Label, Sample) %>%
  summarise(mean_log2FC = round(mean(log2FC, na.rm = TRUE), 2), .groups = "drop")
write.csv(mean_log2fc_det_df, file.path(out_dir_lysoip_organelle_dist, "LysoIP_mean_log2FC_IVc.csv"), row.names = FALSE)

# --- 5. Plot
p_violin_det <- ggplot(violin_det_df, aes(x = interaction(Organelle, Sample), y = log2FC, fill = Sample)) +
  geom_violin(scale = "width", trim = FALSE, width = 0.9) +
  geom_jitter(width = 0.15, height = 0, size = 0.3, alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  scale_fill_manual(values = c("Ctrl vs Untagged" = "grey70", "ASAH1 vs Untagged" = "dodgerblue3")) +
  theme_bw(base_size = 6) +
  theme(panel.grid = element_blank(), axis.title.x = element_blank(), axis.text.x = element_text(angle = 90), legend.position = "none") +
  labs(y = expression(log[2]*"FC"), title = "Organelle Enrichment HeLa Ctrl vs ASAH1-/-")

# --- 6. Save
ggsave(file.path(out_dir_lysoip_organelle_dist, "LysoIP_OrganelleEnrichment_ViolinCombo_IVc.pdf"), p_violin_det, width = 3, height = 5, device = cairo_pdf)



```


### IVc. Violin Plot of select annotations in ctrl vs ASAH1-/-
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Violin Plot of select annotations in ctrl vs ASAH1-/-
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Define setup
organelles <- c("Lysosome","EarlyEndosome","Endo_iN_curated_Hundley","Golgi","RecyclingEndosome","ER","Mito")

org_mapping_detailed <- tibble(
  Organelle = factor(organelles, levels = organelles),
  Org_Label = c("Lysosome","EarlyEndosome","Endo_iN_curated_Hundley","Golgi","RecyclingEndosome","ER","Mito"),
  Org_Number = 1:7
)

org_labels <- org_mapping_detailed$Org_Label
org_order  <- org_mapping_detailed$Org_Number

# --- 2. Create data subset for both comparisons
df_ctrl <- helalysoip_annotated_df %>%
  filter(if_any(all_of(organelles), ~ .x)) %>%
  select(Gene.Symbol, all_of(organelles), log2FC_CtrlLysoIP.untagged) %>%
  pivot_longer(cols = all_of(organelles), names_to = "Organelle", values_to = "flag") %>%
  filter(flag) %>%
  mutate(Sample = "Ctrl vs Untagged", log2FC = log2FC_CtrlLysoIP.untagged)

df_asah1 <- helalysoip_annotated_df %>%
  filter(if_any(all_of(organelles), ~ .x)) %>%
  select(Gene.Symbol, all_of(organelles), log2FC_ASAH1LysoIP.untagged) %>%
  pivot_longer(cols = all_of(organelles), names_to = "Organelle", values_to = "flag") %>%
  filter(flag) %>%
  mutate(Sample = "ASAH1 vs Untagged", log2FC = log2FC_ASAH1LysoIP.untagged)

# --- 3. Combine dataframes and annotate
violin_df <- bind_rows(df_ctrl, df_asah1) %>%
  mutate(Sample = factor(Sample, levels = c("Ctrl vs Untagged","ASAH1 vs Untagged")),
         Organelle = factor(Organelle, levels = organelles)) %>%
  left_join(org_mapping_detailed, by = "Organelle")

# --- 4. Compute mean log2FC per annotation and sample → save CSV
mean_log2fc_df <- violin_df %>%
  group_by(Organelle, Org_Label, Sample) %>%
  summarise(mean_log2FC = round(mean(log2FC, na.rm = TRUE), 2), .groups = "drop")

write.csv(mean_log2fc_df,file.path(out_dir_lysoip_organelle_dist, "LysoIP_detailedEndo_mean_log2FC.csv"),row.names = FALSE)

# --- 5. Plot
n_slots <- length(organelles) * 2
xs <- seq_len(n_slots)

p_violin <- ggplot(violin_df, aes(x = interaction(Organelle, Sample), y = log2FC, fill = Sample)) +
  geom_violin(scale = "width", trim = FALSE, width = 0.9) +
  geom_boxplot(width = 0.2, fill = "white", outlier.shape = NA, color = "black", linewidth = 0.3) +
  geom_jitter(width = 0.15, height = 0, size = 0.3, alpha = 0.2) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  scale_fill_manual(values = c("Ctrl vs Untagged" = "grey70", "ASAH1 vs Untagged" = "dodgerblue3")) +
  scale_x_discrete(labels = setNames(
    rep(org_labels, times = 2),
    interaction(rep(org_mapping_detailed$Organelle, times = 2),
                rep(c("Ctrl vs Untagged","ASAH1 vs Untagged"), each = length(organelles)))
  )) +
  theme_bw(base_size = 10) +
  theme(panel.grid = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 0),
        legend.position = "none") +
  labs(y = expression(log[2]*"FC"), title = "Organelle Enrichment HeLa Ctrl vs ASAH1-/-") +
  annotate("text", x = xs, y = -4.5, label = rep(org_order, times = 2),
           color = rep(c("darkorange","firebrick"), each = length(organelles)), size = 3) +
  annotate("text", x = mean(1:length(organelles)), y = -5.2, label = "Ctrl vs Untagged", size = 3.2) +
  annotate("text", x = mean((length(organelles)+1):n_slots), y = -5.2, label = "ASAH1 vs Untagged", size = 3.2)

# --- 6. Save
ggsave(file.path(out_dir_lysoip_organelle_dist, "LysoIP_OrganelleEnrichment_detailed_ViolinCombo.pdf"), p_violin, width = 5, height = 5, device = cairo_pdf)


```


### IVd. Co-purification / co-enrichment relative to lysosome mean per genotype
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Co-purification / co-enrichment relative to lysosome mean per genotype
# ─────────────────────────────────────────────────────────────────────────────

# --- 0. Define organelle annotations to evaluate (must be logical columns in helalysoip_annotated_df)
organelle_coenrich <- c("Lysosome", "Endo_iN_curated_Hundley", "Golgi", "ER", "Mito",
                        "EarlyEndosome", "RecyclingEndosome")
organelle_coenrich <- organelle_coenrich[organelle_coenrich %in% names(helalysoip_annotated_df)]

# --- 1. Helper to compute lysosome mean and co-enrichment flags for one genotype
compute_coenrichment_one <- function(df_in, sample_col, sample_label) {
  stopifnot(sample_col %in% names(df_in))
  # lysosome mean for this genotype
  lysosome_mean <- df_in %>%
    filter(Lysosome == TRUE) %>%
    pull(all_of(sample_col)) %>%
    { mean(., na.rm = TRUE) }

  # gene-level long df of organelle memberships
  long_membership <- df_in %>%
    select(Gene.Symbol, all_of(sample_col), all_of(organelle_coenrich)) %>%
    pivot_longer(cols = all_of(organelle_coenrich),
                 names_to = "Organelle", values_to = "flag") %>%
    filter(flag) %>%
    mutate(Sample = sample_label,
           log2FC_value = .data[[sample_col]],
           lysosome_mean = lysosome_mean,
           sig_coenriched = is.finite(log2FC_value) & (log2FC_value >= lysosome_mean)) %>%
    select(Gene.Symbol, Sample, Organelle, log2FC_value, lysosome_mean, sig_coenriched)

  return(long_membership)
}

# --- 2. Run for Ctrl vs Untagged and ASAH1 vs Untagged
coenrich_ctrl_df <- compute_coenrichment_one(
  df_in = helalysoip_annotated_df,
  sample_col = "log2FC_CtrlLysoIP.untagged",
  sample_label = "Ctrl vs Untagged"
)

coenrich_asah1_df <- compute_coenrichment_one(
  df_in = helalysoip_annotated_df,
  sample_col = "log2FC_ASAH1LysoIP.untagged",
  sample_label = "ASAH1 vs Untagged"
)

coenrich_genelevel_df <- bind_rows(coenrich_ctrl_df, coenrich_asah1_df)

# --- 3. Write protein-level CSV
write.csv(coenrich_genelevel_df,
          file = file.path(out_dir_lysoip_organelle_dist, "LysoIP_coenrichment_genelevel.csv"),
          row.names = FALSE)

# --- 4. Summarize counts per annotation and genotype
coenrich_summary_df <- coenrich_genelevel_df %>%
  group_by(Organelle, Sample) %>%
  summarise(
    n_organelle_genes = n(),
    n_sig_coenriched = sum(sig_coenriched, na.rm = TRUE),
    frac_sig_coenriched = ifelse(n_organelle_genes > 0, n_sig_coenriched / n_organelle_genes, NA_real_),
    lysosome_mean_ref = unique(lysosome_mean),
    .groups = "drop"
  ) %>%
  arrange(Organelle, Sample)

# --- 5. Determine organelle order (ascending by total sig across genotypes)
totals_order <- coenrich_summary_df %>%
  group_by(Organelle) %>%
  summarise(total_sig = sum(n_sig_coenriched, na.rm = TRUE), .groups = "drop") %>%
  arrange(total_sig)
organelle_order <- totals_order$Organelle

# --- 6. Write summary CSV
genes_per_group_df <- coenrich_genelevel_df %>%
  filter(sig_coenriched) %>%
  group_by(Organelle, Sample) %>%
  summarise(genes_sig_coenriched = paste(sort(unique(as.character(Gene.Symbol))), collapse = ";"), .groups = "drop")

coenrich_summary_df <- coenrich_summary_df %>%
  left_join(genes_per_group_df, by = c("Organelle","Sample")) %>%
  mutate(genes_sig_coenriched = replace_na(genes_sig_coenriched, "")) %>%
  mutate(Organelle = factor(Organelle, levels = organelle_order)) %>%
  arrange(Organelle, Sample)

write.csv(coenrich_summary_df, file.path(out_dir_lysoip_organelle_dist, "LysoIP_coenrichment_summary.csv"), row.names = FALSE)

# --- 7. Stacked bar plot: counts of sig. co-enriched per annotation
coenrich_bar_plot <- ggplot(coenrich_summary_df, aes(x = n_sig_coenriched, y = Organelle, fill = Sample)) +
  geom_col(width = 0.8, color = "black", linewidth = 0.1) +
  geom_text(aes(label = ifelse(n_sig_coenriched > 0, n_sig_coenriched, "")), position = position_stack(vjust = 0.5), size = 2.8) +
  scale_fill_manual(values = c("Ctrl vs Untagged" = "grey70", "ASAH1 vs Untagged" = "dodgerblue3")) +
  labs(x = NULL, y = "# sig. co-enriched (log2FC ≥ mean Lyso)", title = "Co-enrichment relative to Lysosome mean (per genotype)") +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(), 
    axis.text.x = element_text(angle = 45, hjust = 1), 
    legend.title = element_blank())


# --- 8. Save plot as PDF 
ggsave(file.path(out_dir_lysoip_organelle_dist, "LysoIP_coenrichment_stackedbar_vertical_sorted_labeled.pdf"), coenrich_bar_plot, width = 6, height = 4, device = cairo_pdf)



```


### IVe. Overlap of sig co-enriched IDs across annotations + Venns
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Overlap of sig co-enriched IDs across annotations + Venns
# ─────────────────────────────────────────────────────────────────────────────

# --- 1.  Targets (exclude Lysosome itself)
venn_ann6 <- c("Endo_iN_curated_Hundley","Golgi","ER","Mito","EarlyEndosome","RecyclingEndosome")

# --- 2. Sets of sig_coenriched genes per genotype (coerce to character)
get_sig_sets <- function(genelevel_df, sample_label, ann_vec) {
  genelevel_df %>%
    filter(Sample == sample_label, sig_coenriched, Organelle %in% ann_vec) %>%
    group_by(Organelle) %>%
    summarise(Genes = list(unique(as.character(Gene.Symbol))), .groups = "drop") %>%
    { setNames(.$Genes, .$Organelle) }
}

ctrl_sets  <- get_sig_sets(coenrich_genelevel_df, "Ctrl vs Untagged",  venn_ann6)
asah1_sets <- get_sig_sets(coenrich_genelevel_df, "ASAH1 vs Untagged", venn_ann6)

# --- 3. Helpers: size filter, sanitize, Venn
min_size <- 5

filter_by_size <- function(setlist, k = min_size) {
  if (is.null(setlist)) return(list())
  keep <- vapply(setlist, function(v) length(unique(as.character(v))) >= k, logical(1))
  setlist[keep]
}

sanitize_sets <- function(setlist) {
  if (is.null(setlist)) return(list())
  setlist <- lapply(setlist, function(v) unique(as.character(v[!is.na(v) & nzchar(v)])))
  setlist[vapply(setlist, length, integer(1)) > 0]
}

plot_venn <- function(setlist, fname, width = 16, height = 14, label_size_pt = 6) {
  setlist <- sanitize_sets(setlist)
  if (length(setlist) < 2) return(invisible(NULL))
  p <- ggVennDiagram::ggVennDiagram(setlist, show_intersect = FALSE, set_color = "black", set_size = NA,
                                    label = "both", label_alpha = 0, label_geom = "label",
                                    label_color = "black", label_size = label_size_pt,
                                    edge_lty = "solid", edge_size = 0) +
       scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") + theme_void()
  ggsave(file.path(out_dir_lysoip_venn_coenrichment, fname), p, width = width, height = height, units = "cm", dpi = 600, device = cairo_pdf)
}

# --- 4. Apply size filter per genotype
ctrl_sets5  <- filter_by_size(ctrl_sets,  min_size)
asah1_sets5 <- filter_by_size(asah1_sets, min_size)

# Log which annotations passed size filter
write.csv(tibble(Genotype = "Ctrl", Annotation = names(ctrl_sets5), n = vapply(ctrl_sets5, length, 1L)), file.path(out_dir_lysoip_venn_coenrichment, "kept_annotations_CTRL_min5.csv"), row.names = FALSE)
write.csv(tibble(Genotype = "ASAH1", Annotation = names(asah1_sets5), n = vapply(asah1_sets5, length, 1L)), file.path(out_dir_lysoip_venn_coenrichment, "kept_annotations_ASAH1_min5.csv"), row.names = FALSE)


# --- 5. Per-annotation Ctrl vs ASAH1 overlap (requires ≥5 on both sides)
anns_to_compare <- intersect(names(ctrl_sets5), names(asah1_sets5))
if (length(anns_to_compare) > 0) {
  per_ann_summary <- purrr::map_dfr(anns_to_compare, function(an) {
    ctrl_vec  <- unique(as.character(ctrl_sets5[[an]]))
    asah1_vec <- unique(as.character(asah1_sets5[[an]]))
    shared    <- intersect(ctrl_vec, asah1_vec)
    union_set <- union(ctrl_vec, asah1_vec)
    jacc      <- ifelse(length(union_set) > 0, length(shared) / length(union_set), NA_real_)
    base      <- gsub("[^A-Za-z0-9]+","_", an)

    # save gene lists overlap and unique for each annotations 
    pad_to <- function(x, n) { c(x, rep(NA_character_, n - length(x))) }
      ctrl_only  <- sort(unique(setdiff(ctrl_vec, asah1_vec)))
      asah1_only <- sort(unique(setdiff(asah1_vec, ctrl_vec)))
      shared     <- sort(unique(intersect(ctrl_vec, asah1_vec)))
      
      # make one CSV per plot: ASAH1_unique, Shared, Control_unique
      nmax <- max(length(asah1_only), length(shared), length(ctrl_only))
      venn_table <- tibble(
        ASAH1_unique   = pad_to(asah1_only, nmax),
        Shared         = pad_to(shared,     nmax),
        Control_unique = pad_to(ctrl_only,  nmax)
      )
      
      csv_name <- paste0("Venn_", base, "_Ctrl_vs_ASAH1_min5.csv")
      write.csv(venn_table, file.path(out_dir_lysoip_venn_coenrichment, csv_name), row.names = FALSE)
    # Venn
    two_set <- list("Ctrl sig" = ctrl_vec, "ASAH1 sig" = asah1_vec)
    plot_venn(two_set, paste0("Venn_", base, "_Ctrl_vs_ASAH1_min5.pdf"), width = 12, height = 10)

    tibble(Annotation = an, n_ctrl = length(ctrl_vec), n_asah1 = length(asah1_vec), n_shared = length(shared), jaccard_ctrl_asah1 = jacc)
  })

  write.csv(per_ann_summary, file.path(out_dir_lysoip_venn_coenrichment, "per_annotation_Ctrl_vs_ASAH1_overlap_summary_min5.csv"), row.names = FALSE)
} else {
  message("No annotations with ≥", min_size, " sig IDs in both Ctrl and ASAH1.")
}
```



### IVf. GO enrichment of Endo annotations sig. Control
```{r}
# pick target annotations
target_ann <- c("Endo_iN_curated_Hundley","EarlyEndosome")

# helper: run topGO for a set of symbols
run_topGO <- function(sym_vec, universe_vec, ann_label, ont = c("BP","CC","MF"), min_genes = 10) {
  if (length(sym_vec) < min_genes) {
    message("Skip ", ann_label, ": n=", length(sym_vec), " < ", min_genes)
    return(invisible(NULL))
  }

  geneList <- factor(as.integer(universe_vec %in% sym_vec))
  names(geneList) <- universe_vec

  for (o in ont) {
    GOdata <- new("topGOdata",
                  ontology = o,
                  allGenes = geneList,
                  geneSel = function(x) x == 1,
                  annot = annFUN.org,
                  mapping = "org.Hs.eg.db",
                  ID = "symbol")

    resultFisher <- runTest(GOdata, algorithm = "classic", statistic = "fisher")

    go_table <- GenTable(GOdata, classicFisher = resultFisher, topNodes = 30)
    go_table <- go_table %>%
      mutate(raw_pval   = score(resultFisher)[GO.ID],
             log10P     = -log10(raw_pval),
             Significant = as.numeric(Significant),
             Expected    = as.numeric(Expected),
             Enrichment  = Significant / Expected) %>%
      filter(!is.na(raw_pval)) %>%
      arrange(raw_pval)

    # genes per term
    go_genes <- genesInTerm(GOdata)
    go_table$Genes <- sapply(go_table$GO.ID, function(go_id) {
      intersect(go_genes[[go_id]], sym_vec) %>% paste(collapse = ";")
    })

    # save
    clean_ann <- gsub("[^A-Za-z0-9]+","_", ann_label)
    write.csv(go_table, file.path(out_dir_lysoip_GOcoenrichment, paste0("GO_", o, "_CTRL_", clean_ann, ".csv")), row.names = FALSE)

    p <- ggplot(go_table[1:min(10,nrow(go_table)), ], aes(x = Enrichment, y = reorder(Term, Enrichment))) +
      geom_point(aes(size = log10P, fill = Enrichment), shape = 21, color = "black", stroke = 0.25) +
      scale_fill_gradient(low = "white", high = "firebrick") +
      theme_bw(base_size = 8) +
      labs(x = "Fold Enrichment", y = "GO Term", size = expression(-log[10]*"P"), title = paste0("GO-", o, " (Ctrl sig) — ", ann_label)) +
      theme(panel.grid = element_blank())
    ggsave(file.path(out_dir_lysoip_GOcoenrichment, paste0("GO_", o, "_CTRL_", clean_ann, ".pdf")), p, width = 5, height = 3.5, device = cairo_pdf)
  }
}

# --- extract universe (all genes across coenrich_summary_df)
universe_genes <- coenrich_summary_df %>%
  pull(genes_sig_coenriched) %>%
  str_split(";") %>%
  unlist() %>%
  unique()

# --- loop over target annotations
for (ann in target_ann) {
  ctrl_syms <- coenrich_summary_df %>%
    filter(Sample == "Ctrl vs Untagged", Organelle == ann) %>%
    pull(genes_sig_coenriched) %>%
    str_split(";") %>%
    unlist() %>%
    unique()

  run_topGO(ctrl_syms, universe_genes, ann)
}

```




# V. Focused lyso evaluations
### Va. Abundnance of lysosomal hydrolases
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Hydrolase abundance in lysosome Ctrl vs ASAH1-/-
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1: Prepare data for slope plot
hydro_df <- helalysoip_annotated_df %>%
  filter(LysoHydrolase == TRUE) %>%
  select(Gene.Symbol,
         Ctrl = log2FC_CtrlLysoIP.untagged,
         ASAH1 = log2FC_ASAH1LysoIP.untagged) %>%
  pivot_longer(cols = c("Ctrl", "ASAH1"), names_to = "Sample", values_to = "log2FC") %>%
  mutate(Gene.Symbol = factor(Gene.Symbol, levels = unique(Gene.Symbol)))  # maintain order

# Ensure factor levels enforce desired order
hydro_df <- hydro_df %>%
  mutate(Sample = factor(Sample, levels = c("Ctrl", "ASAH1")))

# --- Step 2: Plot slope plot
p_slope <- ggplot(hydro_df, aes(x = Sample, y = log2FC, group = Gene.Symbol)) +
  geom_line(color = "grey90", alpha = 0.8) +
  geom_point(size = 3, aes(fill = Sample), shape = 21, color = "black") +
  scale_fill_manual(values = c("Ctrl" = "grey70", "ASAH1" = "dodgerblue3")) +
  theme_bw(base_size = 6) +
  labs(x = NULL, y = expression(log[2]*"FC"),
       title = "Lysohydrolase Abundance in Ctrl vs ASAH1-/-") +
  theme(
    panel.grid = element_blank(),
    aspect.ratio = 1.75,
    legend.position = "none"
  )

# --- Step 3: Save as square PDF
ggsave(filename = file.path(out_dir_lysoip_organelle_dist,
                            "lysohydrolase_slopeplot.pdf"),
       plot = p_slope, width = 2, height = 4, device = cairo_pdf)



# ─────────────────────────────────────────────────────────────────────────────
# Hydrolase abundance in lysosome Ctrl vs ASAH1-/-
# heatmap 
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1: Prepare matrix for heatmap ---
heatmap_matrix_lysohydro <- helalysoip_annotated_df %>%
  filter(LysoHydrolase == TRUE) %>%
  select(Gene.Symbol,
         Ctrl = log2FC_CtrlLysoIP.untagged,
         ASAH1 = log2FC_ASAH1LysoIP.untagged) %>%
  column_to_rownames("Gene.Symbol") %>%
  as.matrix()

# --- Step 2: Plot heatmap ---
pdf(file = file.path(out_dir_lysoip_organelle_dist, "lysohydrolase_heatmap.pdf"),
    width = 2, height = 5, useDingbats = FALSE)

pheatmap(
  heatmap_matrix_lysohydro,
  color = colorRampPalette(c("dodgerblue3", "white", "firebrick"))(100),
  cluster_rows = FALSE,
  cluster_cols = FALSE,
  na_col = "grey70",
  cellheight = 15,
  cellwidth = 15,
  border_color = "black",
  lwd = 0.25,
  main = "Lysosomal Hydrolase log2FC (Ctrl vs ASAH1−/−)"
)
dev.off()

```


### Vb. Rainfallplots of ASAH1 vs Control LysoIP for select annotations 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Rainfall plot: ASAH1LysoIP vs CtrlLysoIP (highlight top 5 by log2FC)
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Define gene sets
vatpase_genes <- c(
  "ATP6V1A","ATP6V1B1","ATP6V1B2","ATP6V1C1","ATP6V1C2","ATP6V1D","ATP6V1E1","ATP6V1E2","ATP6V1F",
  "ATP6V1G1","ATP6V1G2","ATP6V1G3","ATP6V1H","ATP6V0A1","ATP6V0A2","ATP6V0A3","ATP6V0A4",
  "ATP6V0C","ATP6V0B","ATP6V0D1","ATP6V0D2","ATP6V0E1","ATP6V0E2","RNASEK",
  "ATP6AP1","ATP6AP2","DMXL1","DMXL2","WDR7","ROGDI", "PODXL"
)

lysohydrolases <- c(
  "ASAH1","GBA","ARSA","ARSB","GALNS","IDUA","GLA","NEU1","MAN2B1",
  "GLB1","HEXA","GNS","HEXB","CTSA","CTSZ","TPP1","NAGLU","CTSL",
  "CTSB","NAGA","LGMN"
)

# --- 2. Subset for lysosome / hydrolases / vATPase
rain_df <- helalysoip_annotated_df %>%
  filter(
    Gene.Symbol %in% vatpase_genes |
    Gene.Symbol %in% lysohydrolases |
    Lysosome == TRUE
  ) %>%
  mutate(
    y_group = case_when(
      Gene.Symbol %in% lysohydrolases ~ "Hydrolases",
      Gene.Symbol %in% vatpase_genes  ~ "vATPase",
      Lysosome == TRUE                ~ "Lysosome",
      TRUE ~ NA_character_
    ),
    log2fc = log2FC_ASAH1LysoIP.CtrlLysoIP
  ) %>%
  filter(!is.na(y_group), is.finite(log2fc)) %>%
  mutate(
    y_group = factor(y_group, levels = c("Lysosome","Hydrolases","vATPase"))
  )

# --- 3. Pick top 5 by absolute FC within each group
label_df <- rain_df %>%
  group_by(y_group) %>%
  slice_max(order_by = abs(log2fc), n = 5, with_ties = FALSE) %>%
  ungroup()

# --- 4. Plot
rainfall_plot <- ggplot(
  rain_df,
  aes(y = log2fc, x = y_group, fill = y_group)
) +
  gghalves::geom_half_point(
    side = "b",
    range_scale = 0.2,
    alpha = 0.2,
    size = 1,
    shape = 16
  ) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.5) +
  ggdist::stat_halfeye(
    adjust = 2,
    width = 0.6,
    .width = 0,
    justification = -0.2,
    point_colour = NA
  ) +
  geom_boxplot(width = 0.15, outlier.shape = NA) +
  geom_text_repel(
    data = label_df,
    aes(label = Gene.Symbol),
    position = position_nudge(x = -0.25),
    size = 2,
    min.segment.length = 0,
    max.overlaps = Inf,
    box.padding = 0.2,
    point.padding = 0.1,
    segment.size = 0.2
  ) +
  scale_fill_manual(values = c(
    "Lysosome"   = "grey70",
    "Hydrolases" = "firebrick",
    "vATPase"    = "dodgerblue3"
  )) +
  coord_flip() +
  theme_bw(base_size = 6) +
  labs(y = "log2FC ASAH1LysoIP vs CtrlLysoIP", x = NULL,
       title = "ASAH1 vs Ctrl: Lysosome / Hydrolases / vATPase") +
  theme(panel.grid = element_blank(), legend.position = "none")

# --- 4b. Ratio-of-ratios metric (Δlog2FC = ASAH1_vs_untagged − Ctrl_vs_untagged)
rain_df_ror <- helalysoip_annotated_df %>%
  filter(Gene.Symbol %in% vatpase_genes | Gene.Symbol %in% lysohydrolases | Lysosome == TRUE) %>%
  mutate(
    y_group = case_when(
      Gene.Symbol %in% lysohydrolases ~ "Hydrolases",
      Gene.Symbol %in% vatpase_genes  ~ "vATPase",
      Lysosome == TRUE                ~ "Lysosome",
      TRUE ~ NA_character_
    ),
    delta_log2fc = log2FC_ASAH1LysoIP.untagged - log2FC_CtrlLysoIP.untagged  # ratio-of-ratios on log2 scale
  ) %>%
  filter(!is.na(y_group), is.finite(delta_log2fc)) %>%
  mutate(y_group = factor(y_group, levels = c("Lysosome","Hydrolases","vATPase")))

# top 5 by |Δlog2FC| within each group
label_df_ror <- rain_df_ror %>%
  group_by(y_group) %>%
  slice_max(order_by = abs(delta_log2fc), n = 5, with_ties = FALSE) %>%
  ungroup()

# plot
rainfall_plot_ror <- ggplot(rain_df_ror, aes(y = delta_log2fc, x = y_group, fill = y_group)) +
  gghalves::geom_half_point(side = "b", range_scale = 0.2, alpha = 0.2, size = 1, shape = 16) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.5) +
  ggdist::stat_halfeye(adjust = 2, width = 0.6, .width = 0, justification = -0.2, point_colour = NA) +
  geom_boxplot(width = 0.15, outlier.shape = NA) +
  geom_text_repel(data = label_df_ror, aes(label = Gene.Symbol), position = position_nudge(x = -0.25),
                  size = 2, min.segment.length = 0, max.overlaps = Inf, box.padding = 0.2,
                  point.padding = 0.1, segment.size = 0.2) +
  scale_fill_manual(values = c("Lysosome" = "grey70", "Hydrolases" = "firebrick", "vATPase" = "dodgerblue3")) +
  coord_flip() +
  theme_bw(base_size = 6) +
  labs(y = expression(Delta~log[2]*"FC (ASAH1−Ctrl)"),
       x = NULL,
       title = "Ratio-of-ratios (Δlog2FC): ASAH1 vs Ctrl — Lysosome / Hydrolases / vATPase") +
  theme(panel.grid = element_blank(), legend.position = "none")


# --- 5. Save
ggsave(file.path(out_dir_lysoip_organelle_rainfall, "LysoIP_rainfall_RatioOfRatios_LysoHydroVATPase.pdf"), rainfall_plot_ror, width = 4, height = 2, device = cairo_pdf)
ggsave(filename = file.path(out_dir_lysoip_organelle_rainfall, "LysoIP_rainfall_ASAH1vsCtrl_LysoHydroVATPase.pdf"),plot = rainfall_plot, width = 4, height = 2, device = cairo_pdf)



```




# VI. Venn Diagramm of lyso, endo and iN-endo list to see overlap
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Venn for all proteins detected
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1: read in .csv file containing the genes which are sig down in proteomics
lysoIPvenn <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/EndoLysoIP_venn.csv', 
                   header=T, sep = ",", , stringsAsFactors = FALSE)


# --- Step 2: Venn of all three datasets #####
ggVennDiagram(
  lysoIPvenn,
  category.names = c("Lyso-enriched", "Endo-enriched", "iNendo-enriched"),
  show_intersect = FALSE,
  set_color = "black",
  set_size = NA,
  label = c("both"),
  label_alpha = 0,
  label_geom = c("label"),
  label_color = "black",
  label_size = NA,
  label_percent_digit = 0,
  label_txtWidth = 40,
  edge_lty = "solid",
  edge_size = 0,
) +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF")


# --- Step 3: Save Venn diagram as .pdf for further processing in illustrator for figures 
ggsave(file.path(out_dir_lysoip_venn,'EndoLysoVennDiagramm.pdf'), width =20, height = 20, units = "cm", dpi=600)



# ─────────────────────────────────────────────────────────────────────────────
# Venn of Lyso and iN endo list
# ─────────────────────────────────────────────────────────────────────────────
# --- Step 4: make subset of IP data to only contain lyso and Endocurated list 
lysoIPvenn_subest <- lysoIPvenn[,c("Lyso", "EndoCurated")]

ggVennDiagram(
  lysoIPvenn_subest,
  category.names = c("Lyso-enriched", "iNendo-enriched"),
  show_intersect = FALSE,
  set_color = "black",
  set_size = NA,
  label = c("both"),
  label_alpha = 0,
  label_geom = c("label"),
  label_color = "black",
  label_size = NA,
  label_percent_digit = 0,
  label_txtWidth = 40,
  edge_lty = "solid",
  edge_size = 0,
) +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  coord_flip() ## flip plot on side 


# --- Step 5: save Venn diagram as .pdf for further processing in illustrator for figures 
ggsave(file.path(out_dir_lysoip_venn, 'EndoCuratedLysoVennDiagramm.pdf'), width =27, height = 20, units = "cm", dpi=600)


# --- Step 6: Extract overlapping protein names #### 
## parse and save overlapping protein names that between the lists 
# Convert columns to sets (remove NA values)
lyso_set <- na.omit(lysoIPvenn$Lyso)
endosome_set <- na.omit(lysoIPvenn$Endosome)
endocurated_set <- na.omit(lysoIPvenn$EndoCurated)


# --- Step 7: Compute pairwise intersections
overlap_lyso_endosome <- intersect(lyso_set, endosome_set)
overlap_lyso_endocurated <- intersect(lyso_set, endocurated_set)
overlap_endosome_endocurated <- intersect(endosome_set, endocurated_set)

# --- Step 8: Save the results to CSV files
write.csv(data.frame(Overlap_Lyso_Endosome = overlap_lyso_endosome),
          '/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/Overlap_Lyso_Endosome.csv', row.names = FALSE)
write.csv(data.frame(Overlap_Lyso_EndoCurated = overlap_lyso_endocurated),
          '/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/Overlap_Lyso_EndoCurated.csv', row.names = FALSE)
write.csv(data.frame(Overlap_Endosome_EndoCurated = overlap_endosome_endocurated),
          '/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/Overlap_Endosome_EndoCurated.csv', row.names = FALSE)




# ─────────────────────────────────────────────────────────────────────────────
# Analysis for enriched protein (log2FC >0.5) in Ctrl over untagged
# ─────────────────────────────────────────────────────────────────────────────
# --- Step 9: Read in .csv file containing the genes which are sig down in proteomics
lysoIPvennCtrl <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/EndoLysoIP_vennCtrl.csv', 
                   header=T, sep = ",", , stringsAsFactors = FALSE)


# --- Step 10: Make subset of IP data to only contain lyso and Endocurated list & plot
lysoIPvennCtrl_subest <- lysoIPvennCtrl[,c("Lyso", "EndoCurated")]

ggVennDiagram(
  lysoIPvennCtrl_subest,
  category.names = c("Lyso-enriched", "iNendo-enriched"),
  show_intersect = FALSE,
  set_color = "black",
  set_size = NA,
  label = c("both"),
  label_alpha = 0,
  label_geom = c("label"),
  label_color = "black",
  label_size = NA,
  label_percent_digit = 0,
  label_txtWidth = 40,
  edge_lty = "solid",
  edge_size = 0,
) +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  coord_flip() ## flip plot on side 


# --- Step 11: Save Venn diagram as .pdf for further processing in illustrator for figures 
ggsave(file.path(out_dir_lysoip_venn,'EndoCuratedLysoVennDiagrammCtrl.pdf'), width =27, height = 20, units = "cm", dpi=600)


# --- Step 12: Ctrl over untagged: Extract overlapping protein names 
## parse and save overlapping protein names that between the lists 

# Convert columns to sets (remove NA values)
lyso_Ctrl_set <- na.omit(lysoIPvennCtrl$Lyso)
endosome_Ctrl_set <- na.omit(lysoIPvennCtrl$Endosome)
endocurated_Ctrl_set <- na.omit(lysoIPvennCtrl$EndoCurated)

# Compute pairwise intersections
overlap_Ctrl_lyso_endosome <- intersect(lyso_Ctrl_set, endosome_Ctrl_set)
overlap_Ctrl_lyso_endocurated <- intersect(lyso_Ctrl_set, endocurated_Ctrl_set)
overlap_Ctrl_endosome_endocurated <- intersect(endosome_Ctrl_set, endocurated_Ctrl_set)

# Save the results to CSV files
write.csv(data.frame(Overlap_Ctrl_Lyso_Endosome = overlap_Ctrl_lyso_endosome),file=file.path(out_dir_lysoip_venn,
          'Overlap_Ctrl_Lyso_Endosome.csv'), row.names = FALSE)
write.csv(data.frame(Overlap_Ctrl_Lyso_EndoCurated = overlap_Ctrl_lyso_endocurated),file=file.path(out_dir_lysoip_venn,
          'Overlap_Ctrl_Lyso_EndoCurated.csv'), row.names = FALSE)
write.csv(data.frame(Overlap_Ctrl_Endosome_EndoCurated = overlap_Ctrl_endosome_endocurated),file=file.path(out_dir_lysoip_venn,
          'Overlap_Ctrl_Endosome_EndoCurated.csv'), row.names = FALSE)





# ─────────────────────────────────────────────────────────────────────────────
# Analysis for enriched protein (log2FC >0.5) in ASAH1 over untagged 
# ─────────────────────────────────────────────────────────────────────────────
# --- Step 13: Read in .csv file containing the genes which are sig down in proteomics
lysoIPvennASAH1 <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20241119_HeLa_Ctrl-ASAH1_LysoIP/MSstats/OrganelleEval/EndoLysoIP_vennASAH1.csv', 
                   header=T, sep = ",", , stringsAsFactors = FALSE)


# --- Step 14: Make subset of IP data to only contain lyso and Endocurated list & plot
lysoIPvennASAH1_subest <- lysoIPvennASAH1[,c("Lyso", "EndoCurated")]

ggVennDiagram(
  lysoIPvennASAH1_subest,
  category.names = c("Lyso-enriched", "iNendo-enriched"),
  show_intersect = FALSE,
  set_color = "black",
  set_size = NA,
  label = c("both"),
  label_alpha = 0,
  label_geom = c("label"),
  label_color = "black",
  label_size = NA,
  label_percent_digit = 0,
  label_txtWidth = 40,
  edge_lty = "solid",
  edge_size = 0,
) +
  scale_fill_gradient(low = "#F4FAFE", high = "#4981BF") +
  coord_flip() ## flip plot on side 


# --- Step 15: Save Venn diagram as .pdf for further processing in illustrator for figures 
ggsave(file.path(out_dir_lysoip_venn,'EndoCuratedLysoVennDiagrammASAH1.pdf'), width =27, height = 20, units = "cm", dpi=600)


# --- Step 16: Ctrl over untagged: Extract overlapping protein names 
## parse and save overlapping protein names that between the lists 
# Convert columns to sets (remove NA values)
lyso_ASAH1_set <- na.omit(lysoIPvennASAH1$Lyso)
endosome_ASAH1_set <- na.omit(lysoIPvennASAH1$Endosome)
endocurated_ASAH1_set <- na.omit(lysoIPvennASAH1$EndoCurated)

# Compute pairwise intersections
overlap_ASAH1_lyso_endosome <- intersect(lyso_ASAH1_set, endosome_ASAH1_set)
overlap_ASAH1_lyso_endocurated <- intersect(lyso_ASAH1_set, endocurated_ASAH1_set)
overlap_ASAH1_endosome_endocurated <- intersect(endosome_ASAH1_set, endocurated_ASAH1_set)

# Save the results to CSV files
write.csv(data.frame(Overlap_ASAH1_Lyso_Endosome = overlap_ASAH1_lyso_endosome),file=file.path(out_dir_lysoip_venn,
          'Overlap_ASAH1_Lyso_Endosome.csv'), row.names = FALSE)
write.csv(data.frame(Overlap_ASAH1_Lyso_EndoCurated = overlap_ASAH1_lyso_endocurated),file=file.path(out_dir_lysoip_venn,
          '/Overlap_ASAH1_Lyso_EndoCurated.csv'), row.names = FALSE)
write.csv(data.frame(Overlap_ASAH1_Endosome_EndoCurated = overlap_ASAH1_endosome_endocurated),file=file.path(out_dir_lysoip_venn,
          'Overlap_ASAH1_Endosome_EndoCurated.csv'), row.names = FALSE)



```


## VII. Autophagy investigation in more detail
```{r}
# --- 0.  define annotation lists:
autophagy_receptors <- c(
  "AMBRA1", "BCL2L13", "BECN1", "BNIP3L", "CALCOCO2", "CCPG1", "CDK5RAP3", "FUNDC1", 
  "LGALS3", "LGALS8", "NBR1", "NCOA4", "NLRX1", "OPTN", "RETREG1", "SQSTM1", 
  "STBD1", "TAX1BP1", "TEX264", "TOLLIP", "TRIM5"
)
autophagy_core <- c(
  "ATG12", "ATG13", "ATG14", "ATG16L1", "ATG3", "ATG4A", "ATG4B", "ATG4C", "ATG5", 
  "ATG7", "ATG9A", "GABARAP", "GABARAPL2", "MAP1LC3A", "MAP1LC3B", "MTOR", "PIK3C3", 
  "PIK3R4", "PLEKHM1", "RAB5A", "RAB7A", "RB1CC1", "RUBCN", "STX17", "ULK1", 
  "ULK2", "UVRAG", "WDR45", "WDR45B", "WIPI1", "WIPI2", "ZFYVE1"
)
golgi_trans <- c(
  "PACS1", "VPS45", "VPS41", "GGA3", "ARFIP2", "GGA1", "GOLPH3L", "GOPC", 
  "AP4M1", "GGA2", "OSBPL11", "GOLGA1", "FAM91A1", "C17orf75", "OSBPL9", "GOLGA4", 
  "VPS51", "TBC1D23", "VPS52", "CCDC91", "ARFIP1", "AP4B1", "AP4E1", "IMPAD1"
)
golgi_trans <- c(
  "PACS1", "VPS45", "VPS41", "GGA3", "ARFIP2", "GGA1", "GOLPH3L", "GOPC", 
  "AP4M1", "GGA2", "OSBPL11", "GOLGA1", "FAM91A1", "C17orf75", "OSBPL9", "GOLGA4", 
  "VPS51", "TBC1D23", "VPS52", "CCDC91", "ARFIP1", "AP4B1", "AP4E1", "IMPAD1"
)

golgi_cis <- c(
  "TMED10", "TRAPPC3", "TMED1", "TRAPPC10", "COPG2", "TRAPPC5", "COPB1", "COPB2", 
  "GOLM1", "COPG1", "B3GAT3", "TRAPPC11", "TRAPPC6B", "TMED2", "GOSR2", "TRAPPC8", 
  "TRAPPC4", "GBF1", "TMED5", "TMED9", "GOLGA5", "SEB22B", "NUCB1", "GOLGA2"
)
ergic <- c(
  "TMED10", "TMED1", "ATP6AP1", "RAB1B", "RAB2A", "TAOK2", "NXF1", "TMEM181", 
  "STX16", "RAB2B", "RAB6B", "USP46", "SURF4", "GLE1", "GORASP1", "LMAN2L", 
  "ECPAS", "TMED2", "UGGT1", "TRAPPC12", "DNM2", "SEH1L", "MARCKS", "GBF1", "RDX", 
  "BCAP31", "DST", "ERGIC3", "TMED9", "LMAN1", "SEB22B", "LMAN2", "STX5"
)

annotation_lists <- list(
  autophagy_receptors = autophagy_receptors,
  autophagy_core = autophagy_core,
  golgi_trans = golgi_trans,
  golgi_cis = golgi_cis,
  ergic = ergic,
  ER = helalysoip_annotated_df %>% filter(ER) %>% pull(Gene.Symbol)  # if ER is already a logical column
)


# --- 1. Annotate dataframe
annot_df <- helalysoip_annotated_df %>%
  select(Gene.Symbol, sig_ASAH1LysoIP.CtrlLysoIP) %>%
  mutate(across(Gene.Symbol, as.character)) %>%
  mutate(across(Gene.Symbol, make.unique))  # in case of duplicate gene names

for (ann in names(annotation_lists)) {
  annot_df[[ann]] <- annot_df$Gene.Symbol %in% annotation_lists[[ann]]
}

# --- 2. Reshape to long format and filter sig hits
sig_hits_df <- annot_df %>%
  pivot_longer(cols = names(annotation_lists), names_to = "Annotation", values_to = "flag") %>%
  filter(flag) %>%
  rename(SigStatus = sig_ASAH1LysoIP.CtrlLysoIP) %>%
  filter(SigStatus %in% c("up", "down"))

# --- 3. Count hits
sig_summary_autophagy <- sig_hits_df %>%
  dplyr::count(.data$Annotation, .data$SigStatus) %>%
  mutate(Comparison = "ASAH1LysoIP vs CtrlLysoIP")

# --- 4. Get gene lists per annotation and direction
sig_genes_autophagy <- sig_hits_df %>%
  filter(SigStatus %in% c("up", "down")) %>%
  group_by(Annotation, SigStatus) %>%
  summarize(Genes = paste(Gene.Symbol, collapse = "; "), .groups = "drop")

# --- 5. Plot
sig_plot_autophagy <- ggplot(sig_summary_autophagy,
                             aes(x = reorder(Annotation, n), y = n, fill = SigStatus)) +
  geom_col(position = "stack") +
  coord_flip() +
  facet_wrap(~ Comparison, ncol = 1) +
  scale_fill_manual(values = c(up = "grey70", down = "dodgerblue3")) +
  labs(x = NULL, y = "# Significant Hits", title = "Significant Hits – ASAH1LysoIP vs CtrlLysoIP") +
  theme_bw(base_size = 8) +
  theme(panel.grid = element_blank())


# --- 6. Save plot and table
ggsave(file.path(out_dir_lysoip_autophagy, "sig_hits_ASAH1LysoIP_barplot.pdf"),
       sig_plot_autophagy, width = 5, height = 4, device = cairo_pdf)

# --- 7. Save gene-level summary for ASAH1LysoIP vs CtrlLysoIP
sig_gene_summary_autophagy <- sig_hits_df %>%
  mutate(
    Type = "SigHits",  # Optional, for consistency
    Comparison = "ASAH1LysoIP vs CtrlLysoIP"
  ) %>%
  group_by(Type, Comparison, Annotation, SigStatus) %>%
  summarise(
    n = n(),
    GeneList = paste(unique(Gene.Symbol), collapse = ";"),
    .groups = "drop"
  )

write.csv(sig_gene_summary_autophagy,file = file.path(out_dir_lysoip_autophagy, "sig_hits_annotation_geneList.csv"),row.names = FALSE)
write_csv(sig_summary_autophagy, file.path(out_dir_lysoip_autophagy, "sig_hits_autophagy_summary.csv"))


```



## VIII. GO term analysis of LysoIP data (based on clusters)
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# GO Term Analysis for LysoIP Clusters (ASAH1 vs Ctrl)
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1. Define function for GO Term analysis 
plot_topGO_for_geneset <- function(gene_set, background_genes, tag = "clusterX", out_dir) {
  # library(topGO)
  # library(org.Hs.eg.db)
  # library(tidyverse)

  # Step 1: Create geneList for topGO
  geneList <- factor(as.integer(background_genes %in% gene_set))
  names(geneList) <- background_genes

  # Step 2: Run topGO Fisher test (BP)
  GOdata <- new("topGOdata",
                ontology = "BP",
                allGenes = geneList,
                geneSel = function(x) x == 1,
                annot = annFUN.org,
                mapping = "org.Hs.eg.db",
                ID = "symbol")

  resultFisher <- runTest(GOdata, algorithm = "classic", statistic = "fisher")

  # Step 3: Generate GO table and extract raw p-values
  # calculate 30 top hits, but only plot top 10 
  go_table <- GenTable(GOdata, classicFisher = resultFisher, topNodes = 30)

  go_table <- go_table %>%
    mutate(
      raw_pval     = score(resultFisher)[GO.ID],
      Significant  = as.numeric(Significant),
      Expected     = as.numeric(Expected),
      Enrichment   = Significant / Expected,
      log10P       = -log10(raw_pval)
    ) %>%
    filter(!is.na(raw_pval)) %>%
    arrange(raw_pval) %>%
    slice_head(n = 10)

  # Step 4: Get associated genes per GO term
  go_genes <- genesInTerm(GOdata)
  go_table$Genes <- sapply(go_table$GO.ID, function(go_id) {
    intersect(go_genes[[go_id]], gene_set) %>% paste(collapse = ";")
  })

  # Step 5: Save GO term table + gene associations
  write_csv(go_table, file = file.path(out_dir, paste0("GO_results_", tag, ".csv")))

  # Step 6: Plot dot plot
  p <- ggplot(go_table, aes(x = Enrichment, y = reorder(Term, Enrichment))) +
    geom_point(aes(size = log10P, fill = Enrichment), shape = 21, color = "black", stroke = 0.25) +
    scale_fill_gradient(low = "white", high = "firebrick") +
    theme_bw(base_size = 8) +
    labs(
      x = "Fold Enrichment",
      y = "GO Term",
      size = expression(-log[10]*"P"),
      title = paste0("Top GO Terms (", tag, ")")
    ) +
    theme(panel.grid = element_blank())

  ggsave(file.path(out_dir, paste0("GO_dotplot_", tag, ".pdf")), p, width = 5, height = 3.5, device = cairo_pdf)

  return(p)
}



# --- Step 2: Define target gene sets based on cluster assignment
genes_lysoip_cluster_up <- helalysoip_annotated_df %>%
  filter(cluster %in% c(1)) %>%
  #filter(cluster %in% c(3, 5)) %>%
  pull(Gene.Symbol) %>%
  unique()

# --- Step 3: Define background gene set
background_genes_lysoip <- helalysoip_annotated_df %>%
  pull(Gene.Symbol) %>%
  unique()

# --- Step 4: Run GO Term analysis & plotting
plot_topGO_for_geneset(
  gene_set = genes_lysoip_cluster_up,
  background_genes = background_genes_lysoip,
  tag = "LysoIP_cluster1",
  out_dir = out_dir_lysoip_GO
)

```
