---
title: "diff118_iNiDA_d23_CtrlSMPD1ASAH1"
output: html_document
date: "2024-10-10"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# load packackes & set project directory
```{r}
# --- Load Required Libraries ---
# --- Core Tidyverse ---
library(tidyverse)     # includes dplyr, ggplot2, tidyr, purrr, tibble, readr, stringr, etc.

# --- Plotting Enhancements ---
library(ggplot2)
library(ggdist)        # stat_halfeye
library(gghalves)      # geom_half_point
library(ggrepel)       # text labels (if used)
library(pheatmap)      # for heatmaps
library(RColorBrewer)  # custom color scales
library(viridis)       # color scales (optional)
library(NatParksPalettes)
library(scales) 
library(ggrepel)

# --- Plot Layouts ---
library(gridExtra)     # arranging plots
library(cowplot)       # aligning and combining plots
library(patchwork)     # alternate plot composition syntax


# --- Data Reshaping and Manipulation ---
library(reshape2)      # melt, dcast (legacy but used in some places)
library(forcats)       # factor reordering
library(data.table)    # fast table handling (if used)

library(lintr)
library(devtools)



# --- GO Term analysis ---
BiocManager::install("topGO")
library(topGO)
BiocManager::install("org.Hs.eg.db")
library(org.Hs.eg.db)


```


# output dirs overview:
```{r}
out_dir_diff118_dataframes <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20240801_dif118_iN-iDA_Ctrl-SMPD1-ASAH1_Proteomics/Eval/dataframes"
dir.create(out_dir_diff118_dataframes, recursive = TRUE, showWarnings = FALSE)

out_dir_diff118_heatmap  <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20240801_dif118_iN-iDA_Ctrl-SMPD1-ASAH1_Proteomics/Eval/heatmaps"
dir.create(out_dir_diff118_heatmap, recursive = TRUE, showWarnings = FALSE)

out_dir_diff118_corrplots <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20240801_dif118_iN-iDA_Ctrl-SMPD1-ASAH1_Proteomics/Eval/Organelle_CrossCorr"
dir.create(out_dir_diff118_corrplots, recursive = TRUE, showWarnings = FALSE)

out_dir_diff118_scatterplots <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20240801_dif118_iN-iDA_Ctrl-SMPD1-ASAH1_Proteomics/Eval/Scatterplots"
dir.create(out_dir_diff118_scatterplots, recursive = TRUE, showWarnings = FALSE)

out_dir_diff118_bar <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20240801_dif118_iN-iDA_Ctrl-SMPD1-ASAH1_Proteomics/Eval/barplots"
dir.create(out_dir_diff118_bar, recursive = TRUE, showWarnings = FALSE)

out_dir_diff118_violin <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20240801_dif118_iN-iDA_Ctrl-SMPD1-ASAH1_Proteomics/Eval/violins"
dir.create(out_dir_diff118_violin, recursive = TRUE, showWarnings = FALSE)

out_dir_diff118_GO <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20240801_dif118_iN-iDA_Ctrl-SMPD1-ASAH1_Proteomics/Eval/GO"
dir.create(out_dir_diff118_GO, recursive = TRUE, showWarnings = FALSE)


```



# I. Background diff 136 axonal proteome Ctrl / ASAH1 e1 day 35 iN differentiation 
Dataset contains in vitro differentiaed iNeurons and iDA at day 23 of differentiation
Genotypes: H9 NGN2 TMEM192-3xHA (het) Control and ASAH1-/- clone E1 and SMPD1-/- clone E8

Samples (all in triplicates, all whole-cell (WC): Ctrl iN, Ctrl iDA, ASAH1 iN, ASAH1 iDA, SMPD1 iN, SMPD1 iDA
18plex_TMTpro & run on Thermo Orbitrap Eclipse w/FAIMS-Pro, hrMS2
data was created with MSstats, has p/q.values and log2FC for samples 
k-means clustering was performed on data, is in column "cluster"



# II. read in data & add protein organelle annotations 

```{r}
# ─────────────────────────────────────────────────────────────────────────────
# 1.  read the data  
# ─────────────────────────────────────────────────────────────────────────────

diff118_df <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20240801_dif118_iN-iDA_Ctrl-SMPD1-ASAH1_Proteomics/Eval/diff118_All_results_stats_localizationAdded.csv', header=T, sep=',', stringsAsFactors = FALSE)


# ─────────────────────────────────────────────────────────────────────────────
# 2.  Transform p/q-values to -log10, and filter non-finite log2FCs
# ─────────────────────────────────────────────────────────────────────────────

log2fc_cols <- c(
"log2FC_Ctrl_d23_iDA.Ctrl_d23_iN",
"log2FC_SMPD1_d23_iN.Ctrl_d23_iN",
"log2FC_SMPD1_d23_iDA.Ctrl_d23_iN",
"log2FC_ASAH1_d23_iN.Ctrl_d23_iN",
"log2FC_ASAH1_d23_iDA.Ctrl_d23_iN",
"log2FC_SMPD1_d23_iN.Ctrl_d23_iDA",
"log2FC_SMPD1_d23_iDA.Ctrl_d23_iDA",
"log2FC_ASAH1_d23_iN.Ctrl_d23_iDA",
"log2FC_ASAH1_d23_iDA.Ctrl_d23_iDA",
"log2FC_SMPD1_d23_iDA.SMPD1_d23_iN",
"log2FC_ASAH1_d23_iN.SMPD1_d23_iN",
"log2FC_ASAH1_d23_iDA.SMPD1_d23_iN",
"log2FC_ASAH1_d23_iN.SMPD1_d23_iDA",
"log2FC_ASAH1_d23_iDA.SMPD1_d23_iDA",
"log2FC_ASAH1_d23_iDA.ASAH1_d23_iN" 
)

# transform p / q values into -log10 values 
diff118_df <- diff118_df %>%
  mutate(across(contains("p.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}"),
         across(contains("q.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}")) %>%
  filter(if_all(all_of(log2fc_cols), ~ is.finite(.)))

# ─────────────────────────────────────────────────────────────────────────────
# 3.  Add Subcellular Annotation
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1: Define contaminant list (optional, can be skipped if not relevant)
contaminant_genes <- c(
  "KRT8", "KRT19", "KRT9", "KRT10", "KRT2", "KRT18", "KRT1", "KRT5",
  "COL10A1", "COL13A1", "COL14A1", "COL18A1", "COL1A1", "COL1A2",
  "COL26A1", "COL2A1", "COL4A1", "COL4A2", "COL5A1", "COL6A1", "COL6A2"
)

# --- Step 2: Load and process subcellular annotation
cols_to_read <- c(1,2,3,4,5,6,7,9,10,12,15,16,17,18,19,20,21,22,23,25,26,27,28,29,30,31,32)
subcell_df <- read_csv("/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/neuroLSDgit/proteome/SubCellAnnotation.csv", show_col_types = FALSE)[, cols_to_read]
subcell_df[] <- lapply(subcell_df, as.character)

long_subcell_df <- subcell_df %>%
  pivot_longer(cols = everything(), names_to = "Localization", values_to = "Genes") %>%
  filter(!is.na(Genes) & Genes != "") %>%
  mutate(Genes = trimws(Genes)) %>%
  distinct()

diff118_df_binary_matrix <- long_subcell_df %>%
  mutate(value = TRUE) %>%
  pivot_wider(
    names_from = Localization,
    values_from = value,
    values_fill = list(value = FALSE)
  )

# --- Step 3: Merge with diff136_df by Gene.Symbol
diff118_df_annotated <- diff118_df %>%
  filter(!Gene.Symbol %in% contaminant_genes) %>%
  left_join(diff118_df_binary_matrix, by = c("Gene.Symbol" = "Genes"))

diff118_df_annotated <- diff118_df_annotated %>%
  mutate(across(where(is.logical) | where(is.numeric), ~ replace_na(., 0)))

# --- Step 4. save as csv file 
write.csv(diff118_df_annotated, 
          file = file.path(out_dir_diff118_dataframes,"diff118_iN-iDA_d23_Ctrl-ASAH1-SMPD1_wholecellproteome_annotated.csv"), row.names = FALSE)
```


### IIa. Heatmap (z-norm rows, cluster by cluster)
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Heatmap (z-norm rows, cluster by cluster)
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. set annotations and sample names 
expr_cols <- c(
  "Ctrl_d23_iN_1", "Ctrl_d23_iN_2","Ctrl_d23_iN_3",
  "Ctrl_d23_iDA_1","Ctrl_d23_iDA_2","Ctrl_d23_iDA_3",
  "SMPD1_d23_iN_1","SMPD1_d23_iN_2","SMPD1_d23_iN_3",
  "SMPD1_d23_iDA_1","SMPD1_d23_iDA_2","SMPD1_d23_iDA_3",                          
  "ASAH1_d23_iN_1","ASAH1_d23_iN_2","ASAH1_d23_iN_3",
  "ASAH1_d23_iDA_1","ASAH1_d23_iDA_2","ASAH1_d23_iDA_3"
)

# Matrix from expression columns
mat <- diff118_df %>%
  filter(!is.na(Gene.Symbol)) %>%
  mutate(Gene.Symbol = make.unique(as.character(Gene.Symbol))) %>%
  select(Gene.Symbol, cluster, all_of(expr_cols))

# Store and remove cluster for sorting
row_cluster <- mat$cluster
rownames(mat) <- mat$Gene.Symbol
mat <- mat[, expr_cols]

# Reorder rows by cluster
mat <- mat[order(row_cluster), , drop = FALSE]


# --- 2. set cluster colors and cluster annotations as rows
# Define full cluster levels explicitly
cluster_levels <- 0:8

# Force 'cluster' to be a factor with all levels, even if not present
row_annotattions_diff118 <- data.frame(
  cluster = factor(row_cluster[order(row_cluster)], levels = cluster_levels)
)
rownames(row_annotattions_diff118) <- rownames(mat)

# Assign distinct colors
cluster_palette <- setNames(
  RColorBrewer::brewer.pal(9, "Pastel1"),
  as.character(cluster_levels)
)

# Add to annotation color list
ann_colors <- list(
  Genotype = c(Ctrl = "grey40", ASAH1 = "dodgerblue3", SMPD1 = "tomato3"),
  Neuron = c(`iN` = "#f1eef6",
               iDA  = "#74a9cf")
)

ann_colors$cluster <- cluster_palette


# --- 3. column annotations
annotation_dif118_col <- tibble(Sample = expr_cols) %>%
  mutate(
    Genotype = case_when(
      str_detect(Sample, "^Ctrl")   ~ "Ctrl",
      str_detect(Sample, "^ASAH1")  ~ "ASAH1",
      str_detect(Sample, "^SMPD1")  ~ "SMPD1",
      TRUE                          ~ NA_character_
    ),
    Neuron = case_when(
      str_detect(Sample, "_iN_")    ~ "iN",
      str_detect(Sample, "_iDA_")   ~ "iDA",
      TRUE                          ~ NA_character_
    )
  ) %>%
  column_to_rownames("Sample")


# --- 4. plot heatmap, save as pdf and store underlying dataframe as csv 
pdf_file <- file.path(out_dir_diff118_heatmap, "diff118_iN-iDAd35_Ctrl-ASAH1-SMPD1_heatmap.pdf")
cairo_pdf(pdf_file, width = 9, height = 10)

pheatmap(
  mat,
  scale              = "row",
  color              = colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(100),
  annotation_col     = annotation_dif118_col,
  annotation_row     = row_annotattions_diff118,
  annotation_colors  = ann_colors,
  breaks             = seq(-4, 4, length.out = 101),
  cluster_rows       = FALSE,
  cluster_cols       = TRUE,
  show_rownames      = FALSE,
  show_colnames      = TRUE,
  angle_col          = 90,
  main               = "diff118 day 23 iN & iDA whole cell proteome: Ctrl, ASAH1, SMPD1",
  fontsize           = 6,
  border_color       = NA
)

dev.off()

# Add cluster as first column to expression matrix
mat_with_cluster <- cbind(cluster = row_annotattions_diff118$cluster, mat)

# Write to CSV with cluster
write.csv(mat_with_cluster,
          file = file.path(out_dir_diff118_heatmap,"diff118_iN-iDAd35_Ctrl-ASAH1-SMPD1_heatmap.csv"),
          row.names = TRUE)
```


### IIb. Heatmap KO/Ctrl (still keep z-norm rows, cluster by cluster)
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Heatmap (z-norm rows, cluster by cluster)
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. set annotations and sample names 
expr_cols <- c(
"log2FC_SMPD1_d23_iN.Ctrl_d23_iN","log2FC_ASAH1_d23_iN.Ctrl_d23_iN",
"log2FC_ASAH1_d23_iDA.Ctrl_d23_iDA","log2FC_SMPD1_d23_iDA.Ctrl_d23_iDA"                
)

# Matrix from expression columns
mat_norm <- diff118_df %>%
  filter(!is.na(Gene.Symbol)) %>%
  mutate(Gene.Symbol = make.unique(as.character(Gene.Symbol))) %>%
  select(Gene.Symbol, cluster, all_of(expr_cols))

# Store and remove cluster for sorting
row_cluster <- mat_norm$cluster
rownames(mat_norm) <- mat_norm$Gene.Symbol
mat_norm <- mat_norm[, expr_cols]

# Reorder rows by cluster
mat_norm <- mat_norm[order(row_cluster), , drop = FALSE]


# --- 2. set cluster colors and cluster annotations as rows
# Define full cluster levels explicitly
cluster_levels <- 0:8

# Force 'cluster' to be a factor with all levels, even if not present
row_annotattions_diff118 <- data.frame(
  cluster = factor(row_cluster[order(row_cluster)], levels = cluster_levels)
)
rownames(row_annotattions_diff118) <- rownames(mat)

# Assign distinct colors
cluster_palette <- setNames(
  RColorBrewer::brewer.pal(9, "Pastel1"),
  as.character(cluster_levels)
)

# Add to annotation color list
ann_colors <- list(
  Genotype = c(Ctrl = "grey40", ASAH1 = "dodgerblue3", SMPD1 = "tomato3"),
  Neuron = c(`iN` = "#f1eef6",
               iDA  = "#74a9cf")
)

ann_colors$cluster <- cluster_palette


# --- 3. column annotations
annotation_dif118_col <- tibble(Sample = expr_cols) %>%
  mutate(
    Genotype = case_when(
      str_detect(Sample, "^Ctrl")   ~ "Ctrl",
      str_detect(Sample, "^ASAH1")  ~ "ASAH1",
      str_detect(Sample, "^SMPD1")  ~ "SMPD1",
      TRUE                          ~ NA_character_
    ),
    Neuron = case_when(
      str_detect(Sample, "_iN_")    ~ "iN",
      str_detect(Sample, "_iDA_")   ~ "iDA",
      TRUE                          ~ NA_character_
    )
  ) %>%
  column_to_rownames("Sample")


# --- 4. plot heatmap, save as pdf and store underlying dataframe as csv 
pdf_file <- file.path(out_dir_diff118_heatmap, "diff118_iN-iDAd35_ASAH1-SMPD1_normCtrl_heatmap.pdf")
cairo_pdf(pdf_file, width = 1.5, height = 5)

pheatmap(
  mat_norm,
  scale              = "row",
  color              = colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(100),
  annotation_col     = annotation_dif118_col,
  annotation_row     = row_annotattions_diff118,
  annotation_colors  = ann_colors,
  breaks             = seq(-2, 2, length.out = 101),
  cluster_rows       = FALSE,
  cluster_cols       = TRUE,
  show_rownames      = FALSE,
  show_colnames      = TRUE,
  angle_col          = 90,
  main               = "diff118 day 23 iN & iDA whole cell proteome: ASAH1/Ctrl, SMPD1/Ctrl",
  fontsize           = 6,
  border_color       = NA
)

dev.off()

# Add cluster as first column to expression matrix
mat_with_cluster <- cbind(cluster = row_annotattions_diff118$cluster, mat)

# Write to CSV with cluster
write.csv(mat_with_cluster,
          file = file.path(out_dir_diff118_heatmap,"diff118_iN-iDAd35_ASAH1-SMPD1_normCtrl_heatmap.pdf"),
          row.names = TRUE)
```


### IIc. Correlation of Selected Annotations
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Correlation of Selected Annotations
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Copy out log2FC & annotated columns for wrangling
# Define log2FC columns (all that start with log2FC_)
log2fc_diff118_cols <- grep("^log2FC_", colnames(diff118_df_annotated), value = TRUE)

# Define annotation columns (binary organelle terms)
# assumes binary 0/1 format and not part of log2FC set
annotation_corr_cols <- setdiff(colnames(diff118_df_annotated), log2fc_diff118_cols)
annotation_corr_cols <- annotation_corr_cols[sapply(diff118_df_annotated[, annotation_corr_cols], function(x) all(x %in% c(0, 1, NA)))]

# Drop unwanted ones
annotation_corr_cols <- setdiff(annotation_corr_cols, c("Autophagy_det", "EndoDetailLoac"))

length(log2fc_diff118_cols)  # sanity check
length(annotation_corr_cols)



# --- 2. Compute Spearman correlation between log2FC and annotations
org_diff118_corr_df <- map_dfr(annotation_corr_cols, function(ann) {
  map_dfr(log2fc_diff118_cols, function(fc_col) {
    x <- diff118_df_annotated[[fc_col]]
    y <- as.numeric(diff118_df_annotated[[ann]])
    keep <- is.finite(x) & is.finite(y)
    if (sum(keep) < 5) return(NULL)

    cor_test <- suppressWarnings(cor.test(x[keep], y[keep], method = "spearman"))
    tibble(
      log2FC_Column = fc_col,
      Organelle     = ann,
      r             = unname(cor_test$estimate),
      p             = cor_test$p.value
    )
  })
})



# --- 3. Summary heatmap (log2FC × Organelle)
org_diff118_corr_mat <- org_diff118_corr_df %>%
  select(log2FC_Column, Organelle, r) %>%
  pivot_wider(names_from = Organelle, values_from = r) %>%
  column_to_rownames("log2FC_Column") %>%
  as.matrix()

# Extract rownames from org_diff118_corr_mat (log2FC columns)
annotation_row <- tibble(Sample = rownames(org_diff118_corr_mat)) %>%
  mutate(
    Genotype = case_when(
      str_detect(Sample, "Ctrl")   ~ "Ctrl",
      str_detect(Sample, "ASAH1")  ~ "ASAH1",
      str_detect(Sample, "SMPD1")  ~ "SMPD1",
      TRUE                         ~ NA_character_
    ),
    Neuron = case_when(
      str_detect(Sample, "iN")  ~ "iN",
      str_detect(Sample, "iDA") ~ "iDA",
      TRUE                      ~ NA_character_
    )
  ) %>%
  column_to_rownames("Sample")

ann_colors_118 <- list(
  Genotype = c(Ctrl = "grey40", ASAH1 = "dodgerblue3", SMPD1 = "tomato3"),
  Neuron = c(iN = "#f1eef6", iDA = "#74a9cf")
)


# Replace NA with 0 (or leave NA if you prefer gaps)
org_diff118_corr_mat[is.na(org_diff118_corr_mat)] <- 0

diff118_iNiDACorr <- pheatmap(org_diff118_corr_mat,
         color = rev(RColorBrewer::brewer.pal(11, "RdYlBu")),
         annotation_row = annotation_row,                
         annotation_colors = ann_colors_118,                
         na_col = "grey90",
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         fontsize = 8,
         cellheight = 10,
         cellwidth = 10,
         border_color = NA, 
         main = "log2FC × Organelle Correlation")

diff118_iNiDACorr



# --- 4. Save heatmap as PDF and csv file 
pdf(file.path(out_dir_diff118_corrplots, "axonprotCorr.pdf"),
    width = 12, height = 16, useDingbats = FALSE)
print(diff118_iNiDACorr)
dev.off()

 write.csv(org_diff118_corr_mat,
          file = file.path(out_dir_diff118_corrplots, "axonprotCorr.csv"),
          row.names = TRUE)



# --- 5. Faceted correlation plots (per-organelle, KO×KO)
# Function to plot KO×KO correlation for a given annotation
plot_ko_corr_matrix <- function(organelle_name, df = diff118_df_annotated) {
  gene_filter <- df[[organelle_name]] == 1
  mat <- df[gene_filter, log2fc_diff118_cols, drop = FALSE]

  if (nrow(mat) < 5) return(NULL)

  corr_mat <- cor(mat, use = "pairwise.complete.obs", method = "spearman")

  pheatmap(
    corr_mat,
    main = organelle_name,
    color = rev(brewer.pal(11, "RdYlBu")),
    silent = TRUE,
    cellheight = 15,
    cellwidth  = 15,
    na_col = "grey90",
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    border_color = NA,
    fontsize = 6
  )
}



# --- 6. Apply to all annotations
heatmap_list <- lapply(annotation_corr_cols, function(org) {
  if (!org %in% colnames(diff118_df_annotated)) return(NULL)
  plot_ko_corr_matrix(org)
})
heatmap_list <- Filter(Negate(is.null), heatmap_list)



# --- 7. Save all in a faceted PDF
# Select how many per row
plots_per_row <- 5
n_plots <- length(heatmap_list)
n_rows <- ceiling(n_plots / plots_per_row)

# Extract gtables
grob_list <- lapply(heatmap_list, function(p) p$gtable)

# Save all plots on a single PDF page
pdf(file.path(out_dir_diff118_corrplots, "diff118_log2FC_annotation_corr_grid.pdf"),
    width = 45, height = 45, useDingbats = FALSE)

do.call(gridExtra::grid.arrange, c(grob_list, nrow = n_rows))

dev.off()



```

### III. Scatterplots of selected annotations 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Scatterplot of Selected Annotations
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Define x and y variable names
x_vars <- c(
  "log2FC_ASAH1_d23_iN.Ctrl_d23_iN",
  "log2FC_ASAH1_d23_iDA.Ctrl_d23_iDA",
  "log2FC_SMPD1_d23_iN.Ctrl_d23_iN",
  "log2FC_SMPD1_d23_iDA.Ctrl_d23_iDA"
)

y_vars <- c(
  "neg_log10_q.val_ASAH1_d23_iN.Ctrl_d23_iN",
  "neg_log10_q.val_ASAH1_d23_iDA.Ctrl_d23_iDA",
  "neg_log10_q.val_SMPD1_d23_iN.Ctrl_d23_iN",
  "neg_log10_q.val_SMPD1_d23_iDA.Ctrl_d23_iDA"
)

sig_vars <- c(
  "sig_ASAH1_d23_iN.Ctrl_d23_iN",
  "sig_ASAH1_d23_iDA.Ctrl_d23_iDA",
  "sig_SMPD1_d23_iN.Ctrl_d23_iN",
  "sig_SMPD1_d23_iDA.Ctrl_d23_iDA"
)

# --- 2. Annotation list (customize here)
annotation_list_scatter <- c("SynapseSVs")
annotation_list_scatter <- c("SVfusion","Svendocytosis","Svexocytosis")
annotation_list_scatter <- c("SynGO")
annotation_list_scatter <- c("EndoLyso","EarlyEndosome","RecyclingEndosome")

# Annotations:
# "Mito","Mito-IMS","Mito-Matrix","Mito-MIM","Mito-MOM","OXPHOS","mtComplexI","Golgi","Lysosome"               ,"ER","Cytoplasm","Nucleus","Autophagy","Autophagy_det","SynGO","Endo_iN_curated_Hundley" "SynapseSVs","Presynaptic","Postsynaptic","EndoDetailLoac","NeuroDev","EndoLyso","EarlyEndosome","RecyclingEndosome","SVfusion","Svendocytosis","Svexocytosis"    

# --- 3. Function to generate scatter plots
plot_diff_scatter <- function(df, annotation_list_scatter, x_vars, y_vars, sig_vars, out_dir) {
  stopifnot(length(x_vars) == length(y_vars), length(x_vars) == length(sig_vars))

  sig_color_map <- c("up" = "tomato", "down" = "dodgerblue3", "n.s." = "grey70")

  for (i in seq_along(x_vars)) {
    x_col <- x_vars[i]
    y_col <- y_vars[i]
    sig_col <- sig_vars[i]

    for (ann in annotation_list_scatter) {
      gene_set <- df %>%
        filter(.data[[ann]] == 1, is.finite(.data[[x_col]]), is.finite(.data[[y_col]])) %>%
        mutate(annotation = ann)

      if (nrow(gene_set) < 3) next
    
      # select top genes for labeling 
      top_genes <- gene_set %>%
        slice_max(order_by = .data[[y_col]], n = 25)
      
      # plot scatterplot
      p <- ggplot(gene_set, aes_string(x = x_col, y = y_col, color = sig_col, label = "Gene.Symbol")) +
        geom_point(alpha = 0.6, size = 1) +
        scale_color_manual(values = sig_color_map) +
        geom_text_repel(
            data = top_genes,
            size = 2,
            max.overlaps = Inf,
            box.padding = 0.3,
            segment.color = "grey60"
          ) +
        theme_bw(base_size = 6) +
        theme(
          panel.grid = element_blank(),
          legend.position = "bottom") +
        labs(
          title = paste("Scatterplot:", ann),
          x = x_col,
          y = y_col
        ) +
        geom_vline(xintercept = 0, linetype = "dashed", color = "grey40", linewidth = 0.3) +
        geom_hline(yintercept = 0, linetype = "dashed", color = "grey40", linewidth = 0.3)

      ggsave(
        filename = file.path(out_dir, paste0("scatter_", ann, "_", gsub("\\.", "_", x_col), ".pdf")),
        plot = p,
        width = 4, height = 4, device = cairo_pdf
      )
    }
  }
}

# --- 4. Call function 
plot_diff_scatter(diff118_df_annotated, annotation_list_scatter, x_vars, y_vars, sig_vars, out_dir_diff118_scatterplots)


```



##### IIIa. Scatterplots of select clusters 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Scatterplot of Selected clusters 
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Define function for scatter plots based on cluster 
plot_diff_scatter_by_cluster <- function(df, cluster_list, x_vars, y_vars, sig_vars, out_dir) {
  stopifnot(length(x_vars) == length(y_vars), length(x_vars) == length(sig_vars))
  
  sig_color_map <- c("up" = "tomato", "down" = "dodgerblue3", "n.s." = "grey70")

  for (i in seq_along(x_vars)) {
    x_col <- x_vars[i]
    y_col <- y_vars[i]
    sig_col <- sig_vars[i]

    for (cl in cluster_list) {
      gene_set <- df %>%
        filter(cluster == cl, is.finite(.data[[x_col]]), is.finite(.data[[y_col]])) %>%
        mutate(Cluster = paste0("Cluster_", cl))

      if (nrow(gene_set) < 3) next
      
      top_genes <- gene_set %>%
        slice_max(order_by = .data[[y_col]], n = 25)

      p <- ggplot(gene_set, aes_string(x = x_col, y = y_col, color = sig_col, label = "Gene.Symbol")) +
        geom_point(alpha = 0.6, size = 1) +
        scale_color_manual(values = sig_color_map) +
        geom_text_repel(
          data = top_genes,
          size = 2,
          max.overlaps = Inf,
          box.padding = 0.3,
          segment.color = "grey60"
        ) +
        theme_bw(base_size = 6) +
        theme(
          panel.grid = element_blank(),
          legend.position = "bottom"
        ) +
        labs(
          title = paste("Scatterplot: Cluster", cl),
          x = x_col,
          y = y_col
        ) +
        geom_vline(xintercept = 0, linetype = "dashed", color = "grey40", linewidth = 0.3) +
        geom_hline(yintercept = 0, linetype = "dashed", color = "grey40", linewidth = 0.3)

      ggsave(
        filename = file.path(out_dir, paste0("scatter_cluster", cl, "_", gsub("\\.", "_", x_col), ".pdf")),
        plot = p,
        width = 4, height = 4, device = cairo_pdf
      )
    }
  }
}


# --- 2. call function to plot clusters of interest
cluster_list <- c(4,6)
plot_diff_scatter_by_cluster(diff118_df_annotated, cluster_list, x_vars, y_vars, sig_vars, out_dir_diff118_scatterplots)

```

### IV. Barplots of sig. up / down proteins per annotations (used defined)
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# barplots of mean(log2FC) of each organelle annotations for select samples
# selected annotations  
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Define color mapping for barplot
sig_color_map_bar <- c("up" = "grey70", "down" = "dodgerblue3")

# --- 2. Define filtered annotation set (exclude "Nucleus")
filtered_annotations <- setdiff(annotation_corr_cols, "Nucleus")


# --- 3. Count hits and extract gene names
count_sig_hits_with_genes <- function(df, annotation_cols, sig_vars) {
  purrr::map_dfr(annotation_cols, function(ann) {
    purrr::map_dfr(sig_vars, function(sig_col) {
      subset <- df[df[[ann]] == 1 & !is.na(df[[sig_col]]), ]
      purrr::map_dfr(c("up", "down"), function(sig_class) {
        genes <- subset$Gene.Symbol[subset[[sig_col]] == sig_class]
        tibble(
          Annotation = ann,
          Comparison = sig_col,
          SigClass = sig_class,
          Count = length(genes),
          Genes = paste(genes, collapse = ";")
        )
      })
    })
  })
}


# --- 4. Run function
sig_counts_long <- count_sig_hits_with_genes(diff118_df_annotated, filtered_annotations, sig_vars)

# --- 5. Save CSV with gene lists
write.csv(sig_counts_long,
          file = file.path(out_dir_diff118_bar, "sig_counts_per_annotation_with_genes.csv"),
          row.names = FALSE)

# --- 6. Order and plot
sig_barplot <- sig_counts_long %>%
  group_by(Annotation) %>%
  mutate(total = sum(Count)) %>%
  ungroup() %>%
  mutate(Annotation = fct_reorder(Annotation, total)) %>%
  ggplot(aes(x = Annotation, y = Count, fill = SigClass)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = sig_color_map_bar) +
  facet_wrap(~ Comparison, scales = "free_x") +
  coord_flip() +
  theme_bw(base_size = 8) +
  theme(
    panel.grid = element_blank(),
    strip.background = element_rect(fill = "grey90"),
    legend.position = "bottom"
  ) +
  labs(
    title = "Significant hits per annotation (excluding Nucleus)",
    y = "# of proteins",
    x = NULL,
    fill = "Significance"
  )

# --- 7. Save as PDF
ggsave(
  file.path(out_dir_diff118_bar, "sig_counts_per_annotation.pdf"),
  plot = sig_barplot,
  width = 8,
  height = 10,
  device = cairo_pdf
)




```



### V. Violinplots of selected clusters 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Violin Plot of Cluster Abundance
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. define & select sample labels for plotting  
sample_cols_diff118_violin <- c(
  "log2FC_ASAH1_d23_iN.Ctrl_d23_iN",
  "log2FC_ASAH1_d23_iDA.Ctrl_d23_iDA",
  "log2FC_SMPD1_d23_iN.Ctrl_d23_iN",
  "log2FC_SMPD1_d23_iDA.Ctrl_d23_iDA"
)


# --- 2. Drop cluster 0 and NA
violin_diff118_df <- diff118_df_annotated %>%
  filter(!is.na(cluster) & cluster != 0) %>%
  pivot_longer(cols = all_of(sample_cols_diff118_violin), names_to = "Sample", values_to = "log2FC") %>%
  filter(!is.na(log2FC))

# --- 3. Consistent y-axis scale
y_limits <- range(violin_diff118_df$log2FC, na.rm = TRUE)

# --- 4. plot facet wrap
diff118_clusterPlot <- ggplot(violin_diff118_df, aes(x = Sample, y = log2FC, fill = Sample)) +
  geom_jitter(
    aes(color = "red"), size = 0.5, alpha = 0.2, width = 0.2, height = 0
  ) +
  geom_violin(scale = "width", trim = FALSE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  # facet_wrap(~ cluster, scales = "fixed") +
  #   coord_cartesian(ylim = c(-2, 2)) +
  facet_wrap(~ cluster, scales = "free_y") +
  scale_fill_manual(values = c(
    "log2FC_ASAH1_d23_iN.Ctrl_d23_iN" = "#f1eef6",
    "log2FC_ASAH1_d23_iDA.Ctrl_d23_iDA" = "#bdc9e1",
    "log2FC_SMPD1_d23_iN.Ctrl_d23_iN" = "#74a9cf",
    "log2FC_SMPD1_d23_iDA.Ctrl_d23_iDA" = "dodgerblue3"
  )) +
  theme_bw(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "none", 
        panel.grid = element_blank()
        ) +
  labs(title = "log2FC by Sample per Cluster", x = NULL, y = "log2FC")

diff118_clusterPlot

# --- 5. save plot as PDF
ggsave(file.path(out_dir_diff118_violin, 
  "diff118_clusterPlot.pdf"), 
  diff118_clusterPlot, width = 6, height = 6, device = cairo_pdf)
```



## VI. GO analysis of clusters of interest 
https://bioconductor.org/packages/release/bioc/vignettes/topGO/inst/doc/topGO.pdf


```{r}
# ─────────────────────────────────────────────────────────────────────────────
# GO term analysis based on clusters 
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1. Define function for GO Term analysis 
plot_topGO_for_geneset <- function(gene_set, background_genes, tag = "clusterX", out_dir) {
  library(topGO)
  library(org.Hs.eg.db)
  library(tidyverse)

  # Step 1: Create geneList for topGO
  geneList <- factor(as.integer(background_genes %in% gene_set))
  names(geneList) <- background_genes

  # Step 2: Run topGO Fisher test (BP)
  GOdata <- new("topGOdata",
                ontology = "BP",
                allGenes = geneList,
                geneSel = function(x) x == 1,
                annot = annFUN.org,
                mapping = "org.Hs.eg.db",
                ID = "symbol")

  resultFisher <- runTest(GOdata, algorithm = "classic", statistic = "fisher")

  # Step 3: Generate GO table and extract raw p-values
  # calculate 30 top hits, but only plot top 10 
  go_table <- GenTable(GOdata, classicFisher = resultFisher, topNodes = 30)

  go_table <- go_table %>%
    mutate(
      raw_pval     = score(resultFisher)[GO.ID],
      Significant  = as.numeric(Significant),
      Expected     = as.numeric(Expected),
      Enrichment   = Significant / Expected,
      log10P       = -log10(raw_pval)
    ) %>%
    filter(!is.na(raw_pval)) %>%
    arrange(raw_pval) %>%
    slice_head(n = 10)

  # Step 4: Get associated genes per GO term
  go_genes <- genesInTerm(GOdata)
  go_table$Genes <- sapply(go_table$GO.ID, function(go_id) {
    intersect(go_genes[[go_id]], gene_set) %>% paste(collapse = ";")
  })

  # Step 5: Save GO term table + gene associations
  write_csv(go_table, file = file.path(out_dir, paste0("GO_results_", tag, ".csv")))

  # Step 6: Plot dot plot
  p <- ggplot(go_table, aes(x = Enrichment, y = reorder(Term, Enrichment))) +
    geom_point(aes(size = log10P, fill = Enrichment), shape = 21, color = "black", stroke = 0.25) +
    scale_fill_gradient(low = "white", high = "firebrick") +
    theme_bw(base_size = 8) +
    labs(
      x = "Fold Enrichment",
      y = "GO Term",
      size = expression(-log[10]*"P"),
      title = paste0("Top GO Terms (", tag, ")")
    ) +
    theme(panel.grid = element_blank())

  ggsave(file.path(out_dir, paste0("GO_dotplot_", tag, ".pdf")), p, width = 5, height = 3.5, device = cairo_pdf)

  return(p)
}



# --- Step 2. Define input clusters to analyse & background genes 
# Input: cluster genes
genes_asah1_up <- diff118_df_annotated %>%
  filter(cluster %in% c(4,6)) %>%
  #filter(cluster %in% c(3,7)) %>%
  pull(Gene.Symbol) %>%
  unique()

# Background genes
background_genes <- unique(diff118_df_annotated$Gene.Symbol)



# --- Step 3. Run function 
# Run function
plot_topGO_for_geneset(
  gene_set = genes_asah1_up,
  background_genes = background_genes,
  tag = "ASAH1_cluster4_6",
  out_dir = out_dir_diff118_GO
)



```






