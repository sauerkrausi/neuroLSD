---
title: "diff136_iNd35_ctrl_asah1e1_axonalproteome"
output: html_document
date: "`r Sys.Date()`"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# load packackes & set project directory
```{r}
out_dir <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv"

#install.packages("GWalkR")
library(GWalkR)
#install.packages("gptstudio")
library(gptstudio)
library(plyr)
library(grid)
library(stringr)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tibble)
library(purrr)
library(rlang)
library(devtools)
#install_github("vqv/ggbiplot")
library(ggbiplot)
library(ggrepel)
library(scales)
library(cowplot)
library(NatParksPalettes)
library(viridis)
library(RColorBrewer)
library(gridExtra)
library(ggplot2)
##install("gplots")
library(gplots)
library(ggVennDiagram)
#library(dendextend)
#install.packages("magick")
#library(magick)
library(png)
#devtools::install_github("rlbarter/superheat")
library(superheat)
install.packages("fmsb")
library(fmsb)
#devtools::install_github("krassowski/complex-upset")
library(ComplexUpset)
#install.packages("UpSetR")
library(UpSetR)
library(data.table)
library(plotly)
library(gghighlight)
#devtools::install_github("jbengler/tidyplots")
library(tidyplots)
library(tidyverse)
library(tidyr)
#install.packages("pheatmap")
library(pheatmap)
#install.packages("RColorBrewer")
library(patchwork)

# For the CRAN version
#install.packages("bigstatsr")
# For the latest version
#remotes::install_github("privefl/bigstatsr")
library(bigstatsr)
library(irlba)
library(lintr)

```


# I. Background diff 136 axonal proteome Ctrl / ASAH1 e1 day 35 iN differentiation 
Dataset contains in vitro differentiaed iNeurons at day 35 of differentiation
Genotypes: Control and ASAH1-/- clone E1
Samples (all in triplicates): whole-cell (WC), soma fraction and axonal fraction 
18plex_TMTpro & run on Thermo Orbitrap Ascent w/FAIMS-Pro, hrMS2
data was created with MSstats, has p/q.values and log2FC for samples 
k-means clustering was performed on data, is in column "cluster"


TO DO:
- add annottaion from subcell.csv to dataframe
- plot facets based on that 
- plot PCA of data and save as PDF
- plot heatmap of data, rows z-scoare using pheatmap & clustering. plot violins plot of abuncance of each sample per genotype of each cluster 
- have cluster information already in csv file, so can use that for clustering?
- correlation of RoR of axon-soma & axon-WC for ctrl vs asah1 


# II. read in data & add protein organelle annotations
- facet wrap by annotations & save 
```{r}
library(tidyverse)      # dplyr ‑ tidyr ‑ ggplot2
library(ggpmisc)        # stat_cor (optional)
library(Cairo)          # cairo_pdf device (if you want PDF output)
library(plotly)
library(dplyr)
library(stringr)
library(pheatmap)
library(scales)
library(tidyr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(readr)
library(tibble)
library(dplyr)


# ─────────────────────────────────────────────────────────────────────────────
# 1.  read the data  
# ─────────────────────────────────────────────────────────────────────────────

diff136_df <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/diff136_iNd35_Ctrl-ASAH1e1_axonalproteome_All_results_stats_localizationAdded.csv', header=T)


# ─────────────────────────────────────────────────────────────────────────────
# 2.  Transform p/q-values to -log10
# ─────────────────────────────────────────────────────────────────────────────

diff136_df <- diff136_df %>%
  mutate(across(contains("p.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}"),
         across(contains("q.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}"))


# ─────────────────────────────────────────────────────────────────────────────
# 3.  Add Subcellular Annotation
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1: Define contaminant list (optional, can be skipped if not relevant)
contaminant_genes <- c(
  "KRT8", "KRT19", "KRT9", "KRT10", "KRT2", "KRT18", "KRT1", "KRT5",
  "COL10A1", "COL13A1", "COL14A1", "COL18A1", "COL1A1", "COL1A2",
  "COL26A1", "COL2A1", "COL4A1", "COL4A2", "COL5A1", "COL6A1", "COL6A2"
)

# --- Step 2: Load and process subcellular annotation
cols_to_read <- c(1,2,3,4,5,6,7,9,10,12,15,16,17,18,19,20,21,22,23,25,26,27,28,29)
subcell_df <- read_csv("/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/SubCellAnnotation.csv", show_col_types = FALSE)[, cols_to_read]
subcell_df[] <- lapply(subcell_df, as.character)

long_subcell_df <- subcell_df %>%
  pivot_longer(cols = everything(), names_to = "Localization", values_to = "Genes") %>%
  filter(!is.na(Genes) & Genes != "") %>%
  mutate(Genes = trimws(Genes)) %>%
  distinct()

binary_matrix <- long_subcell_df %>%
  mutate(value = TRUE) %>%
  pivot_wider(
    names_from = Localization,
    values_from = value,
    values_fill = list(value = FALSE)
  )

# --- Step 3: Merge with diff136_df by Gene.Symbol
diff136_df_annotated <- diff136_df %>%
  filter(!Gene.Symbol %in% contaminant_genes) %>%
  left_join(binary_matrix, by = c("Gene.Symbol" = "Genes"))

diff136_df_annotated <- diff136_df_annotated %>%
  mutate(across(where(is.logical) | where(is.numeric), ~ replace_na(., 0)))

# --- Step 4. save as csv file 
write.csv(diff136_df_annotated, 
          file = "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/dataframes/diff136_iNd35_Ctrl-ASAH1e1_axonalproteome_annotated.csv", row.names = FALSE)


# ─────────────────────────────────────────────────────────────────────────────
# 4. Heatmap (z-norm rows, cluster by cluster)
# ─────────────────────────────────────────────────────────────────────────────
out_dir  <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/heatmaps"
pdf_file <- file.path(out_dir, "diff136_heatmap_axonalProt_ctrl_asah1.pdf")

# --- 1. set annotations and sample names 
expr_cols <- c(
  "Ctrl_1","Ctrl_2","Ctrl_3",
  "Ctrl_Soma_1","Ctrl_Soma_2","Ctrl_Soma_3",
  "Ctrl_Axon_1","Ctrl_Axon_2","Ctrl_Axon_3",
  "ASAH1_1","ASAH1_2","ASAH1_3",
  "ASAH1_Soma_1","ASAH1_Soma_2","ASAH1_Soma_3",
  "ASAH1_Axon_1","ASAH1_Axon_2","ASAH1_Axon_3"
)

# Matrix from expression columns
mat <- diff136_df %>%
  filter(!is.na(Gene.Symbol)) %>%
  mutate(Gene.Symbol = make.unique(as.character(Gene.Symbol))) %>%
  select(Gene.Symbol, cluster, all_of(expr_cols))

# Store and remove cluster for sorting
row_cluster <- mat$cluster
rownames(mat) <- mat$Gene.Symbol
mat <- mat[, expr_cols]

# Reorder rows by cluster
mat <- mat[order(row_cluster), , drop = FALSE]


# --- 2. set cluster colors and cluster anntations as rows
# Define full cluster levels explicitly
cluster_levels <- 0:6

# Force 'cluster' to be a factor with all levels, even if not present
row_annotation <- data.frame(
  cluster = factor(row_cluster[order(row_cluster)], levels = cluster_levels)
)
rownames(row_annotation) <- rownames(mat)

# Assign distinct colors (Set2 has up to 8 distinct hues)
cluster_palette <- setNames(
  RColorBrewer::brewer.pal(7, "Set2")[1:7],
  as.character(cluster_levels)
)

# Add to annotation color list
ann_colors$cluster <- cluster_palette


# --- 3. column annotations
annotation_col <- tibble(Sample = expr_cols) %>%
  mutate(
    Genotype = if_else(str_detect(Sample, "^Ctrl"), "Ctrl", "ASAH1"),
    Fraction = case_when(
      str_detect(Sample, "_Soma")  ~ "Soma",
      str_detect(Sample, "_Axon")  ~ "Axon",
      TRUE                         ~ "Whole-cell"
    )
  ) %>%
  column_to_rownames("Sample")

ann_colors <- list(
  Genotype = c(Ctrl = "grey40", ASAH1 = "dodgerblue3"),
  Fraction = c(`Whole-cell` = "#f1eef6",
               Soma         = "#bdc9e1",
               Axon         = "#74a9cf")
)


# --- 4. plot heatmap, save as pdf and store underlying dataframe as csv 
cairo_pdf(pdf_file, width = 9, height = 10)

pheatmap(
  mat,
  scale              = "row",
  color              = colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(100),
  annotation_col     = annotation_col,
  annotation_row     = row_annotation,
  annotation_colors  = ann_colors,
  breaks             = seq(-4, 4, length.out = 101),
  cluster_rows       = FALSE,
  cluster_cols       = TRUE,
  show_rownames      = FALSE,
  show_colnames      = TRUE,
  angle_col          = 90,
  main               = "diff136 day 35 axonal proteome: Ctrl vs ASAH1",
  fontsize           = 6,
  border_color       = NA
)

dev.off()

# Add cluster as first column to expression matrix
mat_with_cluster <- cbind(cluster = row_annotation$cluster, mat)

# Write to CSV with cluster
write.csv(mat_with_cluster,
          file = "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/dataframes/diff136_iNd35_heatmap.csv",
          row.names = TRUE)


# ─────────────────────────────────────────────────────────────────────────────
# 5. Violin Plot of Cluster Abundance
# ─────────────────────────────────────────────────────────────────────────────

violin_df <- diff136_df_annotated %>%
  pivot_longer(cols = all_of(sample_cols), names_to = "Sample", values_to = "Abundance")

ggplot(violin_df, aes(x = cluster, y = Abundance, fill = Sample)) +
  geom_violin(scale = "width", trim = FALSE) +
  theme_bw() + facet_wrap(~ Sample)






# ─────────────────────────────────────────────────────────────────────────────
# 6. Correlation of Selected Annotations
# ─────────────────────────────────────────────────────────────────────────────
annotations <- c("EndoLyso", "Presynaptic", "Postsynaptic", "SynGO", "SynapseSVs")

correlate_log2fc_annotations <- function(data, annotations) {
  out <- lapply(annotations, function(a) {
    subset <- data[data[[a]] == TRUE, ]
    cor_val <- cor(subset$log2FC_ASAH1_Axon.ASAH1, subset$log2FC_Ctrl_Axon.Ctrl, use = "complete.obs")
    data.frame(annotation = a, correlation = cor_val)
  })
  do.call(rbind, out)
}

cor_results <- correlate_log2fc_annotations(diff136_df_annotated, annotations)



# ─────────────────────────────────────────────────────────────────────────────
# 7. Scatterplot of vATPase Members
# ─────────────────────────────────────────────────────────────────────────────
vatpase_genes <- c("ATP6V1G1", "ATP6AP2", "ATP6V1B2", "ATP6V1C1", "ATP6V1E1", "ATP6V1A", "ATP6V0D1",
                   "ATP6AP1", "ATP6V1F", "ATP6V0A1", "ATP6V0A2", "ATP6V1H", "ATP6V1D", "ROGDI",
                   "SYP", "DMXL1", "DMXL2", "PODXL", "PODXL2")

scatter_df <- diff136_df_annotated %>%
  filter(Gene.Symbol %in% vatpase_genes)

ggplot(scatter_df, aes(x = log2FC_ASAH1_Axon.ASAH1, y = log2FC_Ctrl_Axon.Ctrl)) +
  geom_point() +
  geom_text(aes(label = Gene.Symbol), hjust = 0, vjust = 1, size = 2.5) +
  theme_minimal()



# ── 0  USER‑TUNEABLE CUT‑OFFS ──────────────────────────────────────────────
cutoff_pos <- 1.5      # minimum +log2FC on the x‑axis
cutoff_neg <- -1.5     # maximum –log2FC on the y‑axis

# ── 1  INPUT DATA  (keep only columns we need) ─────────────────────────────
plot_df <- diff136_df %>%                                    # <‑– your CSV read in
  select(Gene.Symbol,
         x = log2FC_Ctrl_Axon.Ctrl_Soma,
         y = log2FC_ASAH1_Axon.ASAH1_Soma)

# ── 2  FLAG & COLOR THE “opposite‑sign” HITS ───────────────────────────────
plot_df <- plot_df %>% 
  mutate(
    highlight =  x >= cutoff_pos & y <= cutoff_neg,
    point_col = if_else(highlight, "red", "grey70"),
    label     = if_else(highlight, Gene.Symbol, NA_character_)
  )

highlight_genes <- filter(plot_df, highlight) %>% pull(Gene.Symbol)
cat("Highlighted proteins (", length(highlight_genes), "):\n",
    paste(highlight_genes, collapse = ", "), "\n", sep = "")

# ── 3  PLOT ────────────────────────────────────────────────────────────────
library(ggplot2)
library(ggrepel)

axon_scatter <- ggplot(plot_df,
                       aes(x = x, y = y)) +
  geom_point(aes(colour = point_col), size = 1.5, alpha = 0.85,
             show.legend = FALSE) +
  geom_text_repel(aes(label = label),
                  max.overlaps = Inf, size = 2.5) +
  geom_smooth(method = "lm", se = FALSE,
              colour = "black", linewidth = 0.3) +
  geom_hline(yintercept = 0, linetype = "dashed", linewidth = 0.3) +
  geom_vline(xintercept = 0, linetype = "dashed", linewidth = 0.3) +
  scale_colour_identity() +
  labs(title = glue::glue("Axon vs Soma log2FC (cutoffs: +{cutoff_pos}, {cutoff_neg})"),
       x = "log2FC Ctrl Axon – Soma",
       y = "log2FC ASAH1 Axon – Soma") +
  theme_bw(base_size = 10) +
  theme(panel.grid = element_blank())

print(axon_scatter)

ggsave(
  file = "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/diff136_axonalProt_highlight_opposite_sign.pdf",
  axon_scatter, width = 8, height = 8, device = cairo_pdf
)
```

## --- heatmap of data and violin plots of clusters ---
```{r}
##############################################################################
##  Axonal-proteome heat-map (Ctrl vs ASAH1) – using pheatmap
##  --------------------------------------------------------------------------
##  • Rows   : proteins (Gene.Symbol) – ordered by the “cluster” column
##  • Columns: 18 samples  (whole-cell / soma / axon ; Ctrl / ASAH1 ; n = 3)
##  • Colour : RdYlBu (reversed) on a z-score (row-scaled) matrix
##  • Output : on-screen plot  +  PDF copy in ‘out_dir’
##############################################################################

library(tidyverse)    # dplyr / readr / tibble  …  
library(pheatmap)     # heat-map
library(RColorBrewer) # palette helper
library(Cairo)        # high-quality (anti-aliased) PDF

## ---------------------------------------------------------------------------
## 1. user settings
## ---------------------------------------------------------------------------
out_dir  <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv"
pdf_file <- file.path(out_dir, "diff136_heatmap_ctrl_asah1.pdf")


## -- keep only the numeric expression columns --------------------------------
expr_cols <- c(
  "Ctrl_1","Ctrl_2","Ctrl_3",
  "Ctrl_Soma_1","Ctrl_Soma_2","Ctrl_Soma_3",
  "Ctrl_Axon_1","Ctrl_Axon_2","Ctrl_Axon_3",
  "ASAH1_1","ASAH1_2","ASAH1_3",
  "ASAH1_Soma_1","ASAH1_Soma_2","ASAH1_Soma_3",
  "ASAH1_Axon_1","ASAH1_Axon_2","ASAH1_Axon_3"
)

mat <- diff136_df %>%                                   # numeric matrix (genes × 18)
  select(all_of(expr_cols)) %>%
  as.matrix()
rownames(mat) <- make.unique(diff136_df$Gene.Symbol)                # gene names as row-names

## -- order rows by the ‘cluster’ column --------------------------------------
##    (pheatmap will use this fixed order – no hierarchical row clustering)
row_order <- order(diff136_df$cluster)
mat        <- mat[row_order, , drop = FALSE]

## ---------------------------------------------------------------------------
## 3. column annotations
## ---------------------------------------------------------------------------
annotation_col <- tibble(Sample = expr_cols) %>%
  mutate(
    Genotype = if_else(str_detect(Sample, "^Ctrl"), "Ctrl", "ASAH1"),
    Fraction = case_when(
      str_detect(Sample, "_Soma")  ~ "Soma",
      str_detect(Sample, "_Axon")  ~ "Axon",
      TRUE                         ~ "Whole-cell"
    )
  ) %>%
  column_to_rownames("Sample")

## -- matching list of colours for each annotation level ----------------------
ann_colors <- list(
  Genotype = c(Ctrl = "grey40", ASAH1 = "dodgerblue3"),
  Fraction = c(`Whole-cell` = "#f1eef6",
               Soma        = "#bdc9e1",
               Axon        = "#74a9cf")
)

## ---------------------------------------------------------------------------
## 4. draw + save  (CairoPDF = anti-aliased) 
## ---------------------------------------------------------------------------
cairo_pdf(pdf_file, width = 9, height = 10)         # open device
pheatmap(
  mat,
  scale            = "row",                         # z-score per gene
  color            = colorRampPalette(
                       rev(brewer.pal(11, "RdYlBu")))(100),
  annotation_col   = annotation_col,
  annotation_colors= ann_colors,
  breaks           = seq(-4,  4, length.out = 101),
  cluster_rows     = TRUE,                         # keep supplied order
  cluster_cols     = TRUE,                          # cluster samples
  show_rownames    = FALSE,
  show_colnames    = TRUE,
  angle_col        = 90,
  main             = "diff136 axonal proteome: Ctrl vs ASAH1",
  fontsize         = 9,
  border_color     = NA
)
dev.off()                                            # close / write PDF




## --- Violin plots of normalized clusters --- ###
# ─────────────────────────────────────────────────────────────────────────────
# 0.  Packages
# ─────────────────────────────────────────────────────────────────────────────
library(tidyverse)   # dplyr, tidyr, ggplot2
library(Cairo)       # high-quality PDF device

# ─────────────────────────────────────────────────────────────────────────────
# 1.  Define the expression columns exactly as used before
# ─────────────────────────────────────────────────────────────────────────────
expr_cols <- c(
  "Ctrl_1", "Ctrl_2", "Ctrl_3",
  "Ctrl_Soma_1", "Ctrl_Soma_2", "Ctrl_Soma_3",
  "Ctrl_Axon_1", "Ctrl_Axon_2", "Ctrl_Axon_3",
  "ASAH1_1", "ASAH1_2", "ASAH1_3",
  "ASAH1_Soma_1", "ASAH1_Soma_2", "ASAH1_Soma_3",
  "ASAH1_Axon_1", "ASAH1_Axon_2", "ASAH1_Axon_3"
)

# ─────────────────────────────────────────────────────────────────────────────
# 2.  Keep only clusters 1-6 and compute gene-wise z-scores
#     • scale() on rows  → z-score per protein across the 18 samples
# ─────────────────────────────────────────────────────────────────────────────
# Create z-score versions
z_df <- diff136_df %>%
  select(Gene.Symbol, cluster, all_of(expr_cols)) %>%
  mutate(across(all_of(expr_cols), ~ as.numeric(scale(.x)), .names = "z_{.col}"))


# ─────────────────────────────────────────────────────────────────────────────
# 3.  Pivot to long format  (one row = one protein × one sample)
# ─────────────────────────────────────────────────────────────────────────────
# Then pivot
long_df <- z_df %>%
  select(Gene.Symbol, cluster, starts_with("z_")) %>%
  pivot_longer(
    cols = starts_with("z_"),
    names_to = "Sample",
    names_pattern = "z_(.*)",  # strip "z_"
    values_to = "z_score"
  )

# ─────────────────────────────────────────────────────────────────────────────
# 4.  Nice colours for six sample groups
# ─────────────────────────────────────────────────────────────────────────────
group_colors <- setNames(
  RColorBrewer::brewer.pal(6, "Blues"),
  c("Ctrl", "Ctrl_Soma", "Ctrl_Axon",
    "ASAH1", "ASAH1_Soma", "ASAH1_Axon")
)
# ────────────────────────────────────────────────────────────────
# 5.  annotate each sample with its group (Whole/Soma/Axon)
# ────────────────────────────────────────────────────────────────
long_df <- long_df %>%
  mutate(Group = case_when(
    str_starts(Sample, "Ctrl_\\d")         ~ "Ctrl",
    str_starts(Sample, "Ctrl_Soma")        ~ "Ctrl_Soma",
    str_starts(Sample, "Ctrl_Axon")        ~ "Ctrl_Axon",
    str_starts(Sample, "ASAH1_\\d")        ~ "ASAH1",
    str_starts(Sample, "ASAH1_Soma")       ~ "ASAH1_Soma",
    str_starts(Sample, "ASAH1_Axon")       ~ "ASAH1_Axon",
    TRUE                                   ~ NA_character_
  ),
  Group = factor(Group, levels = names(group_colors)))


# ─────────────────────────────────────────────────────────────────────────────
# 6.  Loop over clusters 1-6: violin + box overlay, save each to PDF
# ─────────────────────────────────────────────────────────────────────────────
out_dir <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv"

for (cl in 1:6) {
  p <- ggplot(
    long_df %>% filter(cluster == cl), aes(x = Sample, y = z_score, fill = Group)) +
    geom_violin(trim = FALSE, scale = "width", colour = NA, alpha = 0.8) +
      geom_boxplot(width = 0.15, outlier.shape = NA, fill = "white", size = 0.15) +
      scale_fill_manual(values = group_colors) +
      labs(
          title = sprintf("Cluster %d : Z-scored Protein Abundance", cl),
          y = "z-score (per protein)", x = NULL
          ) +
        theme_bw(base_size = 6) +
        theme(
          legend.position = "none",
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          axis.text.x = element_text(angle = 90, hjust = 0)
        )

  # ---- save PDF (cairo for vector, no font headaches) ----------------------
  pdf_file <- file.path(out_dir, sprintf("diff136_cluster%02d_violin.pdf", cl))
  Cairo::CairoPDF(pdf_file, width = 2, height = 2)
  print(p)
  dev.off()
}


```


# Ctrl vs ASAH1 ratio-of-ratios scatterplots (RoR)
## --- comparison WC vs Axon fractions ---
plot ASAH1 vs Control on scatterplot
make subplots for different enriched quadrands 
save plots and hits as csv file 
```{r}
###############################################################################
#  Axonal-vs-Whole cell scatter plots
#  – highlight user-defined log2FC windows
#  – collect labelled gene IDs into a CSV
#  – export publication-quality PDFs
###############################################################################

out_dir <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv"

# ────────────────────────────────────────────────────────────────────────────
# helper that  ➜  1) BUILDS a ggplot scatter
#              ➜  2) RETURNS the vector of highlighted gene symbols
#              (optional) 3) writes the PDF immediately
# ────────────────────────────────────────────────────────────────────────────
plot_axonal_scatter <- function(data,
                                x_col, y_col,         # column names (strings)
                                x_plot, y_plot,       # window to display
                                x_lab,  y_lab,        # sub-box that gets labels
                                highlight_col = "red",
                                pdf_path     = NULL)  # optional output file
{
  xs <- sym(x_col)   # ← convert to quosures for tidy-eval
  ys <- sym(y_col)

  # 🔹 1. Tag points & subset to view-window
  df <- data %>%
    mutate(
      highlight = (!!xs >= min(x_lab) & !!xs <= max(x_lab)) &   # logical flag
                  (!!ys >= min(y_lab) & !!ys <= max(y_lab)),
      point_col = if_else(highlight, highlight_col, "grey70"),  # point colour
      label     = if_else(highlight, Gene.Symbol, NA_character_)# label text
    ) %>%
    filter(between(!!xs, x_plot[1], x_plot[2]),                 # keep only
           between(!!ys, y_plot[1], y_plot[2]))                 # window bounds

  # 🔹 2. Build the ggplot object
  p <- ggplot(df, aes(x = !!xs, y = !!ys)) +
    geom_point(aes(colour = point_col), size = 1.6, alpha = .8,
               show.legend = FALSE) +
    geom_text_repel(aes(label = label), max.overlaps = Inf, size = 3) +
    geom_hline(yintercept = 0, linetype = "dashed", linewidth = .3) +
    geom_vline(xintercept = 0, linetype = "dashed", linewidth = .3) +
    scale_colour_identity() +
    coord_cartesian(xlim = x_plot, ylim = y_plot, expand = TRUE) +
    labs(x = x_col, y = y_col,
         title = sprintf(
           "Display x:[%.1f,%.1f] y:[%.1f,%.1f] | Label box x:[%.1f,%.1f] y:[%.1f,%.1f]",
           x_plot[1], x_plot[2], y_plot[1], y_plot[2],
           x_lab[1],  x_lab[2],  y_lab[1],  y_lab[2])) +
    theme_bw(base_size = 8) +
    theme(panel.grid = element_blank())

  # 🔹 3. Optional: write PDF directly
  if (!is.null(pdf_path)) {
    ggsave(pdf_path, p, width = 6, height = 6, device = cairo_pdf)
  }

  # 🔹 4. Collect unique highlighted genes
  hits <- df %>%
    filter(highlight) %>%
    distinct(Gene.Symbol) %>%
    pull(Gene.Symbol)

  # return both plot and hit list
  list(plot = p, hits = hits)
}

# ────────────────────────────────────────────────────────────────────────────
#  CREATE THREE DIFFERENT WINDOWS & CAPTURE THEIR HIT LISTS
# ────────────────────────────────────────────────────────────────────────────
p_axonWC_enriched_ASAH1 <- plot_axonal_scatter(
  diff136_df,
  x_col = "log2FC_Ctrl_Axon.Ctrl",
  y_col = "log2FC_ASAH1_Axon.ASAH1",
  x_plot = c(-3, 0),   y_plot = c(0, 3),     # display window
  x_lab  = c(-3, -0.5), y_lab = c(0.5, 3)    # label sub-box
  # pdf_path = file.path(out_dir, "axon_enriched_ASAH1.pdf")
)

p_axonWC_enriched_Ctrl <- plot_axonal_scatter(
  diff136_df,
  x_col = "log2FC_Ctrl_Axon.Ctrl",
  y_col = "log2FC_ASAH1_Axon.ASAH1",
  x_plot = c(0, 3), y_plot = c(-3, 0),
  x_lab  = c(0.5, 3), y_lab  = c(-0.5, -3)
  # pdf_path = file.path(out_dir, "axon_enriched_Ctrl.pdf")
)

p_axonWC_enriched_both <- plot_axonal_scatter(
  diff136_df,
  x_col = "log2FC_Ctrl_Axon.Ctrl",
  y_col = "log2FC_ASAH1_Axon.ASAH1",
  x_plot = c(0, 3), y_plot = c(0, 3),
  x_lab  = c(1, 3), y_lab  = c(0.5, 3)
  # pdf_path = file.path(out_dir, "axon_enriched_both.pdf")
)

# ────────────────────────────────────────────────────────────────────────────
#  BUILD A SIDE-BY-SIDE TABLE OF UNIQUE HITS AND WRITE TO CSV
# ────────────────────────────────────────────────────────────────────────────
max_len <- max(lengths(list(p_axonWC_enriched_ASAH1$hits,
                            p_axonWC_enriched_Ctrl$hits,
                            p_axonWC_enriched_both$hits)))

hits_tblWC <- tibble(
  p_axonWC_enriched_ASAH1 = c(p_axonWC_enriched_ASAH1$hits,
                            rep(NA, max_len - length(p_axonWC_enriched_ASAH1$hits))),
  p_axonWC_enriched_Ctrl  = c(p_axonWC_enriched_Ctrl$hits,
                            rep(NA, max_len - length(p_axonWC_enriched_Ctrl$hits))),
  p_axonWC_enriched_both  = c(p_axonWC_enriched_both$hits,
                            rep(NA, max_len - length(p_axonWC_enriched_both$hits)))
)

write_csv(hits_tblWC,
  file.path(out_dir, "diff136_highlighted_axonal-vs-WC_proteins.csv"))

# ────────────────────────────────────────────────────────────────────────────
#  VIEW PLOTS IN RStudio / TERMINAL
# ────────────────────────────────────────────────────────────────────────────
p_axonWC_enriched_ASAH1
p_axonWC_enriched_Ctrl
p_axonWC_enriched_both

# ────────────────────────────────────────────────────────────────────────────
#  FINAL EXPORTS – MANUAL ggsave FOR CUSTOM SIZE / FORMAT
# ────────────────────────────────────────────────────────────────────────────
ggsave(file.path(out_dir, "axon-vs-WC_enriched_both.pdf"),
       p_axonWC_enriched_both$plot, width = 8, height = 8, device = cairo_pdf)

ggsave(file.path(out_dir, "axon-vs-WC_enriched_Ctrl.pdf"),
       p_axonWC_enriched_Ctrl$plot,  width = 8, height = 8, device = cairo_pdf)

ggsave(file.path(out_dir, "axon-vs-WCenriched_ASAH1.pdf"),
       p_axonWC_enriched_ASAH1$plot, width = 8, height = 8, device = cairo_pdf)
```


## --- comparison Soma vs Axon fractions ---
plot ASAH1 vs Control on scatterplot
make subplots for different enriched quadrands 
save plots and hits as csv file 
```{r}
###############################################################################
#  Axonal-vs-Somatic scatter plots
#  – highlight user-defined log2FC windows
#  – collect labelled gene IDs into a CSV
#  – export publication-quality PDFs
###############################################################################

out_dir <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv"

# ────────────────────────────────────────────────────────────────────────────
# helper that  ➜  1) BUILDS a ggplot scatter
#              ➜  2) RETURNS the vector of highlighted gene symbols
#              (optional) 3) writes the PDF immediately
# ────────────────────────────────────────────────────────────────────────────
plot_axonal_scatter <- function(data,
                                x_col, y_col,         # column names (strings)
                                x_plot, y_plot,       # window to display
                                x_lab,  y_lab,        # sub-box that gets labels
                                highlight_col = "red",
                                pdf_path     = NULL)  # optional output file
{
  xs <- sym(x_col)   # ← convert to quosures for tidy-eval
  ys <- sym(y_col)

  # 🔹 1. Tag points & subset to view-window
  df <- data %>%
    mutate(
      highlight = (!!xs >= min(x_lab) & !!xs <= max(x_lab)) &   # logical flag
                  (!!ys >= min(y_lab) & !!ys <= max(y_lab)),
      point_col = if_else(highlight, highlight_col, "grey70"),  # point colour
      label     = if_else(highlight, Gene.Symbol, NA_character_)# label text
    ) %>%
    filter(between(!!xs, x_plot[1], x_plot[2]),                 # keep only
           between(!!ys, y_plot[1], y_plot[2]))                 # window bounds

  # 🔹 2. Build the ggplot object
  p <- ggplot(df, aes(x = !!xs, y = !!ys)) +
    geom_point(aes(colour = point_col), size = 1.6, alpha = .8,
               show.legend = FALSE) +
    geom_text_repel(aes(label = label), max.overlaps = Inf, size = 3) +
    geom_hline(yintercept = 0, linetype = "dashed", linewidth = .3) +
    geom_vline(xintercept = 0, linetype = "dashed", linewidth = .3) +
    scale_colour_identity() +
    coord_cartesian(xlim = x_plot, ylim = y_plot, expand = TRUE) +
    labs(x = x_col, y = y_col,
         title = sprintf(
           "Display x:[%.1f,%.1f] y:[%.1f,%.1f] | Label box x:[%.1f,%.1f] y:[%.1f,%.1f]",
           x_plot[1], x_plot[2], y_plot[1], y_plot[2],
           x_lab[1],  x_lab[2],  y_lab[1],  y_lab[2])) +
    theme_bw(base_size = 8) +
    theme(panel.grid = element_blank())

  # 🔹 3. Optional: write PDF directly
  if (!is.null(pdf_path)) {
    ggsave(pdf_path, p, width = 6, height = 6, device = cairo_pdf)
  }

  # 🔹 4. Collect unique highlighted genes
  hits <- df %>%
    filter(highlight) %>%
    distinct(Gene.Symbol) %>%
    pull(Gene.Symbol)

  # return both plot and hit list
  list(plot = p, hits = hits)
}

# ────────────────────────────────────────────────────────────────────────────
#  CREATE THREE DIFFERENT WINDOWS & CAPTURE THEIR HIT LISTS
# ────────────────────────────────────────────────────────────────────────────
p_axon_enriched_ASAH1 <- plot_axonal_scatter(
  diff136_df,
  x_col = "log2FC_Ctrl_Axon.Ctrl_Soma",
  y_col = "log2FC_ASAH1_Axon.ASAH1_Soma",
  x_plot = c(-3, 0),   y_plot = c(0, 3),     # display window
  x_lab  = c(-3, -0.5), y_lab = c(0.5, 3)    # label sub-box
  # pdf_path = file.path(out_dir, "axon_enriched_ASAH1.pdf")
)

p_axon_enriched_Ctrl <- plot_axonal_scatter(
  diff136_df,
  x_col = "log2FC_Ctrl_Axon.Ctrl_Soma",
  y_col = "log2FC_ASAH1_Axon.ASAH1_Soma",
  x_plot = c(0, 3), y_plot = c(-3, 0),
  x_lab  = c(1, 3), y_lab  = c(-1, -3)
  # pdf_path = file.path(out_dir, "axon_enriched_Ctrl.pdf")
)

p_axon_enriched_both <- plot_axonal_scatter(
  diff136_df,
  x_col = "log2FC_Ctrl_Axon.Ctrl_Soma",
  y_col = "log2FC_ASAH1_Axon.ASAH1_Soma",
  x_plot = c(0, 3), y_plot = c(0, 3),
  x_lab  = c(1, 3), y_lab  = c(0.5, 3)
  # pdf_path = file.path(out_dir, "axon_enriched_both.pdf")
)

# ────────────────────────────────────────────────────────────────────────────
#  BUILD A SIDE-BY-SIDE TABLE OF UNIQUE HITS AND WRITE TO CSV
# ────────────────────────────────────────────────────────────────────────────
max_len <- max(lengths(list(p_axon_enriched_ASAH1$hits,
                            p_axon_enriched_Ctrl$hits,
                            p_axon_enriched_both$hits)))

hits_tbl <- tibble(
  p_axon_enriched_ASAH1 = c(p_axon_enriched_ASAH1$hits,
                            rep(NA, max_len - length(p_axon_enriched_ASAH1$hits))),
  p_axon_enriched_Ctrl  = c(p_axon_enriched_Ctrl$hits,
                            rep(NA, max_len - length(p_axon_enriched_Ctrl$hits))),
  p_axon_enriched_both  = c(p_axon_enriched_both$hits,
                            rep(NA, max_len - length(p_axon_enriched_both$hits)))
)

write_csv(hits_tbl,
  file.path(out_dir, "diff136_highlighted_axonal_proteins.csv"))

# ────────────────────────────────────────────────────────────────────────────
#  VIEW PLOTS IN RStudio / TERMINAL
# ────────────────────────────────────────────────────────────────────────────
p_axon_enriched_ASAH1
p_axon_enriched_Ctrl
p_axon_enriched_both

# ────────────────────────────────────────────────────────────────────────────
#  FINAL EXPORTS – MANUAL ggsave FOR CUSTOM SIZE / FORMAT
# ────────────────────────────────────────────────────────────────────────────
ggsave(file.path(out_dir, "axon_enriched_both.pdf"),
       p_axon_enriched_both$plot, width = 8, height = 8, device = cairo_pdf)

ggsave(file.path(out_dir, "axon_enriched_Ctrl.pdf"),
       p_axon_enriched_Ctrl$plot,  width = 8, height = 8, device = cairo_pdf)

ggsave(file.path(out_dir, "axon_enriched_ASAH1.pdf"),
       p_axon_enriched_ASAH1$plot, width = 8, height = 8, device = cairo_pdf)
```