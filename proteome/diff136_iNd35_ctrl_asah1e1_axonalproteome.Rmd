---
title: "diff136_iNd35_ctrl_asah1e1_axonalproteome"
output: html_document
date: "`r Sys.Date()`"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# load packackes 
```{r}
# --- Load Required Libraries ---
# --- Core Tidyverse ---
library(tidyverse)     # includes dplyr, ggplot2, tidyr, purrr, tibble, readr, stringr, etc.
library(dplyr)
library(tidyr)

# --- Plotting Enhancements ---
library(ggplot2)
library(ggdist)        # stat_halfeye
library(gghalves)      # geom_half_point
library(ggrepel)       # text labels (if used)
library(pheatmap)      # for heatmaps
library(RColorBrewer)  # custom color scales
library(viridis)       # color scales (optional)
library(NatParksPalettes)
library(scales) 
library(eulerr)

# --- Plot Layouts ---
library(gridExtra)     # arranging plots
library(cowplot)       # aligning and combining plots
library(patchwork)     # alternate plot composition syntax


# --- Data Reshaping and Manipulation ---
library(reshape2)      # melt, dcast (legacy but used in some places)
library(forcats)       # factor reordering
library(data.table)    # fast table handling (if used)

library(lintr)
library(devtools)

```


# output dirs overview:
```{r}
out_dir_diff136_dataframes <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/dataframes"
dir.create(out_dir_diff136_dataframes, recursive = TRUE, showWarnings = FALSE)

out_dir_diff136_heatmap  <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/heatmaps"
dir.create(out_dir_diff136_heatmap, recursive = TRUE, showWarnings = FALSE)

out_dir_diff136_corrplots <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/Organelle_CrossCorr"
dir.create(out_dir_diff136_corrplots, recursive = TRUE, showWarnings = FALSE)

out_dir_diff136_organelle_dist <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/Organelle_Distribution"
dir.create(out_dir_diff136_organelle_dist, recursive = TRUE, showWarnings = FALSE)

out_dir_diff136_rainbow <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/Organelle_Distribution_Rainbow"
dir.create(out_dir_diff136_rainbow, recursive = TRUE, showWarnings = FALSE)

out_dir_diff136_rainbow_RoR <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/Organelle_Distribution_Rainbow/ror"
dir.create(out_dir_diff136_rainbow_RoR, recursive = TRUE, showWarnings = FALSE)

out_dir_diff136_rainbow_GO <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/GO"
dir.create(out_dir_diff136_rainbow_GO, recursive = TRUE, showWarnings = FALSE)

out_dir_diff136_rainbow_GOcluster <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/GO/heatmapclusters"
dir.create(out_dir_diff136_rainbow_GOcluster, recursive = TRUE, showWarnings = FALSE)

out_dir_diff136_rainbow_GOror <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/GO/RoR"
dir.create(out_dir_diff136_rainbow_GOror, recursive = TRUE, showWarnings = FALSE)

```



# I. Background diff 136 axonal proteome Ctrl / ASAH1 e1 day 35 iN differentiation 
Dataset contains in vitro differentiaed iNeurons at day 35 of differentiation
Genotypes: H9 NGN2 TMEM192-3xHA (het) Control and ASAH1-/- clone E1
Samples (all in triplicates): whole-cell (WC), soma fraction and axonal fraction 
18plex_TMTpro & run on Thermo Orbitrap Ascent w/FAIMS-Pro, hrMS2
data was created with MSstats, has p/q.values and log2FC for samples 
k-means clustering was performed on data, is in column "cluster"


# II. read in data & add protein organelle annotations
- facet wrap by annotations & save 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# 1.  read the data  
# ─────────────────────────────────────────────────────────────────────────────

diff136_df <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/datasets/diff136_iNd35_Ctrl-ASAH1e1_axonalproteome_All_results_stats_localizationAdded.csv', header=T)


# ─────────────────────────────────────────────────────────────────────────────
# 2.  Transform p/q-values to -log10, and filter non-finite log2FCs
# ─────────────────────────────────────────────────────────────────────────────

log2fc_cols <- c(
  "log2FC_Ctrl_Soma.Ctrl",
  "log2FC_Ctrl_Axon.Ctrl",
  "log2FC_ASAH1.Ctrl",
  "log2FC_ASAH1_Soma.Ctrl",
  "log2FC_ASAH1_Axon.Ctrl",
  "log2FC_Ctrl_Axon.Ctrl_Soma",
  "log2FC_ASAH1.Ctrl_Soma",
  "log2FC_ASAH1_Soma.Ctrl_Soma",
  "log2FC_ASAH1_Axon.Ctrl_Soma",
  "log2FC_ASAH1.Ctrl_Axon",
  "log2FC_ASAH1_Soma.Ctrl_Axon",
  "log2FC_ASAH1_Axon.Ctrl_Axon",
  "log2FC_ASAH1_Soma.ASAH1",
  "log2FC_ASAH1_Axon.ASAH1",
  "log2FC_ASAH1_Axon.ASAH1_Soma"
)

diff136_df <- diff136_df %>%
  mutate(across(contains("p.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}"),
         across(contains("q.val"), ~ ifelse(. > 0, -log10(.), NA), .names = "neg_log10_{.col}")) %>%
  filter(if_all(all_of(log2fc_cols), ~ is.finite(.)))

# ─────────────────────────────────────────────────────────────────────────────
# 3.  Add Subcellular Annotation
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1: Define contaminant list (optional, can be skipped if not relevant)
contaminant_genes <- c(
  "KRT8", "KRT19", "KRT9", "KRT10", "KRT2", "KRT18", "KRT1", "KRT5",
  "COL10A1", "COL13A1", "COL14A1", "COL18A1", "COL1A1", "COL1A2",
  "COL26A1", "COL2A1", "COL4A1", "COL4A2", "COL5A1", "COL6A1", "COL6A2"
)

# --- Step 2: Load and process subcellular annotation
cols_to_read <- c(1,2,3,4,5,6,7,9,10,12,15,16,17,18,19,20,21,22,23,25,26,27,28,29,30,31,32,33)
subcell_df <- read_csv("/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/neuroLSDgit/proteome/SubCellAnnotation.csv", show_col_types = FALSE)[, cols_to_read]
subcell_df[] <- lapply(subcell_df, as.character)

long_subcell_df <- subcell_df %>%
  pivot_longer(cols = everything(), names_to = "Localization", values_to = "Genes") %>%
  filter(!is.na(Genes) & Genes != "") %>%
  mutate(Genes = trimws(Genes)) %>%
  distinct()

binary_matrix <- long_subcell_df %>%
  mutate(value = TRUE) %>%
  pivot_wider(
    names_from = Localization,
    values_from = value,
    values_fill = list(value = FALSE)
  )

# --- Step 3: Merge with diff136_df by Gene.Symbol
diff136_df_annotated <- diff136_df %>%
  filter(!Gene.Symbol %in% contaminant_genes) %>%
  left_join(binary_matrix, by = c("Gene.Symbol" = "Genes"))

diff136_df_annotated <- diff136_df_annotated %>%
  mutate(across(where(is.logical) | where(is.numeric), ~ replace_na(., 0)))

# --- Step 4. save as csv file 
write.csv(diff136_df_annotated, 
          file = file.path(out_dir_diff136_dataframes,"diff136_iNd35_Ctrl-ASAH1e1_axonalproteome_annotated.csv"), row.names = FALSE)
```


### IIa. Heatmap (z-norm rows, cluster by cluster)
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Heatmap (z-norm rows, cluster by cluster)
# ─────────────────────────────────────────────────────────────────────────────
out_dir_diff136_heatmap  <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Proteomics/20250603_diff136_iN_d35_Ctrl-ASAH1E1_AxonalProteomics/diff136renv/heatmaps"
pdf_file <- file.path(out_dir_diff136_heatmap, "diff136_heatmap_axonalProt_ctrl_asah1.pdf")

# --- 1. set annotations and sample names 
expr_cols <- c(
  "Ctrl_1","Ctrl_2","Ctrl_3",
  "Ctrl_Soma_1","Ctrl_Soma_2","Ctrl_Soma_3",
  "Ctrl_Axon_1","Ctrl_Axon_2","Ctrl_Axon_3",
  "ASAH1_1","ASAH1_2","ASAH1_3",
  "ASAH1_Soma_1","ASAH1_Soma_2","ASAH1_Soma_3",
  "ASAH1_Axon_1","ASAH1_Axon_2","ASAH1_Axon_3"
)

# Matrix from expression columns
mat <- diff136_df %>%
  filter(!is.na(Gene.Symbol)) %>%
  mutate(Gene.Symbol = make.unique(as.character(Gene.Symbol))) %>%
  select(Gene.Symbol, cluster, all_of(expr_cols))

# Store and remove cluster for sorting
row_cluster <- mat$cluster
rownames(mat) <- mat$Gene.Symbol
mat <- mat[, expr_cols]

# Reorder rows by cluster
mat <- mat[order(row_cluster), , drop = FALSE]


# --- 2. set cluster colors and cluster annotations as rows
# Define full cluster levels explicitly
cluster_levels <- 0:6

# Force 'cluster' to be a factor with all levels, even if not present
row_annotation <- data.frame(
  cluster = factor(row_cluster[order(row_cluster)], levels = cluster_levels)
)
rownames(row_annotation) <- rownames(mat)

# Assign distinct colors (Set2 has up to 8 distinct hues)
cluster_palette <- setNames(
  RColorBrewer::brewer.pal(7, "Set2")[1:7],
  as.character(cluster_levels)
)

# Add to annotation color list
ann_colors <- list(
  Genotype = c(Ctrl = "grey40", ASAH1 = "dodgerblue3"),
  Fraction = c(`Whole-cell` = "#f1eef6",
               Soma         = "#bdc9e1",
               Axon         = "#74a9cf")
)

ann_colors$cluster <- cluster_palette


# --- 3. column annotations
annotation_col <- tibble(Sample = expr_cols) %>%
  mutate(
    Genotype = if_else(str_detect(Sample, "^Ctrl"), "Ctrl", "ASAH1"),
    Fraction = case_when(
      str_detect(Sample, "_Soma")  ~ "Soma",
      str_detect(Sample, "_Axon")  ~ "Axon",
      TRUE                         ~ "Whole-cell"
    )
  ) %>%
  column_to_rownames("Sample")



# --- 4. plot heatmap, save as pdf and store underlying dataframe as csv 
cairo_pdf(pdf_file, width = 9, height = 10)

pheatmap(
  mat,
  scale              = "row",
  color              = colorRampPalette(rev(brewer.pal(11, "RdYlBu")))(100),
  annotation_col     = annotation_col,
  annotation_row     = row_annotation,
  annotation_colors  = ann_colors,
  breaks             = seq(-4, 4, length.out = 101),
  cluster_rows       = FALSE,
  cluster_cols       = TRUE,
  show_rownames      = FALSE,
  show_colnames      = TRUE,
  angle_col          = 90,
  main               = "diff136 day 35 axonal proteome: Ctrl vs ASAH1",
  fontsize           = 6,
  border_color       = NA
)

dev.off()

# Add cluster as first column to expression matrix
mat_with_cluster <- cbind(cluster = row_annotation$cluster, mat)

# Write to CSV with cluster
write.csv(mat_with_cluster,
          file = file.path(out_dir_diff136_heatmap,"diff136_iNd35_heatmap.csv"),
          row.names = TRUE)
```



### IIb.  Violin Plot of Cluster Abundance
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Violin Plot of Cluster Abundance
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. define & select sample labels for plotting  
sample_cols <- c(
  "log2FC_Ctrl_Soma.Ctrl",
  "log2FC_Ctrl_Axon.Ctrl",
  "log2FC_ASAH1_Soma.ASAH1",
  "log2FC_ASAH1_Axon.ASAH1"
)


# --- 2. Drop cluster 0 and NA
violin_df <- diff136_df_annotated %>%
  filter(!is.na(cluster) & cluster != 0) %>%
  pivot_longer(cols = all_of(sample_cols), names_to = "Sample", values_to = "log2FC") %>%
  filter(!is.na(log2FC))

# --- 3. Consistent y-axis scale
y_limits <- range(violin_df$log2FC, na.rm = TRUE)

# --- 4. plot facet wrap
diff136_clusterPlot <- ggplot(violin_df, aes(x = Sample, y = log2FC, fill = Sample)) +
  geom_jitter(
    aes(color = "red"), size = 0.5, alpha = 0.2, width = 0.2, height = 0
  ) +
  geom_violin(scale = "width", trim = FALSE) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  #facet_wrap(~ cluster, scales = "fixed") +
  facet_wrap(~ cluster, scales = "free_y") +
  #coord_cartesian(ylim = y_limits) +
  scale_fill_manual(values = c(
    "log2FC_Ctrl_Soma.Ctrl" = "#f1eef6",
    "log2FC_Ctrl_Axon.Ctrl" = "#bdc9e1",
    "log2FC_ASAH1_Soma.ASAH1" = "#74a9cf",
    "log2FC_ASAH1_Axon.ASAH1" = "dodgerblue3"
  )) +
  theme_bw(base_size = 10) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "none", 
        #panel.grid = element_blank()
        ) +
  labs(title = "log2FC by Sample per Cluster", x = NULL, y = "log2FC")

diff136_clusterPlot

# --- 5. save plot as PDF
ggsave(file.path(out_dir_diff136_heatmap, 
  "diff136_clusterPlot.pdf"), 
  diff136_clusterPlot, width = 6, height = 6, device = cairo_pdf)
```


# III. Correlation of Selected Annotations
calculate annotated-based correlation across all and also facet wrap them
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Correlation of Selected Annotations
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Copy out log2FC & annotated columns for wrangling
# Define log2FC columns (all that start with log2FC_)
log2fc_cols <- grep("^log2FC_", colnames(diff136_df_annotated), value = TRUE)

# Define annotation columns (binary organelle terms)
# assumes binary 0/1 format and not part of log2FC set
annotation_cols <- setdiff(colnames(diff136_df_annotated), log2fc_cols)
annotation_cols <- annotation_cols[sapply(diff136_df_annotated[, annotation_cols], function(x) all(x %in% c(0, 1, NA)))]

# Drop unwanted ones
annotation_cols <- setdiff(annotation_cols, c("Autophagy_det", "EndoDetailLoac"))



length(log2fc_cols)  # sanity check
length(annotation_cols)



# --- 2. Compute Spearman correlation between log2FC and annotations
org_corr_df <- map_dfr(annotation_cols, function(ann) {
  map_dfr(log2fc_cols, function(fc_col) {
    x <- diff136_df_annotated[[fc_col]]
    y <- as.numeric(diff136_df_annotated[[ann]])
    keep <- is.finite(x) & is.finite(y)
    if (sum(keep) < 5) return(NULL)

    cor_test <- suppressWarnings(cor.test(x[keep], y[keep], method = "spearman"))
    tibble(
      log2FC_Column = fc_col,
      Organelle     = ann,
      r             = unname(cor_test$estimate),
      p             = cor_test$p.value
    )
  })
})



# --- 3. Summary heatmap (log2FC × Organelle)
org_corr_mat <- org_corr_df %>%
  select(log2FC_Column, Organelle, r) %>%
  pivot_wider(names_from = Organelle, values_from = r) %>%
  column_to_rownames("log2FC_Column") %>%
  as.matrix()

# Extract rownames from org_corr_mat (log2FC columns)
annotation_row <- tibble(Sample = rownames(org_corr_mat)) %>%
  mutate(
    Genotype = if_else(str_detect(Sample, "^log2FC_Ctrl"), "Ctrl", "ASAH1"),
    Fraction = case_when(
      str_detect(Sample, "_Soma")  ~ "Soma",
      str_detect(Sample, "_Axon")  ~ "Axon",
      TRUE                         ~ "Whole-cell"
    )
  ) %>%
  column_to_rownames("Sample")


# Replace NA with 0 (or leave NA if you prefer gaps)
org_corr_mat[is.na(org_corr_mat)] <- 0

axonprotCorr <- pheatmap(org_corr_mat,
         color = rev(RColorBrewer::brewer.pal(11, "RdYlBu")),
         annotation_row = annotation_row,                
         annotation_colors = ann_colors,                
         na_col = "grey90",
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         fontsize = 8,
         cellheight = 10,
         cellwidth = 10,
         border_color = NA, 
         main = "log2FC × Organelle Correlation")

axonprotCorr



# --- 4. Save heatmap as PDF and csv file 
pdf(file.path(out_dir_diff136_corrplots, "axonprotCorr.pdf"),
    width = 12, height = 16, useDingbats = FALSE)
print(axonprotCorr)
dev.off()

write.csv(org_corr_mat,
          file = file.path(out_dir_diff136_corrplots, "axonprotCorr.csv"),
          row.names = TRUE)



# --- 5. Faceted correlation plots (per-organelle, KO×KO)
# Function to plot KO×KO correlation for a given annotation
plot_ko_corr_matrix <- function(organelle_name, df = diff136_df_annotated) {
  gene_filter <- df[[organelle_name]] == 1
  mat <- df[gene_filter, log2fc_cols, drop = FALSE]

  if (nrow(mat) < 5) return(NULL)

  corr_mat <- cor(mat, use = "pairwise.complete.obs", method = "spearman")

  pheatmap(
    corr_mat,
    main = organelle_name,
    color = rev(brewer.pal(11, "RdYlBu")),
    silent = TRUE,
    cellheight = 15,
    cellwidth  = 15,
    na_col = "grey90",
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    border_color = NA,
    fontsize = 6
  )
}



# --- 6. Apply to all annotations
heatmap_list <- lapply(annotation_cols, function(org) {
  if (!org %in% colnames(diff136_df_annotated)) return(NULL)
  plot_ko_corr_matrix(org)
})
heatmap_list <- Filter(Negate(is.null), heatmap_list)



# --- 7. Save all in a faceted PDF
pdf(file.path(out_dir_diff136_corrplots, "diff136_log2FC_annotation_corr_facet.pdf"),
    width = 12, height = 16, useDingbats = FALSE)
print(axonprotCorr)
dev.off()



# --- 8. make subset of comparisons, plot heatmap and save pdf 
selected_samples <- c(
  "log2FC_ASAH1_Axon.ASAH1_Soma",
  "log2FC_ASAH1_Axon.ASAH1",
  "log2FC_ASAH1_Soma.ASAH1",
  "log2FC_ASAH1_Soma.Ctrl_Soma",
  "log2FC_ASAH1_Axon.Ctrl_Axon",
  "log2FC_ASAH1.Ctrl",
  "log2FC_Ctrl_Axon.Ctrl_Soma",
  "log2FC_Ctrl_Axon.Ctrl",
  "log2FC_Ctrl_Soma.Ctrl"
)

# Subset matrix and annotations
org_corr_subset <- org_corr_mat[rownames(org_corr_mat) %in% selected_samples, , drop = FALSE]
annotation_row_subset <- annotation_row[rownames(org_corr_subset), , drop = FALSE]

# Create heatmap
axonprotCorr_subset <- pheatmap(org_corr_subset,
  color = rev(RColorBrewer::brewer.pal(11, "RdYlBu")),
  annotation_row = annotation_row_subset,
  annotation_colors = ann_colors,
  na_col = "grey90",
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  fontsize = 8,
  cellheight = 10,
  cellwidth = 10,
  border_color = NA,
  main = "log2FC × Organelle Correlation (Selected Samples)"
)

# Save to PDF
pdf(file.path(out_dir_diff136_corrplots, "axonprotCorr_subset.pdf"),
    width = 10, height = 12, useDingbats = FALSE)
print(axonprotCorr_subset)
dev.off()



# --- 9. Apply to all annotations
plot_ko_corr_matrix_select <- function(organelle_name, df = diff136_df_annotated, log2fc_subset = selected_samples) {
  gene_filter <- df[[organelle_name]] == 1
  mat <- df[gene_filter, log2fc_subset, drop = FALSE]

  if (nrow(mat) < 5) return(NULL)

  corr_mat <- cor(mat, use = "pairwise.complete.obs", method = "spearman")

  pheatmap(
    corr_mat,
    main = organelle_name,
    color = rev(brewer.pal(11, "RdYlBu")),
    silent = TRUE,
    cellheight = 15,
    cellwidth  = 15,
    na_col = "grey90",
    cluster_rows = TRUE,
    cluster_cols = TRUE,
    border_color = NA,
    fontsize = 6
  )
}

# Build corr matrices for all annotations and save for later faceting 
heatmap_list_selected <- lapply(annotation_cols, function(org) {
  if (!org %in% colnames(diff136_df_annotated)) return(NULL)
  plot_ko_corr_matrix_select(org, log2fc_subset = selected_samples)
})
heatmap_list_selected <- Filter(Negate(is.null), heatmap_list_selected)

# Save to PDF
pdf(file.path(out_dir_diff136_corrplots, "diff136_selected_log2FC_annotation_corr_facet.pdf"), width = 35, height = 35, useDingbats = FALSE)
grid.arrange(grobs = lapply(heatmap_list_selected, `[[`, "gtable"), ncol = 4)
dev.off()


```



## IIIa. Barplots of mean(log2FC) of each organelle annotations arcross all sample comparisons
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# barplots of mean(log2FC) of each organelle annotations across all sample comparisons
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1. Define relevant log2FC and annotation columns
log2fc_cols <- grep("^log2FC_", colnames(diff136_df_annotated), value = TRUE)

# Filter binary annotation columns (0/1 or NA only)
annotation_cols <- setdiff(colnames(diff136_df_annotated), log2fc_cols)
annotation_cols <- annotation_cols[
  sapply(diff136_df_annotated[, annotation_cols], function(x) all(x %in% c(0, 1, NA)))
]

# Drop unwanted annotations
annotation_cols <- setdiff(annotation_cols, c("Autophagy_det", "EndoDetailLoac"))


# --- Step 2. Reshape to long format for annotation × log2FC mapping
long_df <- diff136_df_annotated %>%
  select(all_of(c("Gene.Symbol", log2fc_cols, annotation_cols))) %>%
  pivot_longer(cols = all_of(log2fc_cols), names_to = "Log2FC", values_to = "value") %>%
  pivot_longer(cols = all_of(annotation_cols), names_to = "Annotation", values_to = "is_annotated") %>%
  filter(is_annotated == 1 & is.finite(value))


# --- Step 3. Compute mean log2FC per organelle annotation
mean_log2fc_df <- long_df %>%
  group_by(Log2FC, Annotation) %>%
  summarise(mean_log2FC = mean(value, na.rm = TRUE), .groups = "drop")


# --- Step 4. Shared x-axis range calculation
xlims <- range(mean_log2fc_df$mean_log2FC, na.rm = TRUE)

# --- 4a. Facet plot across all log2FCs with fixed x-axis
loc_dist_overview_all <- ggplot(mean_log2fc_df, aes(x = reorder(Annotation, mean_log2FC), y = mean_log2FC)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  coord_flip(ylim = xlims) +
  facet_wrap(~ Log2FC, ncol = 3) +
  labs(x = NULL, y = "Mean log2FC", title = "Mean log2FC per Organelle Annotation (All)") +
  theme_bw(base_size = 8)

ggsave(file.path(out_dir_diff136_organelle_dist, "diff136_loc_dist_overview_all.pdf"),
  loc_dist_overview_all,
  width = 14, height = 12, device = cairo_pdf
)

# --- 4b. Filter for user-specified subset
subset_log2fc <- c(
  "log2FC_ASAH1_Axon.ASAH1_Soma",
  "log2FC_ASAH1_Axon.ASAH1",
  "log2FC_ASAH1_Soma.ASAH1",
  "log2FC_ASAH1_Soma.Ctrl_Soma",
  "log2FC_ASAH1_Axon.Ctrl_Axon",
  "log2FC_ASAH1.Ctrl",
  "log2FC_Ctrl_Axon.Ctrl_Soma",
  "log2FC_Ctrl_Axon.Ctrl",
  "log2FC_Ctrl_Soma.Ctrl"
)

mean_log2fc_subset_df <- mean_log2fc_df %>% filter(Log2FC %in% subset_log2fc)

loc_dist_overview_subset <- ggplot(mean_log2fc_subset_df, aes(x = reorder(Annotation, mean_log2FC), y = mean_log2FC)) +
  geom_col(fill = "steelblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  coord_flip(ylim = xlims) +
  facet_wrap(~ Log2FC, ncol = 3) +
  labs(x = NULL, y = "Mean log2FC", title = "Mean log2FC per Organelle Annotation (Selected)") +
  theme_bw(base_size = 8)


# --- Step 5. Save to PDF
ggsave(file.path(out_dir_diff136_organelle_dist, "diff136_loc_dist_overview_selected.pdf"),
  loc_dist_overview_subset,
  width = 14, height = 12, device = cairo_pdf
)




# ─────────────────────────────────────────────────────────────────────────────
# barplots of mean(log2FC) of each organelle annotations across all sample comparisons
# selected annotations  
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 6. Manual Subset of comparisons for function 
subset2_log2fc <- c(
  "log2FC_ASAH1_Soma.Ctrl_Soma",
  "log2FC_ASAH1_Axon.Ctrl_Axon"
)

mean2_log2fc_subset_df <- mean_log2fc_df %>% 
  filter(Annotation != "Nucleus") %>% 
  filter(Log2FC %in% subset2_log2fc)

loc_dist_overview_subset2 <- ggplot(mean2_log2fc_subset_df, aes(x = reorder(Annotation, mean_log2FC), y = mean_log2FC)) +
  geom_col(fill = "dodgerblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  #coord_flip(ylim = xlims) +
  coord_flip() +
  facet_wrap(~ Log2FC, ncol = 3) +
  labs(x = NULL, y = "Mean log2FC", title = "Mean log2FC per Organelle Annotation (Selected)") +
  theme_bw(base_size = 6) +
  theme(
   panel.grid = element_blank() 
  )


# --- Step 7. Save to PDF
ggsave(file.path(out_dir_diff136_organelle_dist, "diff136_loc_dist_overview_selected_directComp.pdf"),
  loc_dist_overview_subset2,
  width = 3, height = 4, device = cairo_pdf
)



# ─────────────────────────────────────────────────────────────────────────────
# barplots of mean(log2FC) of each organelle annotations across all sample comparisons
# selected annotations  
# sorted in decreasing manner 
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 8a. Define order based on Axon comparison
axon_order <- mean2_log2fc_subset_df %>%
  filter(Log2FC == "log2FC_ASAH1_Axon.Ctrl_Axon") %>%
  arrange(mean_log2FC) %>%
  pull(Annotation)

# --- Step 8b. Apply this order as factor levels for all comparisons
mean2_log2fc_subset_df <- mean2_log2fc_subset_df %>%
  filter(Annotation != "Nucleus") %>% 
  mutate(Annotation = factor(Annotation, levels = axon_order))

# --- Step 8c. Plot with consistent order
loc_dist_overview_subset3 <- ggplot(
  mean2_log2fc_subset_df,
  aes(x = Annotation, y = mean_log2FC)
) +
  geom_col(fill = "dodgerblue") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  coord_flip() +
  facet_wrap(~ Log2FC, ncol = 2) +
  labs(x = NULL, y = "Mean log2FC",
       title = "Mean log2FC per Organelle Annotation\n(Prioritized by Axon Order)") +
  theme_bw(base_size = 6) +
  theme(panel.grid = element_blank())


# --- Step 9. Save to PDF
ggsave(file.path(out_dir_diff136_organelle_dist, "diff136_loc_dist_overview_selected_directComp_decs.pdf"),
  loc_dist_overview_subset3,
  width = 3, height = 4, device = cairo_pdf
)

```


## IIIb. Barplots of WC-norm mean(log2FC) of select annotations (also RoR for the norm plots )
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# barplots of mean(log2FC) of each organelle annotations across all sample comparisons
# internally normalized comparisons
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1. Manual Subset of internal norm comparisons
subset3_log2fc <- c(
  "log2FC_ASAH1_Axon.ASAH1",
  "log2FC_Ctrl_Axon.Ctrl"
)

mean3_log2fc_subset_df <- mean_log2fc_df %>% 
  filter(Annotation != "Nucleus") %>% 
  filter(Log2FC %in% subset3_log2fc)

# --- Step 2a. Define order based on Axon.ASAH1 comparison
axon_norm_order2 <- mean3_log2fc_subset_df %>%
  filter(Log2FC == "log2FC_ASAH1_Axon.ASAH1") %>%
  arrange(mean_log2FC) %>%
  pull(Annotation)

# --- Step 2b. Apply this order as factor levels for both comparisons
mean3_log2fc_subset_df <- mean3_log2fc_subset_df %>%
  mutate(Annotation = factor(Annotation, levels = axon_norm_order2))

# --- Step 3. Plot with consistent order 
loc_dist_overview_subset_norm <- ggplot(
  mean3_log2fc_subset_df,
  aes(x = Annotation, y = mean_log2FC)
) +
  geom_col(fill = "dodgerblue2") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  coord_flip() +
  facet_wrap(~ Log2FC, ncol = 2) +
  labs(x = NULL, y = "Mean log2FC",
       title = "Mean log2FC per Organelle Annotation\n(Internal Normalization)") +
  theme_bw(base_size = 6) +
  theme(panel.grid = element_blank())

# --- Step 4. Save to PDF
ggsave(file.path(out_dir_diff136_organelle_dist, "diff136_loc_dist_overview_selected_directComp_internalNorm.pdf"), 
       loc_dist_overview_subset_norm, width = 3, height = 4, device = cairo_pdf)





# ─────────────────────────────────────────────────────────────────────────────
# barplots with internal norm comparisons + ratio-of-ratios
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 3. Compute ratio-of-ratios
ratio_df <- mean3_log2fc_subset_df %>%
  dplyr::select(Log2FC, Annotation, mean_log2FC) %>%
  pivot_wider(names_from = Log2FC, values_from = mean_log2FC) %>%
  mutate(ratio_of_ratios = `log2FC_ASAH1_Axon.ASAH1` / `log2FC_Ctrl_Axon.Ctrl`,
         Log2FC = "RatioOfRatios") %>%
  dplyr::select(Annotation, Log2FC, mean_log2FC = ratio_of_ratios)

# --- Step 4. Combine with original df
combined_df <- bind_rows(mean3_log2fc_subset_df, ratio_df) %>%
  mutate(Annotation = factor(Annotation, levels = axon_norm_order2))

# --- Step 5. Plot with 3 facets
loc_dist_overview_subset_ratio <- ggplot(
  combined_df,
  aes(x = Annotation, y = mean_log2FC)
) +
  geom_col(fill = "dodgerblue2") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  coord_flip() +
  facet_wrap(~ Log2FC, ncol = 3) +
  labs(x = NULL, y = "Mean log2FC",
       title = "Mean log2FC per Organelle Annotation\n(Internal Norm + Ratio-of-Ratios)") +
  theme_bw(base_size = 6) +
  theme(panel.grid = element_blank())

# --- Step 6. Save to PDF
ggsave(file.path(out_dir_diff136_organelle_dist, "diff136_loc_dist_overview_selected_directComp_internalNorm_ratio.pdf"),
       loc_dist_overview_subset_ratio,
       width = 5, height = 4, device = cairo_pdf)

```





## IIIb++.
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# IIIb-plus. Resort by RoR, save sorted plot, extract top-5 annotations,
# make Euler plots, and run GO on sig up/down for those annotations
# ─────────────────────────────────────────────────────────────────────────────

# # Safety: rebuild the inputs if current session does not have them
# if (!exists("mean3_log2fc_subset_df") || !exists("ratio_df")) {
#   subset3_log2fc <- c("log2FC_ASAH1_Axon.ASAH1", "log2FC_Ctrl_Axon.Ctrl")
# 
#   mean3_log2fc_subset_df <- mean_log2fc_df %>% 
#     filter(Annotation != "Nucleus") %>% 
#     filter(Log2FC %in% subset3_log2fc)
# 
#   axon_norm_order2 <- mean3_log2fc_subset_df %>%
#     filter(Log2FC == "log2FC_ASAH1_Axon.ASAH1") %>%
#     arrange(mean_log2FC) %>%
#     pull(Annotation)
# 
#   mean3_log2fc_subset_df <- mean3_log2fc_subset_df %>%
#     mutate(Annotation = factor(Annotation, levels = axon_norm_order2))
# 
#   ratio_df <- mean3_log2fc_subset_df %>%
#     dplyr::select(Log2FC, Annotation, mean_log2FC) %>%
#     tidyr::pivot_wider(names_from = Log2FC, values_from = mean_log2FC) %>%
#     mutate(ratio_of_ratios = `log2FC_ASAH1_Axon.ASAH1` / `log2FC_Ctrl_Axon.Ctrl`,
#            Log2FC = "RatioOfRatios") %>%
#     dplyr::select(Annotation, Log2FC, mean_log2FC = ratio_of_ratios)
# 
#   combined_df <- bind_rows(mean3_log2fc_subset_df, ratio_df) %>%
#     mutate(Annotation = factor(Annotation, levels = axon_norm_order2))
# }

# --- 1. RoR-sorted plot
ror_sort_order_vec <- ratio_df %>%
  arrange(desc(mean_log2FC)) %>%
  pull(Annotation)

# mark which facets get the restricted range
combined_df_sortedByRoR <- combined_df_sortedByRoR %>%
  mutate(y_clamped = ifelse(Log2FC %in% c("log2FC_ASAH1_Axon.ASAH1",
                                          "log2FC_Ctrl_Axon.Ctrl"),
                            pmax(pmin(mean_log2FC, 0.5), -0.5),
                            mean_log2FC))

loc_dist_overview_subset_ratio_sorted <- ggplot(
  combined_df_sortedByRoR,
  aes(x = Annotation, y = y_clamped)
) +
  geom_col(fill = "dodgerblue2") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  coord_flip() +
  facet_wrap(~ Log2FC, ncol = 3, scales = "free_y") +
  labs(x = NULL, y = "Mean log2FC",
       title = "Mean log2FC per Organelle Annotation\n(Internal Norm + Ratio-of-Ratios, RoR-sorted)") +
  theme_bw(base_size = 6) +
  theme(panel.grid = element_blank())

ggsave(file.path(out_dir_diff136_organelle_dist,"diff136_loc_dist_overview_selected_directComp_internalNorm_rorsorted_clamped.pdf"),
       loc_dist_overview_subset_ratio_sorted, width = 5, height = 4, device = cairo_pdf)



# Ensure we have the RoR sort order
if (!exists("ror_sort_order_vec")) {
  ror_sort_order_vec <- ratio_df %>%
    arrange(desc(mean_log2FC)) %>%
    pull(Annotation)
}

# Build internal-norm-only df, ordered by RoR and clamped
comparisons_internal_norm <- c("log2FC_ASAH1_Axon.ASAH1",
                               "log2FC_Ctrl_Axon.Ctrl")

combined_df_internalNorm_rorSorted <- combined_df %>%
  filter(Log2FC %in% comparisons_internal_norm) %>%
  mutate(
    Annotation = factor(Annotation, levels = ror_sort_order_vec),
    mean_log2FC = pmax(pmin(mean_log2FC, 0.6), -0.6)
  )

loc_dist_overview_internalNorm_rorSorted <- ggplot(
  combined_df_internalNorm_rorSorted,
  aes(x = Annotation, y = mean_log2FC)
) +
  geom_col(fill = "dodgerblue2") +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  coord_flip() +
  # reverse limits so highest-RoR annotations appear at the top
  scale_x_discrete(limits = ror_sort_order_vec) +
  facet_wrap(~ Log2FC, ncol = 2, scales = "free_y") +
  labs(x = NULL, y = NULL,
       title = "Mean log2FC per Organelle Annotation\n(Internal Norm Only, RoR order, clamped)") +
  theme_bw(base_size = 6) +
  theme(panel.grid = element_blank())

ggsave(
  file.path(out_dir_diff136_organelle_dist,"diff136_loc_dist_overview_selected_directComp_internalNorm_clamped_rorSorted.pdf"),
  loc_dist_overview_internalNorm_rorSorted,width = 4, height = 4, device = cairo_pdf)





# --- 2. CSV of genes in top 5 annotations by RoR and Euler overlap plots
suppressPackageStartupMessages(require(eulerr))

top5_annotations_by_ror <- ratio_df %>%
  arrange(desc(mean_log2FC)) %>%
  slice_head(n = 5) %>%
  pull(Annotation) %>%
  as.character()

# helper to get gene sets per annotation for internal-norm comparisons
get_internal_norm_gene_sets <- function(ann_term, df) {
  sub_df <- df %>% filter(.data[[ann_term]] == 1)
  asah1_pos <- sub_df %>%
    filter(is.finite(log2FC_ASAH1_Axon.ASAH1) & log2FC_ASAH1_Axon.ASAH1 > 0) %>%
    pull(Gene.Symbol) %>% unique()
  ctrl_pos <- sub_df %>%
    filter(is.finite(log2FC_Ctrl_Axon.Ctrl) & log2FC_Ctrl_Axon.Ctrl > 0) %>%
    pull(Gene.Symbol) %>% unique()
  list(ASAH1_only = setdiff(asah1_pos, ctrl_pos),
       Ctrl_only  = setdiff(ctrl_pos, asah1_pos),
       Common     = intersect(asah1_pos, ctrl_pos),
       ASAH1_all  = asah1_pos,
       Ctrl_all   = ctrl_pos)
}

# build table
top5_gene_overlap_tbl <- purrr::map_dfr(top5_annotations_by_ror, function(ann_term) {
  gs <- get_internal_norm_gene_sets(ann_term, diff136_df_annotated)
  tibble(
    Annotation = ann_term,
    Set        = c("ASAH1_only", "Ctrl_only", "Common"),
    N          = c(length(gs$ASAH1_only), length(gs$Ctrl_only), length(gs$Common)),
    Genes      = c(paste(gs$ASAH1_only, collapse = ";"),
                   paste(gs$Ctrl_only,  collapse = ";"),
                   paste(gs$Common,     collapse = ";"))
  )
})

csv_top5_genes_path <- file.path(out_dir_diff136_organelle_dist, "top5_byRoR_gene_overlap_ASAH1_vs_Ctrl.csv")
write.csv(top5_gene_overlap_tbl, csv_top5_genes_path, row.names = FALSE)

# Euler plots per annotation
euler_out_dir_top5 <- file.path(out_dir_diff136_organelle_dist, "euler_top5_byRoR")
dir.create(euler_out_dir_top5, showWarnings = FALSE, recursive = TRUE)

invisible(lapply(top5_annotations_by_ror, function(ann_term) {
  gs <- get_internal_norm_gene_sets(ann_term, diff136_df_annotated)
  fit2 <- eulerr::euler(list(ASAH1 = gs$ASAH1_all, Ctrl = gs$Ctrl_all))
  p_euler <- plot(fit2, labels = TRUE, quantities = TRUE)
  grDevices::cairo_pdf(file.path(euler_out_dir_top5, paste0("euler_", ann_term, "_ASAH1_vs_Ctrl.pdf")),
                       width = 3.5, height = 3.0)
  print(p_euler)
  dev.off()
}))

# 3) GO analysis on sig up and down genes for the same top 5 annotations
sig_gene_csv_path <- file.path(out_dir_diff136_organelle_dist, "diff136_sig_hits_annotation_geneList.csv")
stopifnot(file.exists(sig_gene_csv_path))

sig_hits_tbl <- read.csv(sig_gene_csv_path, stringsAsFactors = FALSE)

# align to the selected top 5 only
go_ann_to_use <- intersect(unique(sig_hits_tbl$Annotation), top5_annotations_by_ror)

# helper to turn semicolon list into vector
split_genes <- function(x) {
  if (is.na(x) || !nzchar(x)) character(0) else unlist(strsplit(x, ";"))
}

# run GO per annotation and direction
invisible(lapply(go_ann_to_use, function(ann_term) {
  lapply(c("up", "down"), function(dir_flag) {
    gene_vec <- sig_hits_tbl %>%
      filter(Annotation == ann_term, SigStatus == dir_flag) %>%
      pull(GeneList) %>%
      purrr::map_chr(identity) %>%
      paste(collapse = ";") %>%
      split_genes() %>%
      unique()

    if (length(gene_vec) >= 5) {
      plot_topGO_for_geneset(
        gene_set = gene_vec,
        background_genes = unique(diff136_df_annotated$Gene.Symbol),
        tag = paste0("Top5_", ann_term, "_", dir_flag),
        out_dir = out_dir_diff136_rainbow_GOror
      )
    }
    NULL
  })
}))
```

## IIIc. Barplots of mean(log2FC) of synaptic annotations
```{r}
# --- Step 1. Define columns and color mapping
plot_cols <- c("log2FC_ASAH1_Axon.ASAH1_Soma", "log2FC_Ctrl_Axon.Ctrl_Soma")
condition_labels <- c("ASAH1", "Ctrl")
names(condition_labels) <- plot_cols

fill_colors <- c("ASAH1" = "dodgerblue", "Ctrl" = "grey70")

selected_annotations <- c("SVfusion", "Svendocytosis", "Svexocytosis", 
                          "SynapseSVs", "Presynaptic", "Postsynaptic","vATPase")

vatpase_genes <- c("ATP6V1G1", "ATP6AP2", "ATP6V1B2", "ATP6V1C1", "ATP6V1E1", "ATP6V1A", "ATP6V0D1",
                   "ATP6AP1", "ATP6V1F", "ATP6V0A1", "ATP6V0A2", "ATP6V1H", "ATP6V1D", "ROGDI",
                   "SYP", "DMXL1", "DMXL2", "PODXL", "PODXL2")


# --- Step 2. Prepare data
summary_sv_df <- diff136_df_annotated %>%
  filter(Gene.Symbol %in% vatpase_genes | 
           rowSums(across(all_of(selected_annotations)), na.rm = TRUE) > 0) %>%
  select(Gene.Symbol, all_of(plot_cols), all_of(selected_annotations)) %>%
  pivot_longer(cols = all_of(plot_cols), names_to = "Comparison", values_to = "log2FC") %>%
  pivot_longer(cols = all_of(selected_annotations), names_to = "Annotation", values_to = "is_annotated") %>%
  filter(is_annotated == 1, is.finite(log2FC)) %>%
  mutate(Condition = recode(Comparison, !!!condition_labels)) %>%
  group_by(Annotation, Condition) %>%
  summarise(
    mean = mean(log2FC, na.rm = TRUE),
    sem  = sd(log2FC, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )


# --- Step 3. Plot means + SEM
barplot_SV_means_sem <- ggplot(summary_sv_df, aes(x = Annotation, y = mean, fill = Condition)) +
  geom_col(position = position_dodge(width = 0.8), width = 0.8, color = "black") +
  geom_errorbar(aes(ymin = mean - sem, ymax = mean + sem), 
                position = position_dodge(width = 0.8), width = 0.2) +
  scale_fill_manual(values = fill_colors) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
  theme_bw(base_size = 6) +
  theme(panel.grid = element_blank()) +
  labs(
    title = "Mean log2FC ± SEM for Synaptic Annotations",
    x = NULL,
    y = "log2FC",
    fill = "Condition"
  )

barplot_SV_means_sem


# --- Step 4. Save PDF
ggsave(file.path(out_dir_diff136_organelle_dist, "diff136_vatpase_synaptic_barplot_means_sem.pdf"),
       barplot_SV_means_sem, width = 3, height = 3, device = cairo_pdf)


```


## IIIe.  Absolute & RoR comparison of Axonal Proteome 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Analysis of axonal proteome in Ctrl & ASAH1-/- neurons 
# do both absolute (in genotype comparison to soma fraction) and ratio of ratio (RoR),
# norm. to WC in genotype 
# ─────────────────────────────────────────────────────────────────────────────

# Calculate RoR and call significance:
# --- Step 1. Calculate RoR
diff136_df_annotated <- diff136_df_annotated %>%
  mutate(RoR_ASAH1_Axon = `log2FC_ASAH1_Axon.ASAH1` - `log2FC_Ctrl_Axon.Ctrl`)

# --- Step 2. Define threshold for up/down calls (adjust as needed)
fc_thresh <- 0.585  # ~1.5-fold

# --- Step 3. Call significance
diff136_df_annotated <- diff136_df_annotated %>%
  mutate(sig_RoR_ASAH1_Axon = case_when(
    is.na(RoR_ASAH1_Axon)        ~ NA_character_,
    RoR_ASAH1_Axon > fc_thresh   ~ "up",
    RoR_ASAH1_Axon < -fc_thresh  ~ "down",
    TRUE                         ~ "n.s."
  ))


# --- Step 4. Define relevant sig columns and annotations
sig_cols_abs <- c("sig_ASAH1_Axon.ASAH1_Soma", "sig_Ctrl_Axon.Ctrl_Soma", "sig_ASAH1_Axon.Ctrl_Axon")
sig_cols_ror <- c("sig_RoR_ASAH1_Axon")

# Binary annotations (0/1 or NA)
annotation_cols <- setdiff(colnames(diff136_df_annotated), c(sig_cols_abs, sig_cols_ror))
annotation_cols <- annotation_cols[
  sapply(diff136_df_annotated[, annotation_cols], function(x) all(x %in% c(0, 1, NA)))
]
annotation_cols <- setdiff(annotation_cols, c("Autophagy (Detailed)", "EndoDetailLoac"))

# --- Step 4a. Long-format: ABS comparisons
sig_long_abs <- diff136_df_annotated %>%
  select(Gene.Symbol, all_of(sig_cols_abs), all_of(annotation_cols)) %>%
  pivot_longer(cols = all_of(sig_cols_abs), names_to = "Comparison", values_to = "SigStatus") %>%
  pivot_longer(cols = all_of(annotation_cols), names_to = "Annotation", values_to = "is_annotated") %>%
  filter(is_annotated == 1 & SigStatus %in% c("up", "down")) %>%
  mutate(Type = "Absolute")

# --- Step 4b. Long-format: RoR comparisons
sig_long_ror <- diff136_df_annotated %>%
  select(Gene.Symbol, all_of(sig_cols_ror), all_of(annotation_cols)) %>%
  pivot_longer(cols = all_of(sig_cols_ror), names_to = "Comparison", values_to = "SigStatus") %>%
  pivot_longer(cols = all_of(annotation_cols), names_to = "Annotation", values_to = "is_annotated") %>%
  filter(is_annotated == 1 & SigStatus %in% c("up", "down")) %>%
  mutate(Type = "RatioOfRatio")

# --- Step 4c. Combine
sig_long_df <- bind_rows(sig_long_abs, sig_long_ror)

# --- Step 5. Count per Annotation × Comparison × Direction
sig_summary <- sig_long_df %>%
  group_by(Type, Comparison, Annotation, SigStatus) %>%
  summarise(n = n(), .groups = "drop")

# --- Step 6. Save gene-level summary
sig_gene_summary <- sig_long_df %>%
  group_by(Type, Comparison, Annotation, SigStatus) %>%
  summarise(
    n = n(),
    GeneList = paste(unique(Gene.Symbol), collapse = ";"),
    .groups = "drop"
  ) %>%
  filter(Annotation != "Nucleus")

sig_summary <- sig_summary %>% filter(Annotation != "Nucleus")
sig_gene_summary <- sig_gene_summary %>% filter(Annotation != "Nucleus")



# --- Step 7. Plot
# --- Absolute plot
sig_plot_abs <- ggplot(filter(sig_summary, Type == "Absolute"),
                       aes(x = reorder(Annotation, n), y = n, fill = SigStatus)) +
  geom_col(position = "stack") +
  coord_flip() +
  facet_wrap(~ Comparison, ncol = 1) +
  scale_fill_manual(values = c(up = "grey70", down = "dodgerblue")) +
  labs(x = NULL, y = "# Significant Hits", title = "Significant Hits – Absolute Comparisons") +
  theme_bw(base_size = 8) +
  theme(panel.grid = element_blank())

ggsave(file.path(out_dir_diff136_organelle_dist,"diff136_sig_hits_annotation_absolute_barplot.pdf"),
  sig_plot_abs,
  width = 5, height = 8, device = cairo_pdf
)


# --- RoR plot
sig_plot_ror <- ggplot(filter(sig_summary, Type == "RatioOfRatio"),
                       aes(x = reorder(Annotation, n), y = n, fill = SigStatus)) +
  geom_col(position = "stack") +
  coord_flip() +
  facet_wrap(~ Comparison, ncol = 1) +
  scale_fill_manual(values = c(up = "grey70", down = "dodgerblue")) +
  labs(x = NULL, y = "# Significant Hits", title = "Significant Hits – Ratio of Ratio Comparisons") +
  theme_bw(base_size = 8) +
  theme(panel.grid = element_blank())

ggsave(file.path(out_dir_diff136_organelle_dist, "diff136_sig_hits_annotation_ror_barplot.pdf"),
  sig_plot_ror,
  width = 6, height = 8, device = cairo_pdf
)

# --- Step 8. Save gene-level summary
sig_gene_summary <- sig_long_df %>%
  group_by(Type, Comparison, Annotation, SigStatus) %>%
  summarise(
    n = n(),
    GeneList = paste(unique(Gene.Symbol), collapse = ";"),
    .groups = "drop"
  )

write.csv(
  sig_gene_summary,
  file = file.path(out_dir_diff136_organelle_dist, "diff136_sig_hits_annotation_geneList.csv"),
  row.names = FALSE
)
```


# IV. Rainbowplot of annotations markers 
## IVa. Rainbowplot of Lysosome & vATPase Members vs nuclear markers 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Rainfall plot for highlighting protein localization
# Lysosome & vATPase Members vs nuclear markers 
# ─────────────────────────────────────────────────────────────────────────────
library(ggplot2)
library(ggdist)
#install.packages("gghalves")
library(gghalves)


# --- Step 0. Define vATPase genes 
vatpase_genes <- c("ATP6V1G1", "ATP6AP2", "ATP6V1B2", "ATP6V1C1", "ATP6V1E1", "ATP6V1A", "ATP6V0D1",
                   "ATP6AP1", "ATP6V1F", "ATP6V0A1", "ATP6V0A2", "ATP6V1H", "ATP6V1D", "ROGDI",
                   "SYP", "DMXL1", "DMXL2", "PODXL", "PODXL2")


# # --- Step 1: Prepare scatter_df with categorical y-axis
scatter_df <- diff136_df_annotated %>%
  filter(Gene.Symbol %in% vatpase_genes | Nucleus == 1 | `Lysosome` == 1) %>%
  mutate(
    y_group = case_when(
      Gene.Symbol %in% vatpase_genes      ~ "vATPase",
      `Lysosome` == 1               ~ "Lysosome",
      Nucleus == 1                        ~ "Nucleus",
      TRUE                                ~ NA_character_
    )
  ) %>%
  filter(!is.na(y_group))

# put nucleus at bottom 
scatter_df <- scatter_df %>%
  mutate(
    y_group = factor(y_group, levels = c("Nucleus", "Lysosome", "vATPase"))
  )

# --- Step 2. create plot 
ASAH1_axonXsoma_loc_rainbowplot <- ggplot(scatter_df, aes(y = log2FC_ASAH1_Axon.ASAH1_Soma, x = y_group, fill = y_group)) + 
  # 1. Aligned half-point jitter
  gghalves::geom_half_point(
    side = "b",            # bottom side (now works because axis is flipped)
    range_scale = 0.2,
    alpha = 0.2,
    size = 1,
    shape = 16
  ) +
  
  # 2. Add dashed zero line (horizontal now)
  geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.5) +

  # 3. Half-eye distribution
  ggdist::stat_halfeye(
    adjust = 2, 
    width = 0.6, 
    .width = 0, 
    justification = -0.2, 
    point_colour = NA
  ) +

  # 4. Boxplot
  geom_boxplot(
    width = 0.15, 
    outlier.shape = NA
  ) +

  # 5. Coloring & theming
  scale_fill_manual(values = c(
    "Nucleus"   = "grey30",
    "Lysosome"  = "#bdc9e1",
    "vATPase"   = "dodgerblue3"
  )) +
  coord_flip() + ## flip graph so it looks still like landscape mode 
  theme_bw(base_size = 6) +
  labs(y = "log2FC ASAH1 Axon vs Soma", x = NULL, title = "Localization Organelle Distribution in Axon vs Soma") +
  theme(
    panel.grid = element_blank(),
    legend.position = "none"
  )


# --- Step 3. save pdf file 
ggsave(file.path(out_dir_diff136_rainbow, "diff136_lysosome_vATPase_nucleus_scatter.pdf"),
  ASAH1_axonXsoma_loc_rainbowplot,
  width = 10, height = 8, device = cairo_pdf
)

```



## IVb. Rainbowplot of User-select Annotations for axon--soma localization distribution
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Rainfall plot for highlighting protein localization
# user select input 
# ─────────────────────────────────────────────────────────────────────────────
# --- Step  1. Function for plotting user-defined gene sets for axon-soma localization distribution
#    saves single plots and faceted version of the three subcell comparisons
plot_annotation_distribution_batch <- function(df, gene_sets, log2fc_cols, out_dir) {
  if (is.character(gene_sets) && is.null(names(gene_sets))) {
    gene_sets <- setNames(gene_sets, gene_sets)
    gene_df <- purrr::imap_dfr(gene_sets, function(col, label) {
      genes <- df$Gene.Symbol[df[[col]] == 1]
      tibble(Gene.Symbol = genes, y_group = label)
    })
  } else {
    gene_df <- purrr::imap_dfr(gene_sets, ~ tibble(Gene.Symbol = .x, y_group = .y))
  }

  # Helper
  clean_name <- function(x) gsub("[^A-Za-z0-9]+", "_", x)
  default_colors <- c("grey30", "#bdc9e1", "dodgerblue3", "#74a9cf", "#045a8d", "#7fcdbb", "#e34a33", "#fdcc8a")
  fill_colors <- setNames(rep_len(default_colors, length(gene_sets)), names(gene_sets))

  # Collect all for faceting
  full_plot_df <- purrr::map_dfr(log2fc_cols, function(fc) {
    df %>%
      right_join(gene_df, by = "Gene.Symbol") %>%
      filter(!is.na(y_group), is.finite(.data[[fc]])) %>%
      mutate(
        y_group = factor(y_group, levels = names(gene_sets)),
        Log2FC = fc
      )
  })

  # Get shared x-axis limits
  x_limits <- range(full_plot_df[[log2fc_cols[1]]], na.rm = TRUE)
  for (fc in log2fc_cols[-1]) {
    x_limits <- range(c(x_limits, full_plot_df[[fc]]), na.rm = TRUE)
  }

  # --- Save individual plots
  for (fc in log2fc_cols) {
    plot_df <- full_plot_df %>% filter(Log2FC == fc)

    p <- ggplot(plot_df, aes(y = .data[[fc]], x = y_group, fill = y_group)) +
      gghalves::geom_half_point(side = "b", range_scale = 0.2, alpha = 0.2, size = 1, shape = 16) +
      geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.5) +
      ggdist::stat_halfeye(adjust = 2, width = 0.6, .width = 0, justification = -0.2, point_colour = NA) +
      geom_boxplot(width = 0.15, outlier.shape = NA) +
      scale_fill_manual(values = fill_colors) +
      coord_flip(ylim = x_limits, clip = "off") +
      theme_bw(base_size = 6) +
      labs(y = fc, x = NULL, title = paste("Localization Distribution:", fc)) +
      theme(panel.grid = element_blank(), legend.position = "none")

    fname <- paste0("locdist_", clean_name(fc), "_", paste(clean_name(names(gene_sets)), collapse = "_"), ".pdf")
    ggsave(file.path(out_dir, fname), p, width = 4, height = 4, device = cairo_pdf)
  }

  # --- Faceted version
  facet_df <- full_plot_df %>%
    pivot_longer(cols = all_of(log2fc_cols), names_to = "log2fc_col", values_to = "value") %>%
    filter(!is.na(value))

  p_all <- ggplot(facet_df, aes(y = value, x = y_group, fill = y_group)) +
    gghalves::geom_half_point(side = "b", range_scale = 0.2, alpha = 0.2, size = 1, shape = 16) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.5) +
    ggdist::stat_halfeye(adjust = 2, width = 0.6, .width = 0, justification = -0.2, point_colour = NA) +
    geom_boxplot(width = 0.15, outlier.shape = NA) +
    scale_fill_manual(values = fill_colors) +
    coord_flip(ylim = x_limits, clip = "off") +
    facet_wrap(~ log2fc_col, ncol = 1) +
    theme_bw(base_size = 6) +
    labs(y = "log2FC", x = NULL, title = "Localization Distribution Across Comparisons") +
    theme(panel.grid = element_blank(), legend.position = "none")

  fname_all <- paste0("facet_locdist_", paste(clean_name(log2fc_cols), collapse = "_"), "_", paste(clean_name(names(gene_sets)), collapse = "_"), ".pdf")
  ggsave(file.path(out_dir, fname_all), p_all, width = 4, height = 10, device = cairo_pdf)
}



# --- Step 2. Define annotations to be plotted 
#gene_sets <- c("SynGO", "Presynaptic", "Postsynaptic")
#gene_sets <- c("EndoLyso","EarlyEndosome","RecyclingEndosome")
#gene_sets <- c("OXPHOS","Lysosome","Endo_iN_curated_Hundley", "EarlyEndosome","RecyclingEndosome")
#gene_sets <- c("OXPHOS","Golgi","ER")
#gene_sets <- c("Nucleus","Lysosome","NeuroDev","SynapseSVs","SVfusion", "Svendocytosis","Svexocytosis")
gene_sets <- c("Lysosome","EarlyEndosome","RecyclingEndosome","SynapseSVs","SVfusion", "Svendocytosis","Svexocytosis")
gene_sets <- c("Nucleus","Lysosome","EarlyEndosome","RecyclingEndosome","NeuroDev","SynapseSVs","Presynaptic", "Postsynaptic")
gene_sets <- c("Mito","MitoIMS","MitoMatrix","MitoMIM","MitoMOM","OXPHOS","mtComplexI")

# --- Step 3. Define log2FC datasets to be plotted 
log2fc_cols <- c(
  "log2FC_ASAH1_Axon.ASAH1_Soma",
  "log2FC_Ctrl_Axon.Ctrl_Soma",
  "log2FC_ASAH1_Axon.Ctrl_Axon"
)

# --- Step 4. Call function and define output directory
plot_annotation_distribution_batch(
  df          = diff136_df_annotated,
  gene_sets   = gene_sets,
  log2fc_cols = log2fc_cols,
  out_dir     = out_dir_diff136_rainbow
)


# Annotations:
# "Mito","MitoIMS","MitoMatrix","MitoMIM","MitoMOM","OXPHOS","mtComplexI","Golgi","Lysosome"               ,"ER","Cytoplasm","Nucleus","Autophagy","Autophagy_det","SynGO","Endo_iN_curated_Hundley" "SynapseSVs","Presynaptic","Postsynaptic","EndoDetailLoac","NeuroDev","EndoLyso","EarlyEndosome","RecyclingEndosome","SVfusion","Svendocytosis","Svexocytosis"     


```



## IVc. Rainbowplot of User-select Annotations for axon--soma localization distribution
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Rainfall plot for highlighting protein localization
# user select input 
# ─────────────────────────────────────────────────────────────────────────────
# --- Step  1. Function for plotting user-defined gene sets for axon-soma localization distribution
#    saves single plots and faceted version of the three subcell comparisons
plot_annotation_distribution_batch <- function(df, gene_sets, log2fc_cols, out_dir, x_lim_override = NULL) {
  if (is.character(gene_sets) && is.null(names(gene_sets))) {
    gene_sets <- setNames(gene_sets, gene_sets)
    gene_df <- purrr::imap_dfr(gene_sets, function(col, label) {
      genes <- df$Gene.Symbol[df[[col]] == 1]
      tibble(Gene.Symbol = genes, y_group = label)
    })
  } else {
    gene_df <- purrr::imap_dfr(gene_sets, ~ tibble(Gene.Symbol = .x, y_group = .y))
  }

  # Helper
  clean_name <- function(x) gsub("[^A-Za-z0-9]+", "_", x)
  default_colors <- c("grey30", "#bdc9e1", "dodgerblue3", "#74a9cf", "#045a8d", "#7fcdbb", "#e34a33", "#fdcc8a")
  fill_colors <- setNames(rep_len(default_colors, length(gene_sets)), names(gene_sets))

  # Collect all for faceting
  full_plot_df <- purrr::map_dfr(log2fc_cols, function(fc) {
    df %>%
      right_join(gene_df, by = "Gene.Symbol") %>%
      filter(!is.na(y_group), is.finite(.data[[fc]])) %>%
      mutate(
        y_group = factor(y_group, levels = names(gene_sets)),
        Log2FC = fc
      )
  })

  # Determine x-axis limits
  if (!is.null(x_lim_override)) {
    x_limits <- x_lim_override
  } else {
    x_limits <- range(full_plot_df[[log2fc_cols[1]]], na.rm = TRUE)
    for (fc in log2fc_cols[-1]) {
      x_limits <- range(c(x_limits, full_plot_df[[fc]]), na.rm = TRUE)
    }
  }

  # Individual plots
  for (fc in log2fc_cols) {
    plot_df <- full_plot_df %>% filter(Log2FC == fc)

    p <- ggplot(plot_df, aes(y = .data[[fc]], x = y_group, fill = y_group)) +
      gghalves::geom_half_point(side = "b", range_scale = 0.2, alpha = 0.2, size = 1, shape = 16) +
      geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.5) +
      ggdist::stat_halfeye(adjust = 2, width = 0.6, .width = 0, justification = -0.2, point_colour = NA) +
      geom_boxplot(width = 0.15, outlier.shape = NA) +
      scale_fill_manual(values = fill_colors) +
      coord_flip(ylim = x_limits, clip = "off") +
      theme_bw(base_size = 6) +
      labs(y = fc, x = NULL, title = paste("Localization Distribution:", fc)) +
      theme(panel.grid = element_blank(), legend.position = "none")

    fname <- paste0("locdist_", clean_name(fc), "_", paste(clean_name(names(gene_sets)), collapse = "_"), ".pdf")
    ggsave(file.path(out_dir, fname), p, width = 4, height = 4, device = cairo_pdf)
  }

  # Faceted version
  facet_df <- full_plot_df %>%
    pivot_longer(cols = all_of(log2fc_cols), names_to = "log2fc_col", values_to = "value") %>%
    filter(!is.na(value))

  p_all <- ggplot(facet_df, aes(y = value, x = y_group, fill = y_group)) +
    gghalves::geom_half_point(side = "b", range_scale = 0.2, alpha = 0.2, size = 1, shape = 16) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.5) +
    ggdist::stat_halfeye(adjust = 2, width = 0.6, .width = 0, justification = -0.2, point_colour = NA) +
    geom_boxplot(width = 0.15, outlier.shape = NA) +
    scale_fill_manual(values = fill_colors) +
    coord_flip(ylim = x_limits, clip = "off") +
    facet_wrap(~ log2fc_col, ncol = 1) +
    theme_bw(base_size = 6) +
    labs(y = "log2FC", x = NULL, title = "Localization Distribution Across Comparisons") +
    theme(panel.grid = element_blank(), legend.position = "none")

  #fname_all <- paste0("facet_locdist_", paste(clean_name(log2fc_cols), collapse = "_"), "_", paste(clean_name(names(gene_sets)), collapse = "_"), ".pdf")
  fname_all <- paste0("facet_locdist_", length(log2fc_cols), "comparisons_", length(gene_sets), "annotations.pdf")
  ggsave(file.path(out_dir, fname_all), p_all, width = 4, height = 10, device = cairo_pdf)
}



# --- Step 2. Define annotations to be plotted 
#gene_sets <- c("SynGO", "Presynaptic", "Postsynaptic")
#gene_sets <- c("EndoLyso","EarlyEndosome","RecyclingEndosome")
#gene_sets <- c("OXPHOS","Lysosome","Endo_iN_curated_Hundley", "EarlyEndosome","RecyclingEndosome")
#gene_sets <- c("OXPHOS","Golgi","ER")
#gene_sets <- c("Nucleus","Lysosome","NeuroDev","SynapseSVs","SVfusion", "Svendocytosis","Svexocytosis")
gene_sets <- c("Lysosome","EarlyEndosome","RecyclingEndosome","SynapseSVs","SVfusion", "Svendocytosis","Svexocytosis")
gene_sets <- c("Nucleus","Lysosome","EarlyEndosome","RecyclingEndosome","NeuroDev","SynapseSVs","Presynaptic", "Postsynaptic")
gene_sets <- c("Mito","MitoIMS","MitoMatrix","MitoMIM","MitoMOM","OXPHOS","mtComplexI")

# --- Step 3. Define log2FC datasets to be plotted 
log2fc_cols <- c(
  "log2FC_ASAH1_Axon.ASAH1_Soma",
  "log2FC_Ctrl_Axon.Ctrl_Soma",
  "log2FC_ASAH1_Axon.Ctrl_Axon"
)


# --- Step 4. Call function and define output directory
plot_annotation_distribution_batch(
  df          = diff136_df_annotated,
  gene_sets   = gene_sets,
  log2fc_cols = log2fc_cols,
  out_dir     = out_dir_diff136_rainbow,
  x_lim_override = c(-2, 2) #do set manuarl x-lims if necessary
)


```




## IVc. RoR-based Rainbowplot of user-selected annotations 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# Rainfall plot for highlighting protein localization
# RoR-based Rainfall Plot of Protein Localization
# user select input 
# ─────────────────────────────────────────────────────────────────────────────

# --- 1. Add RoR column (if not yet present)
diff136_df_annotated <- diff136_df_annotated %>%
  mutate(RoR_ASAH1_Axon = log2FC_ASAH1_Axon.ASAH1 - log2FC_Ctrl_Axon.Ctrl) %>% 
  mutate(RoR_ASAH1_Soma = log2FC_ASAH1_Soma.ASAH1 - log2FC_Ctrl_Soma.Ctrl)

# --- 2. Function: rainplot for RoR values by gene set
plot_ror_annotation_distribution <- function(df, gene_sets, ror_cols, out_dir, xlim = NULL) {
  # --- 2.1. Prepare gene set annotations
  if (is.character(gene_sets) && is.null(names(gene_sets))) {
    gene_sets <- setNames(gene_sets, gene_sets)
    gene_df <- purrr::imap_dfr(gene_sets, function(col, label) {
      genes <- df$Gene.Symbol[df[[col]] == 1]
      tibble(Gene.Symbol = genes, y_group = label)
    })
  } else {
    gene_df <- purrr::imap_dfr(gene_sets, ~ tibble(Gene.Symbol = .x, y_group = .y))
  }

  clean_name <- function(x) gsub("[^A-Za-z0-9]+", "_", x)
  default_colors <- c("grey30", "#bdc9e1", "dodgerblue3", "#74a9cf", "#045a8d", "#7fcdbb", "#e34a33", "#fdcc8a")
  fill_colors <- setNames(rep_len(default_colors, length(gene_sets)), names(gene_sets))

  # --- 2.2. Build plotting data
  full_plot_df <- purrr::map_dfr(ror_cols, function(fc) {
    df %>%
      right_join(gene_df, by = "Gene.Symbol") %>%
      filter(!is.na(y_group), is.finite(.data[[fc]])) %>%
      mutate(
        y_group = factor(y_group, levels = names(gene_sets)),
        Log2FC = fc
      )
  })

  # --- 2.3. Compute or apply x-axis limits
  facet_df <- full_plot_df %>%
    pivot_longer(cols = all_of(ror_cols), names_to = "log2fc_col", values_to = "value") %>%
    filter(!is.na(value))

  x_limits <- if (!is.null(xlim)) xlim else range(facet_df$value, na.rm = TRUE)

  # --- 2.4. Individual plots
  for (fc in ror_cols) {
    plot_df <- facet_df %>% filter(log2fc_col == fc)

    p <- ggplot(plot_df, aes(y = value, x = y_group, fill = y_group)) +
      gghalves::geom_half_point(side = "b", range_scale = 0.2, alpha = 0.2, size = 1, shape = 16) +
      geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.5) +
      ggdist::stat_halfeye(adjust = 2, width = 0.6, .width = 0, justification = -0.2, point_colour = NA) +
      geom_boxplot(width = 0.15, outlier.shape = NA) +
      scale_fill_manual(values = fill_colors) +
      coord_flip(ylim = x_limits, clip = "off") +
      theme_bw(base_size = 6) +
      labs(y = "RoR (ASAH1 vs Ctrl)", x = NULL, title = paste("RoR Localization:", fc)) +
      theme(panel.grid = element_blank(), legend.position = "none")

    ggsave(
      file.path(out_dir, paste0("ror_locdist_", clean_name(fc), "_", paste(clean_name(names(gene_sets)), collapse = "_"), ".pdf")),
      p, width = 4, height = 2, device = cairo_pdf
    )
  }

  # --- 2.5. Faceted plot
  p_all <- ggplot(facet_df, aes(y = value, x = y_group, fill = y_group)) +
    gghalves::geom_half_point(side = "b", range_scale = 0.2, alpha = 0.2, size = 1, shape = 16) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red", linewidth = 0.5) +
    ggdist::stat_halfeye(adjust = 2, width = 0.6, .width = 0, justification = -0.2, point_colour = NA) +
    geom_boxplot(width = 0.15, outlier.shape = NA) +
    scale_fill_manual(values = fill_colors) +
    coord_flip(ylim = x_limits, clip = "on") +
    facet_wrap(~ log2fc_col, ncol = 1) +
    theme_bw(base_size = 6) +
    labs(y = "RoR (log2FC ΔAxon/WC)", x = NULL, title = "RoR Localization Across Comparisons") +
    theme(panel.grid = element_blank(), legend.position = "none")

  ggsave(
    file.path(out_dir, paste0("facet_ror_locdist_", paste(clean_name(ror_cols), collapse = "_"), "_", paste(clean_name(names(gene_sets)), collapse = "_"), ".pdf")),
    p_all, width = 6, height = 5, device = cairo_pdf
  )
}


# --- 3. Define input annotations 
# gene_sets <- c("SynGO", "Presynaptic", "Postsynaptic")
# gene_sets <- c("EndoLyso","EarlyEndosome","RecyclingEndosome")
# gene_sets <- c("OXPHOS","Lysosome","Endo_iN_curated_Hundley", "EarlyEndosome","RecyclingEndosome")
# gene_sets <- c("OXPHOS","Golgi","ER")
# gene_sets <- c("Nucleus","Lysosome","NeuroDev","SynapseSVs","SVfusion", "Svendocytosis","Svexocytosis")
# gene_sets <- c("Lysosome","EarlyEndosome","RecyclingEndosome","SynapseSVs","SVfusion", "Svendocytosis","Svexocytosis")
# gene_sets <- c("Nucleus","Lysosome","EarlyEndosome","RecyclingEndosome","NeuroDev","SynapseSVs","Presynaptic", "Postsynaptic")
gene_sets <- c("Lysosome", "EarlyEndosome", "RecyclingEndosome", "SynapseSVs", "SVfusion", "Svendocytosis", "Svexocytosis")
gene_sets <- c("Mito","MitoIMS","MitoMatrix","MitoMIM","MitoMOM","OXPHOS","mtComplexI")


# --- 4. Define dataframes to plot (either Axon, Soma or both)
# single comparison 
# ror_cols <- c("RoR_ASAH1_Axon")
# ror_cols <- c("RoR_ASAH1_Soma")

# double comparison
ror_cols <- c("RoR_ASAH1_Axon", "RoR_ASAH1_Soma")


# --- 5. Run function
plot_ror_annotation_distribution(
  df        = diff136_df_annotated,
  gene_sets = gene_sets,
  ror_cols  = ror_cols,
  out_dir   = out_dir_diff136_rainbow_RoR,
  xlim      = c(-3, 3) #do set manuarl x-lims if necessary
)



# Annotations:
# "Mito","MitoIMS","MitoMatrix","MitoMIM","MitoMOM","OXPHOS","mtComplexI","Golgi","Lysosome"               ,"ER","Cytoplasm","Nucleus","Autophagy","Autophagy_det","SynGO","Endo_iN_curated_Hundley" "SynapseSVs","Presynaptic","Postsynaptic","EndoDetailLoac","NeuroDev","EndoLyso","EarlyEndosome","RecyclingEndosome","SVfusion","Svendocytosis","Svexocytosis","vATPase"     


```




# VI. GO analysis of clusters of interest 
```{r}
# ─────────────────────────────────────────────────────────────────────────────
# GO term analysis based on clusters 
# ─────────────────────────────────────────────────────────────────────────────

# --- Step 1. Define function for GO Term analysis 
plot_topGO_for_geneset <- function(gene_set, background_genes, tag = "clusterX", out_dir) {
  library(topGO)
  library(org.Hs.eg.db)
  library(tidyverse)

  # Step 1: Create geneList for topGO
  geneList <- factor(as.integer(background_genes %in% gene_set))
  names(geneList) <- background_genes

  # Step 2: Run topGO Fisher test (BP)
  GOdata <- new("topGOdata",
                ontology = "BP",
                allGenes = geneList,
                geneSel = function(x) x == 1,
                annot = annFUN.org,
                mapping = "org.Hs.eg.db",
                ID = "symbol")

  resultFisher <- runTest(GOdata, algorithm = "classic", statistic = "fisher")

  # Step 3: Generate GO table and extract raw p-values
  # calculate 30 top hits, but only plot top 10 
  go_table <- GenTable(GOdata, classicFisher = resultFisher, topNodes = 30)

  go_table <- go_table %>%
    mutate(
      raw_pval     = score(resultFisher)[GO.ID],
      Significant  = as.numeric(Significant),
      Expected     = as.numeric(Expected),
      Enrichment   = Significant / Expected,
      log10P       = -log10(raw_pval)
    ) %>%
    filter(!is.na(raw_pval)) %>%
    arrange(raw_pval) %>%
    slice_head(n = 10)

  # Step 4: Get associated genes per GO term
  go_genes <- genesInTerm(GOdata)
  go_table$Genes <- sapply(go_table$GO.ID, function(go_id) {
    intersect(go_genes[[go_id]], gene_set) %>% paste(collapse = ";")
  })

  # Step 5: Save GO term table + gene associations
  write_csv(go_table, file = file.path(out_dir, paste0("GO_results_", tag, ".csv")))

  # Step 6: Plot dot plot
  p <- ggplot(go_table, aes(x = Enrichment, y = reorder(Term, Enrichment))) +
    geom_point(aes(size = log10P, fill = Enrichment), shape = 21, color = "black", stroke = 0.25) +
    scale_fill_gradient(low = "white", high = "firebrick") +
    theme_bw(base_size = 8) +
    labs(
      x = "Fold Enrichment",
      y = "GO Term",
      size = expression(-log[10]*"P"),
      title = paste0("Top GO Terms (", tag, ")")
    ) +
    theme(panel.grid = element_blank())

  ggsave(file.path(out_dir, paste0("GO_dotplot_", tag, ".pdf")), p, width = 5, height = 3.5, device = cairo_pdf)

  return(p)
}



# --- Step 2. Define input clusters to analyse & background genes 
# Input: cluster genes
genes_interest <- diff136_df_annotated %>%
  #filter(cluster %in% c(4)) %>%
  filter(cluster %in% c(4,5)) %>%
  pull(Gene.Symbol) %>%
  unique()

# Background genes
background_genes <- unique(diff136_df_annotated$Gene.Symbol)



# --- Step 3. Run function 
# Run function
plot_topGO_for_geneset(
  gene_set = genes_interest,
  background_genes = background_genes,
  tag = "ASAH1_cluster4_5",
  out_dir = out_dir_diff136_rainbow_GOcluster
)



```
