---
title: "HeLa_lysoCa_eval"
output: html_document
date: "2025-08-10"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# I. Load packackes
```{r}
library(devtools)
# Core data manipulation 
library(tidyverse)
library(Cairo)
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(tibble)
library(purrr)
library(patchwork)

# For PDF export
library(Cairo)    

# Tidy evaluation helpers (used in dplyr/mutate etc.)
library(rlang)

```

# II. dataimport and metadata setup
```{r}

# --- 1. Setup
# Input path and file
in_dir_ogb5n <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20241111_HeLa-Ctrl-ASAH1_OGB1AM_OGB5N_SiRLyso_MLSA5/Eval_OGB5N"
infile_ogb5n  <- file.path(in_dir_ogb5n, "OGB5N_object_clean.csv")

# Output directory
out_dir_ogb5n <- file.path(in_dir_ogb5n, "out_eval_OGB5N")
dir.create(out_dir_ogb5n, showWarnings = FALSE, recursive = TRUE)

# Colors and ordering
group_levels_fixed <- c("Ctrl_fed", "Ctrl_1hMLSA5", "ASAH1_fed", "ASAH1_1hMLSA5")
group_colors_fixed <- c(
  "Ctrl_fed" = "grey70",
  "Ctrl_1hMLSA5" = "grey90",
  "ASAH1_fed" = "dodgerblue",
  "ASAH1_1hMLSA5" = "skyblue"
)

# Measurements
intensity_cols <- c(
  "Intensity_IntegratedIntensity_OGB5N",
  "Intensity_IntegratedIntensity_OGB5N_on_Lyso",
  "Intensity_MeanIntensity_OGB5N",
  "Intensity_MeanIntensity_OGB5N_on_Lyso"
)

sanitize_name <- function(x) gsub("[^A-Za-z0-9]+", "_", x)


# --- 2. Load and select
ogb5n_df <- read_csv(infile_ogb5n, guess_max = 200000)

ogb5n_core <- ogb5n_df %>%
  select(ImageNumber, FileName_OGB5N, all_of(intensity_cols))

```


# III. Parse data and read in data in long format
```{r}
# --- 3.Parse metadata from filenames
ogb5n_parsed <- ogb5n_core %>%
  mutate(
    Genotype = case_when(
      str_detect(FileName_OGB5N, "(?i)(^|_)ASAH1(_|$)") ~ "ASAH1",
      str_detect(FileName_OGB5N, "(?i)(^|_)(Ctrl|Control)(_|$)") ~ "Ctrl",
      TRUE ~ NA_character_
    ),
    Treatment = case_when(
      str_detect(FileName_OGB5N, "(?i)(^|_)fed(_|$)") ~ "fed",
      str_detect(FileName_OGB5N, "(?i)1h\\s*mlsa5") ~ "1hMLSA5",
      TRUE ~ NA_character_
    ),
    RepeatID = str_extract(FileName_OGB5N, "(?i)series[_\\s-]*\\d+") %>% str_extract("\\d+") %>% as.integer(),
    RepeatID = if_else(is.na(RepeatID), ImageNumber, RepeatID),
    Group = paste(Genotype, Treatment, sep = "_")
  ) %>%
  filter(!is.na(Genotype), !is.na(Treatment)) %>%
  mutate(Group = factor(Group, levels = group_levels_fixed))


# --- 4.Long format and per-repeat summaries
ogb5n_long <- ogb5n_parsed %>%
  pivot_longer(cols = all_of(intensity_cols), names_to = "Measurement", values_to = "Value")

ogb5n_rep_summary <- ogb5n_long %>%
  group_by(Measurement, Genotype, Treatment, Group, RepeatID) %>%
  summarise(
    n_objects = n(),
    mean_value = mean(Value, na.rm = TRUE),
    median_value = median(Value, na.rm = TRUE),
    sd_value = sd(Value, na.rm = TRUE),
    .groups = "drop"
  )

write_csv(ogb5n_rep_summary, file.path(out_dir_ogb5n, "OGB5N_perRepeat_summary.csv"))
```



# IV. Stat test 
```{r}
# --- 5. Global stats (Kruskal and all pairwise Wilcoxon BH)
run_stats_for_measurement <- function(meas_name, rep_df_input) {
  sub_df <- rep_df_input %>% filter(Measurement == meas_name) %>% mutate(Group = droplevels(Group))
  kw <- tryCatch({
    stat <- kruskal.test(mean_value ~ Group, data = sub_df)
    tibble(Measurement = meas_name, test = "KruskalWallis",
           statistic = unname(stat$statistic), df = unname(stat$parameter), p_value = unname(stat$p.value))
  }, error = function(e) tibble(Measurement = meas_name, test = "KruskalWallis", statistic = NA, df = NA, p_value = NA))
  pw <- tryCatch({
    w <- pairwise.wilcox.test(sub_df$mean_value, sub_df$Group, p.adjust.method = "BH", exact = FALSE)
    as_tibble(as.table(w$p.value)) %>%
      rename(group1 = Var1, group2 = Var2, p_adj = Freq) %>%
      mutate(Measurement = meas_name, test = "PairwiseWilcoxonBH") %>%
      select(Measurement, test, group1, group2, p_adj)
  }, error = function(e) tibble(Measurement = meas_name, test = "PairwiseWilcoxonBH", group1 = NA, group2 = NA, p_adj = NA))
  list(kw = kw, pw = pw)
}

stats_list <- purrr::map(intensity_cols, ~run_stats_for_measurement(.x, ogb5n_rep_summary))
kw_tbl <- dplyr::bind_rows(lapply(stats_list, `[[`, "kw"))
pw_tbl <- dplyr::bind_rows(lapply(stats_list, `[[`, "pw"))

write_csv(kw_tbl, file.path(out_dir_ogb5n, "OGB5N_stats_kruskal.csv"))
write_csv(pw_tbl, file.path(out_dir_ogb5n, "OGB5N_stats_pairwise_wilcoxon_BH.csv"))


# --- 6. Planned contrasts: genotype within treatment, treatment within genotype

planned_contrasts_for_measurement <- function(meas_name, rep_df_input) {
  sub <- rep_df_input %>% filter(Measurement == meas_name)

  v <- function(g) sub %>% filter(Group == g) %>% pull(mean_value)

  pairs_tbl <- tibble(
    contrast = c(
      "Genotype_at_fed: ASAH1_fed vs Ctrl_fed",
      "Genotype_at_1hMLSA5: ASAH1_1hMLSA5 vs Ctrl_1hMLSA5",
      "Treatment_in_Ctrl: Ctrl_1hMLSA5 vs Ctrl_fed",
      "Treatment_in_ASAH1: ASAH1_1hMLSA5 vs ASAH1_fed"
    ),
    g1 = c("ASAH1_fed", "ASAH1_1hMLSA5", "Ctrl_1hMLSA5", "ASAH1_1hMLSA5"),
    g2 = c("Ctrl_fed",  "Ctrl_1hMLSA5",  "Ctrl_fed",     "ASAH1_fed")
  )

  out <- pairs_tbl %>%
    rowwise() %>%
    mutate(
      n1 = length(v(g1)),
      n2 = length(v(g2)),
      p_value = tryCatch(wilcox.test(v(g1), v(g2))$p.value, error = function(e) NA_real_),
      effect_direction = sign(median(v(g1), na.rm = TRUE) - median(v(g2), na.rm = TRUE))
    ) %>%
    ungroup() %>%
    mutate(
      p_adj_BH = p.adjust(p_value, method = "BH"),
      Measurement = meas_name
    ) %>%
    select(Measurement, contrast, g1, g2, n1, n2, p_value, p_adj_BH, effect_direction)

  out
}

planned_list <- purrr::map(intensity_cols, ~planned_contrasts_for_measurement(.x, ogb5n_rep_summary))
planned_tbl <- dplyr::bind_rows(planned_list)
write_csv(planned_tbl, file.path(out_dir_ogb5n, "OGB5N_stats_planned_contrasts_wilcoxon_BH.csv"))

```


# V. Summarize, plot data & save summary
```{r}
# --- 7a. Bar plots
split(ogb5n_group_summary, ogb5n_group_summary$Measurement) %>%
  purrr::iwalk(function(df_bar, meas_name) {

    df_pts <- ogb5n_rep_summary %>%
      dplyr::filter(Measurement == meas_name) %>%
      dplyr::mutate(Group = factor(Group, levels = levels(df_bar$Group)))

    p_bar <- ggplot(df_bar, aes(x = Group, y = group_mean, fill = Group)) +
      geom_col(width = 0.7) +
      geom_errorbar(aes(ymin = group_mean - group_sem, ymax = group_mean + group_sem),
                    width = 0.2, linewidth = 0.4) +
      geom_point(
        data = df_pts,
        aes(x = Group, y = mean_value),
        position = position_jitter(width = 0.1, height = 0, seed = 123),
        size = 1.6,
        alpha = 0.85,
        inherit.aes = FALSE
      ) +
      scale_fill_manual(values = group_colors_fixed, guide = "none") +
      labs(title = meas_name, x = NULL, y = "Mean per repeat") +
      theme_bw() +
      theme(panel.grid = element_blank(), plot.title = element_text(size = 10, face = "bold"))

    ggsave(
      filename = file.path(out_dir_ogb5n, paste0("bar_mean_", sanitize_name(meas_name), ".pdf")),
      plot = p_bar, width = 4, height = 4, device = "pdf"
    )
  })

# --- 7b. Violin plots with boxplots + jitter
split(ogb5n_group_summary, ogb5n_group_summary$Measurement) %>%
  purrr::iwalk(function(df_bar, meas_name) {

    df_pts <- ogb5n_rep_summary %>%
      dplyr::filter(Measurement == meas_name) %>%
      dplyr::mutate(Group = factor(Group, levels = levels(df_bar$Group)))

    p_violin <- ggplot(df_pts, aes(x = Group, y = mean_value, fill = Group)) +
      geom_violin(trim = FALSE, width = 0.8, adjust = 1.2, linewidth = 0.3) +
      geom_boxplot(width = 0.15, outlier.shape = NA, fill = "white", linewidth = 0.35) +
      geom_point(
        position = position_jitter(width = 0.1, height = 0, seed = 123),
        size = 1.4,
        alpha = 0.8
      ) +
      scale_fill_manual(values = group_colors_fixed, guide = "none") +
      labs(title = paste(meas_name, "(per-repeat means)"),
           x = NULL, y = "Per-repeat means") +
      theme_bw() +
      theme(panel.grid = element_blank(), plot.title = element_text(size = 10, face = "bold"))

    ggsave(
      filename = file.path(out_dir_ogb5n, paste0("violin_", sanitize_name(meas_name), ".pdf")),
      plot = p_violin, width = 4, height = 4, device = "pdf"
    )
  })

# --- 8. Quick table check
ogb5n_group_summary %>%
  dplyr::select(Measurement, Group, n_repeats, group_mean) %>%
  dplyr::arrange(Measurement, Group) %>%
  print(n = 40)

readr::write_csv(ogb5n_group_summary, file.path(out_dir_ogb5n, "OGB5N_stats_summary.csv"))
```
