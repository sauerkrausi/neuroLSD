---
title: "HeLa_lysoCa_eval"
output: html_document
date: "2025-08-10"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# I. Load packackes
```{r}
library(devtools)

# Core data manipulation & visualization
library(tidyverse)        # ggplot2, dplyr, purrr, readr, tibble, tidyr, stringr
library(zoo)              # Rolling operations
library(reshape2)         # Data reshaping
library(pheatmap)         # Heatmaps
library(ggdendro)         # Dendrograms
library(viridis)          # Color palettes
library(RColorBrewer)
library(NatParksPalettes)
library(tidyplots)
library(ggpubr)           # Publication-ready plots
library(ggsignif)         # Significance annotations
library(Cairo)            # For cairo_pdf output
library(patchwork)        # Plot layouts
library(cowplot)          # Plot composition
library(gridExtra)        # Layout utilities
library(grid)             # Viewports and custom layout
library(rlang)            # Tidy evaluation tools

# Signal processing
#library(signal)

# Plot composition
library(gridExtra)
library(grid)
library(cowplot)
library(Cairo)
library(dplyr)

```

```{r}
# Calcium flux eval from lysosomal OGB5N live-cell imaging
# Input path and file
in_dir_ogb5n <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20241111_HeLa-Ctrl-ASAH1_OGB1AM_OGB5N_SiRLyso_MLSA5/Eval_OGB5N"
infile_ogb5n  <- file.path(in_dir_ogb5n, "OGB5N_object_clean.csv")

# Output directory
out_dir_ogb5n <- file.path(in_dir_ogb5n, "out_eval_OGB5N")
dir.create(out_dir_ogb5n, showWarnings = FALSE, recursive = TRUE)

suppressPackageStartupMessages({
  library(readr)
  library(dplyr)
  library(stringr)
  library(tidyr)
  library(ggplot2)
  library(purrr)
})

# Read data
ogb5n_df <- read_csv(infile_ogb5n, guess_max = 200000)

# Columns of interest
intensity_cols <- c(
  "Intensity_IntegratedIntensity_OGB5N",
  "Intensity_IntegratedIntensity_OGB5N_on_Lyso",
  "Intensity_MeanIntensity_OGB5N",
  "Intensity_MeanIntensity_OGB5N_on_Lyso"
)

ogb5n_core <- ogb5n_df %>%
  select(ImageNumber, FileName_OGB5N, all_of(intensity_cols))

# Parse Genotype, Treatment, and replicate index from FileName_OGB5N
# Assumptions:
#   Genotype tokens contain "Ctrl" or "Control" or "ASAH1"
#   Treatment tokens contain "fed" or "1hMLSA5"
#   Replicate indicated as "(series n)" where n is 0..8
ogb5n_parsed <- ogb5n_core %>%
  mutate(
    Genotype_raw = str_extract(FileName_OGB5N, "(?i)Ctrl|Control|ASAH1"),
    Genotype = case_when(
      is.na(Genotype_raw) ~ NA_character_,
      str_detect(Genotype_raw, regex("ASAH1", ignore_case = TRUE)) ~ "ASAH1",
      TRUE ~ "Ctrl"
    ),
    Treatment = str_to_lower(str_extract(FileName_OGB5N, "(fed|1hMLSA5)")),
    RepeatID = str_extract(FileName_OGB5N, "(?i)series\\s*\\d+") %>%
      str_extract("\\d+") %>% as.integer(),
    Group = paste(Genotype, Treatment, sep = "_")
  ) %>%
  mutate(
    Group = factor(Group, levels = c("Ctrl_fed", "Ctrl_1hmlsa5", "ASAH1_fed", "ASAH1_1hmlsa5"))
  )

# Guardrails for parsing
if (any(is.na(ogb5n_parsed$Genotype))) {
  warning("Some Genotype values could not be parsed from FileName_OGB5N.")
}
if (any(is.na(ogb5n_parsed$Treatment))) {
  warning("Some Treatment values could not be parsed from FileName_OGB5N.")
}
if (any(is.na(ogb5n_parsed$RepeatID))) {
  warning("Some RepeatID values could not be parsed from FileName_OGB5N.")
}

# Long format for convenient summarization
ogb5n_long <- ogb5n_parsed %>%
  pivot_longer(cols = all_of(intensity_cols),
               names_to = "Measurement",
               values_to = "Value")

# Per replicate summary statistics
ogb5n_rep_summary <- ogb5n_long %>%
  group_by(Measurement, Genotype, Treatment, Group, RepeatID) %>%
  summarise(
    n_objects = n(),
    mean_value = mean(Value, na.rm = TRUE),
    median_value = median(Value, na.rm = TRUE),
    sd_value = sd(Value, na.rm = TRUE),
    .groups = "drop"
  )

# Save per replicate summary
write_csv(ogb5n_rep_summary,
          file.path(out_dir_ogb5n, "OGB5N_perRepeat_summary.csv"))

# Stats across groups using per replicate means as the unit of analysis
# Kruskal-Wallis plus pairwise Wilcoxon with BH correction
run_stats_for_measurement <- function(meas_name, rep_df) {
  sub_df <- rep_df %>% filter(Measurement == meas_name) %>%
    filter(!is.na(Group)) %>%
    mutate(Group = droplevels(Group))
  # Kruskal
  kw <- tryCatch(
    {
      stat <- kruskal.test(mean_value ~ Group, data = sub_df)
      tibble(
        Measurement = meas_name,
        test = "KruskalWallis",
        statistic = unname(stat$statistic),
        df = unname(stat$parameter),
        p_value = unname(stat$p.value)
      )
    },
    error = function(e) tibble(Measurement = meas_name, test = "KruskalWallis", statistic = NA, df = NA, p_value = NA)
  )
  # Pairwise Wilcoxon
  pw <- tryCatch(
    {
      w <- pairwise.wilcox.test(sub_df$mean_value, sub_df$Group, p.adjust.method = "BH", exact = FALSE)
      # Convert matrix to tidy tibble
      as_tibble(as.table(w$p.value), .name_repair = "unique") %>%
        rename(group1 = Var1, group2 = Var2, p_adj = Freq) %>%
        mutate(Measurement = meas_name, test = "PairwiseWilcoxonBH") %>%
        select(Measurement, test, group1, group2, p_adj)
    },
    error = function(e) tibble(Measurement = meas_name, test = "PairwiseWilcoxonBH", group1 = NA, group2 = NA, p_adj = NA)
  )
  list(kw = kw, pw = pw)
}

stats_list <- map(intensity_cols, ~run_stats_for_measurement(.x, ogb5n_rep_summary))
kw_tbl <- bind_rows(lapply(stats_list, `[[`, "kw"))
pw_tbl <- bind_rows(lapply(stats_list, `[[`, "pw"))

write_csv(kw_tbl, file.path(out_dir_ogb5n, "OGB5N_stats_kruskal.csv"))
write_csv(pw_tbl, file.path(out_dir_ogb5n, "OGB5N_stats_pairwise_wilcoxon_BH.csv"))

# Group summary for plotting from per replicate means
ogb5n_group_summary <- ogb5n_rep_summary %>%
  group_by(Measurement, Group) %>%
  summarise(
    n_repeats = n(),
    group_mean = mean(mean_value, na.rm = TRUE),
    group_sd = sd(mean_value, na.rm = TRUE),
    group_sem = group_sd / sqrt(n_repeats),
    .groups = "drop"
  ) %>%
  mutate(
    Group = factor(Group, levels = c("Ctrl_fed", "Ctrl_1hmlsa5", "ASAH1_fed", "ASAH1_1hmlsa5"))
  )

# Colors and order
group_colors <- c(
  "Ctrl_fed" = "grey70",
  "Ctrl_1hmlsa5" = "grey90",
  "ASAH1_fed" = "dodgerblue",
  "ASAH1_1hmlsa5" = "skyblue"
)

# Helper to sanitize measurement names for filenames
sanitize_name <- function(x) {
  gsub("[^A-Za-z0-9]+", "_", x)
}

# Plot and save per measurement
invisible(
  ogb5n_group_summary %>%
    split(.$Measurement) %>%
    imap(function(df_plot, meas_name) {
      p <- ggplot(df_plot, aes(x = Group, y = group_mean, fill = Group)) +
        geom_col(width = 0.7) +
        geom_errorbar(aes(ymin = group_mean - group_sem, ymax = group_mean + group_sem),
                      width = 0.2, linewidth = 0.4) +
        scale_fill_manual(values = group_colors, guide = "none") +
        labs(
          title = meas_name,
          x = NULL,
          y = "Mean per repeat"
        ) +
        theme_bw() +
        theme(
          panel.grid = element_blank(),
          plot.title = element_text(size = 11, face = "bold")
        )
      fname_base <- paste0("bar_mean_", sanitize_name(meas_name))
      ggsave(filename = file.path(out_dir_ogb5n, paste0(fname_base, ".pdf")),
             plot = p, width = 6, height = 4, device = cairo_pdf)
      ggsave(filename = file.path(out_dir_ogb5n, paste0(fname_base, ".png")),
             plot = p, width = 6, height = 4, dpi = 300)
    })
)

# Also save the per object tidy table with parsed metadata
write_csv(
  ogb5n_long %>%
    select(ImageNumber, FileName_OGB5N, Genotype, Treatment, RepeatID, Group, Measurement, Value),
  file.path(out_dir_ogb5n, "OGB5N_perObject_long_with_metadata.csv")
)

message("Done. Outputs written to: ", out_dir_ogb5n)
```


# II. Data input & output dir 
```{r}
# -------------------
# DEFINE INPUT  
# -------------------
th_summary <- read.csv("/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20240417_diff118_iN-iDA_test_d23_Ctrl-SMPD1-ASAH1/THeval/results/TH_quantification_summary.csv")

# -------------------
# DEFINE OUTPUT DIR  
# -------------------
theval_outdir <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20240417_diff118_iN-iDA_test_d23_Ctrl-SMPD1-ASAH1/THeval/eval"
dir.create(theval_outdir, showWarnings = FALSE, recursive = TRUE)

```



# III. plot data and save as pdf
```{r}
# --- 1. Add genotype and neurontype columns
th_summary <- th_summary %>%
  mutate(
    neurontype = case_when(
      str_detect(file, "iN")  ~ "iN",
      str_detect(file, "iDA") ~ "iDA",
      TRUE ~ NA_character_
    ),
    genotype = case_when(
      str_detect(file, "Ctrl")  ~ "Ctrl",
      TRUE ~ NA_character_
    ),
    neurontype = factor(neurontype, levels = c("iN", "iDA"))
  )

# --- 2. Aggregate with mean & SD
agg_df <- th_summary %>%
  group_by(genotype, neurontype) %>%
  summarise(
    PercentPos_mean = mean(percent_th_positive, na.rm = TRUE),
    PercentPos_sd   = sd(percent_th_positive, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(PercentNeg_mean = 100 - PercentPos_mean)

# --- 3. Pivot longer for plotting
stacked_df <- agg_df %>%
  pivot_longer(
    cols = c(PercentPos_mean, PercentNeg_mean),
    names_to = "THstatus",
    values_to = "Percent"
  ) %>%
  mutate(
    THstatus = ifelse(THstatus == "PercentPos_mean", "TH+", "TH−"),
    Group = paste(genotype, THstatus, sep = "_"),
    THstatus = factor(THstatus, levels = c("TH+", "TH−"))
  )

# --- 4. Compute label positions
stacked_df <- stacked_df %>%
  group_by(genotype, neurontype) %>%
  arrange(desc(THstatus)) %>%
  mutate(
    ypos = cumsum(Percent) - Percent / 2,
    label = paste0(round(Percent), "%")
  ) %>%
  ungroup()

# --- 5. Define colors
group_colors <- c(
  "Ctrl_TH+" = "grey50",
  "Ctrl_TH−" = "grey70"
)

# --- Build errorbar data (only TH+ rows, includes SD)
errorbar_df <- agg_df %>%
  transmute(
    genotype,
    neurontype,
    Percent = PercentPos_mean,
    PercentPos_sd
  )

# --- 6. Plot with error bars for TH+
th_stacked_plot <- ggplot(stacked_df, aes(x = genotype, y = Percent, fill = Group)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  geom_errorbar(
    data = errorbar_df,
    aes(
      x = genotype,
      y = Percent,
      ymin = Percent - PercentPos_sd,
      ymax = Percent + PercentPos_sd
    ),
    inherit.aes = FALSE,
    width = 0.2,
    color = "black"
  ) +
  geom_text(aes(label = label, y = ypos), color = "white", size = 2.5) +
  facet_wrap(~ neurontype, nrow = 1) +
  labs(
    title = "% TH+ vs TH− Cells by Genotype",
    y = "Percent of Cells",
    x = "Genotype"
  ) +
  scale_fill_manual(values = group_colors) +
  scale_y_continuous(limits = c(0, 100), expand = c(0, 0)) +
  theme_bw(base_size = 7) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- 7. Save
ggsave(filename = file.path(theval_outdir, "TH_positive_vs_negative_stacked.pdf"),
       plot = th_stacked_plot, width = 2, height = 4, device = cairo_pdf)
```