---
title: "HeLa_lysoCa_eval"
output: html_document
date: "2025-08-10"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# I. Load packackes
```{r}
library(devtools)

# Core data manipulation & visualization
library(tidyverse)        # ggplot2, dplyr, purrr, readr, tibble, tidyr, stringr
library(zoo)              # Rolling operations
library(reshape2)         # Data reshaping
library(pheatmap)         # Heatmaps
library(ggdendro)         # Dendrograms
library(viridis)          # Color palettes
library(RColorBrewer)
library(NatParksPalettes)
library(tidyplots)
library(ggpubr)           # Publication-ready plots
library(ggsignif)         # Significance annotations
library(Cairo)            # For cairo_pdf output
library(patchwork)        # Plot layouts
library(cowplot)          # Plot composition
library(gridExtra)        # Layout utilities
library(grid)             # Viewports and custom layout
library(rlang)            # Tidy evaluation tools

# Signal processing
  library(readr)
  library(dplyr)
  library(stringr)
  library(tidyr)
  library(ggplot2)
  library(purrr)
# Plot composition
library(gridExtra)
library(grid)
library(cowplot)
library(Cairo)
library(dplyr)

```

```{r}
# Calcium flux eval from lysosomal OGB5N live-cell imaging
# Input path and file
in_dir_ogb5n <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20241111_HeLa-Ctrl-ASAH1_OGB1AM_OGB5N_SiRLyso_MLSA5/Eval_OGB5N"
infile_ogb5n  <- file.path(in_dir_ogb5n, "OGB5N_object_clean.csv")

# Output directory
out_dir_ogb5n <- file.path(in_dir_ogb5n, "out_eval_OGB5N")
dir.create(out_dir_ogb5n, showWarnings = FALSE, recursive = TRUE)

# Read data
ogb5n_df <- read_csv(infile_ogb5n, guess_max = 200000)

# Columns of interest
intensity_cols <- c(
  "Intensity_IntegratedIntensity_OGB5N",
  "Intensity_IntegratedIntensity_OGB5N_on_Lyso",
  "Intensity_MeanIntensity_OGB5N",
  "Intensity_MeanIntensity_OGB5N_on_Lyso"
)

ogb5n_core <- ogb5n_df %>%
  select(ImageNumber, FileName_OGB5N, all_of(intensity_cols))

# Parse Genotype, Treatment, and replicate index from FileName_OGB5N
# Assumptions:
#   Genotype tokens contain "Ctrl" or "Control" or "ASAH1"
#   Treatment tokens contain "Fed" or "1hMLSA5"
#   Replicate indicated as "(series n)" where n is 0..8
# 1) Parse again
group_levels_fixed <- c("Ctrl_fed", "Ctrl_1hMLSA5", "ASAH1_fed", "ASAH1_1hMLSA5")

ogb5n_parsed <- ogb5n_core %>%
  mutate(
    Genotype = case_when(
      str_detect(FileName_OGB5N, "(?i)(^|_)ASAH1(_|$)") ~ "ASAH1",
      str_detect(FileName_OGB5N, "(?i)(^|_)(Ctrl|Control)(_|$)") ~ "Ctrl",
      TRUE ~ NA_character_
    ),
    Treatment = case_when(
      str_detect(FileName_OGB5N, "(?i)(^|_)fed(_|$)") ~ "fed",
      str_detect(FileName_OGB5N, "(?i)1h\\s*mlsa5") ~ "1hMLSA5",
      TRUE ~ NA_character_
    ),
    RepeatID = str_extract(FileName_OGB5N, "(?i)series[_\\s-]*\\d+") %>% str_extract("\\d+") %>% as.integer(),
    RepeatID = if_else(is.na(RepeatID), ImageNumber, RepeatID),  # fallback if no "series n" tag
    Group = paste(Genotype, Treatment, sep = "_")
  ) %>%
  filter(!is.na(Genotype), !is.na(Treatment)) %>%
  mutate(Group = factor(Group, levels = group_levels_fixed))

# 2) Long format (rebuild)
ogb5n_long <- ogb5n_parsed %>%
  pivot_longer(
    cols = all_of(intensity_cols),
    names_to = "Measurement",
    values_to = "Value"
  )

# 3) Per-repeat summary (rebuild)
ogb5n_rep_summary <- ogb5n_long %>%
  group_by(Measurement, Genotype, Treatment, Group, RepeatID) %>%
  summarise(
    n_objects = n(),
    mean_value = mean(Value, na.rm = TRUE),
    median_value = median(Value, na.rm = TRUE),
    sd_value = sd(Value, na.rm = TRUE),
    .groups = "drop"
  )

# 4) Stats (rebuild)
run_stats_for_measurement <- function(meas_name, rep_df_input) {
  sub_df <- rep_df_input %>% filter(Measurement == meas_name) %>% mutate(Group = droplevels(Group))
  kw <- tryCatch({
    stat <- kruskal.test(mean_value ~ Group, data = sub_df)
    tibble(Measurement = meas_name, test = "KruskalWallis",
           statistic = unname(stat$statistic), df = unname(stat$parameter), p_value = unname(stat$p.value))
  }, error = function(e) tibble(Measurement = meas_name, test = "KruskalWallis", statistic = NA, df = NA, p_value = NA))
  pw <- tryCatch({
    w <- pairwise.wilcox.test(sub_df$mean_value, sub_df$Group, p.adjust.method = "BH", exact = FALSE)
    as_tibble(as.table(w$p.value)) %>%
      rename(group1 = Var1, group2 = Var2, p_adj = Freq) %>%
      mutate(Measurement = meas_name, test = "PairwiseWilcoxonBH") %>%
      select(Measurement, test, group1, group2, p_adj)
  }, error = function(e) tibble(Measurement = meas_name, test = "PairwiseWilcoxonBH", group1 = NA, group2 = NA, p_adj = NA))
  list(kw = kw, pw = pw)
}

stats_list <- purrr::map(intensity_cols, ~run_stats_for_measurement(.x, ogb5n_rep_summary))
kw_tbl <- dplyr::bind_rows(lapply(stats_list, `[[`, "kw"))
pw_tbl <- dplyr::bind_rows(lapply(stats_list, `[[`, "pw"))

write_csv(ogb5n_rep_summary, file.path(out_dir_ogb5n, "OGB5N_perRepeat_summary.csv"))
write_csv(kw_tbl, file.path(out_dir_ogb5n, "OGB5N_stats_kruskal.csv"))
write_csv(pw_tbl, file.path(out_dir_ogb5n, "OGB5N_stats_pairwise_wilcoxon_BH.csv"))

# 5) Group summary for plotting (rebuild)
ogb5n_group_summary <- ogb5n_rep_summary %>%
  group_by(Measurement, Group) %>%
  summarise(
    n_repeats = n(),
    group_mean = mean(mean_value, na.rm = TRUE),
    group_sd = sd(mean_value, na.rm = TRUE),
    group_sem = group_sd / sqrt(n_repeats),
    .groups = "drop"
  ) %>%
  mutate(Group = factor(Group, levels = group_levels_fixed))

# 6) Plot PDF only
group_colors_fixed <- c(
  "Ctrl_fed" = "grey70",
  "Ctrl_1hMLSA5" = "grey90",
  "ASAH1_fed" = "dodgerblue",
  "ASAH1_1hMLSA5" = "skyblue"
)

sanitize_name <- function(x) gsub("[^A-Za-z0-9]+", "_", x)

invisible(
  ogb5n_group_summary %>%
    split(.$Measurement) %>%
    purrr::imap(function(df_plot, meas_name) {
      p <- ggplot(df_plot, aes(x = Group, y = group_mean, fill = Group)) +
        geom_col(width = 0.7) +
        geom_errorbar(aes(ymin = group_mean - group_sem, ymax = group_mean + group_sem), width = 0.2, linewidth = 0.4) +
        scale_fill_manual(values = group_colors_fixed, guide = "none") +
        labs(title = meas_name, x = NULL, y = "Mean per repeat") +
        theme_bw() +
        theme(panel.grid = element_blank(), plot.title = element_text(size = 11, face = "bold"))
      ggsave(file.path(out_dir_ogb5n, paste0("bar_mean_", sanitize_name(meas_name), ".pdf")),
             plot = p, width = 6, height = 4, device = "pdf")
    })
)



# Optional quick check
ogb5n_group_summary %>% select(Measurement, Group, n_repeats, group_mean) %>% arrange(Measurement, Group) %>% print(n = 40)
```


