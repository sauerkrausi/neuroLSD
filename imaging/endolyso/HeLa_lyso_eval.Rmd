---
title: "HeLa Endo-lyso imaging eval"
output: html_document
date: "2025-08-10"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# I. Load packackes
```{r}
library(devtools)
# Core data manipulation 
library(tidyverse)
library(Cairo)
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
library(tibble)
library(purrr)
library(patchwork)

# For PDF export
library(Cairo)    

# Tidy evaluation helpers (used in dplyr/mutate etc.)
library(rlang)



library(tidyverse)
library(readr)
library(stringr)
library(rstatix) 

```


# II. TFN-488 uptake â€” Combined colocalization eval
## IIa. dataimport and metadata setup
```{r}
# Root path
root_tfn <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250121_HeLa-Ctrl-ASAH1_TFN-488_uptakeAssay"

# Input TFN.csv in each CP_Eval_* folder
cp_dirs <- c("CP_Eval_1", "CP_Eval_2", "CP_Eval_3")
infiles_tfn <- file.path(root_tfn, cp_dirs, "Endosomes.csv")

# Output directory
out_dir_tfn <- file.path(root_tfn, "Combined_colocalization_eval")
dir.create(out_dir_tfn, showWarnings = FALSE, recursive = TRUE)

# Columns to import
keep_cols_tfn <- c(
  "FileName_TFN",
  "Correlation_Manders_TFN_EEA1",
  "Correlation_Overlap_EEA1_TFN",
  "AreaShape_Area",
  "AreaShape_Compactness"
)

# Read and combine, add RepeatID from folder index
tfn_raw <- purrr::map2_dfr(
  infiles_tfn, seq_along(infiles_tfn),
  ~ readr::read_csv(.x, guess_max = 200000, show_col_types = FALSE) %>%
      dplyr::select(any_of(keep_cols_tfn)) %>%
      dplyr::mutate(RepeatID = .y)
)

# Group order and colors
tfn_group_levels <- c("Ctrl_5min", "Ctrl_45min", "ASAH1_5min", "ASAH1_45min")
tfn_group_colors <- c(
  "Ctrl_5min"   = "grey70",
  "Ctrl_45min"  = "grey90",
  "ASAH1_5min"  = "dodgerblue",
  "ASAH1_45min" = "skyblue"
)

sanitize_label <- function(x) gsub("[^A-Za-z0-9]+", "_", x)

```


## IIb. Parse data and read in data in long format
```{r}
# Strict tokens to avoid chase samples; require the trailing underscore after timepoint
tfn_parsed <- tfn_raw %>%
  mutate(
    Genotype = case_when(
      str_detect(FileName_TFN, "(?i)(^|_)Ctrl-5min_")  ~ "Ctrl",
      str_detect(FileName_TFN, "(?i)(^|_)Ctrl-45min_") ~ "Ctrl",
      str_detect(FileName_TFN, "(?i)(^|_)ASAH1-5min_")  ~ "ASAH1",
      str_detect(FileName_TFN, "(?i)(^|_)ASAH1-45min_") ~ "ASAH1",
      TRUE ~ NA_character_
    ),
    Timepoint = case_when(
      str_detect(FileName_TFN, "(?i)(^|_)(Ctrl|ASAH1)-5min_")  ~ "5min",
      str_detect(FileName_TFN, "(?i)(^|_)(Ctrl|ASAH1)-45min_") ~ "45min",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(Genotype), !is.na(Timepoint)) %>%
  mutate(
    Group = factor(paste(Genotype, Timepoint, sep = "_"), levels = tfn_group_levels)
  )

# Metrics to analyze and plot
metric_cols_tfn <- c(
  "Correlation_Manders_TFN_EEA1",
  "Correlation_Overlap_EEA1_TFN",
  "AreaShape_Area",
  "AreaShape_Compactness"
)

# Long format for convenience
tfn_long <- tfn_parsed %>%
  pivot_longer(cols = all_of(metric_cols_tfn), names_to = "Metric", values_to = "Value")
```



## IIc. Per-repeat summaries & stats
```{r}
tfn_rep_summary <- tfn_long %>%
  group_by(Metric, Group, RepeatID) %>%
  summarise(
    n_objects   = n(),
    mean_value  = mean(Value, na.rm = TRUE),
    median_value= median(Value, na.rm = TRUE),
    sd_value    = sd(Value, na.rm = TRUE),
    .groups = "drop"
  )

readr::write_csv(tfn_rep_summary, file.path(out_dir_tfn, "TFN_perRepeat_summary.csv"))

# Global Kruskal + pairwise Wilcoxon (BH) per metric
tfn_run_stats <- function(metric_name, rep_df) {
  sub <- rep_df %>% dplyr::filter(Metric == metric_name) %>% dplyr::mutate(Group = droplevels(Group))

  kw <- tryCatch({
    s <- kruskal.test(mean_value ~ Group, data = sub)
    tibble::tibble(Metric = metric_name, test = "KruskalWallis",
                   statistic = unname(s$statistic), df = unname(s$parameter), p_value = unname(s$p.value))
  }, error = function(e) tibble::tibble(Metric = metric_name, test = "KruskalWallis",
                                        statistic = NA, df = NA, p_value = NA))

  pw <- tryCatch({
    w <- pairwise.wilcox.test(sub$mean_value, sub$Group, p.adjust.method = "BH", exact = FALSE)
    as_tibble(as.table(w$p.value)) %>%
      dplyr::rename(group1 = Var1, group2 = Var2, p_adj = Freq) %>%
      dplyr::mutate(Metric = metric_name, test = "PairwiseWilcoxonBH") %>%
      dplyr::select(Metric, test, group1, group2, p_adj)
  }, error = function(e) tibble::tibble(Metric = metric_name, test = "PairwiseWilcoxonBH",
                                        group1 = NA, group2 = NA, p_adj = NA))

  list(kw = kw, pw = pw)
}

tfn_stats_list <- purrr::map(unique(tfn_long$Metric), ~ tfn_run_stats(.x, tfn_rep_summary))
tfn_kw_tbl <- dplyr::bind_rows(lapply(tfn_stats_list, `[[`, "kw"))
tfn_pw_tbl <- dplyr::bind_rows(lapply(tfn_stats_list, `[[`, "pw"))

readr::write_csv(tfn_kw_tbl, file.path(out_dir_tfn, "TFN_stats_kruskal.csv"))
readr::write_csv(tfn_pw_tbl, file.path(out_dir_tfn, "TFN_stats_pairwise_wilcoxon_BH.csv"))

```


## IId. Summarize, plot data & save summary
```{r}
# Group summary for bars
tfn_group_summary <- tfn_rep_summary %>%
  group_by(Metric, Group) %>%
  summarise(
    n_repeats  = n(),
    group_mean = mean(mean_value, na.rm = TRUE),
    group_sem  = sd(mean_value, na.rm = TRUE) / sqrt(n_repeats),
    .groups = "drop"
  ) %>%
  mutate(Group = factor(Group, levels = levels(tfn_parsed$Group)))

# Bar plots with jittered per-repeat points
split(tfn_group_summary, tfn_group_summary$Metric) %>%
  purrr::iwalk(function(df_bar, metric_name) {

    df_pts <- tfn_rep_summary %>%
      dplyr::filter(Metric == metric_name) %>%
      dplyr::mutate(Group = factor(Group, levels = levels(df_bar$Group)))

    p_bar <- ggplot(df_bar, aes(x = Group, y = group_mean, fill = Group)) +
      geom_col(width = 0.7) +
      geom_errorbar(aes(ymin = group_mean - group_sem, ymax = group_mean + group_sem), width = 0.2, linewidth = 0.4) +
      geom_point(
        data = df_pts,
        aes(x = Group, y = mean_value),
        position = position_jitter(width = 0.1, height = 0, seed = 123),
        size = 1.6, alpha = 0.85, inherit.aes = FALSE
      ) +
      scale_fill_manual(values = tfn_group_colors, guide = "none") +
      labs(title = metric_name, x = NULL, y = "Mean per repeat") +
      theme_bw() +
      theme(panel.grid = element_blank(), plot.title = element_text(size = 10, face = "bold"))

    print(p_bar)
    ggsave(file.path(out_dir_tfn, paste0("bar_", sanitize_label(metric_name), ".pdf")),
           plot = p_bar, width = 4, height = 4, device = "pdf")
  })

# Violin plots with jitter (background) + boxplot
split(tfn_group_summary, tfn_group_summary$Metric) %>%
  purrr::iwalk(function(df_bar, metric_name) {

    df_pts <- tfn_rep_summary %>%
      dplyr::filter(Metric == metric_name) %>%
      dplyr::mutate(Group = factor(Group, levels = levels(df_bar$Group)))

    p_violin <- ggplot(df_pts, aes(x = Group, y = mean_value, fill = Group)) +
      geom_point(
        position = position_jitter(width = 0.1, height = 0, seed = 123),
        size = 1.2, alpha = 0.3
      ) +
      geom_violin(trim = FALSE, width = 0.8, adjust = 1.2, linewidth = 0.3, alpha = 0.85) +
      geom_boxplot(width = 0.15, outlier.shape = NA, fill = "white", linewidth = 0.35) +
      scale_fill_manual(values = tfn_group_colors, guide = "none") +
      labs(title = paste(metric_name, "(per-repeat means)"), x = NULL, y = "Per-repeat means") +
      theme_bw() +
      theme(panel.grid = element_blank(), plot.title = element_text(size = 10, face = "bold"))

    print(p_violin)
    ggsave(file.path(out_dir_tfn, paste0("violin_", sanitize_label(metric_name), ".pdf")),
           plot = p_violin, width = 4, height = 4, device = "pdf")
  })

# --- 8. Quick table check
tfn_group_summary %>%
  dplyr::select(Metric, Group, n_repeats, group_mean) %>%
  dplyr::arrange(Metric, Group) %>%
  print(n = 40)

readr::write_csv(tfn_group_summary, file.path(out_dir_tfn, "OGB5N_stats_summary.csv"))
```




# III. HeLa endo-lysosomal stain evaluation


```{r}
# ------------------------------------------
# Color and quant eval of endo-lyso stains
# HeLa Control and ASAH1-/-
# ------------------------------------------


# --- 1. User inputs and outputs
hela_base_dir <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250613_HeLa-Ctrl-ASAH1_EndoLysoStains/cpsamEL/eval"

hela_genotype_colors <- c(
  "Control" = "grey80",
  "ASAH1"   = "dodgerblue"
)

hela_out_dir <- file.path(hela_base_dir, "figures")
dir.create(hela_out_dir, showWarnings = FALSE, recursive = TRUE)


# --- 2. IO helpers
hela_read_metrics_pairwise <- function(metrics_dir) {
  f <- file.path(metrics_dir, "pairwise_colocalization.csv")
  if (!file.exists(f)) return(NULL)
  readr::read_csv(f, show_col_types = FALSE)
}

hela_read_metrics_summary <- function(metrics_dir) {
  f <- file.path(metrics_dir, "per_image_summary.csv")
  if (!file.exists(f)) return(NULL)
  readr::read_csv(f, show_col_types = FALSE)
}


# --- 3. Parsing helpers
hela_get_genotype <- function(x_prefix) {
  ifelse(stringr::str_detect(x_prefix, stringr::regex("ASAH1", ignore_case = TRUE)),
         "ASAH1", "Control")
}


# --- 4. Build data frames
hela_subdirs_vec <- list.dirs(hela_base_dir, full.names = TRUE, recursive = FALSE)

hela_pairwise_list <- list()
hela_summary_list  <- list()

for (sd in hela_subdirs_vec) {
  metrics_dir <- file.path(sd, "metrics")
  if (!dir.exists(metrics_dir)) next

  pw_df <- hela_read_metrics_pairwise(metrics_dir)
  sm_df <- hela_read_metrics_summary(metrics_dir)

  if (!is.null(pw_df)) {
    pw_df <- pw_df %>%
      mutate(
        genotype = hela_get_genotype(prefix),
        pair = paste(stainA, stainB, sep = "_"),
        src_combo = basename(sd)
      )
    hela_pairwise_list[[length(hela_pairwise_list) + 1]] <- pw_df
  }

  if (!is.null(sm_df)) {
    sm_df <- sm_df %>%
      mutate(
        genotype = hela_get_genotype(prefix),
        src_combo = basename(sd)
      )
    hela_summary_list[[length(hela_summary_list) + 1]] <- sm_df
  }
}

HeLa_colocalization_df <- bind_rows(hela_pairwise_list) %>%
  relocate(genotype, .after = prefix) %>%
  mutate(genotype = factor(genotype, levels = c("Control", "ASAH1")))

HeLa_summary_df <- bind_rows(hela_summary_list) %>%
  relocate(genotype, .after = prefix) %>%
  mutate(genotype = factor(genotype, levels = c("Control", "ASAH1")))


# --- 5. Statistics helpers
hela_wilcox_by_group <- function(in_df, group_var, value_col) {
  stopifnot(group_var %in% names(in_df), value_col %in% names(in_df))
  in_df %>%
    select(all_of(group_var), genotype, !!sym(value_col)) %>%
    filter(!is.na(.data[[value_col]])) %>%
    group_by(.data[[group_var]]) %>%
    do({
      if (dplyr::n_distinct(.$genotype) < 2) tibble(statistic = NA_real_, p = NA_real_)
      else {
        wt <- rstatix::wilcox_test(reformulate("genotype", response = value_col), data = .)
        tibble(statistic = wt$statistic, p = wt$p)
      }
    }) %>%
    ungroup() %>%
    mutate(
      p_adj = p.adjust(p, method = "BH"),
      p_label = case_when(
        is.na(p_adj) ~ "n.a.",
        p_adj < 0.001 ~ "***",
        p_adj < 0.01  ~ "**",
        p_adj < 0.05  ~ "*",
        TRUE          ~ "ns"
      )
    )
}


# --- 6. Add stats to data frames
# 6a. Pairwise colocalization stats per metric per pair
coloc_metrics_vec <- c("coloc_per_nucleus", "frac_coloc_A", "frac_coloc_B")

for (m_name in coloc_metrics_vec) {
  if (!m_name %in% names(HeLa_colocalization_df)) next
  stat_tbl_m <- hela_wilcox_by_group(HeLa_colocalization_df, "pair", m_name) %>%
    select(pair,
           !!sym(paste0("p_adj_", m_name)) := p_adj,
           !!sym(paste0("p_label_", m_name)) := p_label,
           !!sym(paste0("statistic_", m_name)) := statistic)
  HeLa_colocalization_df <- HeLa_colocalization_df %>%
    left_join(stat_tbl_m, by = "pair")
}

readr::write_csv(HeLa_colocalization_df,
                 file.path(hela_out_dir, "HeLa_colocalization_with_stats.csv"))

# 6b. Summary stats per metric across images
# Normalize possible column name variants once
if ("n_EEA1_per_nucleus" %in% names(HeLa_summary_df) && !("EEA1_per_nucleus" %in% names(HeLa_summary_df))) {
  HeLa_summary_df <- HeLa_summary_df %>% rename(EEA1_per_nucleus = n_EEA1_per_nucleus)
}
if ("n_VPS35_per_nucleus" %in% names(HeLa_summary_df) && !("VPS35_per_nucleus" %in% names(HeLa_summary_df))) {
  HeLa_summary_df <- HeLa_summary_df %>% rename(VPS35_per_nucleus = n_VPS35_per_nucleus)
}

summary_avg_metrics_vec <- c("avg_area_HA", "avg_area_EEA1", "avg_area_VPS35")
summary_pernuc_metrics_vec <- c("HA_per_nucleus", "EEA1_per_nucleus", "VPS35_per_nucleus")

hela_add_summary_stats <- function(df_in, metric_names, adjust_scope_label) {
  present_metrics <- intersect(metric_names, names(df_in))
  if (length(present_metrics) == 0) return(df_in)

  stats_list <- lapply(present_metrics, function(mn) {
    st <- hela_wilcox_by_group(
      df_in %>% select(genotype, !!sym(mn)) %>% mutate(metric = mn),
      group_var = "metric",
      value_col = mn
    )
    st$metric <- mn
    st
  })

  stats_df <- bind_rows(stats_list) %>%
    mutate(
      p_adj = p.adjust(p, method = "BH"),
      p_label = case_when(
        is.na(p_adj) ~ "n.a.",
        p_adj < 0.001 ~ "***",
        p_adj < 0.01  ~ "**",
        p_adj < 0.05  ~ "*",
        TRUE          ~ "ns"
      )
    )

  df_out <- df_in
  for (mn in present_metrics) {
    row_m <- stats_df %>% filter(metric == mn) %>% slice(1)
    df_out[[paste0("p_adj_", mn)]] <- row_m$p_adj
    df_out[[paste0("p_label_", mn)]] <- row_m$p_label
    df_out[[paste0("statistic_", mn)]] <- row_m$statistic
  }

  readr::write_csv(
    stats_df %>% select(metric, statistic, p, p_adj, p_label),
    file.path(hela_out_dir, paste0("HeLa_summary_stats_", adjust_scope_label, ".csv"))
  )

  df_out
}

HeLa_summary_df <- HeLa_summary_df %>%
  hela_add_summary_stats(summary_avg_metrics_vec, "avg_area") %>%
  hela_add_summary_stats(summary_pernuc_metrics_vec, "per_nucleus")

readr::write_csv(HeLa_summary_df,file.path(hela_out_dir, "HeLa_summary_with_stats.csv"))


# --- 7. Plotting helpers
hela_plot_coloc_metric <- function(input_df, y_col, y_lab, out_name, palette_vec) {
  stopifnot(y_col %in% names(input_df))

  stats_tbl <- input_df %>%
    select(pair, genotype, !!sym(y_col)) %>%
    filter(!is.na(.data[[y_col]])) %>%
    group_by(pair) %>%
    do({
      if (dplyr::n_distinct(.$genotype) < 2) tibble(statistic = NA_real_, p = NA_real_)
      else {
        wt <- rstatix::wilcox_test(reformulate("genotype", response = y_col), data = .)
        tibble(statistic = wt$statistic, p = wt$p)
      }
    }) %>%
    ungroup() %>%
    mutate(
      p_adj = p.adjust(p, method = "BH"),
      p_label = case_when(
        is.na(p_adj) ~ "n.a.",
        p_adj < 0.001 ~ "***",
        p_adj < 0.01  ~ "**",
        p_adj < 0.05  ~ "*",
        TRUE          ~ "ns"
      )
    )

  y_pos_tbl <- input_df %>%
    group_by(pair) %>%
    summarize(y_pos = max(.data[[y_col]], na.rm = TRUE) * 1.05, .groups = "drop")

  stats_for_plot <- left_join(stats_tbl, y_pos_tbl, by = "pair")

  p_obj <- ggplot(input_df, aes(x = genotype, y = .data[[y_col]], fill = genotype)) +
    geom_violin(trim = FALSE, linewidth = 0.2) +
    geom_boxplot(width = 0.15, outlier.shape = NA, fill = "white") +
    geom_jitter(width = 0.12, alpha = 0.6, size = 0.9) +
    scale_fill_manual(values = palette_vec) +
    labs(title = y_lab, x = "Genotype", y = y_lab) +
    facet_wrap(~ pair, scales = "free_y") +
    theme_bw(base_size = 10) +
    theme(
      panel.grid = element_blank(),
      legend.position = "none",
      strip.background = element_rect(fill = "grey95", color = "grey80")
    ) +
    geom_text(
      data = stats_for_plot,
      aes(x = 1.5, y = y_pos, label = paste0("BH p: ", signif(p_adj, 3), "  ", p_label)),
      inherit.aes = FALSE, size = 3
    )

  ggsave(file.path(hela_out_dir, out_name), p_obj, width = 10, height = 7)
  invisible(p_obj)
}

hela_plot_summary_metrics <- function(input_df, metric_vec, title_txt, out_name, palette_vec) {
  metric_vec <- intersect(metric_vec, names(input_df))
  if (length(metric_vec) == 0) {
    warning("No requested metrics found for ", out_name)
    return(invisible(NULL))
  }

  long_df <- input_df %>%
    select(genotype, dplyr::all_of(metric_vec)) %>%
    pivot_longer(cols = dplyr::all_of(metric_vec), names_to = "metric", values_to = "value")

  p_sm <- ggplot(long_df, aes(x = genotype, y = value, fill = genotype)) +
    geom_violin(trim = FALSE, linewidth = 0.2) +
    geom_boxplot(width = 0.25, outlier.shape = NA) +
    geom_jitter(width = 0.12, alpha = 0.6, size = 0.9) +
    scale_fill_manual(values = palette_vec) +
    labs(title = title_txt, x = "Genotype", y = NULL) +
    facet_wrap(~ metric, scales = "free_y") +
    theme_bw(base_size = 10) +
    theme(
      panel.grid = element_blank(),
      legend.position = "none",
      strip.background = element_rect(fill = "grey95", color = "grey80")
    )

  ggsave(file.path(hela_out_dir, out_name), p_sm, width = 10, height = 7)
  invisible(p_sm)
}


# --- 8. Plots
# Colocalization
hela_plot_coloc_metric(
  HeLa_colocalization_df, "frac_coloc_A",
  "Fraction colocalized in A", "HeLa_frac_coloc_A_by_genotype.pdf",
  hela_genotype_colors
)
hela_plot_coloc_metric(
  HeLa_colocalization_df, "frac_coloc_B",
  "Fraction colocalized in B", "HeLa_frac_coloc_B_by_genotype.pdf",
  hela_genotype_colors
)

# Per image summary
hela_plot_summary_metrics(
  HeLa_summary_df,
  c("avg_area_HA", "avg_area_EEA1", "avg_area_VPS35"),
  "Average object area per image",
  "HeLa_summary_avg_area_metrics.pdf",
  hela_genotype_colors
)
hela_plot_summary_metrics(
  HeLa_summary_df,
  c("HA_per_nucleus", "EEA1_per_nucleus", "VPS35_per_nucleus"),
  "Objects per nucleus per image",
  "HeLa_summary_per_nucleus_metrics.pdf",
  hela_genotype_colors
)



```

