---
title: "neuron_endo_syn_eval"
output: html_document
date: "2025-08-15"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# I. Load packackes
```{r}
library(devtools)
# Core data manipulation 
library(tidyverse)
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(tibble)
library(purrr)

# plotting
library(ggplot2)
library(Cairo)

# data cleaning
library(janitor)

# stats
library(rstatix)
library(ggpubr)   

# tidy evaluation
library(rlang)


```


# II. EEA1 numbers in iN and iDA neurons 
```{r}
# ------------------------------------------
# Color of 5min or 45min incubated TFN-488 in
# HeLa Control and ASAH1-/- 
# ------------------------------------------

# --- 1. Path to your metrics
metrics_dir <- "/Users/felix/Documents/PostDoc/Harvard/03_LSD-PD/Microscopy/20240417_diff118_iN-iDA_test_d23_Ctrl-SMPD1-ASAH1/EEA1eval/results/metrics"
outdir <- "/Users/felix/Documents/PostDoc/Harvard/03_LSD-PD/Microscopy/20240417_diff118_iN-iDA_test_d23_Ctrl-SMPD1-ASAH1/EEA1eval/results/metrics"

# --- 2. data
eea1_neuron_df <- read_csv(file.path(metrics_dir, "per_image_summary.csv"), show_col_types = FALSE)

# --- 3. groups and colors
eea1_neuron_df <- eea1_neuron_df %>%
  mutate(
    group_combo = paste(Genotype, neurontype, sep = "_"),
    group_combo = factor(group_combo, levels = c("Ctrl_iN", "Ctrl_iDA", "ASAH1_iN", "ASAH1_iDA"))
  )

group_colors <- c(
  "Ctrl_iN"   = "grey60",
  "Ctrl_iDA"  = "grey80",
  "ASAH1_iN"  = "dodgerblue3",
  "ASAH1_iDA" = "dodgerblue"
)

# --- 4. summary stats
eea1_summary_df <- eea1_neuron_df %>%
  group_by(group_combo, Genotype, neurontype) %>%
  summarise(
    mean_n_EEA1_nuc = mean(n_EEA1_nuc, na.rm = TRUE),
    sd_n_EEA1_nuc   = sd(n_EEA1_nuc, na.rm = TRUE),
    n_images        = dplyr::n(),
    se_n_EEA1_nuc   = sd_n_EEA1_nuc / sqrt(n_images),
    .groups = "drop"
  )

# --- 5. stats
kw_test_df <- kruskal_test(n_EEA1_nuc ~ group_combo, data = eea1_neuron_df) %>%
  mutate(test = "Kruskal-Wallis")
kw_subtitle <- paste0("Kruskal-Wallis p = ", signif(kw_test_df$p, 3))

pwc <- eea1_neuron_df %>%
  pairwise_wilcox_test(n_EEA1_nuc ~ group_combo, p.adjust.method = "holm") %>%
  add_xy_position(x = "group_combo", fun = "max", data = eea1_neuron_df)

# --- 6. plot with jitter and p-value brackets
p_eea1_bar_sd_jitter <- ggplot(eea1_summary_df, aes(x = group_combo, y = mean_n_EEA1_nuc, fill = group_combo)) +
  geom_col(width = 0.7) +
  geom_errorbar(aes(ymin = mean_n_EEA1_nuc - sd_n_EEA1_nuc,
                    ymax = mean_n_EEA1_nuc + sd_n_EEA1_nuc),
                width = 0.15) +
  geom_point(data = eea1_neuron_df, aes(x = group_combo, y = n_EEA1_nuc),color = "black", position = position_jitter(width = 0.12, height = 0),
             size = 1.6, alpha = 0.4, inherit.aes = FALSE) +
  scale_fill_manual(values = group_colors, guide = "none") +
  labs(x = "Group", y = "n_EEA1_nuc (mean ± SD)",
       title = "larger EEA1 puncta per nucleus",
       subtitle = kw_subtitle) +
  theme_bw(base_size = 6) +
  theme(panel.grid = element_blank()) +
  expand_limits(y = max(pwc$y.position, na.rm = TRUE) * 1.05)

p_eea1_bar_sd_jitter <- p_eea1_bar_sd_jitter +
  stat_pvalue_manual(pwc,
                     label = "p.adj.signif",
                     xmin = "group1", xmax = "group2",
                     y.position = "y.position",
                     tip.length = 0.01, size = 2.6)

# --- 7. save
write_csv(eea1_summary_df, file.path(outdir, "eea1_neuron_stats_summary.csv"))
write_csv(kw_test_df,      file.path(outdir, "eea1_neuron_kw_test.csv"))
write_csv(pwc,             file.path(outdir, "eea1_neuron_pairwise_wilcoxon_with_xypos.csv"))
ggsave(file.path(outdir, "eea1_neuron_barplot_n_EEA1_nuc_mean_SD_jitter_pvals.pdf"), p_eea1_bar_sd_jitter, width = 3, height = 4, units = "in")
```



# III. Synatic marker evaluation iN and iDA, day 30/38 in Ctrl and ASAH1 
### IIIa. setup and parse though data 
```{r}
# ------------------------------------------------------------------- #
# Synatic marker evaluation iN and iDA, day 30/38 in Ctrl and ASAH1 
# data file parser to combine data from eval folders d30 d38 & different genotypes 
# ------------------------------------------------------------------- #

# --- 1. define color maps for plotting 
group_colors <- c(
  "Ctrl_iN"   = "grey60",
  "Ctrl_iDA"  = "grey80",
  "ASAH1_iN"  = "dodgerblue3",
  "ASAH1_iDA" = "dodgerblue"
)

# --- 2. parse though HD folders to read in result files 
# 2.2 Base directory and subfolders
eval_base_dir <- "/Users/felix/Documents/PostDoc/Harvard/03_LSD-PD/Microscopy/20241225_diff129_iN-iDA_d23-d30-d38/Data"
outdir <- "/Users/felix/Documents/PostDoc/Harvard/03_LSD-PD/Microscopy/20241225_diff129_iN-iDA_d23-d30-d38/Data/Results"

eval_folders <- c(
  "20241130_diff129_iNiDA_d30_ASAH1_plate1_SynMarker_MIP/_out/metrics",
  "20241130_diff129_iNiDA_d30_Ctrl_plate1_SynMarker_MIP/_out/metrics",
  "20241224_diff129_iNiDA_d38_ASAH1_plate2_SynMarkers_MIP/_out/metrics",
  "20241224_diff129_iNiDA_d38_Ctrl_plate2_SynMarkers_MIP/_out/metrics"
)

# 2.2 Build full paths
eval_paths <- file.path(eval_base_dir, eval_folders, "per_image_summary.csv")

# Annotate genotype/day
eval_input_tbl <- tibble(
  file_path = eval_paths,
  genotype  = c("ASAH1", "Ctrl", "ASAH1", "Ctrl"),
  day       = c(30, 30, 38, 38)
)

# 2.3 Output
eval_output_file <- file.path(outdir, "combined_per_image_eval.csv")

eval_read_one <- function(file_path) {
  read_csv(
    file_path,
    col_types = cols(
      .default   = col_guess(),
      series_id  = col_character(),   # <- key fix
      wavelength = col_character()    # <- optional: prevents future clashes
    ),
    progress = FALSE
  )
}
eval_combine_and_save <- function(input_tbl,
                                  out_file,
                                  out_dir = dirname(out_file)) {
  if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

  safe_read <- possibly(eval_read_one, otherwise = NULL)

  annotated <- pmap(
    list(input_tbl$file_path, input_tbl$genotype, input_tbl$day),
    function(p, g, d) {
      df <- safe_read(p)
      if (is.null(df)) return(NULL)
      df %>%
        mutate(
          genotype   = g,
          day        = as.integer(d),
          source_file = as.character(p)
        )
    }
  )

  non_null <- annotated[!vapply(annotated, is.null, logical(1))]
  if (length(non_null) == 0L) stop("No files could be read.")

  eval_combined_df <- bind_rows(non_null)

  # 2.4 Put metadata collumn first in output dataframe
  front_cols <- c("genotype", "day", "source_file")
  ordered_cols <- c(intersect(front_cols, names(eval_combined_df)),
                    setdiff(names(eval_combined_df), front_cols))
  eval_combined_df <- eval_combined_df[, ordered_cols]

  write_csv(eval_combined_df, out_file)
  message("Wrote: ", out_file)
  invisible(eval_combined_df)
}

# --- 3. Run function once to get combined dataframe
 combined_syneval_df <- eval_combine_and_save(eval_input_tbl, eval_output_file)

 
 coloc_cols <- c(
  "bassoon_total_objects","bassoon_syp_coloc_count","bassoon_single_count",
  "bassoon_syp_coloc_percent","bassoon_single_percent",
  "syp_total_objects","syp_bassoon_coloc_count","syp_single_count",
  "syp_bassoon_coloc_percent","syp_single_percent"
)

combined_syneval_df <- combined_syneval_df %>%
  mutate(across(any_of(coloc_cols), ~ suppressWarnings(as.numeric(.))))


```


### IIIb. run stat test on objects and plot 
```{r}
# ------------------------------------------------------------------- #
# Synatic marker evaluation iN and iDA, day 30/38 in Ctrl and ASAH1 
# stat test and plotting function 
# ------------------------------------------------------------------- #

# --- 1. Helper: standard error of the mean
.sem_val_fn <- function(x) sd(x, na.rm = TRUE) / sqrt(sum(is.finite(x)))

# --- 2. Helper: convert p-values to significance symbols
.p_to_symbol <- function(p) {
  case_when(
    is.na(p) ~ "",
    p < 1e-4 ~ "****",
    p < 1e-3 ~ "***",
    p < 1e-2 ~ "**",
    p < 0.05 ~ "*",
    TRUE ~ "ns"
  )
}

# --- 2.1 Helper: normalize stain names to canonical labels (handles TOMM20/TOM20 etc.)
.normalize_stain <- function(x) {
  x_chr <- as.character(x)
  x_up  <- toupper(x_chr)
  dplyr::case_when(
    x_up %in% c("TOMM20", "TOM20") ~ "Tom20",
    x_up %in% c("SYN1", "SYN")     ~ "SYN1",
    x_up %in% c("SYP")             ~ "SYP",
    x_up %in% c("BASSOON")         ~ "Bassoon",
    x_up %in% c("EEA1")            ~ "EEA1",
    TRUE                           ~ x_chr
  )
}

# --- 3. Main function for eval and plotting of python script results
make_syn_barplots_with_stats <- function(df_input,
                                         output_dir,
                                         stains_keep = c("Bassoon","SYP","SYN1","EEA1","Tom20"),
                                         metrics_keep = c(
                                           "object_count","avg_perimeter_px","avg_eccentricity",
                                           "avg_solidity","avg_area_px",
                                           "syp_total_objects","syp_single_count",
                                           "bassoon_syp_coloc_count","syp_bassoon_coloc_count",
                                           "syp_bassoon_coloc_percent","bassoon_syp_coloc_percent"
                                         )) {

  if (!dir.exists(output_dir)) dir.create(output_dir, recursive = TRUE)

  coloc_metrics <- c("syp_total_objects","syp_single_count",
                     "bassoon_syp_coloc_count","syp_bassoon_coloc_count",
                     "syp_bassoon_coloc_percent","bassoon_syp_coloc_percent")

  # 3.1 Filter dataset and create ordered group variable
  df_base <- df_input %>%
    filter(neuron_type %in% c("iN","iDA"),
           genotype %in% c("Ctrl","ASAH1"),
           day %in% c(30L,38L)) %>%
    mutate(
      group_id   = factor(paste(genotype, neuron_type, sep = "_"),
                          levels = c("Ctrl_iN","Ctrl_iDA","ASAH1_iN","ASAH1_iDA")),
      day        = as.integer(day),
      stain_name = ifelse(is.na(stain_name), "NA", stain_name),
      stain_norm = .normalize_stain(stain_name)   # <- canonicalized stain label
    )

  # 3.1.1 Canonicalize the stains_keep vector to match stain_norm
  stains_keep_norm <- .normalize_stain(stains_keep)

  stats_all_list <- list()

  # 3.2 Loop over metrics
  for (metric_var_name in metrics_keep) {

    # 3.2.1 Keep only rows with finite values for the current metric
    df_metric <- df_base %>% filter(is.finite(.data[[metric_var_name]]))

    # 3.2.2 Facet logic:
    #       - Coloc metrics use a single facet "SYP-Bassoon"
    #       - Non-coloc metrics facet by normalized stain and restrict to stains_keep_norm
    if (metric_var_name %in% coloc_metrics) {
      df_clean <- df_metric %>%
        mutate(facet_group = "SYP-Bassoon")
    } else {
      df_clean <- df_metric %>%
        filter(stain_norm %in% stains_keep_norm) %>%
        mutate(facet_group = stain_norm)
    }

    # Guard: if nothing left, skip this metric
    if (nrow(df_clean) == 0L) next

    # 3.3 ---- Per-day plots
    for (this_day in c(30L,38L)) {
      df_day <- df_clean %>% filter(day == this_day)
      if (nrow(df_day) == 0L) next

      # 3.3.1 Summary statistics for barplots
      df_summary <- df_day %>%
        group_by(facet_group, group_id) %>%
        summarise(n_images=n(),
                  mean_val=mean(.data[[metric_var_name]], na.rm=TRUE),
                  sem_val=.sem_val_fn(.data[[metric_var_name]]),
                  ymax=max(.data[[metric_var_name]],na.rm=TRUE),
                  .groups="drop") %>%
        tidyr::complete(
          facet_group,
          group_id=factor(c("Ctrl_iN","Ctrl_iDA","ASAH1_iN","ASAH1_iDA"),
                          levels=c("Ctrl_iN","Ctrl_iDA","ASAH1_iN","ASAH1_iDA")),
          fill=list(n_images=0,mean_val=0,sem_val=0,ymax=0)
        )

      # 3.3.2 Stats: Wilcoxon pairwise with BH correction
      all_comparisons_4 <- combn(levels(df_summary$group_id), 2, simplify=FALSE)
      stats_by_facet <- df_day %>%
        group_split(facet_group, keep=TRUE) %>%
        purrr::map_df(function(df_f) {
          fg <- unique(df_f$facet_group)
          purrr::map_df(all_comparisons_4, function(cmp) {
            g1 <- cmp[1]; g2 <- cmp[2]
            x1 <- df_f %>% filter(group_id==g1) %>% pull(.data[[metric_var_name]])
            x2 <- df_f %>% filter(group_id==g2) %>% pull(.data[[metric_var_name]])
            wt <- tryCatch(wilcox.test(x1,x2,exact=FALSE), error=function(e) list(p.value=NA_real_))
            tibble(facet_group=fg,group1=g1,group2=g2,
                   n1=sum(is.finite(x1)),n2=sum(is.finite(x2)),
                   p_raw=as.numeric(wt$p.value))
          }) %>% mutate(p_adj=p.adjust(p_raw,method="BH"))
        }) %>%
        mutate(metric=metric_var_name, day=this_day, p_symbol=.p_to_symbol(p_adj))
      stats_all_list[[paste(metric_var_name,this_day,sep="_")]] <- stats_by_facet

      # 3.3.3 Positioning of significance bars
      y_positions_df <- df_summary %>%
        group_by(facet_group) %>%
        summarise(base_y=max(ymax,na.rm=TRUE),.groups="drop") %>%
        mutate(base_y=ifelse(is.finite(base_y),base_y,0))
      pval_annot <- stats_by_facet %>%
        left_join(y_positions_df, by="facet_group") %>%
        group_by(facet_group) %>%
        mutate(step=ifelse(base_y>0,0.05*base_y,0.05),
               y.position=base_y+seq_len(n())*step,
               xmin=group1,xmax=group2,label=p_symbol) %>%
        ungroup() %>% filter(!label %in% c("ns",""))

      # 3.3.4 Plotting (bar)
      y_lab <- if (grepl("percent$", metric_var_name)) paste0(metric_var_name," [%]") else metric_var_name
      p_syn <- ggplot(df_summary,aes(x=group_id,y=mean_val,fill=group_id)) +
        geom_col(width=0.7) +
        geom_errorbar(aes(ymin=mean_val-sem_val,ymax=mean_val+sem_val),width=0.2) +
        geom_jitter(data=df_day,aes(x=group_id,y=.data[[metric_var_name]]),
                    inherit.aes=FALSE,alpha=0.5,width=0.15,height=0,color="black") +
        facet_wrap(~facet_group,scales="free_y",nrow=1) +
        scale_fill_manual(values=group_colors,guide="none") +
        labs(x="Genotype × Neuron type", y=y_lab,
             title=paste0("Day ",this_day," · ",metric_var_name)) +
        theme_bw(base_size=6)+
        theme(panel.grid=element_blank(),strip.background=element_blank(),
              axis.text.x=element_text(angle=30,hjust=1,vjust=1),
              plot.title=element_text(face="bold"))
      if(nrow(pval_annot)>0){
        p_syn <- p_syn + stat_pvalue_manual(pval_annot,label="label",
                                            xmin="xmin",xmax="xmax",y.position="y.position",
                                            tip.length=0.01,bracket.size=0.3,size=2.2)
      }
      
      ## save pdfs
      ggsave(file.path(output_dir,paste0("syn_barplot_",metric_var_name,"_day",this_day,".pdf")), p_syn,width=3,height=4.2,units="in",device=cairo_pdf)

      
      
      # 3.3.5 Plotting (violin + jitter behind + white box on top)
      p_syn_violin <- ggplot(df_day, aes(x = group_id, y = .data[[metric_var_name]], fill = group_id)) +
        geom_jitter(width = 0.15, height = 0, alpha = 0.2, color = "black") +
        geom_violin(width = 0.85, scale = "width", trim = TRUE) +
        geom_boxplot(width = 0.25, outlier.shape = NA, fill = "white", color = "black", fatten = 1) +
        facet_wrap(~ facet_group, scales = "free_y", nrow = 1) +
        scale_fill_manual(values = group_colors, guide = "none") +
        labs(x = "Genotype × Neuron type", y = y_lab,
             title = paste0("Day ", this_day, " · ", metric_var_name, " (violin)")) +
        theme_bw(base_size = 6) +
        theme(panel.grid = element_blank(),
              strip.background = element_blank(),
              axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
              plot.title = element_text(face = "bold"))
      ggsave(file.path(output_dir, paste0("syn_violin_", metric_var_name, "_day", this_day, ".pdf")), p_syn_violin, width = 3, height = 4, units = "in", device = cairo_pdf)

      
      # 3.3.6 Add significance to violin (reuse pval_annot)
      if (nrow(pval_annot) > 0) {
        p_syn_violin_stats <- p_syn_violin +
          stat_pvalue_manual(
            pval_annot,
            label = "label",
            xmin = "xmin", xmax = "xmax",
            y.position = "y.position",
            tip.length = 0.01, bracket.size = 0.3, size = 2.0
          ) +
          expand_limits(y = max(pval_annot$y.position, na.rm = TRUE) * 1.02)

        ggsave(file.path(output_dir, paste0("syn_violin_", metric_var_name, "_day", this_day, "_pvals.pdf")), p_syn_violin_stats, width = 3, height = 4, units = "in", device = cairo_pdf)
      }
      
      # 3.3.7 Optional: single-facet violin plots (one per stain/metric/day) with stats
      for (fg in unique(df_day$facet_group)) {
        df_day_fg <- df_day %>% filter(facet_group == fg)
        pval_annot_fg <- pval_annot %>% filter(facet_group == fg)
        if (nrow(df_day_fg) == 0) next

        p_fg <- ggplot(df_day_fg, aes(x = group_id, y = .data[[metric_var_name]], fill = group_id)) +
          geom_jitter(width = 0.15, height = 0, alpha = 0.2, color = "black") +
          geom_violin(width = 0.85, scale = "width", trim = TRUE) +
          geom_boxplot(width = 0.25, outlier.shape = NA, fill = "white", color = "black", fatten = 1) +
          scale_fill_manual(values = group_colors, guide = "none") +
          labs(x = "Genotype × Neuron type", y = y_lab,
               title = paste0("Day ", this_day, " · ", metric_var_name, " · ", fg)) +
          theme_bw(base_size = 6) +
          theme(panel.grid = element_blank(),
                strip.background = element_blank(),
                axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
                plot.title = element_text(face = "bold"))

        if (nrow(pval_annot_fg) > 0) {
          p_fg <- p_fg + stat_pvalue_manual(
            pval_annot_fg,
            label = "label", xmin = "xmin", xmax = "xmax", y.position = "y.position",
            tip.length = 0.01, bracket.size = 0.3, size = 2.0
          ) +
          expand_limits(y = max(pval_annot_fg$y.position, na.rm = TRUE) * 1.02)
        }

        ggsave(file.path(output_dir,
                         paste0("syn_violin_", metric_var_name,
                                "_day", this_day, "_", fg, "_pvals.pdf")),
               p_fg, width = 3, height = 4, units = "in", device = cairo_pdf)
      }
    }

    # 3.4 ---- Merged-days 8-group plots (with stats)
    # 3.4.1 Build df with group_day
    df_merged <- df_clean %>%
      mutate(
        group_day=factor(paste(genotype,neuron_type,paste0("d",day),sep="_"),
                         levels=c("Ctrl_iN_d30","Ctrl_iN_d38","Ctrl_iDA_d30","Ctrl_iDA_d38",
                                  "ASAH1_iN_d30","ASAH1_iN_d38","ASAH1_iDA_d30","ASAH1_iDA_d38"))
      )

    
    # 3.4.2 Summaries
    df_summary_merged <- df_merged %>%
      group_by(facet_group,group_day,group_id) %>%
      summarise(n_images=n(),
                mean_val=mean(.data[[metric_var_name]],na.rm=TRUE),
                sem_val=.sem_val_fn(.data[[metric_var_name]]),
                ymax=max(.data[[metric_var_name]],na.rm=TRUE),.groups="drop") %>%
      tidyr::complete(facet_group,
                      group_day=factor(levels(df_merged$group_day),levels=levels(df_merged$group_day)),
                      group_id=factor(levels(df_base$group_id),levels=levels(df_base$group_id)),
                      fill=list(n_images=0,mean_val=0,sem_val=0,ymax=0))

    # 3.4.3 Stats for merged
    all_comparisons_8 <- combn(levels(df_summary_merged$group_day),2,simplify=FALSE)
    stats_merged <- df_merged %>%
      group_split(facet_group,keep=TRUE) %>%
      purrr::map_df(function(df_f){
        fg <- unique(df_f$facet_group)
        purrr::map_df(all_comparisons_8,function(cmp){
          g1 <- cmp[1]; g2 <- cmp[2]
          x1 <- df_f %>% filter(group_day==g1) %>% pull(.data[[metric_var_name]])
          x2 <- df_f %>% filter(group_day==g2) %>% pull(.data[[metric_var_name]])
          wt <- tryCatch(wilcox.test(x1,x2,exact=FALSE),error=function(e) list(p.value=NA_real_))
          tibble(facet_group=fg,group1=g1,group2=g2,
                 n1=sum(is.finite(x1)),n2=sum(is.finite(x2)),
                 p_raw=as.numeric(wt$p.value))
        }) %>% mutate(p_adj=p.adjust(p_raw,method="BH"))
      }) %>%
      mutate(metric=metric_var_name,day=NA_integer_,p_symbol=.p_to_symbol(p_adj))
    stats_all_list[[paste(metric_var_name,"merged",sep="_")]] <- stats_merged

    
    
    # 3.4.4 Positioning and plot (bar)
    y_positions_merged <- df_summary_merged %>%
      group_by(facet_group) %>%
      summarise(base_y=max(ymax,na.rm=TRUE),.groups="drop") %>%
      mutate(base_y=ifelse(is.finite(base_y),base_y,0))
    pval_annot_merged <- stats_merged %>%
      left_join(y_positions_merged,by="facet_group") %>%
      group_by(facet_group) %>%
      mutate(step=ifelse(base_y>0,0.05*base_y,0.05),
             y.position=base_y+seq_len(n())*step,
             xmin=group1,xmax=group2,label=p_symbol) %>%
      ungroup() %>% filter(!label %in% c("ns",""))
    y_lab <- if(grepl("percent$",metric_var_name)) paste0(metric_var_name," [%]") else metric_var_name

    p_merged <- ggplot(df_summary_merged,aes(x=group_day,y=mean_val,fill=group_id))+
      geom_col(width=0.7)+
      geom_errorbar(aes(ymin=mean_val-sem_val,ymax=mean_val+sem_val),width=0.2)+
      geom_jitter(data=df_merged,aes(x=group_day,y=.data[[metric_var_name]]),
                  inherit.aes=FALSE,alpha=0.5,width=0.15,height=0,color="black")+
      facet_wrap(~facet_group,scales="free_y",nrow=1)+
      scale_fill_manual(values=group_colors,name=NULL)+
      labs(x="Genotype × Neuron type × Day", y=y_lab,
           title=paste0("Merged days · ",metric_var_name))+
      theme_bw(base_size=6)+
      theme(panel.grid=element_blank(),strip.background=element_blank(),
            axis.text.x=element_text(angle=30,hjust=1,vjust=1),
            plot.title=element_text(face="bold"),legend.position="bottom")+
      stat_pvalue_manual(pval_annot_merged,label="label",xmin="xmin",xmax="xmax",
                         y.position="y.position",tip.length=0.01,bracket.size=0.3,size=2.0)

    ## save pdfs
    ggsave(file.path(output_dir,paste0("syn_barplot_",metric_var_name,"_merged_days.pdf")), p_merged, width=3, height=4.2, units="in", device=cairo_pdf)

    # 3.4.5 Violin+jitter+boxplot for merged-days
    p_merged_violin <- ggplot(df_merged, aes(x = group_day, y = .data[[metric_var_name]], fill = group_id)) +
      geom_jitter(width = 0.15, height = 0, alpha = 0.2, color = "black") +
      geom_violin(width = 0.85, scale = "width", trim = TRUE) +
      geom_boxplot(width = 0.25, outlier.shape = NA, fill = "white", color = "black", fatten = 1) +
      facet_wrap(~ facet_group, scales = "free_y", nrow = 1) +
      scale_fill_manual(values = group_colors, name = NULL) +
      labs(x = "Genotype × Neuron type × Day", y = y_lab,
           title = paste0("Merged days · ", metric_var_name, " (violin)")) +
      theme_bw(base_size = 6) +
      theme(panel.grid = element_blank(),
            strip.background = element_blank(),
            axis.text.x = element_text(angle = 30, hjust = 1, vjust = 1),
            plot.title = element_text(face = "bold"),
            legend.position = "bottom")
    ggsave(file.path(output_dir, paste0("syn_violin_", metric_var_name, "_merged_days.pdf")),
           p_merged_violin, width = 3, height = 4, units = "in", device = cairo_pdf)

    # 3.4.6 Add significance to merged violin (reuse pval_annot_merged)
    if (nrow(pval_annot_merged) > 0) {
      p_merged_violin_stats <- p_merged_violin +
        stat_pvalue_manual(
          pval_annot_merged,
          label = "label",
          xmin = "xmin", xmax = "xmax",
          y.position = "y.position",
          tip.length = 0.01, bracket.size = 0.3, size = 2.0
        ) +
        expand_limits(y = max(pval_annot_merged$y.position, na.rm = TRUE) * 1.02)

      ggsave(file.path(output_dir, paste0("syn_violin_", metric_var_name, "_merged_days_pvals.pdf")),  p_merged_violin_stats, width = 3, height = 4, units = "in", device = cairo_pdf)
    }
  }

  # 3.5 Combine all stats and save
  stats_all_df <- bind_rows(stats_all_list) %>%
    select(day,metric,facet_group,group1,group2,n1,n2,p_raw,p_adj,p_symbol) %>%
    arrange(metric,day,facet_group,group1,group2)
  write_csv(stats_all_df,file.path(output_dir,"syn_barplot_pairwise_stats_BH.csv"))
}



# --- 4. Call function, define input / output 
make_syn_barplots_with_stats(
  df_input   = combined_syneval_df,
  output_dir = outdir
)

```



