---
title: "neuron_endo_syn_eval"
output: html_document
date: "2025-08-15"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# I. Load packackes
```{r}
library(devtools)
# Core data manipulation 
library(tidyverse)
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(tibble)
library(purrr)

# plotting
library(ggplot2)
library(Cairo)

# data cleaning
library(janitor)

# stats
library(rstatix)
library(ggpubr)   

# tidy evaluation
library(rlang)


```


# II. EEA1 numbers in iN and iDA neurons 
```{r}
# ------------------------------------------
# Color of 5min or 45min incubated TFN-488 in
# HeLa Control and ASAH1-/- 
# ------------------------------------------

# --- 1. Path to your metrics
metrics_dir <- "/Users/felix/Documents/PostDoc/Harvard/03_LSD-PD/Microscopy/20240417_diff118_iN-iDA_test_d23_Ctrl-SMPD1-ASAH1/EEA1eval/results/metrics"
outdir <- "/Users/felix/Documents/PostDoc/Harvard/03_LSD-PD/Microscopy/20240417_diff118_iN-iDA_test_d23_Ctrl-SMPD1-ASAH1/EEA1eval/results/metrics"

# --- 2. data
eea1_neuron_df <- read_csv(file.path(metrics_dir, "per_image_summary.csv"), show_col_types = FALSE)

# --- 3. groups and colors
eea1_neuron_df <- eea1_neuron_df %>%
  mutate(
    group_combo = paste(Genotype, neurontype, sep = "_"),
    group_combo = factor(group_combo, levels = c("Ctrl_iN", "Ctrl_iDA", "ASAH1_iN", "ASAH1_iDA"))
  )

group_colors <- c(
  "Ctrl_iN"   = "grey60",
  "Ctrl_iDA"  = "grey80",
  "ASAH1_iN"  = "dodgerblue3",
  "ASAH1_iDA" = "dodgerblue"
)

# --- 4. summary stats
eea1_summary_df <- eea1_neuron_df %>%
  group_by(group_combo, Genotype, neurontype) %>%
  summarise(
    mean_n_EEA1_nuc = mean(n_EEA1_nuc, na.rm = TRUE),
    sd_n_EEA1_nuc   = sd(n_EEA1_nuc, na.rm = TRUE),
    n_images        = dplyr::n(),
    se_n_EEA1_nuc   = sd_n_EEA1_nuc / sqrt(n_images),
    .groups = "drop"
  )

# --- 5. stats
kw_test_df <- kruskal_test(n_EEA1_nuc ~ group_combo, data = eea1_neuron_df) %>%
  mutate(test = "Kruskal-Wallis")
kw_subtitle <- paste0("Kruskal-Wallis p = ", signif(kw_test_df$p, 3))

pwc <- eea1_neuron_df %>%
  pairwise_wilcox_test(n_EEA1_nuc ~ group_combo, p.adjust.method = "holm") %>%
  add_xy_position(x = "group_combo", fun = "max", data = eea1_neuron_df)

# --- 6. plot with jitter and p-value brackets
p_eea1_bar_sd_jitter <- ggplot(eea1_summary_df, aes(x = group_combo, y = mean_n_EEA1_nuc, fill = group_combo)) +
  geom_col(width = 0.7) +
  geom_errorbar(aes(ymin = mean_n_EEA1_nuc - sd_n_EEA1_nuc,
                    ymax = mean_n_EEA1_nuc + sd_n_EEA1_nuc),
                width = 0.15) +
  geom_point(data = eea1_neuron_df, aes(x = group_combo, y = n_EEA1_nuc),color = "black", position = position_jitter(width = 0.12, height = 0),
             size = 1.6, alpha = 0.4, inherit.aes = FALSE) +
  scale_fill_manual(values = group_colors, guide = "none") +
  labs(x = "Group", y = "n_EEA1_nuc (mean Â± SD)",
       title = "larger EEA1 puncta per nucleus",
       subtitle = kw_subtitle) +
  theme_bw(base_size = 6) +
  theme(panel.grid = element_blank()) +
  expand_limits(y = max(pwc$y.position, na.rm = TRUE) * 1.05)

p_eea1_bar_sd_jitter <- p_eea1_bar_sd_jitter +
  stat_pvalue_manual(pwc,
                     label = "p.adj.signif",
                     xmin = "group1", xmax = "group2",
                     y.position = "y.position",
                     tip.length = 0.01, size = 2.6)

# --- 7. save
write_csv(eea1_summary_df, file.path(outdir, "eea1_neuron_stats_summary.csv"))
write_csv(kw_test_df,      file.path(outdir, "eea1_neuron_kw_test.csv"))
write_csv(pwc,             file.path(outdir, "eea1_neuron_pairwise_wilcoxon_with_xypos.csv"))
ggsave(file.path(outdir, "eea1_neuron_barplot_n_EEA1_nuc_mean_SD_jitter_pvals.pdf"), p_eea1_bar_sd_jitter, width = 3, height = 4, units = "in")
```



# II. Synatic marker evaluation iN and iDA, day 30/38 in Ctrl and ASAH1 
### IIa. setup and parse though data 
```{r}
# ------------------------------------------------------------------- #
# Synatic marker evaluation iN and iDA, day 30/38 in Ctrl and ASAH1 
# ------------------------------------------------------------------- #

# --- 1. define color maps for plotting 
group_colors <- c(
  "Ctrl_iN"   = "grey60",
  "Ctrl_iDA"  = "grey80",
  "ASAH1_iN"  = "dodgerblue3",
  "ASAH1_iDA" = "dodgerblue"
)

# --- 2. parse though HD folders to read in result files 
# Base directory and subfolders
eval_base_dir <- "/Users/felix/Documents/PostDoc/Harvard/03_LSD-PD/Microscopy/20241225_diff129_iN-iDA_d23-d30-d38/Data"
outdir <- "/Users/felix/Documents/PostDoc/Harvard/03_LSD-PD/Microscopy/20241225_diff129_iN-iDA_d23-d30-d38/Data/Results"

eval_folders <- c(
  "20241130_diff129_iNiDA_d30_ASAH1_plate1_SynMarker_MIP/_out/metrics",
  "20241130_diff129_iNiDA_d30_Ctrl_plate1_SynMarker_MIP/_out/metrics",
  "20241224_diff129_iNiDA_d38_ASAH1_plate2_SynMarkers_MIP/_out/metrics",
  "20241224_diff129_iNiDA_d38_Ctrl_plate2_SynMarkers_MIP/_out/metrics"
)

# Build full paths
eval_paths <- file.path(eval_base_dir, eval_folders, "per_image_summary.csv")

# Annotate genotype/day
eval_input_tbl <- tibble(
  file_path = eval_paths,
  genotype  = c("ASAH1", "Ctrl", "ASAH1", "Ctrl"),
  day       = c(30, 30, 38, 38)
)

# Output
eval_output_file <- file.path(outdir, "combined_per_image_eval.csv")

eval_read_one <- function(file_path) {
  read_csv(file_path, col_types = cols(.default = col_guess()), progress = FALSE)
}

eval_combine_and_save <- function(input_tbl,
                                  out_file,
                                  out_dir = dirname(out_file)) {
  if (!dir.exists(out_dir)) dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)

  safe_read <- possibly(eval_read_one, otherwise = NULL)

  annotated <- pmap(
    list(input_tbl$file_path, input_tbl$genotype, input_tbl$day),
    function(p, g, d) {
      df <- safe_read(p)
      if (is.null(df)) return(NULL)
      df %>%
        mutate(
          genotype   = g,
          day        = as.integer(d),
          source_file = as.character(p)
        )
    }
  )

  non_null <- annotated[!vapply(annotated, is.null, logical(1))]
  if (length(non_null) == 0L) stop("No files could be read.")

  eval_combined_df <- bind_rows(non_null)

  # Put metadata first
  front_cols <- c("genotype", "day", "source_file")
  ordered_cols <- c(intersect(front_cols, names(eval_combined_df)),
                    setdiff(names(eval_combined_df), front_cols))
  eval_combined_df <- eval_combined_df[, ordered_cols]

  write_csv(eval_combined_df, out_file)
  message("Wrote: ", out_file)
  invisible(eval_combined_df)
}

# --- 3. Run function once to get combined dataframe
 combined_syneval_df <- eval_combine_and_save(eval_input_tbl, eval_output_file)

```

