---
title: "neuroLSD_CalciumMaster"
output: html_document
date: "2025-07-21"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Aim
Create master file that loops through all calcium imaging evals and combines results in master file for stats, plotting and saving.

# I. Load packackes
```{r}
library(devtools)

# Core data manipulation & visualization
library(tidyverse)        # ggplot2, dplyr, purrr, readr, tibble, tidyr, stringr
library(zoo)              # Rolling operations
library(reshape2)         # Data reshaping
library(pheatmap)         # Heatmaps
library(ggdendro)         # Dendrograms
library(viridis)          # Color palettes
library(RColorBrewer)
library(NatParksPalettes)
library(tidyplots)
library(ggpubr)           # Publication-ready plots
library(ggsignif)         # Significance annotations
library(Cairo)            # For cairo_pdf output
library(patchwork)        # Plot layouts
library(cowplot)          # Plot composition
library(gridExtra)        # Layout utilities
library(grid)             # Viewports and custom layout
library(rlang)            # Tidy evaluation tools

# Network analysis
library(igraph)
library(ggraph)
#devtools::install_github("simo-91/CalNetExploreR")
library(CalNetExploreR)

# Signal processing
#library(signal)

# Plot composition
library(gridExtra)
library(grid)
library(cowplot)
library(Cairo)
library(dplyr)
library(ggsignif)

```


# II. Metdata input 
```{r}
# -------------------
# DEFINE INPUT DIRS 
# -------------------
timepoint_dirs <- list(
  d33iDA = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20241127_diff129_iN-iDA_Ctrl-ASAH1_Calcium-liveCell/cpsamWF/nd2_labels/calcium_analysis_results_dataframes",
  d38 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250710_diff138_iN_d38_Ctrl-ASAH1_Flou4/cpsam_d38/nd2_labels/calcium_analysis_results_dataframes",
  d42 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250714_diff138_iN_d42_Ctrl-ASAH1_Flou4/nd2_labels/calcium_analysis_results_dataframes",
  d45 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250717_diff138_iN_d45_Ctrl-ASAH1_Flou4/nd2_labels/calcium_analysis_results_dataframes",
  d50 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250721_diff138_iN_d50_Ctrl-ASAH1_Flou4/nd2iN_labels/calcium_analysis_results_dataframes",
  d50iDA = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250721_diff138_iN_d50_Ctrl-ASAH1_Flou4/nd2iDA_labels/calcium_analysis_results_dataframes",
  d60 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250731_diff138_iN_d60_Ctrl-ASAH1_Flou4/nd2iN_labels/calcium_analysis_results_dataframes",
  d60iDA = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250731_diff138_iN_d60_Ctrl-ASAH1_Flou4/nd2iDA_labels/calcium_analysis_results_dataframes"
)

# -------------------
# DEFINE INPUT FILES  
# -------------------
ca_filenames <- c(
  "combined_cell_community_membership",
  "comunitySize_highcorr",
  "combined_events_per_min_results",
  "combined_sample_level_normalised_metrics"
)

# -------------------
# DEFINE OUTPUT DIR  
# -------------------
camaster_outdir <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/camaster_outdir"
dir.create(camaster_outdir, showWarnings = FALSE, recursive = TRUE)

camaster_plot_outdir <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/camaster_outdir/plots"
dir.create(camaster_plot_outdir, showWarnings = FALSE, recursive = TRUE)

# -------------------
# DEFINE INPUT METADATA
# -------------------
celltype <- c("iN","iDA")
timepoint <- c("d33", "d38", "d42", "d45", "d50", "d60")
genotypes <- c("Ctrl", "ASAH1")
treatments <- c("Fed_Fluo4", "KCL_Fluo4", "Caffeine_Fluo4", "25µMCQNX10µMDAP5_Fluo4")

```


# III. Parse through files and make master file
```{r}
# -----------------------------
# Metadata annotation helpers
# -----------------------------
extract_match <- function(x, patterns) {
  str_extract(x, str_c(patterns, collapse = "|"))
}

annotate_sample_metadata <- function(df) {
  df %>%
    mutate(
      Celltype    = extract_match(Sample, celltype),
      Timepoint   = extract_match(Sample, timepoint),
      Genotype    = extract_match(Sample, genotypes),
      Treatment   = extract_match(Sample, treatments),
      SampleLabel = str_c(Genotype, Treatment, sep = "_")
    ) %>%
    relocate(Sample, Celltype, Timepoint, Genotype, Treatment, SampleLabel)
}

# -----------------------------
# Master file creation
# -----------------------------
for (fname in ca_filenames) {
  master_df <- map_dfr(timepoint_dirs, function(dir_path) {
    file_path <- file.path(dir_path, paste0(fname, ".csv"))
    if (!file.exists(file_path)) return(NULL)

    df <- read_csv(file_path, show_col_types = FALSE)
    if (!"Sample" %in% colnames(df)) {
      warning("Missing 'Sample' column in: ", file_path)
      return(NULL)
    }

    annotate_sample_metadata(df)
  })

  # Assign variable
  assign(paste0("master_", fname), master_df)

  # Save to output
  write_csv(master_df, file.path(camaster_outdir, paste0("master_", fname, ".csv")))
}

# -----------------------------
# List of Master files
# -----------------------------
master_combined_cell_community_membership
master_comunitySize_highcorr
master_combined_events_per_min_results
master_combined_sample_level_normalised_metrics
```


# IV. Stat test 
```{r}
# -----------------------------
# Stats: Active Frames & Firing Events
# Tiered Comparisons: Treatments, Timepoints, Genotypes
# -----------------------------

run_pairwise_test <- function(df, metric_col, group_col, group1, group2) {
  data_sub <- df %>%
    filter(!!sym(group_col) %in% c(group1, group2)) %>%
    select(!!sym(group_col), !!sym(metric_col)) %>%
    drop_na()

  if (n_distinct(data_sub[[group_col]]) < 2) return(NULL)

  test_res <- wilcox.test(
    formula = as.formula(paste(metric_col, "~", group_col)),
    data = data_sub
  )

  tibble(
    Metric = metric_col,
    GroupVar = group_col,
    Group1 = group1,
    Group2 = group2,
    Statistic = test_res$statistic,
    P_Value = test_res$p.value,
    Method = "Wilcoxon rank-sum"
  )
}

# Add combined labels
stats_df <- master_combined_sample_level_normalised_metrics %>%
  filter(Treatment %in% c("Fed_Fluo4", "KCL_Fluo4", "25µMCQNX10µMDAP5_Fluo4")) %>%
  mutate(
    GroupID = paste(Genotype, Treatment, Timepoint, sep = "_"),
    GenotypeTreatment = paste(Genotype, Treatment, sep = "_")
  )

# ---- 1. Within-genotype treatment comparisons
within_treatment_stats <- stats_df %>%
  group_by(Celltype, Timepoint, Genotype) %>%
  group_modify(~ {
    groups <- unique(.x$Treatment)
    comp_pairs <- combn(groups, 2, simplify = FALSE)

    bind_rows(lapply(comp_pairs, function(comp) {
      bind_rows(
        run_pairwise_test(.x, "Mean_percent_active_frames", "Treatment", comp[1], comp[2]),
        run_pairwise_test(.x, "Firing_events_per_min", "Treatment", comp[1], comp[2])
      ) %>%
        mutate(ComparisonType = "WithinGenotype_Treatment", Genotype = unique(.x$Genotype))
    }))
  }) %>%
  ungroup()

# ---- 2. Within-genotype across timepoints (same treatment)
across_time_stats <- stats_df %>%
  group_by(Celltype, Genotype, Treatment, .drop = TRUE) %>%
  group_modify(~ {
    groups <- unique(.x$Timepoint)
    if (length(groups) < 2) return(NULL)
    comp_pairs <- combn(groups, 2, simplify = FALSE)

    bind_rows(lapply(comp_pairs, function(comp) {
      bind_rows(
        run_pairwise_test(.x, "Mean_percent_active_frames", "Timepoint", comp[1], comp[2]),
        run_pairwise_test(.x, "Firing_events_per_min", "Timepoint", comp[1], comp[2])
      ) %>%
        mutate(
          ComparisonType = "WithinGenotype_Timepoint",
          Celltype = unique(.x$Celltype),
          Genotype = unique(.x$Genotype),
          Treatment = unique(.x$Treatment)
        )
    }))
  }) %>%
  ungroup()

# ---- 3. Between-genotype (same timepoint & treatment)
between_genotype_stats <- stats_df %>%
  group_by(Celltype, Timepoint, Treatment) %>%
  group_modify(~ {
    if (n_distinct(.x$Genotype) < 2) return(NULL)
    bind_rows(
      run_pairwise_test(.x, "Mean_percent_active_frames", "Genotype", "Ctrl", "ASAH1"),
      run_pairwise_test(.x, "Firing_events_per_min", "Genotype", "Ctrl", "ASAH1")
    ) %>%
      mutate(ComparisonType = "BetweenGenotype", Treatment = unique(.x$Treatment))
  }) %>%
  ungroup()

# ---- Combine all tiers
all_stats <- bind_rows(within_treatment_stats, across_time_stats, between_genotype_stats)

# Helper to convert p-values to significance stars
p_to_stars <- function(pval) {
  case_when(
    is.na(pval) ~ "",
    pval <= 0.001 ~ "***",
    pval <= 0.01  ~ "**",
    pval <= 0.05  ~ "*",
    TRUE ~ "ns"
  )
}

# Add TestType, FDR, and significance stars
all_stats <- all_stats %>%
  mutate(
    TestType = ifelse(Metric == "Mean_percent_active_frames", "ActiveFrames", "FiringEvents"),
    P_Adjusted_FDR = p.adjust(P_Value, method = "BH"),
    Signif_raw = p_to_stars(P_Value),
    Signif_FDR = p_to_stars(P_Adjusted_FDR)
  )

# Save with stars
stats_outfile <- file.path(camaster_outdir, "calcium_stats_tests_alltiers.csv")
write_csv(all_stats, stats_outfile)

```


# V. QC plots Ctrl basal-sitmulation-inhibition
```{r}
# -----------------------------
# QC plots 
# -----------------------------

# --- Filter data
inhibitor_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Genotype == "Ctrl",
    Timepoint %in% c("d38", "d42"),
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4", "25µMCQNX10µMDAP5_Fluo4")
  ) %>%
  mutate(
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4", "25µMCQNX10µMDAP5_Fluo4")),
    Timepoint = factor(Timepoint, levels = c("d38", "d42"))
  )

# --- Define color palette
inhibitor_colors <- c(
  "Fed_Fluo4" = "grey50",
  "KCL_Fluo4" = "grey70",
  "25µMCQNX10µMDAP5_Fluo4" = "grey90"
)


# Define pairwise comparisons
pairwise_comparisons <- list(
  c("Fed_Fluo4", "KCL_Fluo4"),               # basal vs stimulated
  c("Fed_Fluo4", "25µMCQNX10µMDAP5_Fluo4")   # basal vs inhibited
)



## --- plot data as is in dataframe ==> firiring rate
# Plot with p-values
inhibitor_plot <- ggplot(inhibitor_df, aes(x = Treatment, y = Firing_events_per_min_norm, fill = Treatment)) +
  geom_violin(trim = FALSE, scale = "width", color = "black", alpha = 0.8) +
  geom_boxplot(width = 0.15, outlier.shape = NA, color = "black", fill = "white") +
  geom_jitter(width = 0.1, size = 1.2, shape = 21, stroke = 0.2, color = "black", fill = "black") +
  facet_wrap(~ Timepoint, nrow = 1) +
  scale_fill_manual(values = inhibitor_colors) +
  stat_compare_means(
    comparisons = pairwise_comparisons,
    method = "t.test",
    label = "p.signif",     # shows *, **, *** instead of raw p-values
    hide.ns = TRUE
  ) +
  labs(
    title = "Normalized Firing Events per Minute under Inhibitors (Ctrl only)",
    y = "Firing Events / Min (Normalized)",
    x = "Treatment"
  ) +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

inhibitor_plot

ggsave(filename = file.path(camaster_plot_outdir, "Ctrl_d38-d42_basal_stim_inhib.pdf"),
       plot = inhibitor_plot, width = 4, height = 4, device = cairo_pdf)




## --- plot data norm to fed in timepoint
# --- Normalize each timepoint's data by Fed_Fluo4 mean
fed_norm_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Genotype == "Ctrl",
    Timepoint %in% c("d38", "d42"),
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4", "25µMCQNX10µMDAP5_Fluo4")
  ) %>%
  group_by(Timepoint) %>%
  mutate(
    FedMean = mean(Firing_events_per_min_norm[Treatment == "Fed_Fluo4"], na.rm = TRUE),
    NormFiring = Firing_events_per_min_norm / FedMean
  ) %>%
  ungroup() %>%
  mutate(
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4", "25µMCQNX10µMDAP5_Fluo4")),
    Timepoint = factor(Timepoint, levels = c("d38", "d42"))
  )

# --- Plot norm to fed in timepoint with p-values
inhibitor_plot_norm <- ggplot(fed_norm_df, aes(x = Treatment, y = NormFiring, fill = Treatment)) +
  geom_violin(trim = FALSE, scale = "width", color = "black", alpha = 0.8) +
  geom_boxplot(width = 0.15, outlier.shape = NA, color = "black", fill = "white") +
  geom_jitter(width = 0.1, size = 1.2, shape = 21, stroke = 0.2, color = "black", fill = "black") +
  facet_wrap(~ Timepoint, nrow = 1) +
  scale_fill_manual(values = inhibitor_colors) +
  stat_compare_means(
    comparisons = pairwise_comparisons,
    method = "t.test",
    label = "p.signif",     # change to "p.format" for exact p-values
    hide.ns = TRUE
  ) +
  labs(
    title = "Relative Firing (Ctrl, Normalized to Fed)",
    y = "Relative Firing (Fed = 1)",
    x = "Treatment"
  ) +
  coord_cartesian(ylim = c(0.6, 1.5)) +   # set y-axis limits
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

inhibitor_plot_norm

ggsave(filename = file.path(camaster_plot_outdir, "Ctrl_d38-d42_basal_stim_inhib_norm.pdf"),
       plot = inhibitor_plot_norm, width = 4, height = 4, device = cairo_pdf)
```


# VI. Vizualiztion
## VIa. ?? Community Size 
```{r}
# -------------------
# Community Size 
# -------------------

# --- Filter and summarize
community_plot_df <- master_combined_cell_community_membership %>%
  filter(
    Celltype == "iN",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d45", "d50","d60"),
    CommunitySize >= 2       # filter out small communities
  ) %>%
  mutate(
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1")),
    Group = paste(Genotype, Treatment, sep = "_")
  ) %>%
  group_by(Genotype, Timepoint, Treatment, Group) %>%
  summarise(
    MeanCommunitySize = mean(CommunitySize, na.rm = TRUE),
    SEM = sd(CommunitySize, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Define fill colors by Group
group_colors <- c(
  "Ctrl_Fed_Fluo4"   = "grey50",
  "Ctrl_KCL_Fluo4"   = "grey70",
  "ASAH1_Fed_Fluo4"  = "dodgerblue",
  "ASAH1_KCL_Fluo4"  = "lightblue"
)

# --- Plot
comm_size <- ggplot(community_plot_df, aes(x = Timepoint, y = MeanCommunitySize, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = MeanCommunitySize - SEM, ymax = MeanCommunitySize + SEM),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(title = "Community Size: Fed vs KCL",
       y = "Mean Community Size",
       x = "Timepoint") +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom")

comm_size
# --- save PDF
ggsave(filename = file.path(camaster_plot_outdir, "Community_size.pdf"),plot = comm_size, width = 4, height = 4, device = cairo_pdf)



# Read normalized metrics (if not already loaded)
norm_metrics_df <- master_combined_sample_level_normalised_metrics %>%
  select(Sample, n_total)

# Join and process community data
community_plot_df <- master_combined_cell_community_membership %>%
  filter(
    Celltype == "iN",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d45", "d50","d60"),
    CommunitySize >= 3
  ) %>%
  left_join(norm_metrics_df, by = "Sample") %>%
  mutate(
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1")),
    Group = paste(Genotype, Treatment, sep = "_"),
    CommunitySize_norm = CommunitySize / n_total
  ) %>%
  group_by(Genotype, Timepoint, Treatment, Group) %>%
  summarise(
    MeanCommunitySize = mean(CommunitySize, na.rm = TRUE),
    MeanCommunitySizeNorm = mean(CommunitySize_norm, na.rm = TRUE),
    SEM = sd(CommunitySize_norm, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# --- Plot
comm_size_norm <- ggplot(community_plot_df, aes(x = Timepoint, y = MeanCommunitySizeNorm, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = MeanCommunitySizeNorm - SEM, ymax = MeanCommunitySizeNorm + SEM),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(title = "Community Size: Fed vs KCL",
       y = "Norm Mean Community Size",
       x = "Timepoint") +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom")

comm_size_norm

```


## ?? VIb. Community Size (High Correlation)
```{r}
# Filter, summarize, and format
community_plot_highcorr_df <- master_comunitySize_highcorr %>%
  filter(
    Celltype == "iN",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d42", "d45", "d50"),
    CommunitySize >= 4
  ) %>%
  mutate(
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1")),
    Group = paste(Genotype, Treatment, sep = "_")
  ) %>%
  group_by(Genotype, Timepoint, Treatment, Group) %>%
  summarise(
    MeanCommunitySize = mean(CommunitySize, na.rm = TRUE),
    SEM = sd(CommunitySize, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Define group colors
group_colors <- c(
  "Ctrl_Fed_Fluo4"  = "grey50",
  "Ctrl_KCL_Fluo4"  = "grey70",
  "ASAH1_Fed_Fluo4" = "dodgerblue",
  "ASAH1_KCL_Fluo4" = "lightblue"
)

# Plot
comm_size <- ggplot(community_plot_highcorr_df, aes(x = Timepoint, y = MeanCommunitySize, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(1), color = "black") +
  geom_errorbar(aes(ymin = MeanCommunitySize - SEM, ymax = MeanCommunitySize + SEM),
                width = 0.2, position = position_dodge(1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Community Size: Fed vs KCL (iN only)",
    y = "Mean Community Size (Raw)",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# Display
comm_size

# Save to file
ggsave(
  filename = file.path(camaster_plot_outdir, "Community_size_raw_iN.pdf"),
  plot = comm_size,
  width = 4, height = 4, device = cairo_pdf
)

```

## Vb. Active frames
### Vb1. iNeuron
```{r}
# -------------------
# Mean Active frames 
# -------------------

## --- 1. % active frames per timepoint and genotype 
# --- Summarization assuming values are already in percent (0–100)
stacked_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Celltype == "iN",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d45", "d50","d60")
  ) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    PercentActive = mean(Mean_percent_active_frames, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    PercentInactive = 100 - PercentActive
  ) %>%
  pivot_longer(
    cols = c(PercentActive, PercentInactive),
    names_to = "ActivityState",
    values_to = "Percent"
  ) %>%
  mutate(
    ActivityState = ifelse(ActivityState == "PercentActive", "active", "nonactive"),
    Group = paste(Genotype, ActivityState, sep = "_"),
    BarGroup = paste(Timepoint, Treatment, sep = "_"),
    ActivityState = factor(ActivityState, levels = c("active", "nonactive")),
    Group = factor(Group, levels = c(
      "Ctrl_nonactive", "Ctrl_active",
      "ASAH1_nonactive", "ASAH1_active"
    )),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

# --- Label position: stack bottom to top
stacked_df <- stacked_df %>%
  group_by(Genotype, BarGroup) %>%
  arrange(ActivityState) %>%
  mutate(
    ypos = cumsum(Percent) - Percent / 2,
    label = paste0(round(Percent), "%")
  ) %>%
  ungroup()

# --- Define color map
group_colors <- c(
  "Ctrl_active"     = "grey50",
  "Ctrl_nonactive"  = "grey70",
  "ASAH1_active"    = "dodgerblue",
  "ASAH1_nonactive" = "lightblue"
)

# --- Plot
perc_active_plot <- ggplot(stacked_df, aes(x = BarGroup, y = Percent, fill = Group)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  geom_text(aes(label = label, y = ypos), color = "white", size = 2.5) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Mean Percent Active vs Non-Active Frames (iN only)",
    y = "Percent of Frames (%)",
    x = "Timepoint & Treatment"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Save plot
ggsave(filename = file.path(camaster_plot_outdir, "Active_frames_iNonly.pdf"), plot = perc_active_plot, width = 6, height = 6, device = cairo_pdf)




## --- 2. % active frames per timepoint and genotype \\ normalized to Ctrl in each timepoint 
# Summarize and calculate raw active counts
active_df_norm <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Celltype == "iN",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d45", "d50","d60")
  ) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    PercentActive = mean(Mean_percent_active_frames, na.rm = TRUE),
    SEM_Active = sd(Mean_percent_active_frames, na.rm = TRUE) / sqrt(n()),
    MeanNTotal = mean(n_total, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    ActiveRaw = PercentActive * MeanNTotal / 100,
    SEM_ActiveRaw = SEM_Active * MeanNTotal / 100  # propagate SEM linearly
  )

# Get reference (Ctrl + Fed per timepoint)
norm_refs <- active_df_norm %>%
  filter(Genotype == "Ctrl", Treatment == "Fed_Fluo4") %>%
  select(Timepoint, RefActive = ActiveRaw, RefSEM = SEM_ActiveRaw)

# Normalize and propagate error
active_df_norm <- active_df_norm %>%
  left_join(norm_refs, by = "Timepoint") %>%
  mutate(
    PercentActive_norm = (ActiveRaw / RefActive) * 100,
    SEM_norm = PercentActive_norm * sqrt((SEM_ActiveRaw / ActiveRaw)^2 + (RefSEM / RefActive)^2),
    BarGroup = paste(Timepoint, Treatment, sep = "_"),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1")),
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4")),
    Timepoint = factor(Timepoint, levels = c("d38", "d45", "d50","d60"))
  )

# Plot normalized percent active (relative to Ctrl Fed per timepoint)
active_only_plot <- ggplot(active_df_norm, aes(x = BarGroup, y = PercentActive_norm, fill = interaction(Genotype, Treatment))) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black", width = 0.95) +
  geom_errorbar(aes(ymin = PercentActive_norm - SEM_norm, ymax = PercentActive_norm + SEM_norm),
                width = 0.2, position = position_dodge(width = 0.8)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Normalized Active Frames (iN only, norm per-timepoint Ctrl Fed)",
    y = "Normalized % Active Frames",
    x = "Timepoint & Treatment"
  ) +
  scale_fill_manual(
    values = c(
      "Ctrl.Fed_Fluo4" = "grey50",
      "Ctrl.KCL_Fluo4" = "grey70",
      "ASAH1.Fed_Fluo4" = "dodgerblue",
      "ASAH1.KCL_Fluo4" = "lightblue"
    ),
    name = "Group"
  ) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Save plot
ggsave(
  filename = file.path(camaster_plot_outdir, "Active_frames_normCtrlTime_iNonly.pdf"), plot = active_only_plot, width = 5, height = 5, device = cairo_pdf)




## --- 3. Total active ROI over time (how many ROIs were active at least once)
# --- Summarization assuming values 
stacked_total_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Celltype == "iN",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d45", "d50","d60")
  ) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    PercentActive = mean(Percent_cells_active, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    PercentInactive = 100 - PercentActive
  ) %>%
  pivot_longer(
    cols = c(PercentActive, PercentInactive),
    names_to = "ActivityState",
    values_to = "Percent"
  ) %>%
  mutate(
    ActivityState = ifelse(ActivityState == "PercentActive", "active", "nonactive"),
    Group = paste(Genotype, ActivityState, sep = "_"),
    BarGroup = paste(Timepoint, Treatment, sep = "_"),
    ActivityState = factor(ActivityState, levels = c("active", "nonactive")),
    Group = factor(Group, levels = c(
      "Ctrl_nonactive", "Ctrl_active",
      "ASAH1_nonactive", "ASAH1_active"
    )),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

# --- Label position: stack bottom to top
stacked_total_df <- stacked_total_df %>%
  group_by(Genotype, BarGroup) %>%
  arrange(ActivityState) %>%
  mutate(
    ypos = cumsum(Percent) - Percent / 2,
    label = paste0(round(Percent), "%")
  ) %>%
  ungroup()

# --- Define color map
group_colors <- c(
  "Ctrl_active"     = "grey50",
  "Ctrl_nonactive"  = "grey70",
  "ASAH1_active"    = "dodgerblue",
  "ASAH1_nonactive" = "lightblue"
)

# --- Plot
perc_active_total_plot <- ggplot(stacked_total_df, aes(x = BarGroup, y = Percent, fill = Group)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  geom_text(aes(label = label, y = ypos), color = "white", size = 2.5) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Percent  Total active ROI over time (iN only)",
    y = "Percent of Frames (%)",
    x = "Timepoint & Treatment"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Save plot
ggsave(filename = file.path(camaster_plot_outdir, "Active_frames_total_iNonly.pdf"), plot = perc_active_total_plot, width = 6, height = 6, device = cairo_pdf)
```



### Vb2. iDA
```{r}
# -------------------
# Mean Active frames 
# -------------------

## --- 1. % active frames per timepoint and genotype 
# --- Summarization assuming values are already in percent (0–100)
stacked_iDA_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Celltype == "iDA",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint == c("d33", "d50")
  ) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    PercentActive = mean(Mean_percent_active_frames, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    PercentInactive = 100 - PercentActive
  ) %>%
  pivot_longer(
    cols = c(PercentActive, PercentInactive),
    names_to = "ActivityState",
    values_to = "Percent"
  ) %>%
  mutate(
    ActivityState = ifelse(ActivityState == "PercentActive", "active", "nonactive"),
    Group = paste(Genotype, ActivityState, sep = "_"),
    BarGroup = paste(Timepoint, Treatment, sep = "_"),
    ActivityState = factor(ActivityState, levels = c("active", "nonactive")),
    Group = factor(Group, levels = c(
      "Ctrl_nonactive", "Ctrl_active",
      "ASAH1_nonactive", "ASAH1_active"
    )),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

# --- Label position: stack bottom to top
stacked_iDA_df <- stacked_iDA_df %>%
  group_by(Genotype, BarGroup) %>%
  arrange(ActivityState) %>%
  mutate(
    ypos = cumsum(Percent) - Percent / 2,
    label = paste0(round(Percent), "%")
  ) %>%
  ungroup()

# --- Define color map
group_colors <- c(
  "Ctrl_active"     = "grey50",
  "Ctrl_nonactive"  = "grey70",
  "ASAH1_active"    = "dodgerblue",
  "ASAH1_nonactive" = "lightblue"
)

# --- Plot
perc_active_iDA_plot <- ggplot(stacked_iDA_df, aes(x = BarGroup, y = Percent, fill = Group)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  geom_text(aes(label = label, y = ypos), color = "white", size = 2.5) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Mean Percent Active vs Non-Active Frames (iDA only)",
    y = "Percent of Frames (%)",
    x = "Timepoint & Treatment"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Save plot
ggsave(filename = file.path(camaster_plot_outdir, "Active_frames_iDAonly.pdf"), plot = perc_active_iDA_plot, width = 4, height = 6, device = cairo_pdf)




## --- 2. % active frames per timepoint and genotype \\ normalized to Ctrl in each timepoint 
# Summarize and calculate raw active counts
# Step 1: Summarize main data
active_df_iDA_norm <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Celltype == "iDA",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d33", "d50")
  ) %>%
  mutate(Timepoint = as.character(Timepoint)) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    PercentActive = mean(Mean_percent_active_frames, na.rm = TRUE),
    SEM_Active = sd(Mean_percent_active_frames, na.rm = TRUE) / sqrt(n()),
    MeanNTotal = mean(n_total, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    ActiveRaw = PercentActive * MeanNTotal / 100,
    SEM_ActiveRaw = SEM_Active * MeanNTotal / 100
  )

# Step 2: Get Ctrl Fed per timepoint reference
norm_iDA_refs <- active_df_iDA_norm %>%
  filter(Genotype == "Ctrl", Treatment == "Fed_Fluo4") %>%
  select(Timepoint, RefActive = ActiveRaw, RefSEM = SEM_ActiveRaw)

# Step 3: Join and normalize
active_df_iDA_norm <- active_df_iDA_norm %>%
  left_join(norm_iDA_refs, by = "Timepoint") %>%
  mutate(
    PercentActive_norm = (ActiveRaw / RefActive) * 100,
    SEM_norm = PercentActive_norm * sqrt((SEM_ActiveRaw / ActiveRaw)^2 + (RefSEM / RefActive)^2),
    BarGroup = paste(Timepoint, Treatment, sep = "_"),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1")),
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4")),
    Timepoint = factor(Timepoint, levels = c("d33", "d50","d60"))
  )

# Optional: restrict to d50 only until d60 data are in
active_df_iDA_norm <- active_df_iDA_norm %>%
  filter(Timepoint %in% c("d33", "d50"))

# Plot normalized percent active (relative to Ctrl Fed per timepoint)
active_only_iDA_plot <- ggplot(active_df_iDA_norm, aes(x = BarGroup, y = PercentActive_norm, fill = interaction(Genotype, Treatment))) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black", width = 0.95) +
  geom_errorbar(aes(ymin = PercentActive_norm - SEM_norm, ymax = PercentActive_norm + SEM_norm),
                width = 0.2, position = position_dodge(width = 0.8)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Normalized Active Frames (iDA only, norm per-timepoint Ctrl Fed)",
    y = "Normalized % Active Frames",
    x = "Timepoint & Treatment"
  ) +
  scale_fill_manual(
    values = c(
      "Ctrl.Fed_Fluo4" = "grey50",
      "Ctrl.KCL_Fluo4" = "grey70",
      "ASAH1.Fed_Fluo4" = "dodgerblue",
      "ASAH1.KCL_Fluo4" = "lightblue"
    ),
    name = "Group"
  ) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Save plot
ggsave(filename = file.path(camaster_plot_outdir, "Active_frames_normCtrlTime_iDAonly.pdf"), plot = active_only_iDA_plot, width = 4, height = 5, device = cairo_pdf)





## --- 3. Total active ROI over time (how many ROIs were active at least once)
# --- Summarization assuming values 
stacked_total_iDA_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Celltype == "iDA",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint == c("d33", "d50")
  ) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    PercentActive = mean(Percent_cells_active, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    PercentInactive = 100 - PercentActive
  ) %>%
  pivot_longer(
    cols = c(PercentActive, PercentInactive),
    names_to = "ActivityState",
    values_to = "Percent"
  ) %>%
  mutate(
    ActivityState = ifelse(ActivityState == "PercentActive", "active", "nonactive"),
    Group = paste(Genotype, ActivityState, sep = "_"),
    BarGroup = paste(Timepoint, Treatment, sep = "_"),
    ActivityState = factor(ActivityState, levels = c("active", "nonactive")),
    Group = factor(Group, levels = c(
      "Ctrl_nonactive", "Ctrl_active",
      "ASAH1_nonactive", "ASAH1_active"
    )),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

# --- Label position: stack bottom to top
stacked_total_iDA_df <- stacked_total_iDA_df %>%
  group_by(Genotype, BarGroup) %>%
  arrange(ActivityState) %>%
  mutate(
    ypos = cumsum(Percent) - Percent / 2,
    label = paste0(round(Percent), "%")
  ) %>%
  ungroup()

# --- Define color map
group_colors <- c(
  "Ctrl_active"     = "grey50",
  "Ctrl_nonactive"  = "grey70",
  "ASAH1_active"    = "dodgerblue",
  "ASAH1_nonactive" = "lightblue"
)

# --- Plot
perc_active_total_iDA_plot <- ggplot(stacked_total_iDA_df, aes(x = BarGroup, y = Percent, fill = Group)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  geom_text(aes(label = label, y = ypos), color = "white", size = 2.5) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Percent  Total active ROI over time (iDA only)",
    y = "Percent of Frames (%)",
    x = "Timepoint & Treatment"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Save plot
ggsave(filename = file.path(camaster_plot_outdir, "Active_frames_total_iDAonly.pdf"), plot = perc_active_total_iDA_plot, width = 4, height = 6, device = cairo_pdf)

```




## Vc. Firing Events per Minute
### Vc1. iNeurons QC over time
```{r}
# -----------------------------
# Supplement: Maturation Fed-only, Ctrl 
# -----------------------------

# Filter Fed only, Ctrl
fed_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Genotype %in% c("Ctrl"),
    Celltype == "iN",   # or "iDA" if preferred
    Treatment == "Fed_Fluo4",
    Timepoint %in% c("d38", "d45", "d50", "d60")
  ) %>%
  mutate(
    Timepoint = factor(Timepoint, levels = c("d38", "d45", "d50", "d60")),
    Genotype = factor(Genotype, levels = c("Ctrl"))
  )

# Pairwise comparisons for timepoints
timepoint_comparisons <- list(
  c("d38", "d45"),
  c("d45", "d50"),
  c("d50", "d60"),
  c("d38", "d60")
)

# Define color palettes for Ctrl
ctrl_colors  <- c("d38" = "grey70", "d45" = "grey60", "d50" = "grey50", "d60" = "grey40")

# Plotting function
plot_genotype_maturation <- function(df, geno, colorset, outfile) {
  plot_df <- df %>% filter(Genotype == geno)
  
  p <- ggplot(plot_df, aes(x = Timepoint, y = Firing_events_per_min, fill = Timepoint)) +
    geom_violin(trim = FALSE, scale = "width", color = "black", alpha = 0.8) +
    geom_boxplot(width = 0.15, outlier.shape = NA, color = "black", fill = "white") +
    geom_jitter(width = 0.1, size = 1.2, shape = 21, stroke = 0.2,
                color = "black", fill = "black") +
    scale_fill_manual(values = colorset) +
    stat_compare_means(
      comparisons = timepoint_comparisons,
      method = "wilcox.test",
      label = "p.signif",
      hide.ns = TRUE
    ) +
    labs(
      title = paste("Firing Events During Maturation (", geno, ", Fed)", sep = ""),
      y = "Firing Events / Min",
      x = "Timepoint"
    ) +
    coord_cartesian(ylim = c(50, 200)) +   # set y-axis limits
    theme_bw(base_size = 6) +
    theme(
      panel.grid = element_blank(),
      legend.position = "none",
      axis.text.x = element_text(angle = 45, hjust = 1)
    )
  
  ggsave(
    filename = file.path(camaster_plot_outdir, outfile),
    plot = p, width = 3, height = 4, device = cairo_pdf
  )
  
  return(p)
}

# Generate Ctrl and ASAH1 plots
ctrl_fed_plot  <- plot_genotype_maturation(fed_df, "Ctrl", ctrl_colors, "Ctrl_Fed_maturation.pdf")



```




### Vc2. iNeurons
```{r}
# -------------------
# Firing Events per Minute
# -------------------

## --- 1. Data preparation 
# --- Prepare data for firing events by sample
summary_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Celltype == "iN",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d45", "d50", "d60")
  ) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    FiringEventsPerMin = mean(Firing_events_per_min, na.rm = TRUE),
    SEM_Firing = sd(Firing_events_per_min, na.rm = TRUE) / sqrt(n()),
    PropHighCorr = mean(prop_high_corr, na.rm = TRUE),
    SEM_Prop = sd(prop_high_corr, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    Timepoint = factor(Timepoint, levels = c("d38", "d45", "d50","d60")),
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4")),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

# --- Normalize to d38 Fed within each Genotype
norm_refs <- summary_df %>%
  filter(Timepoint == "d38", Treatment == "Fed_Fluo4") %>%
  select(Genotype, FiringEventsPerMin_ref = FiringEventsPerMin, SEM_Firing_ref = SEM_Firing)

summary_df <- summary_df %>%
  left_join(norm_refs, by = "Genotype") %>%
  mutate(
    FiringEventsPerMin_norm = (FiringEventsPerMin / FiringEventsPerMin_ref) * 100,
    SEM_Firing_norm = (SEM_Firing / FiringEventsPerMin_ref) * 100
  ) %>%
  select(-FiringEventsPerMin_ref, -SEM_Firing_ref)


# --- Normalize to Ctrl + Fed at each timepoint
norm_refs <- summary_df %>%
  filter(Genotype == "Ctrl", Treatment == "Fed_Fluo4") %>%
  select(Timepoint, FiringEventsPerMin_ref = FiringEventsPerMin, SEM_Firing_ref = SEM_Firing)

summary_df <- summary_df %>%
  left_join(norm_refs, by = "Timepoint") %>%
  mutate(
    FiringEventsPerMin_normtime = (FiringEventsPerMin / FiringEventsPerMin_ref) * 100,
    SEM_Firing_norm = (SEM_Firing / FiringEventsPerMin_ref) * 100
  ) %>%
  select(-FiringEventsPerMin_ref, -SEM_Firing_ref)


# --- Define sample order 
summary_df <- summary_df %>%
  mutate(
    Group = paste(Genotype, Treatment, sep = "_")
  )

# --- Define color map
group_colors <- c(
  "Ctrl_Fed_Fluo4"     = "grey50",
  "Ctrl_KCL_Fluo4"     = "grey70",
  "ASAH1_Fed_Fluo4"    = "dodgerblue",
  "ASAH1_KCL_Fluo4"    = "lightblue"
)


## --- 2. Plot data 
# --- Plot Firing Events per Minute
firing_events_plot <- ggplot(summary_df, aes(x = Timepoint, y = FiringEventsPerMin, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = FiringEventsPerMin - SEM_Firing, ymax = FiringEventsPerMin + SEM_Firing),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Firing Events per Minute",
    y = "Firing Events / Min",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Plot Norm Firing Events per Minute
firing_events_norm_plot <- ggplot(summary_df, aes(x = Timepoint, y = FiringEventsPerMin_norm, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(
    ymin = FiringEventsPerMin_norm - SEM_Firing_norm,
    ymax = FiringEventsPerMin_norm + SEM_Firing_norm
  ), width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Normalized Firing Rate",
    y = "Relative Firing (%)",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Plot Norm T=fed ctrl Firing Events per Minute
firing_events_norm_time_plot <- ggplot(summary_df, aes(x = Timepoint, y = FiringEventsPerMin_normtime, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(
    ymin = FiringEventsPerMin_normtime - SEM_Firing_norm,
    ymax = FiringEventsPerMin_normtime + SEM_Firing_norm
  ), width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Normalized Firing Rate within timepoints",
    y = "Relative Firing (%)",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )


# --- Facet by timepoint: Plot Norm T=fed ctrl Firing Events per Minute
firing_events_norm_time_plot_days<- ggplot(summary_df, aes(x = Genotype, 
                                                      y = FiringEventsPerMin_normtime, 
                                                      fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(
    ymin = FiringEventsPerMin_normtime - SEM_Firing_norm,
    ymax = FiringEventsPerMin_normtime + SEM_Firing_norm
  ), width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Timepoint, nrow = 1) +
  labs(
    title = "Normalized Firing Rate within timepoints",
    y = "Relative Firing (%)",
    x = "Genotype"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 0, hjust = 0.5),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )
firing_events_norm_time_plot_days




# --- save PDF
ggsave(filename = file.path(camaster_plot_outdir, "Firing_events_iN.pdf"),plot = firing_events_plot, width = 4, height = 4, device = cairo_pdf)
ggsave(filename = file.path(camaster_plot_outdir, "Firing_events_iN_norm.pdf"),plot = firing_events_norm_plot, width = 4, height = 4, device = cairo_pdf)
ggsave(filename = file.path(camaster_plot_outdir, "Firing_events_iN_normtime.pdf"),plot = firing_events_norm_time_plot, width = 4, height = 4, device = cairo_pdf)
ggsave(filename = file.path(camaster_plot_outdir, "Firing_events_iN_normtime_byDay.pdf"),plot = firing_events_norm_time_plot_days, width = 4, height = 4, device = cairo_pdf)
```



### Vc3. iDA
```{r}
# --- 1. Data preparation
ida_summary_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Celltype == "iDA",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d33", "d50")
  ) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    FiringEventsPerMin = mean(Firing_events_per_min, na.rm = TRUE),
    SEM_Firing = sd(Firing_events_per_min, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    Timepoint = factor(Timepoint, levels = c("d33", "d50")),
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4")),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

# --- Normalize to Ctrl + Fed_Fluo4 at each timepoint
ida_norm_refs <- ida_summary_df %>%
  filter(Genotype == "Ctrl", Treatment == "Fed_Fluo4") %>%
  select(Timepoint, FiringEventsPerMin_ref = FiringEventsPerMin, SEM_Firing_ref = SEM_Firing)

ida_summary_df <- ida_summary_df %>%
  left_join(ida_norm_refs, by = "Timepoint") %>%
  mutate(
    FiringEventsPerMin_norm = (FiringEventsPerMin / FiringEventsPerMin_ref) * 100,
    SEM_Firing_norm = FiringEventsPerMin_norm * sqrt(
      (SEM_Firing / FiringEventsPerMin)^2 + (SEM_Firing_ref / FiringEventsPerMin_ref)^2
    ),
    Group = paste(Genotype, Treatment, sep = "_")
  )

# --- Define color map
group_colors <- c(
  "Ctrl_Fed_Fluo4"  = "grey50",
  "Ctrl_KCL_Fluo4"  = "grey70",
  "ASAH1_Fed_Fluo4" = "dodgerblue",
  "ASAH1_KCL_Fluo4" = "lightblue"
)

# --- Plot: raw firing events
ida_firing_raw_plot <- ggplot(ida_summary_df, aes(x = Timepoint, y = FiringEventsPerMin, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(1), color = "black") +
  geom_errorbar(aes(
    ymin = FiringEventsPerMin - SEM_Firing,
    ymax = FiringEventsPerMin + SEM_Firing
  ), width = 0.2, position = position_dodge(1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Firing Events per Minute (iDA)",
    y = "Firing Events / Min",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Plot: normalized firing events
ida_firing_norm_plot <- ggplot(ida_summary_df, aes(x = Timepoint, y = FiringEventsPerMin_norm, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(1), color = "black") +
  geom_errorbar(aes(
    ymin = FiringEventsPerMin_norm - SEM_Firing_norm,
    ymax = FiringEventsPerMin_norm + SEM_Firing_norm
  ), width = 0.2, position = position_dodge(1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Normalized Firing Rate (iDA, per-timepoint Ctrl Fed = 100%)",
    y = "Relative Firing (%)",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- Save
ggsave(file.path(camaster_plot_outdir, "Firing_events_iDA.pdf"), plot = ida_firing_raw_plot, width = 4, height = 4, device = cairo_pdf)
ggsave(file.path(camaster_plot_outdir, "Firing_events_iDA_norm.pdf"), plot = ida_firing_norm_plot, width = 4, height = 4, device = cairo_pdf)
```





## misc
```{r}
# --- Plot Proportion High Corr ROIs 
prop_high_corr_plot <- ggplot(summary_df, aes(x = Timepoint, y = PropHighCorr, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = PropHighCorr - SEM_Prop, ymax = PropHighCorr + SEM_Prop),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Proportion of Highly Correlated ROIs",
    y = "Proportion High Corr",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

ggsave(filename = file.path(camaster_plot_outdir, "Proportion_high_corr_ROI.pdf"),plot = prop_high_corr_plot, width = 4, height = 4, device = cairo_pdf)
```

