---
title: "neuroLSD_CalciumMaster"
output: html_document
date: "2025-07-21"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Aim
Create master file that loops through all calcium imaging evals and combines results in master file for stats, plotting and saving.

# I. Load packackes
```{r}
library(devtools)

# Core data manipulation & visualization
library(tidyverse)        # ggplot2, dplyr, purrr, readr, tibble, tidyr, stringr
library(zoo)              # Rolling operations
library(reshape2)         # Data reshaping
library(pheatmap)         # Heatmaps
library(ggdendro)         # Dendrograms
library(viridis)          # Color palettes
library(RColorBrewer)
library(NatParksPalettes)
library(tidyplots)
library(ggpubr)           # Publication-ready plots
library(ggsignif)         # Significance annotations
library(Cairo)            # For cairo_pdf output
library(patchwork)        # Plot layouts
library(cowplot)          # Plot composition
library(gridExtra)        # Layout utilities
library(grid)             # Viewports and custom layout
library(rlang)            # Tidy evaluation tools

# Network analysis
library(igraph)
library(ggraph)
#devtools::install_github("simo-91/CalNetExploreR")
library(CalNetExploreR)

# Signal processing
#library(signal)

# Plot composition
library(gridExtra)
library(grid)
library(cowplot)
library(Cairo)
library(dplyr)

```


# II. Metdata input 
```{r}
# -------------------
# DEFINE INPUT DIRS 
# -------------------
timepoint_dirs <- list(
  d38 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250710_diff138_iN_d38_Ctrl-ASAH1_Flou4/cpsam_d38/nd2_labels/calcium_analysis_results_dataframes",
  d42 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250714_diff138_iN_d42_Ctrl-ASAH1_Flou4/nd2_labels/calcium_analysis_results_dataframes",
  d45 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250717_diff138_iN_d45_Ctrl-ASAH1_Flou4/nd2_labels/calcium_analysis_results_dataframes",
  d50 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250721_diff138_iN_d50_Ctrl-ASAH1_Flou4/nd2iN_labels/calcium_analysis_results_dataframes",
  d50iDA = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250721_diff138_iN_d50_Ctrl-ASAH1_Flou4/nd2iDA_labels/calcium_analysis_results_dataframes"
  #d60 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250714_diff138_iN_d42_Ctrl-ASAH1_Flou4/cpsam_d42/nd2_labels/calcium_analysis_results_dataframes"
)

# -------------------
# DEFINE INPUT FILES  
# -------------------
ca_filenames <- c(
  "combined_cell_community_membership",
  "comunitySize_highcorr",
  "combined_events_per_min_results",
  "combined_sample_level_normalised_metrics"
)

# -------------------
# DEFINE OUTPUT DIR  
# -------------------
camaster_outdir <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/camaster_outdir"
dir.create(camaster_outdir, showWarnings = FALSE, recursive = TRUE)

camaster_plot_outdir <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/camaster_outdir/plots"
dir.create(camaster_plot_outdir, showWarnings = FALSE, recursive = TRUE)

# -------------------
# DEFINE INPUT METADATA
# -------------------
celltype <- c("iN","iDA")
timepoint <- c("d38", "d42", "d45", "d50", "d60")
genotypes <- c("Ctrl", "ASAH1")
treatments <- c("Fed_Fluo4", "KCL_Fluo4", "Caffeine_Fluo4", "25µMCQNX10µMDAP5_Fluo4")

```


# III. Parse through files and make master file
```{r}
# -----------------------------
# Metadata annotation helpers
# -----------------------------
extract_match <- function(x, patterns) {
  str_extract(x, str_c(patterns, collapse = "|"))
}

annotate_sample_metadata <- function(df) {
  df %>%
    mutate(
      Celltype    = extract_match(Sample, celltype),
      Timepoint   = extract_match(Sample, timepoint),
      Genotype    = extract_match(Sample, genotypes),
      Treatment   = extract_match(Sample, treatments),
      SampleLabel = str_c(Genotype, Treatment, sep = "_")
    ) %>%
    relocate(Sample, Celltype, Timepoint, Genotype, Treatment, SampleLabel)
}

# -----------------------------
# Master file creation
# -----------------------------
for (fname in ca_filenames) {
  master_df <- map_dfr(timepoint_dirs, function(dir_path) {
    file_path <- file.path(dir_path, paste0(fname, ".csv"))
    if (!file.exists(file_path)) return(NULL)

    df <- read_csv(file_path, show_col_types = FALSE)
    if (!"Sample" %in% colnames(df)) {
      warning("Missing 'Sample' column in: ", file_path)
      return(NULL)
    }

    annotate_sample_metadata(df)
  })

  # Assign variable
  assign(paste0("master_", fname), master_df)

  # Save to output
  write_csv(master_df, file.path(camaster_outdir, paste0("master_", fname, ".csv")))
}

# -----------------------------
# List of Master files
# -----------------------------
master_combined_cell_community_membership
master_comunitySize_highcorr
master_combined_events_per_min_results
master_combined_sample_level_normalised_metrics
```


# IV. Stat test 

# V. QC plots Ctrl basal-sitmulation-inhibition
```{r}
# -----------------------------
# QC plots 
# -----------------------------

# --- Filter data
inhibitor_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Genotype == "Ctrl",
    Timepoint %in% c("d38", "d42"),
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4", "25µMCQNX10µMDAP5_Fluo4")
  ) %>%
  mutate(
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4", "25µMCQNX10µMDAP5_Fluo4")),
    Timepoint = factor(Timepoint, levels = c("d38", "d42"))
  )

# --- Define color palette
inhibitor_colors <- c(
  "Fed_Fluo4" = "grey50",
  "KCL_Fluo4" = "grey70",
  "25µMCQNX10µMDAP5_Fluo4" = "grey90"
)


## --- plot data as is in dataframe ==> firiring rate
# --- Plot
inhibitor_plot <- ggplot(inhibitor_df, aes(x = Treatment, y = Firing_events_per_min_norm, fill = Treatment)) +
  geom_violin(trim = FALSE, scale = "width", color = "black", alpha = 0.8) +
  geom_boxplot(width = 0.15, outlier.shape = NA, color = "black", fill = "white") +
  geom_jitter(width = 0.1, size = 1.2, shape = 21, stroke = 0.2, color = "black", fill = "black") +
  facet_wrap(~ Timepoint, nrow = 1) +
  scale_fill_manual(values = inhibitor_colors) +
  labs(
    title = "Normalized Firing Events per Minute under Inhibitors (Ctrl only)",
    y = "Firing Events / Min (Normalized)",
    x = "Treatment"
  ) +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )
inhibitor_plot

# --- Save plot
ggsave(filename = file.path(camaster_plot_outdir, "Ctrl_d38-d42_basal_stim_inhib.pdf"),
       plot = inhibitor_plot, width = 4, height = 4, device = cairo_pdf)


## --- plot data norm to fed in timepoint
# --- Normalize each timepoint's data by Fed_Fluo4 mean
fed_norm_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Genotype == "Ctrl",
    Timepoint %in% c("d38", "d42"),
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4", "25µMCQNX10µMDAP5_Fluo4")
  ) %>%
  group_by(Timepoint) %>%
  mutate(
    FedMean = mean(Firing_events_per_min_norm[Treatment == "Fed_Fluo4"], na.rm = TRUE),
    NormFiring = Firing_events_per_min_norm / FedMean
  ) %>%
  ungroup() %>%
  mutate(
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4", "25µMCQNX10µMDAP5_Fluo4")),
    Timepoint = factor(Timepoint, levels = c("d38", "d42"))
  )

# --- Plot norm to fed in timepoint
inhibitor_plot_norm <- ggplot(fed_norm_df, aes(x = Treatment, y = NormFiring, fill = Treatment)) +
  geom_violin(trim = FALSE, scale = "width", color = "black", alpha = 0.8) +
  geom_boxplot(width = 0.15, outlier.shape = NA, color = "black", fill = "white") +
  geom_jitter(width = 0.1, size = 1.2, shape = 21, stroke = 0.2, color = "black", fill = "black") +
  facet_wrap(~ Timepoint, nrow = 1) +
  scale_fill_manual(values = inhibitor_colors) +
  labs(
    title = "Relative Firing (Ctrl, Normalized to Fed)",
    y = "Relative Firing (Fed = 1)",
    x = "Treatment"
  ) +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

inhibitor_plot_norm

# --- Save plot
ggsave(filename = file.path(camaster_plot_outdir, "Ctrl_d38-d42_basal_stim_inhib_norm.pdf"),
       plot = inhibitor_plot_norm, width = 4, height = 4, device = cairo_pdf)
```


# VI. Vizualiztion
## VIa. Community Size 
```{r}
# -------------------
# Community Size 
# -------------------

# --- Filter and summarize
community_plot_df <- master_combined_cell_community_membership %>%
  filter(
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d42", "d45"),
    CommunitySize >= 2       # filter out small communities
  ) %>%
  mutate(
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1")),
    Group = paste(Genotype, Treatment, sep = "_")
  ) %>%
  group_by(Genotype, Timepoint, Treatment, Group) %>%
  summarise(
    MeanCommunitySize = mean(CommunitySize, na.rm = TRUE),
    SEM = sd(CommunitySize, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Define fill colors by Group
group_colors <- c(
  "Ctrl_Fed_Fluo4"   = "grey50",
  "Ctrl_KCL_Fluo4"   = "grey70",
  "ASAH1_Fed_Fluo4"  = "dodgerblue",
  "ASAH1_KCL_Fluo4"  = "lightblue"
)

# --- Plot
comm_size <- ggplot(community_plot_df, aes(x = Timepoint, y = MeanCommunitySize, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = MeanCommunitySize - SEM, ymax = MeanCommunitySize + SEM),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(title = "Community Size: Fed vs KCL",
       y = "Mean Community Size",
       x = "Timepoint") +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom")

comm_size
# --- save PDF
ggsave(filename = file.path(camaster_plot_outdir, "Community_size.pdf"),plot = comm_size, width = 4, height = 4, device = cairo_pdf)



# Read normalized metrics (if not already loaded)
norm_metrics_df <- master_combined_sample_level_normalised_metrics %>%
  select(Sample, n_total)

# Join and process community data
community_plot_df <- master_combined_cell_community_membership %>%
  filter(
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d42", "d45"),
    CommunitySize >= 4
  ) %>%
  left_join(norm_metrics_df, by = "Sample") %>%
  mutate(
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1")),
    Group = paste(Genotype, Treatment, sep = "_"),
    CommunitySize_norm = CommunitySize / n_total
  ) %>%
  group_by(Genotype, Timepoint, Treatment, Group) %>%
  summarise(
    MeanCommunitySize = mean(CommunitySize, na.rm = TRUE),
    MeanCommunitySizeNorm = mean(CommunitySize_norm, na.rm = TRUE),
    SEM = sd(CommunitySize_norm, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# --- Plot
comm_size_norm <- ggplot(community_plot_df, aes(x = Timepoint, y = MeanCommunitySizeNorm, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = MeanCommunitySizeNorm - SEM, ymax = MeanCommunitySizeNorm + SEM),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(title = "Community Size: Fed vs KCL",
       y = "Norm Mean Community Size",
       x = "Timepoint") +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom")

comm_size_norm

```


## VIb. Community Size (High Correlation)
```{r}
# Filter, summarize, and format
community_plot_highcorr_df <- master_comunitySize_highcorr %>%
  filter(
    Celltype == "iN",
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d42", "d45", "d50"),
    CommunitySize >= 4
  ) %>%
  mutate(
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1")),
    Group = paste(Genotype, Treatment, sep = "_")
  ) %>%
  group_by(Genotype, Timepoint, Treatment, Group) %>%
  summarise(
    MeanCommunitySize = mean(CommunitySize, na.rm = TRUE),
    SEM = sd(CommunitySize, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Define group colors
group_colors <- c(
  "Ctrl_Fed_Fluo4"  = "grey50",
  "Ctrl_KCL_Fluo4"  = "grey70",
  "ASAH1_Fed_Fluo4" = "dodgerblue",
  "ASAH1_KCL_Fluo4" = "lightblue"
)

# Plot
comm_size <- ggplot(community_plot_highcorr_df, aes(x = Timepoint, y = MeanCommunitySize, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(1), color = "black") +
  geom_errorbar(aes(ymin = MeanCommunitySize - SEM, ymax = MeanCommunitySize + SEM),
                width = 0.2, position = position_dodge(1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Community Size: Fed vs KCL (iN only)",
    y = "Mean Community Size (Raw)",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 6) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# Display
comm_size

# Save to file
ggsave(
  filename = file.path(camaster_plot_outdir, "Community_size_raw_iN.pdf"),
  plot = comm_size,
  width = 4, height = 4, device = cairo_pdf
)

```

## Vb. Active frames
```{r}
# -------------------
# Active frames 
# -------------------

# --- Summarization assuming values are already in percent (0–100)
stacked_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d42", "d45","d50")
  ) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    PercentActive = mean(Mean_percent_active_frames, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    PercentInactive = 100 - PercentActive
  ) %>%
  pivot_longer(
    cols = c(PercentActive, PercentInactive),
    names_to = "ActivityState",
    values_to = "Percent"
  ) %>%
  mutate(
    ActivityState = ifelse(ActivityState == "PercentActive", "active", "nonactive"),
    Group = paste(Genotype, ActivityState, sep = "_"),
    BarGroup = paste(Timepoint, Treatment, sep = "_"),
    ActivityState = factor(ActivityState, levels = c("active", "nonactive")),
    Group = factor(Group, levels = c(
      "Ctrl_nonactive", "Ctrl_active",
      "ASAH1_nonactive", "ASAH1_active"
    ))
  )
# Label position: stack bottom to top
stacked_df <- stacked_df %>%
  group_by(Genotype, BarGroup) %>%
  arrange(ActivityState) %>%
  mutate(
    ypos = cumsum(Percent) - Percent / 2,
    label = paste0(round(Percent), "%")
  ) %>%
  ungroup()


# --- Define sample order 
stacked_df <- stacked_df %>%
  mutate(
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

# --- Define color map
group_colors <- c(
  "Ctrl_active"     = "grey50",
  "Ctrl_nonactive"  = "grey70",
  "ASAH1_active"    = "dodgerblue",
  "ASAH1_nonactive" = "lightblue"
)

# --- Plot: Each bar = one timepoint:treatment, stacked = active/nonactive, facet by genotype
perc_active_plot <- ggplot(stacked_df, aes(x = BarGroup, y = Percent, fill = Group)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  geom_text(aes(label = label, y = ypos), color = "white", size = 2.5) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Mean Percent Active vs Non-Active Frames",
    y = "Percent of Frames (%)",
    x = "Timepoint & Treatment"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

perc_active_plot
# --- save PDF
ggsave(filename = file.path(camaster_plot_outdir, "Percent_Active.pdf"),plot = perc_active_plot, width = 4, height = 5, device = cairo_pdf)

```

## Vc. Firing Events per Minute
```{r}
# -------------------
# Firing Events per Minute
# -------------------

# --- Prepare data for firing events by sample
summary_df <- master_combined_sample_level_normalised_metrics %>%
  filter(Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
         Timepoint %in% c("d38", "d42", "d45")) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    FiringEventsPerMin = mean(Firing_events_per_min, na.rm = TRUE),
    SEM_Firing = sd(Firing_events_per_min, na.rm = TRUE) / sqrt(n()),
    PropHighCorr = mean(prop_high_corr, na.rm = TRUE),
    SEM_Prop = sd(prop_high_corr, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    Timepoint = factor(Timepoint, levels = c("d38", "d42", "d45")),
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4")),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

# norm option for fed == 100
summary_df <- summary_df %>%
  group_by(Genotype, Timepoint) %>%
  mutate(
    FedReference = FiringEventsPerMin[Treatment == "Fed_Fluo4"][1],
    FiringEventsPerMin_norm = (FiringEventsPerMin / FedReference) * 100,
    SEM_Firing_norm = (SEM_Firing / FedReference) * 100
  ) %>%
  ungroup()

# --- Define sample order 
summary_df <- summary_df %>%
  mutate(
    Group = paste(Genotype, Treatment, sep = "_")
  )

# --- Define color map
group_colors <- c(
  "Ctrl_Fed_Fluo4"     = "grey50",
  "Ctrl_KCL_Fluo4"     = "grey70",
  "ASAH1_Fed_Fluo4"    = "dodgerblue",
  "ASAH1_KCL_Fluo4"    = "lightblue"
)

# --- Plot Firing Events per Minute
firing_events_plot <- ggplot(summary_df, aes(x = Timepoint, y = FiringEventsPerMin, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = FiringEventsPerMin - SEM_Firing, ymax = FiringEventsPerMin + SEM_Firing),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Firing Events per Minute",
    y = "Firing Events / Min",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# ---Norm Plot Firing Events per Minute
firing_events_norm_plot <- ggplot(summary_df, aes(x = Timepoint, y = FiringEventsPerMin_norm, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(
    ymin = FiringEventsPerMin_norm - SEM_Firing_norm,
    ymax = FiringEventsPerMin_norm + SEM_Firing_norm
  ), width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Normalized Firing Rate (Fed = 100%)",
    y = "Relative Firing (%)",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )


# --- Plot Proportion High Corr ROIs 
prop_high_corr_plot <- ggplot(summary_df, aes(x = Timepoint, y = PropHighCorr, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = PropHighCorr - SEM_Prop, ymax = PropHighCorr + SEM_Prop),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Proportion of Highly Correlated ROIs",
    y = "Proportion High Corr",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

# --- save PDF
ggsave(filename = file.path(camaster_plot_outdir, "Firing_events.pdf"),plot = firing_events_plot, width = 4, height = 4, device = cairo_pdf)
ggsave(filename = file.path(camaster_plot_outdir, "Firing_events_norm.pdf"),plot = firing_events_norm_plot, width = 4, height = 4, device = cairo_pdf)
ggsave(filename = file.path(camaster_plot_outdir, "Proportion_high_corr_ROI.pdf"),plot = prop_high_corr_plot, width = 4, height = 4, device = cairo_pdf)


```
