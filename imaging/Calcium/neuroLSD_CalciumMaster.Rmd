---
title: "neuroLSD_CalciumMaster"
output: html_document
date: "2025-07-21"
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Aim
Create master file that loops through all calcium imaging evals and combines results in master file for stats, plotting and saving.

# I. Load packackes
```{r}
library(devtools)

# Core data manipulation & visualization
library(tidyverse)        # ggplot2, dplyr, purrr, readr, tibble, tidyr, stringr
library(zoo)              # Rolling operations
library(reshape2)         # Data reshaping
library(pheatmap)         # Heatmaps
library(ggdendro)         # Dendrograms
library(viridis)          # Color palettes
library(RColorBrewer)
library(NatParksPalettes)
library(tidyplots)
library(ggpubr)           # Publication-ready plots
library(ggsignif)         # Significance annotations
library(Cairo)            # For cairo_pdf output
library(patchwork)        # Plot layouts
library(cowplot)          # Plot composition
library(gridExtra)        # Layout utilities
library(grid)             # Viewports and custom layout
library(rlang)            # Tidy evaluation tools

# Network analysis
library(igraph)
library(ggraph)
#devtools::install_github("simo-91/CalNetExploreR")
library(CalNetExploreR)

# Signal processing
#library(signal)

# Plot composition
library(gridExtra)
library(grid)
library(cowplot)

library(dplyr)

```


# II. Metdata input 
```{r}
# -------------------
# DEFINE INPUT DIRS 
# -------------------
timepoint_dirs <- list(
  d38 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250710_diff138_iN_d38_Ctrl-ASAH1_Flou4/cpsam_d38/nd2_labels/calcium_analysis_results_dataframes",
  d42 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250714_diff138_iN_d42_Ctrl-ASAH1_Flou4/nd2_labels/calcium_analysis_results_dataframes",
  d45 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250717_diff138_iN_d45_Ctrl-ASAH1_Flou4/nd2_labels/calcium_analysis_results_dataframes"
  #d50 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250714_diff138_iN_d42_Ctrl-ASAH1_Flou4/cpsam_d42/nd2_labels/calcium_analysis_results_dataframes"
  #d60 = "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/20250714_diff138_iN_d42_Ctrl-ASAH1_Flou4/cpsam_d42/nd2_labels/calcium_analysis_results_dataframes"
)

# -------------------
# DEFINE INPUT FILES  
# -------------------
ca_filenames <- c(
  "combined_cell_community_membership",
  "combined_events_per_min_results",
  "combined_sample_level_normalised_metrics"
)

# -------------------
# DEFINE OUTPUT DIR  
# -------------------
camaster_outdir <- "/Users/felix/HMS Dropbox/Felix Kraus/Felix/Harvard/03_LSD-PD/Microscopy/camaster_outdir"
dir.create(camaster_outdir, showWarnings = FALSE, recursive = TRUE)



# Define naming/color input
celltype <- "iN"
timepoint <- c("d38", "d42", "d45", "d50", "d60")
genotypes <- c("Ctrl", "ASAH1")
treatments <- c("Fed_Fluo4", "KCL_Fluo4", "Caffeine_Fluo4", "25µMCQNX10µMDAP5_Fluo4")

# Construct sample keys
sample_keys <- expand.grid(
  Genotype  = genotypes,
  Treatment = treatments,
  stringsAsFactors = FALSE
) %>%
  mutate(
    SampleLabel = str_c(Genotype, Treatment, sep = "_"),
    PlotOrder = paste(Genotype, match(Treatment, treatments), sep = "_")
  ) %>%
  arrange(factor(Genotype, levels = genotypes), match(Treatment, treatments)) %>%
  mutate(SampleLabel = factor(SampleLabel, levels = SampleLabel))

# Color mapping
geno_levels <- sample_keys$SampleLabel
geno_cols <- setNames(
  sapply(sample_keys$Genotype, function(geno) {
    if (geno == "Ctrl") "grey70" else if (geno == "ASAH1") "lightblue" else "lightgrey"
  }),
  sample_keys$SampleLabel
)

# Sample key to SampleLabel mapping
genotype_map <- setNames(
  sample_keys$SampleLabel,
  paste(celltype, rep(timepoint, each = nrow(sample_keys)), 
        rep(sample_keys$Genotype, times = length(timepoint)), 
        rep(sample_keys$Treatment, times = length(timepoint)), sep = "_")
)

# Apply SampleLabel factor level
set_samplelabel_factor <- function(df) {
  df %>%
    mutate(SampleLabel = factor(SampleLabel, levels = sample_keys$SampleLabel))
}



```


# III. Parse through files and make master file
```{r}
# -----------------------------
# Metadata annotation helpers
# -----------------------------
extract_match <- function(x, patterns) {
  str_extract(x, str_c(patterns, collapse = "|"))
}

annotate_sample_metadata <- function(df) {
  df %>%
    mutate(
      Celltype    = extract_match(Sample, celltype),
      Timepoint   = extract_match(Sample, timepoint),
      Genotype    = extract_match(Sample, genotypes),
      Treatment   = extract_match(Sample, treatments),
      SampleLabel = str_c(Genotype, Treatment, sep = "_")
    ) %>%
    relocate(Sample, Celltype, Timepoint, Genotype, Treatment, SampleLabel)
}

# -----------------------------
# Master file creation
# -----------------------------
for (fname in ca_filenames) {
  master_df <- map_dfr(timepoint_dirs, function(dir_path) {
    file_path <- file.path(dir_path, paste0(fname, ".csv"))
    if (!file.exists(file_path)) return(NULL)

    df <- read_csv(file_path, show_col_types = FALSE)
    if (!"Sample" %in% colnames(df)) {
      warning("Missing 'Sample' column in: ", file_path)
      return(NULL)
    }

    annotate_sample_metadata(df)
  })

  # Assign variable
  assign(paste0("master_", fname), master_df)

  # Save to output
  write_csv(master_df, file.path(camaster_outdir, paste0("master_", fname, ".csv")))
}

# -----------------------------
# List of Master files
# -----------------------------
master_combined_cell_community_membership
master_combined_events_per_min_results
master_combined_sample_level_normalised_metrics
```


# IV. Stat test 


# V. Vizualiztion
```{r}


community_plot_df
# Filter and summarize
community_plot_df <- master_combined_cell_community_membership %>%
  filter(Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
         Timepoint %in% c("d38", "d42", "d45")) %>%
  mutate(
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1")),
    Group = paste(Genotype, Treatment, sep = "_")
  ) %>%
  group_by(Genotype, Timepoint, Treatment, Group) %>%
  summarise(
    MeanCommunitySize = mean(CommunitySize, na.rm = TRUE),
    SEM = sd(CommunitySize, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  )

# Define fill colors by Group
group_colors <- c(
  "Ctrl_Fed_Fluo4"   = "grey50",
  "Ctrl_KCL_Fluo4"   = "grey70",
  "ASAH1_Fed_Fluo4"  = "dodgerblue",
  "ASAH1_KCL_Fluo4"  = "lightblue"
)

# Plot
ggplot(community_plot_df, aes(x = Timepoint, y = MeanCommunitySize, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = MeanCommunitySize - SEM, ymax = MeanCommunitySize + SEM),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(title = "Community Size: Fed vs KCL",
       y = "Mean Community Size",
       x = "Timepoint") +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    panel.grid = element_blank(),
    legend.position = "bottom")


# -------------------
# Active frames 
# -------------------

# summarization assuming values are already in percent (0–100)
stacked_df <- master_combined_sample_level_normalised_metrics %>%
  filter(
    Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
    Timepoint %in% c("d38", "d42", "d45")
  ) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    PercentActive = mean(Mean_percent_active_frames, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  mutate(
    PercentInactive = 100 - PercentActive
  ) %>%
  pivot_longer(
    cols = c(PercentActive, PercentInactive),
    names_to = "ActivityState",
    values_to = "Percent"
  ) %>%
  mutate(
    ActivityState = ifelse(ActivityState == "PercentActive", "active", "nonactive"),
    Group = paste(Genotype, ActivityState, sep = "_"),
    BarGroup = paste(Timepoint, Treatment, sep = "_"),
    ActivityState = factor(ActivityState, levels = c("nonactive", "active")),
    Group = factor(Group, levels = c(
      "Ctrl_nonactive", "Ctrl_active",
      "ASAH1_nonactive", "ASAH1_active"
    ))
  )

stacked_df <- stacked_df %>%
  mutate(
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

# Color map
group_colors <- c(
  "Ctrl_active"     = "grey50",
  "Ctrl_nonactive"  = "grey70",
  "ASAH1_active"    = "dodgerblue",
  "ASAH1_nonactive" = "lightblue"
)

# Plot: Each bar = one timepoint:treatment, stacked = active/nonactive, facet by genotype
ggplot(stacked_df, aes(x = BarGroup, y = Percent, fill = Group)) +
  geom_bar(stat = "identity", position = "stack", color = "black") +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Mean Percent Active vs Non-Active Frames",
    y = "Percent of Frames (%)",
    x = "Timepoint & Treatment"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )









# -------------------
# Active frames 
# -------------------

summary_df <- master_combined_sample_level_normalised_metrics %>%
  filter(Treatment %in% c("Fed_Fluo4", "KCL_Fluo4"),
         Timepoint %in% c("d38", "d42", "d45")) %>%
  group_by(Genotype, Timepoint, Treatment) %>%
  summarise(
    FiringEventsPerMin = mean(Firing_events_per_min, na.rm = TRUE),
    SEM_Firing = sd(Firing_events_per_min, na.rm = TRUE) / sqrt(n()),
    PropHighCorr = mean(prop_high_corr, na.rm = TRUE),
    SEM_Prop = sd(prop_high_corr, na.rm = TRUE) / sqrt(n()),
    .groups = "drop"
  ) %>%
  mutate(
    Timepoint = factor(Timepoint, levels = c("d38", "d42", "d45")),
    Treatment = factor(Treatment, levels = c("Fed_Fluo4", "KCL_Fluo4")),
    Genotype = factor(Genotype, levels = c("Ctrl", "ASAH1"))
  )

summary_df <- summary_df %>%
  mutate(
    Group = paste(Genotype, Treatment, sep = "_")
  )
group_colors <- c(
  "Ctrl_Fed_Fluo4"     = "grey50",
  "Ctrl_KCL_Fluo4"     = "grey70",
  "ASAH1_Fed_Fluo4"    = "dodgerblue",
  "ASAH1_KCL_Fluo4"    = "lightblue"
)



# Plot Firing Events per Minute
ggplot(summary_df, aes(x = Timepoint, y = FiringEventsPerMin, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = FiringEventsPerMin - SEM_Firing, ymax = FiringEventsPerMin + SEM_Firing),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Firing Events per Minute",
    y = "Firing Events / Min",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )

ggplot(summary_df, aes(x = Timepoint, y = PropHighCorr, fill = Group)) +
  geom_bar(stat = "identity", position = position_dodge(width = 1), color = "black") +
  geom_errorbar(aes(ymin = PropHighCorr - SEM_Prop, ymax = PropHighCorr + SEM_Prop),
                width = 0.2, position = position_dodge(width = 1)) +
  facet_wrap(~ Genotype, nrow = 1) +
  labs(
    title = "Proportion of Highly Correlated Cells",
    y = "Proportion High Corr",
    x = "Timepoint"
  ) +
  scale_fill_manual(values = group_colors) +
  theme_bw(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  )


```
