---
title: "Lipidomics_HeLa_iN-diff133_ASAH1-WC-OrganellIeIP"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# load packackes
```{r}
# Core Data Manipulation & Tidyverse
library(tidyverse)     # Includes ggplot2, dplyr, tidyr, readr, tibble, purrr, stringr, forcats
library(plyr)
library(dplyr)
library(data.table)
library(broom)
library(rlang)

# Visualization: ggplot2 Extensions & Plots
library(ggplot2)
library(ggrepel)
library(ggpubr)
library(ggpmisc)
library(cowplot)
library(patchwork)
library(scales)
library(gghighlight)
library(superheat)
library(ggVennDiagram)
library(UpSetR)
library(ComplexUpset)

# Heatmaps & Clustering
library(pheatmap)
library(RColorBrewer)
library(circlize)
#install.packages("magick")
library(magick)

# Color Palettes
library(viridis)
library(NatParksPalettes)


# Dimension Reduction / Statistics
library(limma)
library(ggbiplot)

# Interactive & Advanced Plotting
library(plotly)
library(circlize)

# Utilities / Dev / Misc
library(grid)
library(gridExtra)
library(Cairo)
#library(png)
library(devtools)
library(lintr)
library(gptstudio)
```


# output dirs overview:
```{r}
out_dir_lipids_HeLaWC <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Lipidomics/Eval/HeLaWC"
dir.create(out_dir_lipids_HeLaWC, recursive = TRUE, showWarnings = FALSE)

out_dir_lipids_HeLaLysoIP <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Lipidomics/Eval/HeLaLysoIP"
dir.create(out_dir_lipids_HeLaLysoIP, recursive = TRUE, showWarnings = FALSE)

out_dir_lipids_iNWC <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Lipidomics/Eval/iNWC"
dir.create(out_dir_lipids_iNWC, recursive = TRUE, showWarnings = FALSE)

out_dir_lipids_iNLysoIP <- "/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Lipidomics/Eval/iNLysoIP"
dir.create(out_dir_lipids_iNLysoIP, recursive = TRUE, showWarnings = FALSE)




```

# background:
contains evaluation for whole-cell and organelle-IP from HeLa or iNeuron d21
- Hela untagged, Ctrl LysoIP, ASAH1-/- LysoIP
- iNeuron untagged, Ctrl EL EndoIP, ASAH11-/- EL EndoIP


# HeLa lipidomics data
## Lyso-IP
load LysoIP data for volcano plots. Color by lipid class in minimal theme (BW)
got the log2FC and -log10 p-value form LipidCruncher (Walther/Ferese lab)
```{r}
# ----------------------------
# LysoIP HeLa 
# bargraph of lipid classes
# ----------------------------

# --- Step 1. read in csv file
lyso_df <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Lipidomics/datasets/Felix-HeLa-IP-lipidomics_cleaned_norm.csv', header=T, sep=',', stringsAsFactors = FALSE)

# Rename LBPA to LBPA-BMPs
lyso_df <- lyso_df %>%
  mutate(ClassKey = str_replace(ClassKey, "^LBPA$", "LBPA-BMP"))

# --- Step 2. get colnames, calculate log2FC
# Columns for replicates
asah1_cols <- c("HeLaLysoIPASAH11", "HeLaLysoIPASAH12", "HeLaLysoIPASAH13")
ctrl_cols  <- c("HeLaLysoIPCtrl1",  "HeLaLysoIPCtrl2",  "HeLaLysoIPCtrl3")

# Per-lipid mean abundance
lyso_fc_df <- lyso_df %>%
  mutate(ASAH1_mean = rowMeans(across(all_of(asah1_cols)), na.rm = TRUE),
         Ctrl_mean  = rowMeans(across(all_of(ctrl_cols)),  na.rm = TRUE),
         log2FC     = log2(ASAH1_mean / Ctrl_mean),
         ClassKey = str_replace(ClassKey, "^LBPA$", "LBPA-BMP"))


# Convert p-value column to numeric if necessary
lyso_df$X..LOG10.pValue. <- as.numeric(lyso_df$X..LOG10.pValue.)

# Add p-value and -log10(p-value) to fc dataframe
lyso_fc_df <- lyso_fc_df %>%
  mutate(pvalue     = 10^(-X..LOG10.pValue.),
         negLog10P  = X..LOG10.pValue.)

# Class-level stats
lyso_fc_stats <- lyso_fc_df %>%
  group_by(ClassKey) %>%
  summarise(mean_log2FC = mean(log2FC, na.rm = TRUE),
            sd_log2FC   = sd(log2FC, na.rm = TRUE),
            .groups = "drop")


# --- Step 3. Barplot
HelalysoIPplot <- ggplot() +
  geom_col(data = lyso_fc_stats,
           aes(x = ClassKey, y = mean_log2FC),
           fill = "grey70", width = 0.7) +
  geom_errorbar(data = lyso_fc_stats,
                aes(x = ClassKey,
                    ymin = mean_log2FC - sd_log2FC,
                    ymax = mean_log2FC + sd_log2FC),
                width = 0.25) +
  geom_jitter(data = lyso_fc_df,
              aes(x = ClassKey, y = log2FC),
              alpha = 0.3, width = 0.25, size = 1) +
  geom_hline(yintercept =0, linetype = "dashed", color = "black") +
  scale_x_discrete(limits = c("Cer","Ch","ChE","DG","FA","GM1","GM2","GM3",
                              "Hex1Cer","Hex2Cer","Hex3Cer","LBPA-BMP",
                              "LPC","LPE","PC","PE","PI","PS","SM","TG")) +
  labs(x = "Lipid class", y = "log2FC (ASAH1 / Ctrl)") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5))


# --- Step 4. Save plot as pdf   
ggsave(file.path(out_dir_lipids_HeLaLysoIP,"HelaLysoIP_Ctrl-ASAh1_lipidomics.pdf"), HelalysoIPplot, width = 6, height = 4, device = cairo_pdf)
write.csv(lyso_fc_df, file = file.path(out_dir_lipids_HeLaLysoIP,"HeLaLysoIP_with_log2FC.csv"), row.names = FALSE)




# Determine the number of unique classes
num_colors <- length(unique(lyso_df$ClassKey))
# Generate an interpolated palette with num_colors colors
custom_colors <- colorRampPalette(brewer.pal(20, "RdYlBu"))(num_colors)

# plot volcano 
HeLalysoVol <- ggplot(data = lyso_fc_df, aes(x = log2FC, y = negLog10P)) +
  geom_point(aes(color = ClassKey), alpha = 0.8, size = 3, stroke = 0) +
  geom_hline(yintercept = 1.30102, colour = "#990000", linetype = "dashed") +
  geom_vline(xintercept = c(log2(0.5), log2(2)), colour = "#990000", linetype = "dashed") +
  geom_text_repel(
    data = subset(lyso_fc_df, negLog10P > 2.0 & (log2FC < -log2(3.5) | log2FC > log2(3.5))),
    aes(label = LipidMolec),
    force = 10, max.overlaps = 100, box.padding = 0.35
  ) +
  scale_color_manual(values = custom_colors)  +
  theme_minimal() +
  theme(
    panel.background = element_rect(colour = "black", fill = NA, size = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  ) +
  ggtitle("Lysosomal Lipidome of HeLa Ctrl vs ASAH1") +
  labs(x = "Log2 FC (ASAH1 / Ctrl)", y = "-Log10(p-value)") +
  coord_fixed(ratio = 2.5)

# --- Step x. save the plot in a square 
ggsave(file.path(out_dir_lipids_HeLaLysoIP,"Volcano_LysoIP_CtrlvsASAH1.pdf"), HeLalysoVol, width = 15, height = 15, device = cairo_pdf)

```






## WC data ##
load WC data for volcano plots. Color by lipid class in minimal theme (BW)
got the log2FC and -log10 p-value form LipidCruncher (Walther/Ferese lab)
```{r}
# ----------------------------
# Whole-cell HeLa 
# bargraph of lipid classes
# ----------------------------

# --- Step 1. Load data
HeLaWCIP_df <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Lipidomics/datasets/Felix-HeLa-WholeCell-lipidomics_norm.csv', header=T, sep=',', stringsAsFactors = FALSE)


# --- Rename lipid class
HeLaWCIP_df <- HeLaWCIP_df %>%
  mutate(ClassKey = str_replace(ClassKey, "^LBPA$", "LBPA-BMP"))

# --- Compute per-lipid means and log2FC
asah1_cols_wc <- paste0("HeLaWCASAH1", 1:6)
ctrl_cols_wc  <- paste0("HeLaWCControl", 1:6)

HeLaWCIP_log2fc_df <- HeLaWCIP_df %>%
  mutate(log2.ASAH1.Ctrl. = as.numeric(log2.ASAH1.Ctrl.),
         ASAH1_mean = rowMeans(across(all_of(asah1_cols_wc)), na.rm = TRUE),
         Ctrl_mean  = rowMeans(across(all_of(ctrl_cols_wc)),  na.rm = TRUE),
         log2FC_raw = log2(ASAH1_mean / Ctrl_mean),
         log2FC = ifelse(is.finite(log2FC_raw), log2FC_raw, NA_real_),
         negLOG10.pValue. = log2.ASAH1.Ctrl. * log10(2)) %>%
  select(-log2FC_raw)

# --- Save updated dataframe
write.csv(HeLaWCIP_log2fc_df, file = file.path(out_dir_lipids_HeLaWC, "HeLaWCIP_with_log2FC.csv"), row.names = FALSE)

# --- Barplot
HeLaWC_fc_stats <- HeLaWCIP_log2fc_df %>%
  filter(is.finite(log2FC)) %>%
  group_by(ClassKey) %>%
  summarise(mean_log2FC = mean(log2FC, na.rm = TRUE),
            sd_log2FC   = sd(log2FC,   na.rm = TRUE),
            .groups = "drop")

HeLaWC_ctrlasah1_lipids_bar <- ggplot() +
  geom_col(data = HeLaWC_fc_stats,
           aes(x = ClassKey, y = mean_log2FC),
           fill = "grey70", width = 0.7) +
  geom_errorbar(data = HeLaWC_fc_stats,
                aes(x = ClassKey,
                    ymin = mean_log2FC - sd_log2FC,
                    ymax = mean_log2FC + sd_log2FC),
                width = 0.25) +
  geom_jitter(data = HeLaWCIP_log2fc_df,
              aes(x = ClassKey, y = log2FC),
              alpha = 0.3, width = 0.25, size = 1) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "black") +
  scale_x_discrete(limits = c("Cer","ChE","CL","DG","DGDG","FA","GD1","GM1","GM2","GM3",
                              "GT1a","Hex1Cer","Hex2Cer","Hex3Cer","LBPA-BMP","LPC","LPE",
                              "PA","PC","PC-P","PE","PG","PI","PS","SM","SPH","ST","TG")) +
  labs(x = "Lipid class", y = "log2FC (ASAH1 / Ctrl)") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, hjust = 0.5)) +
  ylim(-6,6)

ggsave(file.path(out_dir_lipids_HeLaWC, "HeLaWCIP_Ctrl-ASAH1_barplot.pdf"), HeLaWC_ctrlasah1_lipids_bar, width = 6, height = 4, device = cairo_pdf)


# --- Volcano plot
num_colors_wc <- length(unique(HeLaWCIP_log2fc_df$ClassKey))
custom_colors_wc <- colorRampPalette(brewer.pal(27, "RdYlBu"))(num_colors_wc)

HeLaWC_ctrl-asah1_lipids_vol <- ggplot(data = HeLaWCIP_log2fc_df, aes(x = log2FC, y = negLOG10.pValue.)) +
  geom_point(aes(color = ClassKey), alpha = 0.8, size = 3, stroke = 0) +
  geom_hline(yintercept = 1.30102, colour = "#990000", linetype = "dashed") +
  geom_vline(xintercept = c(log2(0.5), log2(2)), colour = "#990000", linetype = "dashed") +
  geom_text_repel(
    data = subset(WC_df, negLOG10.pValue. > 3.0 & (log2FC < -log2(5) | log2FC > log2(5))),
    aes(label = LipidMolec),
    force = 10, max.overlaps = 100, box.padding = 0.35
  ) +
  scale_color_manual(values = custom_colors_wc) +
  theme_minimal() +
  theme(
    panel.background = element_rect(colour = "black", fill = NA, size = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  ) +
  ggtitle("Whole Cell Lipidome of HeLa Ctrl vs ASAH1") +
  labs(x = "Log2 FC (ASAH1 / Ctrl)", y = "-Log10(p-value)") +
  coord_fixed(ratio = 1.10)

ggsave(file.path(out_dir_lipids_HeLaWC, "Volcano_WC_CtrlvsASAH1.pdf"), HeLaWC_ctrl-asah1_lipids_vol , width = 20, height = 20, units = "cm", dpi = 600)


```



## WC data if iNeurons ##
Data from day 21 iNeurons, untagged, Ctrl EL c125 and ASAH1 EL D4
got the log2FC and -log10 p-value form LipidCruncher (Walther/Ferese lab)
```{r}
# load dataset for volcano 
iNWC_df <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Lipidomics/20250206_diff133_iNd21_Untagged_CtrlEL_ASAH1EL_EndoIP_Lipidomics/Eval/plots/volcano_data_CtrlASAH1.csv', header=T, sep=',', stringsAsFactors = FALSE)

# Determine the number of unique classes
num_colors_iNwc <- length(unique(iNWC_df$ClassKey))
# Generate an interpolated palette with num_colors colors
custom_colors_iNwc <- colorRampPalette(brewer.pal(32, "RdYlBu"))(num_colors_iNwc)

# plot volcano 
iNwcVol <- ggplot(data = iNWC_df, aes(x = FoldChange, y = negLOG10.pValue.)) +
  geom_point(aes(color = ClassKey), alpha = 0.8, size = 3, stroke = 0) +
  geom_hline(yintercept = 1.30102, colour = "#990000", linetype = "dashed") +
  geom_vline(xintercept = c(log2(0.5), log2(2)), colour = "#990000", linetype = "dashed") +
  # Only label significant hits
  geom_text_repel(
    data = subset(iNWC_df, negLOG10.pValue. > 1.33 & (FoldChange < -log2(3) | FoldChange > log2(3))),
    aes(label = LipidMolec),
    force = 10, max.overlaps = 100, box.padding = 0.35
  ) +
  scale_color_manual(values = custom_colors_iNwc)  +
  theme_minimal() +
  theme(
    panel.background = element_rect(colour = "black", fill = NA, size = 1),
    panel.grid = element_blank(),
    legend.position = "bottom"
  ) +
  ggtitle("Whole Cell Lipidome of iNeuron d21 Ctrl vs ASAH1") +
  labs(x = "Log2 FC iN d21 Ctrl vs ASAH1", y = "-Log10(q-value)")

iNwcVol +
  scale_x_continuous(limits = c(-5, 5)) +
  coord_fixed(ratio = 1.75)

#save the plot in a square 
ggsave("/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Lipidomics/20250206_diff133_iNd21_Untagged_CtrlEL_ASAH1EL_EndoIP_Lipidomics/Eval/plots/Volcano_iNWC_CtrlvsASAH1.pdf", width =20, height = 20, units = "cm", dpi=600)

```



```{r}
library(GWalkR)
LysoLipidHeLaASAH1_df <- read.csv('/Users/felix/Dropbox (HMS)/Felix/Harvard/03_LSD-PD/Lipidomics/20241229_HeLa-Ctrl-ASAH1_LysoIP_lipidocmics/Eval_LysoIP/Felix-HeLa-IP-lipidomics_cleaned_norm.csv', header=T, sep=',', stringsAsFactors = FALSE)
gwalkr(LysoLipidHeLaASAH1_df)
```

